{% extends "admin/base.html" %}

{% block title %}Qu·∫£n l√Ω D·ªØ li·ªáu - Admin - Gia Ph·∫£ Nguy·ªÖn Ph∆∞·ªõc T·ªôc{% endblock %}

{% block content %}
<div class="section-header">
  <h1>üíæ Qu·∫£n l√Ω D·ªØ li·ªáu</h1>
  <p>Qu·∫£n l√Ω v√† xem th√¥ng tin c√°c b·∫£ng trong database Gia ph·∫£</p>
</div>

<!-- Main Tables -->
<div class="section-header">
  <h2>üìä B·∫£ng ch√≠nh (Gia ph·∫£)</h2>
</div>
<div class="tables-grid" id="mainTables">
  <div class="table-card">
    <h3>persons</h3>
    <div class="description">Danh s√°ch th√†nh vi√™n trong gia ph·∫£</div>
    <div class="record-count" id="personsCount">-</div>
    <div class="actions">
      <a href="/members" class="btn btn-sm btn-primary">Xem danh s√°ch</a>
    </div>
  </div>
  <div class="table-card">
    <h3>relationships</h3>
    <div class="description">Quan h·ªá cha m·∫π - con c√°i</div>
    <div class="record-count" id="relationshipsCount">-</div>
  </div>
  <div class="table-card">
    <h3>spouse_sibling_children</h3>
    <div class="description">H√¥n ph·ªëi, anh ch·ªã em, con c√°i</div>
    <div class="record-count" id="spouseSiblingChildrenCount">-</div>
  </div>
</div>

<!-- Supporting Tables -->
<div class="section-header">
  <h2>üîß B·∫£ng ph·ª• tr·ª£</h2>
</div>
<div class="tables-grid" id="supportTables">
  <div class="table-card">
    <h3>activities</h3>
    <div class="description">Ho·∫°t ƒë·ªông / Tin t·ª©c</div>
    <div class="record-count" id="activitiesCount">-</div>
    <div class="actions">
      <a href="/admin/activities" class="btn btn-sm btn-primary">Qu·∫£n l√Ω</a>
    </div>
  </div>
  <div class="table-card">
    <h3>users</h3>
    <div class="description">T√†i kho·∫£n admin</div>
    <div class="record-count" id="usersCount">-</div>
    <div class="actions">
      <a href="/admin/users" class="btn btn-sm btn-primary">Qu·∫£n l√Ω</a>
    </div>
  </div>
  <div class="table-card">
    <h3>activity_logs</h3>
    <div class="description">Logs ho·∫°t ƒë·ªông h·ªá th·ªëng</div>
    <div class="record-count" id="activityLogsCount">-</div>
    <div class="actions">
      <a href="/admin/logs" class="btn btn-sm btn-primary">Xem logs</a>
    </div>
  </div>
</div>

<!-- Database Schema (cho developer) -->
<div class="section-header">
  <h2>üóÑÔ∏è Database schema</h2>
  <p class="text-muted">C·∫•u tr√∫c b·∫£ng v√† m·ªëi quan h·ªá d·ªØ li·ªáu ‚Äî gi√∫p developer n·∫Øm schema nhanh.</p>
</div>
<div class="admin-card">
  <div id="schemaLoading" class="loading">ƒêang t·∫£i schema...</div>
  <div id="schemaError" class="message error" style="display:none;"></div>
  <div id="schemaContent" style="display:none;">
    <p class="text-muted" style="margin-bottom: 1rem;"><strong id="schemaDbName"></strong></p>
    <div class="schema-section">
      <h3 class="schema-subtitle">B·∫£ng v√† c·ªôt</h3>
      <div id="schemaTables"></div>
    </div>
    <div class="schema-section">
      <h3 class="schema-subtitle">Quan h·ªá (Foreign keys)</h3>
      <div id="schemaRelationships"></div>
    </div>
  </div>
</div>

<style>
  .schema-section { margin-top: 1.5rem; }
  .schema-subtitle { font-size: 1rem; color: var(--admin-primary); margin-bottom: 0.75rem; }
  .schema-table-block { margin-bottom: 1rem; border: 1px solid var(--admin-border); border-radius: var(--admin-radius); overflow: hidden; }
  .schema-table-name { background: var(--admin-bg); padding: 0.5rem 0.75rem; font-weight: 600; color: var(--admin-text); }
  .schema-table-cols { padding: 0.5rem 0.75rem; font-size: 0.875rem; }
  .schema-table-cols table { width: 100%; border-collapse: collapse; }
  .schema-table-cols th, .schema-table-cols td { text-align: left; padding: 0.35rem 0.5rem; border-bottom: 1px solid var(--admin-border); }
  .schema-table-cols th { color: var(--admin-text-muted); font-weight: 500; }
  .schema-table-cols .col-key { color: var(--admin-primary); }
  .schema-rel-list { list-style: none; margin: 0; padding: 0; }
  .schema-rel-list li { padding: 0.4rem 0; border-bottom: 1px solid var(--admin-border); font-family: monospace; font-size: 0.875rem; }
  .schema-rel-list li:last-child { border-bottom: none; }
  .schema-rel-from { color: var(--admin-primary); }
  .schema-rel-arrow { color: var(--admin-text-muted); margin: 0 0.25rem; }
</style>

<script>
  async function loadTableStats() {
    try {
      // Load persons count
      try {
        const membersRes = await fetch('/api/members', { credentials: 'include' });
        if (membersRes.ok) {
          const result = await membersRes.json();
          if (result.success && Array.isArray(result.data)) {
            document.getElementById('personsCount').textContent = result.data.length;
          }
        }
      } catch (e) {
        console.error('Error loading persons:', e);
      }

      // Load relationships count
      try {
        const relRes = await fetch('/admin/api/table-stats?table=relationships', { credentials: 'include' });
        if (relRes.ok) {
          const result = await relRes.json();
          if (result.success) {
            document.getElementById('relationshipsCount').textContent = result.count || '-';
          }
        }
      } catch (e) {
        console.error('Error loading relationships:', e);
      }

      // Load spouse_sibling_children count
      try {
        const sscRes = await fetch('/admin/api/table-stats?table=spouse_sibling_children', { credentials: 'include' });
        if (sscRes.ok) {
          const result = await sscRes.json();
          if (result.success) {
            document.getElementById('spouseSiblingChildrenCount').textContent = result.count || '-';
          }
        }
      } catch (e) {
        console.error('Error loading spouse_sibling_children:', e);
      }

      // Load activities count
      try {
        const activitiesRes = await fetch('/api/activities', { credentials: 'include' });
        if (activitiesRes.ok) {
          const activities = await activitiesRes.json();
          document.getElementById('activitiesCount').textContent = Array.isArray(activities) ? activities.length : '-';
        }
      } catch (e) {
        console.error('Error loading activities:', e);
      }

      // Load users count
      try {
        const usersRes = await fetch('/api/admin/users', { credentials: 'include' });
        if (usersRes.ok) {
          const users = await usersRes.json();
          document.getElementById('usersCount').textContent = Array.isArray(users) ? users.length : '-';
        }
      } catch (e) {
        console.error('Error loading users:', e);
      }

      // Load activity_logs count
      try {
        const logsRes = await fetch('/api/admin/activity-logs?limit=1', { credentials: 'include' });
        if (logsRes.ok) {
          const result = await logsRes.json();
          if (result.success) {
            document.getElementById('activityLogsCount').textContent = result.total || '-';
          }
        }
      } catch (e) {
        console.error('Error loading activity_logs:', e);
      }
    } catch (error) {
      console.error('Error loading table stats:', error);
    }
  }

  async function loadSchema() {
    const loading = document.getElementById('schemaLoading');
    const errEl = document.getElementById('schemaError');
    const content = document.getElementById('schemaContent');
    const dbName = document.getElementById('schemaDbName');
    const tablesEl = document.getElementById('schemaTables');
    const relEl = document.getElementById('schemaRelationships');
    errEl.style.display = 'none';
    content.style.display = 'none';
    try {
      const res = await fetch('/admin/api/schema', { credentials: 'include' });
      const data = await res.json();
      if (!res.ok || !data.success) {
        errEl.textContent = data.error || 'Kh√¥ng t·∫£i ƒë∆∞·ª£c schema';
        errEl.style.display = 'block';
        loading.style.display = 'none';
        return;
      }
      loading.style.display = 'none';
      content.style.display = 'block';
      dbName.textContent = 'Database: ' + (data.database || '');
      tablesEl.innerHTML = (data.tables || []).map(t => {
        const cols = (t.columns || []).map(c =>
          `<tr><td>${escapeHtml(c.name)}</td><td>${escapeHtml(c.type)}</td><td class="${c.key ? 'col-key' : ''}">${escapeHtml(c.key || '')}</td><td>${c.nullable ? 'YES' : 'NO'}</td></tr>`
        ).join('');
        return `<div class="schema-table-block"><div class="schema-table-name">${escapeHtml(t.name)}</div><div class="schema-table-cols"><table><thead><tr><th>C·ªôt</th><th>Ki·ªÉu</th><th>Key</th><th>Nullable</th></tr></thead><tbody>${cols}</tbody></table></div></div>`;
      }).join('');
      const fks = data.foreign_keys || [];
      relEl.innerHTML = fks.length
        ? '<ul class="schema-rel-list">' + fks.map(fk =>
            `<li><span class="schema-rel-from">${escapeHtml(fk.from_table)}.${escapeHtml(fk.from_column)}</span><span class="schema-rel-arrow">‚Üí</span><span>${escapeHtml(fk.to_table)}.${escapeHtml(fk.to_column)}</span></li>`
          ).join('') + '</ul>'
        : '<p class="text-muted">Kh√¥ng c√≥ foreign key n√†o (quan h·ªá c√≥ th·ªÉ qua ·ª©ng d·ª•ng).</p>';
    } catch (e) {
      loading.style.display = 'none';
      errEl.textContent = 'L·ªói: ' + (e.message || 'Kh√¥ng t·∫£i ƒë∆∞·ª£c schema');
      errEl.style.display = 'block';
    }
  }

  function escapeHtml(text) {
    if (text == null) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadTableStats();
    loadSchema();
  });
</script>
{% endblock %}
