{% extends "admin_base.html" %}

{% block title %}Qu·∫£n l√Ω D·ªØ li·ªáu - Admin - Gia Ph·∫£ Nguy·ªÖn Ph∆∞·ªõc T·ªôc{% endblock %}

{% block extra_css %}
<style>
  .tables-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  .table-card {
    background: white;
    padding: var(--space-5);
    border-radius: var(--radius-md, 8px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid var(--color-primary, #2563eb);
  }

  .table-card h3 {
    color: var(--color-primary, #2563eb);
    margin-bottom: var(--space-2);
    font-size: var(--font-size-lg, 18px);
  }

  .table-card .description {
    color: var(--color-text-muted, #6b7280);
    font-size: var(--font-size-sm, 14px);
    margin-bottom: var(--space-3);
  }

  .table-card .record-count {
    font-size: var(--font-size-xl, 24px);
    font-weight: var(--font-weight-bold, 700);
    color: var(--color-primary, #2563eb);
    margin-bottom: var(--space-2);
  }

  .table-card .actions {
    display: flex;
    gap: var(--space-2);
    margin-top: var(--space-3);
  }

  .section-header {
    background: white;
    padding: var(--space-6);
    border-radius: var(--radius-md, 8px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: var(--space-6);
  }

  .section-header h2 {
    color: var(--color-primary, #2563eb);
    margin-bottom: var(--space-2);
  }

  .section-header p {
    color: var(--color-text-muted, #6b7280);
  }
</style>
{% endblock %}

{% block content %}
<div class="section-header">
  <h1>üíæ Qu·∫£n l√Ω D·ªØ li·ªáu</h1>
  <p>Qu·∫£n l√Ω v√† xem th√¥ng tin c√°c b·∫£ng trong database Gia ph·∫£</p>
</div>

<!-- Main Tables -->
<div class="section-header">
  <h2>üìä B·∫£ng ch√≠nh (Gia ph·∫£)</h2>
</div>
<div class="tables-grid" id="mainTables">
  <div class="table-card">
    <h3>persons</h3>
    <div class="description">Danh s√°ch th√†nh vi√™n trong gia ph·∫£</div>
    <div class="record-count" id="personsCount">-</div>
    <div class="actions">
      <a href="/members" class="btn btn-sm btn-primary">Xem danh s√°ch</a>
    </div>
  </div>
  <div class="table-card">
    <h3>relationships</h3>
    <div class="description">Quan h·ªá cha m·∫π - con c√°i</div>
    <div class="record-count" id="relationshipsCount">-</div>
  </div>
  <div class="table-card">
    <h3>spouse_sibling_children</h3>
    <div class="description">H√¥n ph·ªëi, anh ch·ªã em, con c√°i</div>
    <div class="record-count" id="spouseSiblingChildrenCount">-</div>
  </div>
</div>

<!-- Supporting Tables -->
<div class="section-header">
  <h2>üîß B·∫£ng ph·ª• tr·ª£</h2>
</div>
<div class="tables-grid" id="supportTables">
  <div class="table-card">
    <h3>activities</h3>
    <div class="description">Ho·∫°t ƒë·ªông / Tin t·ª©c</div>
    <div class="record-count" id="activitiesCount">-</div>
    <div class="actions">
      <a href="/admin/activities" class="btn btn-sm btn-primary">Qu·∫£n l√Ω</a>
    </div>
  </div>
  <div class="table-card">
    <h3>users</h3>
    <div class="description">T√†i kho·∫£n admin</div>
    <div class="record-count" id="usersCount">-</div>
    <div class="actions">
      <a href="/admin/users" class="btn btn-sm btn-primary">Qu·∫£n l√Ω</a>
    </div>
  </div>
  <div class="table-card">
    <h3>activity_logs</h3>
    <div class="description">Logs ho·∫°t ƒë·ªông h·ªá th·ªëng</div>
    <div class="record-count" id="activityLogsCount">-</div>
    <div class="actions">
      <a href="/admin/logs" class="btn btn-sm btn-primary">Xem logs</a>
    </div>
  </div>
</div>

<script>
  async function loadTableStats() {
    try {
      // Load persons count
      try {
        const membersRes = await fetch('/api/members', { credentials: 'include' });
        if (membersRes.ok) {
          const result = await membersRes.json();
          if (result.success && Array.isArray(result.data)) {
            document.getElementById('personsCount').textContent = result.data.length;
          }
        }
      } catch (e) {
        console.error('Error loading persons:', e);
      }

      // Load relationships count
      try {
        const relRes = await fetch('/admin/api/table-stats?table=relationships', { credentials: 'include' });
        if (relRes.ok) {
          const result = await relRes.json();
          if (result.success) {
            document.getElementById('relationshipsCount').textContent = result.count || '-';
          }
        }
      } catch (e) {
        console.error('Error loading relationships:', e);
      }

      // Load spouse_sibling_children count
      try {
        const sscRes = await fetch('/admin/api/table-stats?table=spouse_sibling_children', { credentials: 'include' });
        if (sscRes.ok) {
          const result = await sscRes.json();
          if (result.success) {
            document.getElementById('spouseSiblingChildrenCount').textContent = result.count || '-';
          }
        }
      } catch (e) {
        console.error('Error loading spouse_sibling_children:', e);
      }

      // Load activities count
      try {
        const activitiesRes = await fetch('/api/activities', { credentials: 'include' });
        if (activitiesRes.ok) {
          const activities = await activitiesRes.json();
          document.getElementById('activitiesCount').textContent = Array.isArray(activities) ? activities.length : '-';
        }
      } catch (e) {
        console.error('Error loading activities:', e);
      }

      // Load users count
      try {
        const usersRes = await fetch('/api/admin/users', { credentials: 'include' });
        if (usersRes.ok) {
          const users = await usersRes.json();
          document.getElementById('usersCount').textContent = Array.isArray(users) ? users.length : '-';
        }
      } catch (e) {
        console.error('Error loading users:', e);
      }

      // Load activity_logs count
      try {
        const logsRes = await fetch('/api/admin/activity-logs?limit=1', { credentials: 'include' });
        if (logsRes.ok) {
          const result = await logsRes.json();
          if (result.success) {
            document.getElementById('activityLogsCount').textContent = result.total || '-';
          }
        }
      } catch (e) {
        console.error('Error loading activity_logs:', e);
      }
    } catch (error) {
      console.error('Error loading table stats:', error);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadTableStats();
  });
</script>
{% endblock %}
