{% extends "admin_base.html" %}

{% block title %}Qu·∫£n l√Ω D·ªØ li·ªáu - Admin - Gia Ph·∫£ Nguy·ªÖn Ph∆∞·ªõc T·ªôc{% endblock %}

{% block extra_css %}
<style>
  .tables-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  .table-card {
    background: white;
    padding: var(--space-5);
    border-radius: var(--radius-md, 8px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid var(--color-primary, #2563eb);
  }

  .table-card h3 {
    color: var(--color-primary, #2563eb);
    margin-bottom: var(--space-2);
    font-size: var(--font-size-lg, 18px);
  }

  .table-card .description {
    color: var(--color-text-muted, #6b7280);
    font-size: var(--font-size-sm, 14px);
    margin-bottom: var(--space-3);
  }

  .table-card .record-count {
    font-size: var(--font-size-xl, 24px);
    font-weight: var(--font-weight-bold, 700);
    color: var(--color-primary, #2563eb);
    margin-bottom: var(--space-2);
  }

  .table-card .actions {
    display: flex;
    gap: var(--space-2);
    margin-top: var(--space-3);
  }

  .section-header {
    background: white;
    padding: var(--space-6);
    border-radius: var(--radius-md, 8px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: var(--space-6);
  }

  .section-header h2 {
    color: var(--color-primary, #2563eb);
    margin-bottom: var(--space-2);
  }

  .section-header p {
    color: var(--color-text-muted, #6b7280);
  }

  /* Logs Table Styles */
  .logs-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: var(--radius-md, 8px);
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-top: var(--space-4);
  }

  .logs-table th {
    background: var(--color-primary, #2563eb);
    color: white;
    padding: var(--space-4);
    text-align: left;
    font-weight: var(--font-weight-semibold, 600);
    white-space: nowrap;
  }

  .logs-table td {
    padding: var(--space-4);
    border-bottom: 1px solid var(--color-border, #e5e7eb);
    vertical-align: top;
  }

  .logs-table tr:hover {
    background: var(--color-bg, #f9fafb);
  }

  .log-action-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: var(--font-size-xs, 12px);
    font-weight: var(--font-weight-semibold, 600);
    white-space: nowrap;
  }

  .log-action-LOGIN,
  .log-action-CREATE_PERSON {
    background: #10b981;
    color: white;
  }

  .log-action-UPDATE_PERSON,
  .log-action-UPDATE_SPOUSE,
  .log-action-UPDATE_USER_ROLE {
    background: #f59e0b;
    color: white;
  }

  .log-action-DELETE_PERSON {
    background: #ef4444;
    color: white;
  }

  .log-action-LOGIN_FAILED {
    background: #dc2626;
    color: white;
  }

  .log-diff {
    max-width: 300px;
    font-size: var(--font-size-sm, 14px);
  }

  .log-diff details {
    cursor: pointer;
  }

  .log-diff summary {
    color: var(--color-primary, #2563eb);
    font-weight: var(--font-weight-semibold, 600);
    padding: var(--space-2);
  }

  .log-diff pre {
    background: var(--color-bg, #f9fafb);
    padding: var(--space-3);
    border-radius: var(--radius-sm, 4px);
    overflow-x: auto;
    font-size: var(--font-size-xs, 12px);
    margin-top: var(--space-2);
    max-height: 200px;
    overflow-y: auto;
  }
</style>
{% endblock %}

{% block content %}
<div class="section-header">
  <h1>üíæ Qu·∫£n l√Ω D·ªØ li·ªáu</h1>
  <p>Qu·∫£n l√Ω v√† xem th√¥ng tin c√°c b·∫£ng trong database Gia ph·∫£</p>
</div>

<!-- Main Tables -->
<div class="section-header">
  <h2>üìä B·∫£ng ch√≠nh (Gia ph·∫£)</h2>
</div>
<div class="tables-grid" id="mainTables">
  <div class="table-card">
    <h3>persons</h3>
    <div class="description">Danh s√°ch th√†nh vi√™n trong gia ph·∫£</div>
    <div class="record-count" id="personsCount">-</div>
    <div class="actions">
      <a href="/members" class="btn btn-sm btn-primary">Xem danh s√°ch</a>
    </div>
  </div>
  <div class="table-card">
    <h3>relationships</h3>
    <div class="description">Quan h·ªá cha m·∫π - con c√°i</div>
    <div class="record-count" id="relationshipsCount">-</div>
  </div>
  <div class="table-card">
    <h3>spouse_sibling_children</h3>
    <div class="description">H√¥n ph·ªëi, anh ch·ªã em, con c√°i</div>
    <div class="record-count" id="spouseSiblingChildrenCount">-</div>
  </div>
</div>

<!-- Supporting Tables -->
<div class="section-header">
  <h2>üîß B·∫£ng ph·ª• tr·ª£</h2>
</div>
<div class="tables-grid" id="supportTables">
  <div class="table-card">
    <h3>activities</h3>
    <div class="description">Ho·∫°t ƒë·ªông / Tin t·ª©c</div>
    <div class="record-count" id="activitiesCount">-</div>
    <div class="actions">
      <a href="/admin/activities" class="btn btn-sm btn-primary">Qu·∫£n l√Ω</a>
    </div>
  </div>
  <div class="table-card">
    <h3>users</h3>
    <div class="description">T√†i kho·∫£n admin</div>
    <div class="record-count" id="usersCount">-</div>
    <div class="actions">
      <a href="/admin/users" class="btn btn-sm btn-primary">Qu·∫£n l√Ω</a>
    </div>
  </div>
  <div class="table-card">
    <h3>activity_logs</h3>
    <div class="description">Logs ho·∫°t ƒë·ªông h·ªá th·ªëng</div>
    <div class="record-count" id="activityLogsCount">-</div>
    <div class="actions">
      <a href="/admin/logs" class="btn btn-sm btn-primary">Xem logs</a>
    </div>
  </div>
</div>

<!-- Recent Activity Logs -->
<div class="section-header">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <h2>üìã Log ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h2>
    <a href="/admin/logs" class="btn btn-sm btn-primary">Xem t·∫•t c·∫£ logs</a>
  </div>
</div>
<div style="overflow-x: auto;">
  <table class="logs-table">
    <thead>
      <tr>
        <th>Th·ªùi gian</th>
        <th>User</th>
        <th>H√†nh ƒë·ªông</th>
        <th>Lo·∫°i ƒë·ªëi t∆∞·ª£ng</th>
        <th>ID ƒë·ªëi t∆∞·ª£ng</th>
        <th>Thay ƒë·ªïi</th>
        <th>IP Address</th>
      </tr>
    </thead>
    <tbody id="recentLogsList">
      <tr>
        <td colspan="7" style="text-align: center; padding: var(--space-8);">
          <div class="loading">ƒêang t·∫£i...</div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<script>
  async function loadTableStats() {
    try {
      // Load persons count
      try {
        const membersRes = await fetch('/api/members', { credentials: 'include' });
        if (membersRes.ok) {
          const result = await membersRes.json();
          if (result.success && Array.isArray(result.data)) {
            document.getElementById('personsCount').textContent = result.data.length;
          }
        }
      } catch (e) {
        console.error('Error loading persons:', e);
      }

      // Load relationships count
      try {
        const relRes = await fetch('/admin/api/table-stats?table=relationships', { credentials: 'include' });
        if (relRes.ok) {
          const result = await relRes.json();
          if (result.success) {
            document.getElementById('relationshipsCount').textContent = result.count || '-';
          }
        }
      } catch (e) {
        console.error('Error loading relationships:', e);
      }

      // Load spouse_sibling_children count
      try {
        const sscRes = await fetch('/admin/api/table-stats?table=spouse_sibling_children', { credentials: 'include' });
        if (sscRes.ok) {
          const result = await sscRes.json();
          if (result.success) {
            document.getElementById('spouseSiblingChildrenCount').textContent = result.count || '-';
          }
        }
      } catch (e) {
        console.error('Error loading spouse_sibling_children:', e);
      }

      // Load activities count
      try {
        const activitiesRes = await fetch('/api/activities', { credentials: 'include' });
        if (activitiesRes.ok) {
          const activities = await activitiesRes.json();
          document.getElementById('activitiesCount').textContent = Array.isArray(activities) ? activities.length : '-';
        }
      } catch (e) {
        console.error('Error loading activities:', e);
      }

      // Load users count
      try {
        const usersRes = await fetch('/api/admin/users', { credentials: 'include' });
        if (usersRes.ok) {
          const users = await usersRes.json();
          document.getElementById('usersCount').textContent = Array.isArray(users) ? users.length : '-';
        }
      } catch (e) {
        console.error('Error loading users:', e);
      }

      // Load activity_logs count
      try {
        const logsRes = await fetch('/api/admin/activity-logs?limit=1', { credentials: 'include' });
        if (logsRes.ok) {
          const result = await logsRes.json();
          if (result.success) {
            document.getElementById('activityLogsCount').textContent = result.total || '-';
          }
        }
      } catch (e) {
        console.error('Error loading activity_logs:', e);
      }
    } catch (error) {
      console.error('Error loading table stats:', error);
    }
  }

  // Load Recent Activity Logs
  async function loadRecentLogs() {
    const listEl = document.getElementById('recentLogsList');
    
    try {
      listEl.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: var(--space-8);"><div class="loading">ƒêang t·∫£i...</div></td></tr>';
      
      const result = await fetch('/api/admin/activity-logs?limit=20&offset=0', {
        credentials: 'include'
      });
      
      if (!result.ok) {
        throw new Error(`HTTP ${result.status}: ${result.statusText}`);
      }
      
      const data = await result.json();
      
      if (!data.success) {
        throw new Error(data.error || 'Kh√¥ng th·ªÉ t·∫£i logs');
      }
      
      const logs = data.logs || [];
      
      if (logs.length === 0) {
        listEl.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: var(--space-8);">Ch∆∞a c√≥ log n√†o</td></tr>';
        return;
      }
      
      // Render logs
      listEl.innerHTML = logs.map(log => {
        const createdAt = log.created_at ? formatDateTime(log.created_at) : '-';
        const username = log.username || log.full_name || 'Kh√°ch';
        const action = log.action || '-';
        const targetType = log.target_type || '-';
        const targetId = log.target_id || '-';
        const ipAddress = log.ip_address || '-';
        
        const actionClass = `log-action-${action}`;
        const actionBadge = `<span class="log-action-badge ${actionClass}">${escapeHtml(action)}</span>`;
        
        // Format before/after data
        const diffHtml = formatLogDiff(log.before_data, log.after_data);
        
        return `
          <tr class="log-row">
            <td>${createdAt}</td>
            <td>${escapeHtml(username)}</td>
            <td>${actionBadge}</td>
            <td>${escapeHtml(targetType)}</td>
            <td>${escapeHtml(String(targetId))}</td>
            <td class="log-diff">${diffHtml}</td>
            <td>${escapeHtml(ipAddress)}</td>
          </tr>
        `;
      }).join('');
      
    } catch (err) {
      listEl.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: var(--space-8); color: #ef4444;">L·ªói: ${escapeHtml(err.message)}</td></tr>`;
    }
  }

  function formatDateTime(dateStr) {
    try {
      const date = new Date(dateStr);
      // Convert sang Vietnam timezone (UTC+7)
      // Format: HH:MM:SS DD/MM/YYYY
      const formatter = new Intl.DateTimeFormat('en-US', {
        timeZone: 'Asia/Ho_Chi_Minh',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
      
      const parts = formatter.formatToParts(date);
      const hours = parts.find(p => p.type === 'hour').value;
      const minutes = parts.find(p => p.type === 'minute').value;
      const seconds = parts.find(p => p.type === 'second').value;
      const day = parts.find(p => p.type === 'day').value;
      const month = parts.find(p => p.type === 'month').value;
      const year = parts.find(p => p.type === 'year').value;
      
      return `${hours}:${minutes}:${seconds} ${day}/${month}/${year}`;
    } catch (e) {
      return dateStr;
    }
  }

  function formatLogDiff(beforeData, afterData) {
    if (!beforeData && !afterData) {
      return '<span style="color: var(--color-text-muted, #6b7280);">Kh√¥ng c√≥ thay ƒë·ªïi</span>';
    }
    
    if (!beforeData && afterData) {
      return `<details>
        <summary>T·∫°o m·ªõi</summary>
        <pre>${escapeHtml(JSON.stringify(afterData, null, 2))}</pre>
      </details>`;
    }
    
    if (beforeData && !afterData) {
      return `<details>
        <summary>X√≥a</summary>
        <pre>${escapeHtml(JSON.stringify(beforeData, null, 2))}</pre>
      </details>`;
    }
    
    // Both exist - show diff
    const beforeStr = JSON.stringify(beforeData, null, 2);
    const afterStr = JSON.stringify(afterData, null, 2);
    
    if (beforeStr === afterStr) {
      return '<span style="color: var(--color-text-muted, #6b7280);">Kh√¥ng c√≥ thay ƒë·ªïi</span>';
    }
    
    return `<details>
      <summary>Xem thay ƒë·ªïi</summary>
      <div>
        <div style="margin-bottom: var(--space-2);">
          <strong style="color: #ef4444;">Tr∆∞·ªõc:</strong>
          <pre class="diff-removed">${escapeHtml(beforeStr)}</pre>
        </div>
        <div>
          <strong style="color: #10b981;">Sau:</strong>
          <pre class="diff-added">${escapeHtml(afterStr)}</pre>
        </div>
      </div>
    </details>`;
  }

  function escapeHtml(text) {
    if (!text) return '-';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadTableStats();
    loadRecentLogs();
  });
</script>
{% endblock %}
