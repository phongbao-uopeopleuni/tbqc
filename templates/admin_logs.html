{% extends "admin_base.html" %}

{% block title %}Log - Admin - Gia Ph·∫£ Nguy·ªÖn Ph∆∞·ªõc T·ªôc{% endblock %}

{% block extra_css %}
<style>
  .filter-controls {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
    padding: var(--space-4);
    background: var(--color-bg, #f9fafb);
    border-radius: var(--radius-md, 8px);
  }

  .filter-controls > div {
    flex: 1;
    min-width: 200px;
  }

  .filter-controls label {
    display: block;
    margin-bottom: var(--space-2);
    font-weight: var(--font-weight-semibold, 600);
    font-size: var(--font-size-sm, 14px);
  }

  .filter-controls select,
  .filter-controls input {
    width: 100%;
    padding: var(--space-3);
    border: 1px solid var(--color-border, #e5e7eb);
    border-radius: var(--radius, 6px);
    font-size: var(--font-size-base, 14px);
  }

  .logs-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: var(--radius-md, 8px);
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .logs-table th {
    background: var(--color-primary, #2563eb);
    color: white;
    padding: var(--space-4);
    text-align: left;
    font-weight: var(--font-weight-semibold, 600);
    white-space: nowrap;
  }

  .logs-table td {
    padding: var(--space-4);
    border-bottom: 1px solid var(--color-border, #e5e7eb);
    vertical-align: top;
  }

  .logs-table tr:hover {
    background: var(--color-bg, #f9fafb);
  }

  .log-action-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: var(--font-size-xs, 12px);
    font-weight: var(--font-weight-semibold, 600);
    white-space: nowrap;
  }

  .log-action-LOGIN,
  .log-action-CREATE_PERSON {
    background: #10b981;
    color: white;
  }

  .log-action-UPDATE_PERSON,
  .log-action-UPDATE_SPOUSE,
  .log-action-UPDATE_USER_ROLE {
    background: #f59e0b;
    color: white;
  }

  .log-action-DELETE_PERSON {
    background: #ef4444;
    color: white;
  }

  .log-action-LOGIN_FAILED {
    background: #dc2626;
    color: white;
  }

  .log-diff {
    max-width: 300px;
    font-size: var(--font-size-sm, 14px);
  }

  .log-diff details {
    cursor: pointer;
  }

  .log-diff summary {
    color: var(--color-primary, #2563eb);
    font-weight: var(--font-weight-semibold, 600);
    padding: var(--space-2);
  }

  .log-diff pre {
    background: var(--color-bg, #f9fafb);
    padding: var(--space-3);
    border-radius: var(--radius-sm, 4px);
    overflow-x: auto;
    font-size: var(--font-size-xs, 12px);
    margin-top: var(--space-2);
    max-height: 200px;
    overflow-y: auto;
  }

  .pagination-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: var(--space-6);
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border, #e5e7eb);
  }

  .pagination-info {
    color: var(--color-text-muted, #6b7280);
  }

  .pagination-buttons {
    display: flex;
    gap: var(--space-2);
    align-items: center;
  }

  @media (max-width: 768px) {
    .hide-mobile {
      display: none;
    }

    .filter-controls {
      flex-direction: column;
    }

    .filter-controls > div {
      width: 100%;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="admin-card">
  <h1>üìã Log</h1>
  <p style="color: var(--color-text-muted, #6b7280); margin-top: var(--space-2);">
    Ghi l·∫°i t·∫•t c·∫£ c√°c thay ƒë·ªïi v√† ho·∫°t ƒë·ªông trong website
  </p>
</div>

<!-- Filter Controls -->
<div class="filter-controls">
  <div>
    <label for="filterAction">H√†nh ƒë·ªông:</label>
    <select id="filterAction" class="select">
      <option value="">T·∫•t c·∫£</option>
      <option value="LOGIN">LOGIN</option>
      <option value="LOGIN_FAILED">LOGIN_FAILED</option>
      <option value="CREATE_PERSON">CREATE_PERSON</option>
      <option value="UPDATE_PERSON">UPDATE_PERSON</option>
      <option value="UPDATE_USER_ROLE">UPDATE_USER_ROLE</option>
      <option value="UPDATE_SPOUSE">UPDATE_SPOUSE</option>
      <option value="DELETE_PERSON">DELETE_PERSON</option>
    </select>
  </div>
  <div>
    <label for="filterTargetType">Lo·∫°i ƒë·ªëi t∆∞·ª£ng:</label>
    <select id="filterTargetType" class="select">
      <option value="">T·∫•t c·∫£</option>
      <option value="Person">Person</option>
      <option value="User">User</option>
      <option value="Spouse">Spouse</option>
      <option value="Post">Post</option>
    </select>
  </div>
  <div>
    <label for="filterUserId">User ID:</label>
    <input type="number" id="filterUserId" class="input" placeholder="T·∫•t c·∫£">
  </div>
  <div style="display: flex; align-items: flex-end; gap: var(--space-2);">
    <button class="btn btn-primary" onclick="applyFilters()">L·ªçc</button>
    <button class="btn btn-secondary" onclick="clearFilters()">X√≥a b·ªô l·ªçc</button>
  </div>
</div>

<!-- Logs Table -->
<div style="overflow-x: auto;">
  <table class="logs-table">
    <thead>
      <tr>
        <th>Th·ªùi gian</th>
        <th>User</th>
        <th>H√†nh ƒë·ªông</th>
        <th>Lo·∫°i ƒë·ªëi t∆∞·ª£ng</th>
        <th>ID ƒë·ªëi t∆∞·ª£ng</th>
        <th>Thay ƒë·ªïi</th>
        <th>IP Address</th>
        <th class="hide-mobile">User Agent</th>
      </tr>
    </thead>
    <tbody id="activityLogsList">
      <tr>
        <td colspan="8" style="text-align: center; padding: var(--space-8);">
          <div class="loading">ƒêang t·∫£i...</div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Pagination -->
<div class="pagination-controls">
  <div class="pagination-info" id="logsPaginationInfo">
    ƒêang t·∫£i...
  </div>
  <div class="pagination-buttons">
    <label for="logsPerPage" style="margin-right: var(--space-2);">S·ªë l∆∞·ª£ng m·ªói trang:</label>
    <select id="logsPerPage" class="select" onchange="changeLogsPerPage()" style="width: auto;">
      <option value="10">10</option>
      <option value="25">25</option>
      <option value="50">50</option>
      <option value="100" selected>100</option>
    </select>
    <button id="prevPageBtn" class="btn btn-secondary" onclick="previousPage()" disabled>Tr∆∞·ªõc</button>
    <button id="nextPageBtn" class="btn btn-secondary" onclick="nextPage()" disabled>Sau</button>
  </div>
</div>

<script>
  // Activity Logs Variables
  let logsOffset = 0;
  let logsLimit = 100;
  let logsTotal = 0;
  let logsFilters = {};

  // Load Activity Logs
  async function loadActivityLogs(limit = logsLimit, offset = logsOffset, filters = logsFilters) {
    const listEl = document.getElementById('activityLogsList');
    const paginationInfo = document.getElementById('logsPaginationInfo');
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    
    try {
      // Build query string
      const params = new URLSearchParams({
        limit: limit.toString(),
        offset: offset.toString()
      });
      
      if (filters.action) params.append('action', filters.action);
      if (filters.target_type) params.append('target_type', filters.target_type);
      if (filters.user_id) params.append('user_id', filters.user_id.toString());
      
      listEl.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: var(--space-8);"><div class="loading">ƒêang t·∫£i...</div></td></tr>';
      
      const result = await fetch(`/api/admin/activity-logs?${params.toString()}`, {
        credentials: 'include',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        }
      });
      
      // X·ª≠ l√Ω c√°c status codes kh√°c nhau
      if (result.status === 401) {
        // Unauthorized - ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c session h·∫øt h·∫°n
        const errorText = await result.text();
        let errorMsg = 'Ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c session ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.';
        try {
          const errorData = JSON.parse(errorText);
          errorMsg = errorData.error || errorMsg;
        } catch (e) {
          // N·∫øu kh√¥ng parse ƒë∆∞·ª£c JSON, d√πng message m·∫∑c ƒë·ªãnh
        }
        listEl.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: var(--space-8); color: #ef4444;">
          <div style="margin-bottom: 10px;"><strong>L·ªói 401: ${errorMsg}</strong></div>
          <a href="/admin/login" class="btn btn-primary" style="text-decoration: none; display: inline-block; padding: 8px 16px;">ƒêƒÉng nh·∫≠p l·∫°i</a>
        </td></tr>`;
        paginationInfo.textContent = 'L·ªói x√°c th·ª±c';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
      }
      
      if (result.status === 403) {
        // Forbidden - kh√¥ng c√≥ quy·ªÅn truy c·∫≠p
        const errorText = await result.text();
        let errorMsg = 'B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y.';
        try {
          const errorData = JSON.parse(errorText);
          errorMsg = errorData.error || errorMsg;
        } catch (e) {
          // N·∫øu kh√¥ng parse ƒë∆∞·ª£c JSON, d√πng message m·∫∑c ƒë·ªãnh
        }
        listEl.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: var(--space-8); color: #ef4444;">
          <div><strong>L·ªói 403: ${errorMsg}</strong></div>
        </td></tr>`;
        paginationInfo.textContent = 'Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
      }
      
      if (result.status === 404) {
        // Not Found - b·∫£ng activity_logs kh√¥ng t·ªìn t·∫°i
        const errorText = await result.text();
        let errorMsg = 'B·∫£ng activity_logs kh√¥ng t·ªìn t·∫°i trong database.';
        try {
          const errorData = JSON.parse(errorText);
          errorMsg = errorData.error || errorMsg;
        } catch (e) {
          // N·∫øu kh√¥ng parse ƒë∆∞·ª£c JSON, d√πng message m·∫∑c ƒë·ªãnh
        }
        listEl.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: var(--space-8); color: #ef4444;">
          <div><strong>L·ªói 404: ${errorMsg}</strong></div>
          <div style="margin-top: 10px; font-size: 14px; color: #666;">Vui l√≤ng ki·ªÉm tra database ho·∫∑c li√™n h·ªá qu·∫£n tr·ªã vi√™n.</div>
        </td></tr>`;
        paginationInfo.textContent = 'B·∫£ng kh√¥ng t·ªìn t·∫°i';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
      }
      
      if (!result.ok) {
        // C√°c l·ªói kh√°c
        const errorText = await result.text();
        let errorMsg = `HTTP ${result.status}: ${result.statusText}`;
        try {
          const errorData = JSON.parse(errorText);
          errorMsg = errorData.error || errorMsg;
        } catch (e) {
          // N·∫øu kh√¥ng parse ƒë∆∞·ª£c JSON, d√πng status text
        }
        throw new Error(errorMsg);
      }
      
      // Parse JSON response
      let data;
      try {
        const responseText = await result.text();
        data = JSON.parse(responseText);
      } catch (parseError) {
        console.error('Error parsing JSON response:', parseError);
        throw new Error('Ph·∫£n h·ªìi t·ª´ server kh√¥ng h·ª£p l·ªá. Vui l√≤ng th·ª≠ l·∫°i.');
      }
      
      if (!data.success) {
        throw new Error(data.error || 'Kh√¥ng th·ªÉ t·∫£i logs');
      }
      
      logsTotal = data.total || 0;
      logsLimit = data.limit || 100;
      logsOffset = data.offset || 0;
      
      const logs = data.logs || [];
      
      if (logs.length === 0) {
        listEl.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: var(--space-8);">Ch∆∞a c√≥ log n√†o</td></tr>';
        paginationInfo.textContent = 'Kh√¥ng c√≥ log n√†o';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
      }
      
      // Render logs
      listEl.innerHTML = logs.map(log => {
        const createdAt = log.created_at ? formatDateTime(log.created_at) : '-';
        const username = log.username || log.full_name || 'Kh√°ch';
        const action = log.action || '-';
        const targetType = log.target_type || '-';
        const targetId = log.target_id || '-';
        const ipAddress = log.ip_address || '-';
        const userAgent = log.user_agent || '-';
        
        const actionClass = `log-action-${action}`;
        const actionBadge = `<span class="log-action-badge ${actionClass}">${escapeHtml(action)}</span>`;
        
        // Format before/after data
        const diffHtml = formatLogDiff(log.before_data, log.after_data);
        
        return `
          <tr class="log-row">
            <td>${createdAt}</td>
            <td>${escapeHtml(username)}</td>
            <td>${actionBadge}</td>
            <td>${escapeHtml(targetType)}</td>
            <td>${escapeHtml(String(targetId))}</td>
            <td class="log-diff">${diffHtml}</td>
            <td>${escapeHtml(ipAddress)}</td>
            <td class="hide-mobile" style="font-size: var(--font-size-xs, 12px); max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(userAgent)}</td>
          </tr>
        `;
      }).join('');
      
      // Update pagination info
      const start = offset + 1;
      const end = Math.min(offset + limit, logsTotal);
      paginationInfo.textContent = `Hi·ªÉn th·ªã ${start}-${end} trong t·ªïng ${logsTotal} logs`;
      
      // Update pagination buttons
      prevBtn.disabled = offset === 0;
      nextBtn.disabled = offset + limit >= logsTotal;
      
    } catch (err) {
      listEl.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: var(--space-8); color: #ef4444;">L·ªói: ${err.message}</td></tr>`;
      paginationInfo.textContent = 'L·ªói khi t·∫£i logs';
      prevBtn.disabled = true;
      nextBtn.disabled = true;
    }
  }

  function formatDateTime(dateStr) {
    try {
      const date = new Date(dateStr);
      // Convert sang Vietnam timezone (UTC+7)
      // Format: HH:MM:SS DD/MM/YYYY
      const formatter = new Intl.DateTimeFormat('en-US', {
        timeZone: 'Asia/Ho_Chi_Minh',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
      
      const parts = formatter.formatToParts(date);
      const hours = parts.find(p => p.type === 'hour').value;
      const minutes = parts.find(p => p.type === 'minute').value;
      const seconds = parts.find(p => p.type === 'second').value;
      const day = parts.find(p => p.type === 'day').value;
      const month = parts.find(p => p.type === 'month').value;
      const year = parts.find(p => p.type === 'year').value;
      
      return `${hours}:${minutes}:${seconds} ${day}/${month}/${year}`;
    } catch (e) {
      return dateStr;
    }
  }

  function formatLogDiff(beforeData, afterData) {
    if (!beforeData && !afterData) {
      return '<span style="color: var(--color-text-muted, #6b7280);">Kh√¥ng c√≥ thay ƒë·ªïi</span>';
    }
    
    if (!beforeData && afterData) {
      return `<details>
        <summary>T·∫°o m·ªõi</summary>
        <pre>${escapeHtml(JSON.stringify(afterData, null, 2))}</pre>
      </details>`;
    }
    
    if (beforeData && !afterData) {
      return `<details>
        <summary>X√≥a</summary>
        <pre>${escapeHtml(JSON.stringify(beforeData, null, 2))}</pre>
      </details>`;
    }
    
    // Both exist - show diff
    const beforeStr = JSON.stringify(beforeData, null, 2);
    const afterStr = JSON.stringify(afterData, null, 2);
    
    if (beforeStr === afterStr) {
      return '<span style="color: var(--color-text-muted, #6b7280);">Kh√¥ng c√≥ thay ƒë·ªïi</span>';
    }
    
    return `<details>
      <summary>Xem thay ƒë·ªïi</summary>
      <div>
        <div style="margin-bottom: var(--space-2);">
          <strong style="color: #ef4444;">Tr∆∞·ªõc:</strong>
          <pre class="diff-removed">${escapeHtml(beforeStr)}</pre>
        </div>
        <div>
          <strong style="color: #10b981;">Sau:</strong>
          <pre class="diff-added">${escapeHtml(afterStr)}</pre>
        </div>
      </div>
    </details>`;
  }

  function escapeHtml(text) {
    if (!text) return '-';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function applyFilters() {
    const action = document.getElementById('filterAction').value.trim();
    const targetType = document.getElementById('filterTargetType').value.trim();
    const userId = document.getElementById('filterUserId').value.trim();
    
    logsFilters = {};
    if (action) logsFilters.action = action;
    if (targetType) logsFilters.target_type = targetType;
    if (userId) logsFilters.user_id = parseInt(userId);
    
    logsOffset = 0;
    loadActivityLogs(logsLimit, logsOffset, logsFilters);
  }

  function clearFilters() {
    document.getElementById('filterAction').value = '';
    document.getElementById('filterTargetType').value = '';
    document.getElementById('filterUserId').value = '';
    logsFilters = {};
    logsOffset = 0;
    loadActivityLogs(logsLimit, logsOffset, logsFilters);
  }

  function changeLogsPerPage() {
    const perPage = parseInt(document.getElementById('logsPerPage').value);
    logsLimit = perPage;
    logsOffset = 0;
    loadActivityLogs(logsLimit, logsOffset, logsFilters);
  }

  function previousPage() {
    if (logsOffset > 0) {
      logsOffset = Math.max(0, logsOffset - logsLimit);
      loadActivityLogs(logsLimit, logsOffset, logsFilters);
    }
  }

  function nextPage() {
    if (logsOffset + logsLimit < logsTotal) {
      logsOffset += logsLimit;
      loadActivityLogs(logsLimit, logsOffset, logsFilters);
    }
  }

  // Initialize activity logs on page load
  document.addEventListener('DOMContentLoaded', () => {
    loadActivityLogs();
  });
</script>
{% endblock %}
