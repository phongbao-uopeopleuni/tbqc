<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Danh S√°ch Th√†nh Vi√™n - TBQC Gia Ph·∫£</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Serif TC', 'Playfair Display', serif;
      background: linear-gradient(135deg, #8B4513 0%, #A0522D 25%, #CD853F 50%, #DAA520 75%, #FFD700 100%);
      background-attachment: fixed;
      padding-top: 70px;
      min-height: 100vh;
    }

    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #111827;
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .navbar-logo {
      font-size: 24px;
      font-weight: 700;
      color: #FFD700;
      text-decoration: none;
    }

    .navbar-menu {
      display: flex;
      gap: 30px;
      list-style: none;
    }

    .navbar-menu a {
      color: white;
      text-decoration: none;
      font-size: 16px;
      font-weight: 500;
      transition: color 0.3s;
      padding: 5px 10px;
      border-radius: 4px;
    }

    .navbar-menu a:hover,
    .navbar-menu a.active {
      color: #FFD700;
      background: rgba(255, 215, 0, 0.1);
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 40px 20px;
      width: 100%;
    }

    .page-header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      text-align: center;
    }

    .page-header h1 {
      color: #8B0000;
      font-size: 36px;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }

    .page-header p {
      color: #666;
      font-size: 16px;
    }

    .controls {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-box {
      flex: 1;
      min-width: 300px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 18px;
      border: 2px solid #DAA520;
      border-radius: 8px;
      font-size: 16px;
      font-family: 'Noto Serif TC', serif;
    }

    .search-box input:focus {
      outline: none;
      border-color: #8B0000;
      box-shadow: 0 0 10px rgba(218, 165, 32, 0.5);
    }

    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Noto Serif TC', serif;
    }

    .btn-search {
      background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
      color: #FFD700;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .btn-search:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }

    .btn-refresh {
      background: #2196F3;
      color: white;
    }

    .btn-refresh:hover {
      background: #1976D2;
      transform: translateY(-2px);
    }

    .btn-add {
      background: #4CAF50;
      color: white;
    }

    .btn-add:hover:not(:disabled) {
      background: #45a049;
      transform: translateY(-2px);
    }

    .btn-update {
      background: #FF9800;
      color: white;
    }

    .btn-update:hover {
      background: #F57C00;
      transform: translateY(-2px);
    }

    .btn-delete {
      background: #f44336;
      color: white;
    }

    .btn-delete:hover {
      background: #d32f2f;
      transform: translateY(-2px);
    }

    .btn-backup {
      background: #9C27B0;
      color: white;
    }

    .btn-backup:hover:not(:disabled) {
      background: #7B1FA2;
      transform: translateY(-2px);
    }

    .btn-backup:disabled {
      background: #9E9E9E;
      cursor: not-allowed;
      opacity: 0.6;
    }


    /* Password modal */
    .password-modal {
      display: none;
      position: fixed;
      z-index: 3000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .password-modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 30px;
      border: 1px solid #888;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      text-align: center;
    }

    .password-modal-content h3 {
      color: #8B0000;
      margin-bottom: 20px;
      font-size: 24px;
    }

    .password-modal-content input {
      width: 100%;
      padding: 12px;
      border: 2px solid #DAA520;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 15px;
      font-family: 'Noto Serif TC', serif;
    }

    .password-modal-content input:focus {
      outline: none;
      border-color: #8B0000;
      box-shadow: 0 0 10px rgba(218, 165, 32, 0.5);
    }

    .password-error {
      color: #c62828;
      font-size: 14px;
      margin-bottom: 15px;
      display: none;
    }

    .password-modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }


    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      width: 100%;
    }

    .table-wrapper {
      overflow-x: auto;
      max-height: 80vh;
      overflow-y: auto;
      width: 100%;
    }

    table {
      width: 100%;
      min-width: 2000px;
      border-collapse: collapse;
      font-size: 14px;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
      color: #FFD700;
      padding: 15px 12px;
      text-align: left;
      font-weight: 700;
      border-bottom: 3px solid #DAA520;
      white-space: nowrap;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
      color: #333;
    }

    tbody tr {
      transition: background 0.2s;
    }

    tbody tr:hover {
      background: #FFF8DC;
    }

    /* Zebra striping - ƒë√°nh m√†u xen k·∫Ω */
    tbody tr:nth-child(odd) {
      background: #ffffff;
    }

    tbody tr:nth-child(even) {
      background: #f5f5f5;
    }

    tbody tr:nth-child(odd):hover {
      background: #FFF8DC;
    }

    tbody tr:nth-child(even):hover {
      background: #FFF8DC;
    }

    .loading {
      text-align: center;
      padding: 60px;
      color: #666;
      font-size: 18px;
    }

    .error {
      text-align: center;
      padding: 60px;
      color: #c62828;
      font-size: 18px;
      background: #ffebee;
      border-radius: 12px;
    }

    .stats {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
      text-align: center;
      color: #666;
      font-size: 16px;
    }

    .stats strong {
      color: #8B0000;
      font-size: 20px;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 30px;
      border: 1px solid #888;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover,
    .close:focus {
      color: #000;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #DAA520;
      border-radius: 8px;
      font-size: 14px;
      font-family: 'Noto Serif TC', serif;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #8B0000;
      box-shadow: 0 0 10px rgba(218, 165, 32, 0.5);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .modal-footer {
      margin-top: 30px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .btn-modal {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Noto Serif TC', serif;
    }

    .btn-modal-save {
      background: #4CAF50;
      color: white;
    }

    .btn-modal-save:hover {
      background: #45a049;
    }

    .btn-modal-cancel {
      background: #757575;
      color: white;
    }

    .btn-modal-cancel:hover {
      background: #616161;
    }

    .checkbox-column {
      width: 50px;
      text-align: center;
    }

    /* ƒê·∫£m b·∫£o b·∫£ng c√≥ th·ªÉ scroll ngang tr√™n m√†n h√¨nh nh·ªè */
    @media (max-width: 1920px) {
      .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
    }

    @media (max-width: 768px) {
      .navbar-menu {
        position: fixed;
        top: 70px;
        left: -100%;
        width: 100%;
        background: #111827;
        flex-direction: column;
        padding: 20px;
        transition: left 0.3s;
      }

      .navbar-menu.active {
        left: 0;
      }

      .controls {
        flex-direction: column;
      }

      .search-box {
        width: 100%;
      }

      .btn {
        width: 100%;
      }

      table {
        font-size: 12px;
        min-width: 1500px;
      }

      th, td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <a href="/" class="navbar-logo">Ph√≤ng Tuy Bi√™n Qu·∫≠n C√¥ng ‚Äì Gia Ph·∫£ Nguy·ªÖn Ph∆∞·ªõc T·ªôc</a>
    <button class="navbar-toggle" onclick="toggleMenu()" style="display: none; background: none; border: none; color: white; font-size: 24px; cursor: pointer;">‚ò∞</button>
    <ul class="navbar-menu" id="navbarMenu">
      <li><a href="/">Trang ch·ªß</a></li>
      <li><a href="/genealogy">Gia ph·∫£</a></li>
      <li><a href="/activities">Ho·∫°t ƒë·ªông</a></li>
      <li><a href="/members" class="active">Th√†nh vi√™n</a></li>
      <li><a href="/contact">Li√™n h·ªá</a></li>
      <li><a href="/admin/activities">ƒêƒÉng nh·∫≠p b√†i ƒëƒÉng</a></li>
    </ul>
  </nav>

  <div class="container">
    <div class="page-header">
      <h1>üìã Danh S√°ch Th√†nh Vi√™n</h1>
      <p>Danh s√°ch ƒë·∫ßy ƒë·ªß c√°c th√†nh vi√™n trong d√≤ng h·ªç Nguy·ªÖn Ph∆∞·ªõc T·ªôc - Tuy Bi√™n Ph√≤ng</p>
    </div>

    <div class="controls">
      <div class="search-box">
        <input type="text" id="membersSearch" placeholder="üîç T√¨m ki·∫øm theo ID, t√™n, gi·ªõi t√≠nh, tr·∫°ng th√°i, ƒë·ªùi, FM_ID, b·ªë, m·∫π, h√¥n ph·ªëi, anh ch·ªã em, con c√°i..." 
               onkeypress="if(event.key==='Enter') filterMembers()">
      </div>
      <button class="btn btn-search" onclick="filterMembers()">T√¨m ki·∫øm</button>
      <button class="btn btn-refresh" onclick="loadMembers()">üîÑ L√†m m·ªõi</button>
      <button class="btn btn-backup" onclick="checkAuthAndBackup()" id="btnBackup" title="T·∫°o backup database">üíæ Backup</button>
      <button class="btn btn-add" onclick="checkAuthAndOpenAdd()" id="btnAddMember">‚ûï Th√™m</button>
      <button class="btn btn-update" onclick="checkAuthAndOpenUpdate()" id="btnUpdateMember">‚úèÔ∏è C·∫≠p nh·∫≠t</button>
      <button class="btn btn-delete" onclick="checkAuthAndDelete()" id="btnDeleteMember">üóëÔ∏è X√≥a</button>
    </div>

    <div class="table-container">
      <div class="table-wrapper">
        <div id="membersTableContainer">
          <div class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        </div>
      </div>
    </div>

    <div class="stats" id="statsContainer">
      <span>T·ªïng s·ªë: <strong id="totalCount">0</strong> th√†nh vi√™n</span>
      <span style="margin-left: 20px;">ƒê√£ ch·ªçn: <strong id="selectedCount">0</strong> th√†nh vi√™n</span>
    </div>
  </div>

  <!-- Password Modal -->
  <div id="passwordModal" class="password-modal">
    <div class="password-modal-content">
      <h3>üîê X√°c th·ª±c m·∫≠t kh·∫©u</h3>
      <p style="color: #666; margin-bottom: 20px;">Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ th·ª±c hi·ªán c√°c thao t√°c ch·ªânh s·ª≠a</p>
      <input type="password" id="passwordInput" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" autocomplete="off" onkeypress="if(event.key==='Enter') verifyPassword()">
      <div class="password-error" id="passwordError">M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng. Vui l√≤ng th·ª≠ l·∫°i.</div>
      <div class="password-modal-buttons">
        <button class="btn-modal btn-modal-cancel" onclick="closePasswordModal()">H·ªßy</button>
        <button class="btn-modal btn-modal-save" onclick="verifyPassword()">X√°c nh·∫≠n</button>
      </div>
    </div>
  </div>

  <!-- Modal Th√™m/C·∫≠p nh·∫≠t th√†nh vi√™n -->
  <div id="memberModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 id="modalTitle">Th√™m th√†nh vi√™n m·ªõi</h2>
      <form id="memberForm" onsubmit="saveMember(event)">
        <div class="form-row">
          <div class="form-group">
            <label for="csv_id">ID (CSV_ID) *</label>
            <input type="text" id="csv_id" name="csv_id" required>
          </div>
          <div class="form-group">
            <label for="fm_id">Father_Mother_ID</label>
            <input type="text" id="fm_id" name="fm_id">
          </div>
        </div>
        <div class="form-group">
          <label for="full_name">H·ªç v√† t√™n *</label>
          <input type="text" id="full_name" name="full_name" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="gender">Gi·ªõi t√≠nh *</label>
            <select id="gender" name="gender" required>
              <option value="">-- Ch·ªçn --</option>
              <option value="Nam">Nam</option>
              <option value="N·ªØ">N·ªØ</option>
              <option value="Kh√°c">Kh√°c</option>
            </select>
          </div>
          <div class="form-group">
            <label for="status">Tr·∫°ng th√°i *</label>
            <select id="status" name="status" required>
              <option value="">-- Ch·ªçn --</option>
              <option value="C√≤n s·ªëng">C√≤n s·ªëng</option>
              <option value="ƒê√£ m·∫•t">ƒê√£ m·∫•t</option>
              <option value="Kh√¥ng r√µ">Kh√¥ng r√µ</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="generation_number">ƒê·ªùi</label>
            <input type="number" id="generation_number" name="generation_number" min="1">
          </div>
          <div class="form-group">
            <label for="birth_date_solar">NƒÉm sinh</label>
            <input type="text" id="birth_date_solar" name="birth_date_solar" placeholder="YYYY-MM-DD ho·∫∑c YYYY" pattern="^\d{4}(-\d{2}(-\d{2})?)?$">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="death_date_solar">NƒÉm m·∫•t</label>
            <input type="text" id="death_date_solar" name="death_date_solar" placeholder="YYYY-MM-DD ho·∫∑c YYYY" pattern="^\d{4}(-\d{2}(-\d{2})?)?$">
          </div>
          <div class="form-group">
            <label for="place_of_death">N∆°i m·∫•t</label>
            <input type="text" id="place_of_death" name="place_of_death" placeholder="Nh·∫≠p n∆°i m·∫•t">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="father_name">T√™n b·ªë</label>
            <input type="text" id="father_name" name="father_name">
          </div>
          <div class="form-group">
            <label for="mother_name">T√™n m·∫π</label>
            <input type="text" id="mother_name" name="mother_name">
          </div>
        </div>
        <div class="form-group">
          <label for="mother_name">T√™n m·∫π</label>
          <input type="text" id="mother_name" name="mother_name">
        </div>
        <div class="form-group">
          <label for="children_info">Th√¥ng tin con</label>
          <textarea id="children_info" name="children_info" rows="3" placeholder="Nh·∫≠p t√™n c√°c con, ph√¢n c√°ch b·∫±ng d·∫•u ch·∫•m ph·∫©y (;)"></textarea>
        </div>
        <div class="form-group">
          <label for="spouse_info">H√¥n ph·ªëi</label>
          <textarea id="spouse_info" name="spouse_info" rows="3" placeholder="Nh·∫≠p t√™n h√¥n ph·ªëi, ph√¢n c√°ch b·∫±ng d·∫•u ch·∫•m ph·∫©y (;)"></textarea>
        </div>
        <div class="form-group">
          <label for="siblings_info">Th√¥ng tin anh ch·ªã em</label>
          <textarea id="siblings_info" name="siblings_info" rows="3" placeholder="Nh·∫≠p t√™n anh ch·ªã em, ph√¢n c√°ch b·∫±ng d·∫•u ch·∫•m ph·∫©y (;)"></textarea>
        </div>
        <input type="hidden" id="person_id" name="person_id">
        <div class="modal-footer">
          <button type="button" class="btn-modal btn-modal-cancel" onclick="closeModal()">H·ªßy</button>
          <button type="submit" class="btn-modal btn-modal-save">L∆∞u</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Password protection - L·∫•y t·ª´ server ƒë·ªÉ tr√°nh hardcode
    const REQUIRED_PASSWORD = {{ members_password|tojson|safe if members_password else 'null' }};
    let isAuthenticated = false;
    let authenticatedPassword = ''; // L∆∞u password ƒë√£ x√°c th·ª±c ƒë·ªÉ g·ª≠i trong API requests
    let pendingAction = null; // L∆∞u h√†nh ƒë·ªông ƒëang ch·ªù x√°c th·ª±c

    // Check authentication state on page load
    function checkAuthState() {
      const authState = sessionStorage.getItem('membersAuth');
      const savedPassword = sessionStorage.getItem('membersPassword');
      if (authState === 'true' && savedPassword) {
        isAuthenticated = true;
        authenticatedPassword = savedPassword;
      }
    }
    
    // Get authenticated password for API requests
    function getAuthPassword() {
      if (isAuthenticated && authenticatedPassword) {
        return authenticatedPassword;
      }
      // Fallback: th·ª≠ l·∫•y t·ª´ sessionStorage
      const savedPassword = sessionStorage.getItem('membersPassword');
      if (savedPassword) {
        authenticatedPassword = savedPassword;
        return savedPassword;
      }
      return null;
    }

    // Show password modal
    function showPasswordModal(actionCallback) {
      pendingAction = actionCallback; // L∆∞u h√†m callback ƒë·ªÉ g·ªçi sau khi x√°c th·ª±c th√†nh c√¥ng
      document.getElementById('passwordModal').style.display = 'block';
      document.getElementById('passwordInput').value = '';
      document.getElementById('passwordError').style.display = 'none';
      document.getElementById('passwordInput').focus();
    }

    // Close password modal
    function closePasswordModal() {
      document.getElementById('passwordModal').style.display = 'none';
      document.getElementById('passwordInput').value = '';
      document.getElementById('passwordError').style.display = 'none';
      pendingAction = null;
    }

    // Verify password
    function verifyPassword() {
      const password = document.getElementById('passwordInput').value.trim();
      const errorDiv = document.getElementById('passwordError');
      
      // Fallback password n·∫øu server kh√¥ng tr·∫£ v·ªÅ
      const fallbackPassword = 'tbqc@2026';
      const serverPassword = REQUIRED_PASSWORD && REQUIRED_PASSWORD !== 'null' && REQUIRED_PASSWORD !== '' ? REQUIRED_PASSWORD : fallbackPassword;
      
      // Debug log
      console.log('Password verification:', {
        input: password ? '***' : '(empty)',
        serverPassword: serverPassword ? '***' : '(empty)',
        requiredPassword: REQUIRED_PASSWORD,
        usingFallback: REQUIRED_PASSWORD === 'null' || REQUIRED_PASSWORD === '' || !REQUIRED_PASSWORD
      });
      
      if (password === serverPassword) {
        // X√°c th·ª±c th√†nh c√¥ng
        isAuthenticated = true;
        authenticatedPassword = password; // L∆∞u password ƒë·ªÉ g·ª≠i trong API requests
        sessionStorage.setItem('membersAuth', 'true');
        sessionStorage.setItem('membersPassword', password); // L∆∞u t·∫°m th·ªùi (s·∫Ω x√≥a khi logout)
        closePasswordModal();
        
        // Th·ª±c hi·ªán h√†nh ƒë·ªông ƒë√£ l∆∞u
        if (pendingAction && typeof pendingAction === 'function') {
          pendingAction();
        }
        pendingAction = null;
      } else {
        // M·∫≠t kh·∫©u sai
        errorDiv.style.display = 'block';
        document.getElementById('passwordInput').value = '';
        document.getElementById('passwordInput').focus();
      }
    }

    // Check auth before opening add modal
    function checkAuthAndOpenAdd() {
      if (isAuthenticated) {
        openAddModal();
      } else {
        showPasswordModal(openAddModal);
      }
    }

    // Check auth before opening update modal
    function checkAuthAndOpenUpdate() {
      // Ki·ªÉm tra ƒë√£ ch·ªçn th√†nh vi√™n ch∆∞a
      const checkboxes = document.querySelectorAll('.row-checkbox:checked');
      if (checkboxes.length !== 1) {
        alert('Vui l√≤ng ch·ªçn ƒë√∫ng 1 th√†nh vi√™n ƒë·ªÉ c·∫≠p nh·∫≠t');
        return;
      }
      
      // Ki·ªÉm tra x√°c th·ª±c
      if (isAuthenticated) {
        openUpdateModal();
      } else {
        showPasswordModal(openUpdateModal);
      }
    }

    // Check auth before deleting
    function checkAuthAndDelete() {
      // Ki·ªÉm tra ƒë√£ ch·ªçn th√†nh vi√™n ch∆∞a
      const checkboxes = document.querySelectorAll('.row-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 th√†nh vi√™n ƒë·ªÉ x√≥a');
        return;
      }
      
      // Ki·ªÉm tra x√°c th·ª±c
      if (isAuthenticated) {
        deleteSelected();
      } else {
        showPasswordModal(deleteSelected);
      }
    }

    // Check auth before backup
    function checkAuthAndBackup() {
      if (isAuthenticated) {
        createBackup();
      } else {
        showPasswordModal(createBackup);
      }
    }

    // Create backup
    async function createBackup() {
      const backupBtn = document.getElementById('btnBackup');
      const originalText = backupBtn.textContent;
      
      try {
        // Disable button v√† hi·ªÉn th·ªã loading
        backupBtn.disabled = true;
        backupBtn.textContent = '‚è≥ ƒêang backup...';
        
        // L·∫•y password ƒë√£ x√°c th·ª±c
        const authPassword = getAuthPassword();
        if (!authPassword) {
          alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng nh·∫≠p l·∫°i m·∫≠t kh·∫©u.');
          showPasswordModal(createBackup);
          return;
        }
        
        const response = await fetch('/api/admin/backup', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ password: authPassword })
        });

        const result = await response.json();
        
        if (result.success) {
          const fileSize = result.file_size ? (result.file_size / 1024 / 1024).toFixed(2) : 'N/A';
          alert(`‚úÖ Backup th√†nh c√¥ng!\n\nFile: ${result.backup_file}\nK√≠ch th∆∞·ªõc: ${fileSize} MB`);
        } else {
          // X·ª≠ l√Ω l·ªói 403 (unauthorized)
          if (response.status === 403) {
            alert('M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng ho·∫∑c phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng nh·∫≠p l·∫°i m·∫≠t kh·∫©u.');
            isAuthenticated = false;
            authenticatedPassword = '';
            sessionStorage.removeItem('membersAuth');
            sessionStorage.removeItem('membersPassword');
            showPasswordModal(createBackup);
            return;
          }
          alert(`‚ùå Backup th·∫•t b·∫°i: ${result.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}`);
        }
      } catch (error) {
        console.error('[Members] Error creating backup:', error);
        alert('L·ªói k·∫øt n·ªëi: ' + error.message);
      } finally {
        // Restore button
        backupBtn.disabled = false;
        backupBtn.textContent = originalText;
      }
    }

    let allMembersData = [];
    let filteredData = [];

    // Load members data
    async function loadMembers() {
      const container = document.getElementById('membersTableContainer');
      container.innerHTML = '<div class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>';
      
      try {
        console.log('[Members] Fetching /api/members...');
        const response = await fetch('/api/members');
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('[Members] API response:', result);
        console.log('[Members] Response keys:', Object.keys(result));
        console.log('[Members] result.success:', result.success);
        console.log('[Members] result.data type:', typeof result.data);
        console.log('[Members] result.data length:', result.data ? result.data.length : 'null');
        
        if (result.success && result.data && Array.isArray(result.data)) {
          allMembersData = result.data;
          filteredData = allMembersData;
          console.log(`[Members] Loaded ${allMembersData.length} members`);
          console.log('[Members] First member:', allMembersData[0]);
          renderMembersTable(filteredData);
          updateStats(filteredData.length);
        } else {
          console.error('[Members] API returned error or invalid data:', result);
          const errorMsg = result.error || 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu';
          const dataInfo = result.data ? `Data type: ${typeof result.data}, isArray: ${Array.isArray(result.data)}` : 'No data field';
          container.innerHTML = `<div class="error">‚ùå L·ªói: ${errorMsg}<br><small>${dataInfo}</small></div>`;
        }
      } catch (error) {
        console.error('[Members] Error loading members:', error);
        container.innerHTML = `<div class="error">‚ùå L·ªói k·∫øt n·ªëi: ${error.message}<br><small>Vui l√≤ng ki·ªÉm tra console ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt</small></div>`;
      }
    }

    // Render members table
    function renderMembersTable(members) {
      const container = document.getElementById('membersTableContainer');
      
      if (!members || members.length === 0) {
        container.innerHTML = '<div class="loading" style="padding: 60px; text-align: center; color: #666; font-size: 18px;">Kh√¥ng c√≥ d·ªØ li·ªáu th√†nh vi√™n</div>';
        updateStats(0);
        return;
      }
      
      console.log(`[Members] Rendering ${members.length} members`);
      
      let html = '<table>';
      html += '<thead><tr>';
      html += '<th class="checkbox-column"><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"></th>';
      html += '<th style="text-align: center; width: 100px;">ID</th>';
      html += '<th style="min-width: 200px;">H·ªç v√† t√™n</th>';
      html += '<th style="min-width: 120px; text-align: center;">Gi·ªõi t√≠nh</th>';
      html += '<th style="min-width: 140px; text-align: center;">Tr·∫°ng th√°i</th>';
      html += '<th style="min-width: 100px; text-align: center;">ƒê·ªùi</th>';
      html += '<th style="min-width: 100px; text-align: center;">NƒÉm sinh</th>';
      html += '<th style="min-width: 100px; text-align: center;">NƒÉm m·∫•t</th>';
      html += '<th style="min-width: 150px; text-align: center;">Father_Mother_ID</th>';
      html += '<th style="min-width: 200px;">T√™n b·ªë</th>';
      html += '<th style="min-width: 200px;">T√™n m·∫π</th>';
      html += '<th style="min-width: 300px;">Th√¥ng tin h√¥n ph·ªëi</th>';
      html += '<th style="min-width: 300px;">Th√¥ng tin anh ch·ªã em</th>';
      html += '<th style="min-width: 300px;">Th√¥ng tin con c√°i</th>';
      html += '</tr></thead><tbody>';
      
      members.forEach((member, index) => {
        html += '<tr>';
        html += `<td class="checkbox-column"><input type="checkbox" class="row-checkbox" value="${member.person_id}" onchange="updateButtonStates()"></td>`;
        html += `<td style="text-align: center; font-weight: 600; color: #8B0000;">${escapeHtml(member.csv_id || member.person_id || '-')}</td>`;
        html += `<td style="font-weight: 600; color: #8B0000;">${escapeHtml(member.full_name || '-')}</td>`;
        html += `<td style="text-align: center;">${escapeHtml(member.gender || '-')}</td>`;
        html += `<td style="text-align: center;">${escapeHtml(member.status || '-')}</td>`;
        html += `<td style="text-align: center; font-weight: 600;">${member.generation_number || '-'}</td>`;
        html += `<td style="text-align: center;">${getYearFromDate(member.birth_date_solar) || '-'}</td>`;
        html += `<td style="text-align: center;">${getYearFromDate(member.death_date_solar) || '-'}</td>`;
        html += `<td style="text-align: center; font-family: monospace; color: #666;">${escapeHtml(member.fm_id || '-')}</td>`;
        html += `<td>${escapeHtml(member.father_name || '-')}</td>`;
        html += `<td>${escapeHtml(member.mother_name || '-')}</td>`;
        html += `<td style="max-width: 300px; word-wrap: break-word; line-height: 1.5;">${escapeHtml(formatText(member.spouses || ''))}</td>`;
        html += `<td style="max-width: 300px; word-wrap: break-word; line-height: 1.5;">${escapeHtml(formatText(member.siblings || ''))}</td>`;
        html += `<td style="max-width: 300px; word-wrap: break-word; line-height: 1.5;">${escapeHtml(formatText(member.children || ''))}</td>`;
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // Format date
    function formatDate(dateStr) {
      if (!dateStr || dateStr === 'None' || dateStr === 'null') return '-';
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) {
          // N·∫øu kh√¥ng parse ƒë∆∞·ª£c, tr·∫£ v·ªÅ nƒÉm
          return dateStr.split('-')[0] || dateStr;
        }
        return date.toLocaleDateString('vi-VN');
      } catch {
        return dateStr.split(' ')[0] || dateStr;
      }
    }

    // Get year from date string
    function getYearFromDate(dateStr) {
      if (!dateStr || dateStr === 'None' || dateStr === 'null' || dateStr === '') return null;
      try {
        // N·∫øu l√† string c√≥ format YYYY-MM-DD ho·∫∑c YYYY-MM-DD HH:MM:SS
        if (typeof dateStr === 'string') {
          const year = dateStr.split('-')[0];
          if (year && year.length === 4 && /^\d{4}$/.test(year)) {
            return year;
          }
        }
        // N·∫øu l√† Date object
        const date = new Date(dateStr);
        if (!isNaN(date.getTime())) {
          return date.getFullYear().toString();
        }
        return null;
      } catch {
        return null;
      }
    }

    // Format text (thay ; th√†nh xu·ªëng d√≤ng)
    function formatText(text) {
      if (!text || text === 'None' || text === 'null' || text === '') return '-';
      // T√°ch theo ; ho·∫∑c ,
      const items = text.split(/[;,]/).map(s => s.trim()).filter(s => s);
      if (items.length === 0) return '-';
      // N·∫øu c√≥ nhi·ªÅu item, join b·∫±ng <br> ƒë·ªÉ hi·ªÉn th·ªã xu·ªëng d√≤ng
      if (items.length > 1) {
        return items.join('<br>');
      }
      return items[0];
    }

    // Escape HTML (nh∆∞ng gi·ªØ <br> cho formatText)
    function escapeHtml(text) {
      if (!text) return '-';
      // N·∫øu text ƒë√£ c√≥ <br> (t·ª´ formatText), kh√¥ng escape n·ªØa
      if (typeof text === 'string' && text.includes('<br>')) {
        return text;
      }
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Filter members
    function filterMembers() {
      const searchTerm = document.getElementById('membersSearch').value.toLowerCase().trim();
      
      if (!searchTerm) {
        filteredData = allMembersData;
      } else {
        filteredData = allMembersData.filter(member => {
          const csvId = (member.csv_id || '').toLowerCase();
          const fullName = (member.full_name || '').toLowerCase();
          const gender = (member.gender || '').toLowerCase();
          const status = (member.status || '').toLowerCase();
          const generation = String(member.generation_number || '');
          const fmId = (member.fm_id || '').toLowerCase();
          const father = (member.father_name || '').toLowerCase();
          const mother = (member.mother_name || '').toLowerCase();
          const spouses = (member.spouses || '').toLowerCase();
          const siblings = (member.siblings || '').toLowerCase();
          const children = (member.children || '').toLowerCase();
          
          return csvId.includes(searchTerm) ||
                 fullName.includes(searchTerm) || 
                 gender.includes(searchTerm) ||
                 status.includes(searchTerm) ||
                 generation.includes(searchTerm) ||
                 fmId.includes(searchTerm) ||
                 father.includes(searchTerm) ||
                 mother.includes(searchTerm) ||
                 spouses.includes(searchTerm) ||
                 siblings.includes(searchTerm) ||
                 children.includes(searchTerm);
        });
      }
      
      renderMembersTable(filteredData);
      updateStats(filteredData.length);
    }

    // Update stats
    function updateStats(count) {
      document.getElementById('totalCount').textContent = count;
    }

    // Toggle mobile menu
    function toggleMenu() {
      const menu = document.getElementById('navbarMenu');
      menu.classList.toggle('active');
    }

    // Selected members
    let selectedMembers = new Set();

    // Toggle select all
    function toggleSelectAll(checkbox) {
      const checkboxes = document.querySelectorAll('.row-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        if (checkbox.checked) {
          selectedMembers.add(cb.value);
        } else {
          selectedMembers.delete(cb.value);
        }
      });
      updateButtonStates();
    }

    // Update button states based on selection
    function updateButtonStates() {
      const checkboxes = document.querySelectorAll('.row-checkbox:checked');
      const selectedCount = checkboxes.length;
      document.getElementById('selectedCount').textContent = selectedCount;

      // Update selectedMembers set
      selectedMembers.clear();
      checkboxes.forEach(cb => selectedMembers.add(cb.value));
      
      // Kh√¥ng disable n√∫t n·ªØa - lu√¥n cho ph√©p click ƒë·ªÉ y√™u c·∫ßu m·∫≠t kh·∫©u ho·∫∑c th√¥ng b√°o
    }

    // Open add modal
    function openAddModal() {
      document.getElementById('modalTitle').textContent = 'Th√™m th√†nh vi√™n m·ªõi';
      document.getElementById('memberForm').reset();
      document.getElementById('person_id').value = '';
      document.getElementById('memberModal').style.display = 'block';
    }

    // Open update modal
    function openUpdateModal() {
      const checkboxes = document.querySelectorAll('.row-checkbox:checked');
      if (checkboxes.length !== 1) {
        alert('Vui l√≤ng ch·ªçn ƒë√∫ng 1 th√†nh vi√™n ƒë·ªÉ c·∫≠p nh·∫≠t');
        return;
      }

      const personId = checkboxes[0].value;
      const member = allMembersData.find(m => m.person_id == personId);
      
      if (!member) {
        alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin th√†nh vi√™n');
        return;
      }

      document.getElementById('modalTitle').textContent = 'C·∫≠p nh·∫≠t th√†nh vi√™n';
      document.getElementById('person_id').value = member.person_id;
      document.getElementById('csv_id').value = member.csv_id || '';
      document.getElementById('fm_id').value = member.fm_id || '';
      document.getElementById('full_name').value = member.full_name || '';
      document.getElementById('gender').value = member.gender || '';
      document.getElementById('status').value = member.status || '';
      document.getElementById('generation_number').value = member.generation_number || '';
      document.getElementById('birth_date_solar').value = member.birth_date_solar || '';
      document.getElementById('death_date_solar').value = member.death_date_solar || '';
      document.getElementById('place_of_death').value = member.place_of_death || '';
      document.getElementById('father_name').value = member.father_name || '';
      document.getElementById('mother_name').value = member.mother_name || '';
      // Populate children, spouse, siblings info
      document.getElementById('children_info').value = member.children || '';
      document.getElementById('spouse_info').value = member.spouses || '';
      document.getElementById('siblings_info').value = member.siblings || '';
      document.getElementById('memberModal').style.display = 'block';
    }

    // Close modal
    function closeModal() {
      document.getElementById('memberModal').style.display = 'none';
      document.getElementById('memberForm').reset();
    }

    // Save member (add or update)
    async function saveMember(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const data = Object.fromEntries(formData);
      const personId = data.person_id;
      const isUpdate = personId && personId !== '';

      // L·∫•y password ƒë√£ x√°c th·ª±c
      const authPassword = getAuthPassword();
      if (!authPassword) {
        alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng nh·∫≠p l·∫°i m·∫≠t kh·∫©u.');
        showPasswordModal(() => saveMember(event));
        return;
      }
      
      // Th√™m password v√†o request
      data.password = authPassword;
      
      try {
        const url = isUpdate ? `/api/persons/${personId}` : '/api/persons';
        const method = isUpdate ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        
        if (response.ok && result.success) {
          alert(isUpdate ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'Th√™m th√†nh c√¥ng!');
          closeModal();
          loadMembers();
        } else {
          // X·ª≠ l√Ω l·ªói 403 (unauthorized) - y√™u c·∫ßu nh·∫≠p l·∫°i password
          if (response.status === 403) {
            alert('M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng ho·∫∑c phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng nh·∫≠p l·∫°i m·∫≠t kh·∫©u.');
            isAuthenticated = false;
            authenticatedPassword = '';
            sessionStorage.removeItem('membersAuth');
            sessionStorage.removeItem('membersPassword');
            showPasswordModal(() => saveMember(event));
            return;
          }
          
          // Hi·ªÉn th·ªã message t·ª´ server ho·∫∑c message m·∫∑c ƒë·ªãnh
          const errorMsg = result.error || result.message || 'Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu';
          if (response.status === 404) {
            alert(`Kh√¥ng t√¨m th·∫•y: ${errorMsg}`);
          } else if (response.status === 400) {
            alert(`D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá: ${errorMsg}`);
          } else {
            alert(`L·ªói: ${errorMsg}`);
          }
        }
      } catch (error) {
        console.error('[Members] Error saving member:', error);
        alert('L·ªói k·∫øt n·ªëi: ' + error.message);
      }
    }

    // Delete selected members
    async function deleteSelected() {
      const checkboxes = document.querySelectorAll('.row-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 th√†nh vi√™n ƒë·ªÉ x√≥a');
        return;
      }

      if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ${checkboxes.length} th√†nh vi√™n ƒë√£ ch·ªçn?`)) {
        return;
      }

      const personIds = Array.from(checkboxes).map(cb => cb.value);
      
      // L·∫•y password ƒë√£ x√°c th·ª±c
      const authPassword = getAuthPassword();
      if (!authPassword) {
        alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng nh·∫≠p l·∫°i m·∫≠t kh·∫©u.');
        showPasswordModal(deleteSelected);
        return;
      }
      
      try {
        const response = await fetch('/api/persons/batch', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            person_ids: personIds,
            password: authPassword
          })
        });

        const result = await response.json();
        
        if (result.success) {
          let message = `‚úÖ X√≥a th√†nh c√¥ng ${checkboxes.length} th√†nh vi√™n!`;
          
          // Hi·ªÉn th·ªã th√¥ng tin backup n·∫øu c√≥
          if (result.backup_created) {
            message += `\n\nüíæ Backup ƒë√£ ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông:\nFile: ${result.backup_file}`;
          } else if (result.backup_warning) {
            message += `\n\n‚ö†Ô∏è C·∫£nh b√°o: ${result.backup_warning}`;
          }
          
          alert(message);
          selectedMembers.clear();
          loadMembers();
        } else {
          // X·ª≠ l√Ω l·ªói 403 (unauthorized)
          if (response.status === 403) {
            alert('M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng ho·∫∑c phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng nh·∫≠p l·∫°i m·∫≠t kh·∫©u.');
            isAuthenticated = false;
            authenticatedPassword = '';
            sessionStorage.removeItem('membersAuth');
            sessionStorage.removeItem('membersPassword');
            showPasswordModal(deleteSelected);
            return;
          }
          alert('L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ x√≥a d·ªØ li·ªáu'));
        }
      } catch (error) {
        alert('L·ªói k·∫øt n·ªëi: ' + error.message);
      }
    }


    // Close password modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('memberModal');
      const passwordModal = document.getElementById('passwordModal');
      if (event.target == modal) {
        closeModal();
      }
      if (event.target == passwordModal) {
        closePasswordModal();
      }
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', () => {
      checkAuthState();
      loadMembers();
    });
  </script>
  
  <!-- Floating Chat Buttons -->
  <a href="https://zalo.me/g/ajmmkc064" target="_blank" class="floating-zalo-button" title="Tham gia nh√≥m Zalo Ph√≤ng Tuy Bi√™n Qu·∫≠n C√¥ng">Z</a>
  <a href="https://m.me/PhongTuyBienQuanCong" target="_blank" class="floating-chat-button" title="Nh·∫Øn tin cho Ph√≤ng Tuy Bi√™n Qu·∫≠n C√¥ng">üí¨</a>
</body>
</html>
