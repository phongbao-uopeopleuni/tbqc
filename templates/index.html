<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ph√≤ng Tuy Bi√™n Qu·∫≠n C√¥ng - Gia Ph·∫£ Nguy·ªÖn Ph∆∞·ªõc T·ªôc| H·ªá Th·ªëng Tra C·ª©u Gia Ph·∫£ Nguy·ªÖn Ph∆∞·ªõc T·ªôc</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Noto Serif TC', 'Playfair Display', serif;
      background: linear-gradient(135deg, #8B4513 0%, #A0522D 25%, #CD853F 50%, #DAA520 75%, #FFD700 100%);
      background-attachment: fixed;
      position: relative;
      padding-top: 70px; /* Space for fixed navbar */
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,215,0,0.03) 10px, rgba(255,215,0,0.03) 20px),
        repeating-linear-gradient(-45deg, transparent, transparent 10px, rgba(184,134,11,0.03) 10px, rgba(184,134,11,0.03) 20px);
      pointer-events: none;
      z-index: 0;
    }

    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      opacity: 0.06;
      background-image: 
        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400"><defs><linearGradient id="dragonGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23DAA520;stop-opacity:0.8" /><stop offset="100%" style="stop-color:%23FFD700;stop-opacity:0.6" /></linearGradient></defs><path d="M80,200 Q40,160 20,200 T80,240 Q120,220 140,200 T80,160" fill="none" stroke="url(%23dragonGrad)" stroke-width="3"/><path d="M60,180 Q20,140 10,180 T60,220 Q100,200 120,180 T60,140" fill="none" stroke="%23FFD700" stroke-width="2" opacity="0.7"/><circle cx="15" cy="180" r="4" fill="%23FFD700" opacity="0.8"/><path d="M50,200 L60,190 M50,200 L60,210" stroke="%23DAA520" stroke-width="2.5" fill="none"/><path d="M70,200 Q90,180 110,200" fill="none" stroke="%23DAA520" stroke-width="2" opacity="0.6"/><circle cx="100" cy="190" r="2" fill="%23FFD700"/></svg>'),
        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400"><defs><linearGradient id="phoenixGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23DC143C;stop-opacity:0.8" /><stop offset="100%" style="stop-color:%23FFD700;stop-opacity:0.6" /></linearGradient></defs><path d="M320,200 Q360,160 380,200 T320,240 Q280,220 260,200 T320,160" fill="none" stroke="url(%23phoenixGrad)" stroke-width="3"/><path d="M340,180 Q380,140 390,180 T340,220 Q300,200 280,180 T340,140" fill="none" stroke="%23FFD700" stroke-width="2" opacity="0.7"/><circle cx="385" cy="180" r="4" fill="%23FFD700" opacity="0.8"/><path d="M350,200 L340,190 M350,200 L340,210" stroke="%23DC143C" stroke-width="2.5" fill="none"/><path d="M330,200 Q310,180 290,200" fill="none" stroke="%23DC143C" stroke-width="2" opacity="0.6"/><circle cx="300" cy="190" r="2" fill="%23FFD700"/><path d="M310,200 Q315,195 320,200 Q315,205 310,200" fill="%23FFD700" opacity="0.5"/></svg>');
      background-size: 500px 500px, 500px 500px;
      background-position: -100px -50px, calc(100% + 100px) -50px;
      background-repeat: no-repeat;
      pointer-events: none;
      z-index: 0;
    }

    /* ============================================
       NAVBAR
       ============================================ */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #111827;
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .navbar-logo {
      font-size: 24px;
      font-weight: 700;
      color: #FFD700;
      text-decoration: none;
    }

    .navbar-menu {
      display: flex;
      gap: 30px;
      list-style: none;
    }

    .navbar-menu a {
      color: white;
      text-decoration: none;
      font-size: 16px;
      font-weight: 500;
      transition: color 0.3s;
      padding: 5px 10px;
      border-radius: 4px;
    }

    .navbar-menu a:hover,
    .navbar-menu a.active {
      color: #FFD700;
      background: rgba(255, 215, 0, 0.1);
    }

    .navbar-toggle {
      display: none;
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
    }

    /* ============================================
       SECTIONS
       ============================================ */
    section {
      min-height: 100vh;
      padding: 80px 30px;
      position: relative;
    }

    .section-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 60px 20px;
    }

    /* Override cho activities-tree section ƒë·ªÉ m·ªü r·ªông t·ªëi ƒëa */
    #activities-tree .section-container {
      max-width: 100%;
      padding: 40px 20px;
    }

    /* ============================================
       HOME SECTION (#home)
       ============================================ */
    #home {
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(139, 0, 0, 0.9) 0%, rgba(220, 20, 60, 0.9) 100%);
      color: white;
      text-align: center;
    }

    .hero-content {
      max-width: 800px;
    }

    .hero-content h1 {
      font-size: 48px;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      color: #FFD700;
    }

    .hero-content p {
      font-size: 20px;
      margin-bottom: 30px;
      line-height: 1.6;
    }

    .cta-button {
      display: inline-block;
      padding: 15px 40px;
      background: linear-gradient(135deg, #FFD700 0%, #DAA520 100%);
      color: #8B0000;
      text-decoration: none;
      border-radius: 50px;
      font-size: 18px;
      font-weight: 700;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .cta-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }

    /* ============================================
       ABOUT SECTION (#about)
       ============================================ */
    #about {
      background: linear-gradient(180deg, #FFF8DC 0%, #FFEBCD 100%);
    }

    .section-title {
      font-size: 36px;
      color: #8B0000;
      margin-bottom: 30px;
      text-align: center;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }

    .about-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      align-items: center;
    }

    .about-text {
      font-size: 18px;
      line-height: 1.8;
      color: #333;
    }

    .about-text p {
      margin-bottom: 20px;
    }

    .about-image {
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .about-image img {
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
      border: 4px solid #DAA520;
      background: white;
      padding: 10px;
      transition: transform 0.3s;
    }

    .about-image img:hover {
      transform: scale(1.05);
    }

    @media (max-width: 768px) {
      .about-content {
        grid-template-columns: 1fr;
      }
      
      .about-image {
        order: -1;
        margin-bottom: 30px;
      }
    }

    /* ============================================
       GENEALOGY TREE SECTION (#activities-tree)
       ============================================ */
    #activities-tree {
      background: linear-gradient(180deg, #FFF8DC 0%, #FFEBCD 100%);
    }

    #activities-tree .section-container {
      max-width: 100%;
      padding: 40px 20px;
    }

    /* ============================================
       ACTIVITIES SECTION (#activities)
       ============================================ */
    #activities {
      background: linear-gradient(180deg, #FFEBCD 0%, #FFF8DC 100%);
    }

    .activities-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
      margin-top: 0;
      padding-top: 20px;
    }

    .activity-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border-left: 5px solid #DAA520;
      transition: transform 0.3s;
    }

    .activity-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .activity-card h3 {
      color: #8B0000;
      margin-bottom: 10px;
      font-size: 20px;
    }

    .activity-date {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .activity-location {
      color: #888;
      font-size: 14px;
      margin-bottom: 15px;
    }

    .activity-description {
      color: #333;
      line-height: 1.6;
    }

    /* ============================================
       STATS SECTION (#stats)
       ============================================ */
    #stats {
      background: linear-gradient(180deg, #FFF8DC 0%, #FFEBCD 100%);
      padding: 40px 0 60px 0;
    }

    #stats .section-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .stats-subtitle {
      text-align: center;
      color: #555;
      margin-bottom: 30px;
      font-size: 16px;
    }

    .stats-layout {
      display: grid;
      grid-template-columns: 1.2fr 2fr;
      gap: 30px;
      align-items: stretch;
    }

    .stats-summary {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }

    .stats-card {
      background: white;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border-left: 5px solid #DAA520;
    }

    .stats-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 6px;
    }

    .stats-value {
      font-size: 22px;
      font-weight: 700;
      color: #8B0000;
    }

    .stats-charts {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .stats-chart-card {
      background: white;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .stats-chart-card h3 {
      margin-bottom: 10px;
      font-size: 16px;
      color: #8B0000;
      text-align: center;
    }

    @media (max-width: 900px) {
      .stats-layout {
        grid-template-columns: 1fr;
      }
      .stats-charts {
        grid-template-columns: 1fr;
      }
    }

    /* Family Tree trong Activities Section */
    .activities-tree-section {
      margin-top: 30px;
      margin-bottom: 40px;
      padding: 30px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 100%;
    }

    .tree-section-title {
      color: #8B0000;
      font-size: 24px;
      margin-bottom: 20px;
      text-align: center;
    }

    .activities-tree-container {
      min-height: 600px;
      height: auto;
      max-height: 85vh;
      position: relative;
      overflow: auto;
      background: #fafafa;
      border-radius: 8px;
      padding: 30px;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }

    .tree-loading {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 16px;
    }

    .activities-tree-container .tree {
      width: 100%;
      min-width: 100%;
      min-height: 600px;
    }

    .activities-tree-container .node {
      background: white;
      border: 2px solid #DAA520;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      min-width: 120px;
      max-width: 150px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: all 0.3s;
    }

    .activities-tree-container .node:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .activities-tree-container .node.founder {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      border-color: #8B0000;
      font-weight: 700;
      font-size: 13px;
    }

    .activities-tree-container .connector {
      stroke: #DAA520;
      stroke-width: 2;
      fill: none;
    }

    .activities-tree-container .horizontal-tree {
      width: 100%;
      min-width: 100%;
      min-height: 600px;
      max-width: 100%;
    }

    .activities-tree-container .horizontal-tree svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      min-width: 100%;
      pointer-events: none;
    }

    .activities-tree-container .horizontal-tree svg line {
      stroke: #DAA520;
      stroke-width: 2;
      fill: none;
    }

    /* ============================================
       GENEALOGY SECTION (#genealogy)
       ============================================ */
    #genealogy {
      background: linear-gradient(180deg, #FFF8DC 0%, #FFEBCD 100%);
      padding: 80px 30px;
    }

    .genealogy-container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    /* Lineage section styles */
    .lineage-section {
      margin-top: 30px;
      padding: 30px;
      background: linear-gradient(180deg, #FFF8DC 0%, #FFEBCD 100%);
      border-top: 5px solid #DAA520;
      border-radius: 0 0 20px 20px;
    }

    .lineage-header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 3px solid #DAA520;
    }

    .lineage-header h2 {
      color: #8B0000;
      font-size: 28px;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }

    .lineage-header p {
      color: #666;
      font-size: 16px;
      font-style: italic;
    }

    .lineage-controls {
      display: flex;
      gap: 15px;
      align-items: flex-end;
      flex-wrap: wrap;
      margin-bottom: 30px;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .lineage-input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      position: relative;
    }

    .lineage-input-group label {
      font-weight: 600;
      color: #8B0000;
      font-size: 14px;
    }

    .lineage-input-group input {
      padding: 12px 18px;
      border: 2px solid #DAA520;
      border-radius: 8px;
      font-size: 16px;
      background: white;
      font-family: 'Noto Serif TC', serif;
      min-width: 200px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .lineage-input-group input:focus {
      outline: none;
      border-color: #8B0000;
      box-shadow: 0 0 10px rgba(218, 165, 32, 0.5);
    }

    .lineage-controls button {
      padding: 12px 30px;
      border: 2px solid #8B0000;
      border-radius: 8px;
      font-size: 16px;
      background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
      color: #FFD700;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      font-family: 'Noto Serif TC', serif;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      height: fit-content;
    }

    .lineage-controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
      background: linear-gradient(135deg, #DC143C 0%, #8B0000 100%);
    }

    .lineage-result {
      margin-top: 20px;
      padding: 25px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      border: 3px solid #DAA520;
    }

    .lineage-result-header h3 {
      color: #8B0000;
      font-size: 22px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #DAA520;
    }

    .lineage-result-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .lineage-item {
      padding: 15px 20px;
      margin: 4px 0;
      background: linear-gradient(180deg, #FFF8DC 0%, #FFEBCD 100%);
      border-left: 5px solid #DAA520;
      border-radius: 8px;
      transition: all 0.3s;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      cursor: pointer;
    }

    .lineage-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      border-left-color: #8B0000;
    }

    .lineage-item.current {
      background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
      border-left-color: #fbc02d;
      border-left-width: 6px;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(251, 192, 45, 0.3);
    }

    .lineage-item .generation {
      display: inline-block;
      min-width: 100px;
      padding: 8px 15px;
      background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
      color: #FFD700;
      border-radius: 20px;
      font-weight: 700;
      font-size: 14px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      margin-right: 20px;
    }

    .lineage-item.current .generation {
      background: linear-gradient(135deg, #fbc02d 0%, #f9a825 100%);
      color: #8B0000;
    }

    .lineage-item .name {
      color: #8B0000;
      font-size: 16px;
      font-weight: 600;
    }

    .lineage-item.current .name {
      font-size: 18px;
    }

    .lineage-parents {
      margin-top: 10px;
      font-size: 16px;
      color: #8B0000;
      font-style: italic;
      font-weight: 500;
      padding-left: 10px;
    }

    .lineage-parents strong {
      color: #8B0000;
      font-style: normal;
      font-weight: 700;
      font-size: 17px;
    }

    .lineage-error {
      padding: 20px;
      background: #ffebee;
      color: #c62828;
      border-radius: 8px;
      border-left: 5px solid #c62828;
      text-align: center;
      font-weight: 600;
    }

    .lineage-loading {
      padding: 20px;
      text-align: center;
      color: #8B0000;
      font-size: 16px;
    }

    .suggestions-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #DAA520;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      margin-top: 5px;
    }

    .suggestion-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }

    .suggestion-item:hover {
      background: #FFF8DC;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-item .suggestion-name {
      font-weight: 600;
      color: #8B0000;
      font-size: 15px;
    }

    .suggestion-item .suggestion-details {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
      font-weight: 400;
    }
    
    .suggestion-item {
      display: flex;
      flex-direction: column;
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-item:hover {
      background: #f9f9f9;
    }

    .lineage-detail-panel {
      margin-top: 20px;
      padding: 25px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      border: 3px solid #DAA520;
    }

    .detail-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #DAA520;
    }

    .detail-panel-header h3 {
      color: #8B0000;
      font-size: 22px;
      margin: 0;
    }

    .close-btn {
      background: #DC143C;
      color: white;
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .close-btn:hover {
      background: #8B0000;
      transform: scale(1.1);
    }

    .detail-form {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px 20px;
    }
    
    @media (max-width: 768px) {
      .detail-form {
        grid-template-columns: 1fr;
      }
    }

    .detail-form .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .detail-form .form-group label {
      font-weight: 600;
      color: #8B0000;
      font-size: 14px;
    }

    .detail-form .form-group input,
    .detail-form .form-group select,
    .detail-form .form-group textarea {
      padding: 10px;
      border: 2px solid #DAA520;
      border-radius: 6px;
      font-size: 14px;
      font-family: 'Noto Serif TC', serif;
    }

    .detail-value {
      padding: 10px;
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
      min-height: 20px;
      line-height: 1.6;
      white-space: pre-line; /* Cho ph√©p xu·ªëng d√≤ng */
    }

    .btn-edit {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-edit:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4);
    }

    .detail-form .form-group input:focus,
    .detail-form .form-group select:focus,
    .detail-form .form-group textarea:focus {
      outline: none;
      border-color: #8B0000;
      box-shadow: 0 0 8px rgba(218, 165, 32, 0.3);
    }

    .form-actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .form-actions button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-save {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }

    .btn-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4);
    }

    .btn-cancel {
      background: #f5f5f5;
      color: #333;
    }

    .btn-cancel:hover {
      background: #e0e0e0;
    }

    .btn-delete {
      background: linear-gradient(135deg, #DC143C 0%, #8B0000 100%);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-delete:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(220, 20, 60, 0.4);
      background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
    }

    /* ============================================
       CONTACT SECTION (#contact)
       ============================================ */
    #contact {
      background: linear-gradient(180deg, #FFEBCD 0%, #FFF8DC 100%);
    }

    .contact-form {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #8B0000;
      font-weight: 600;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #DAA520;
      border-radius: 6px;
      font-size: 16px;
      font-family: 'Noto Serif TC', serif;
    }

    .form-group textarea {
      min-height: 120px;
      resize: vertical;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #8B0000;
      box-shadow: 0 0 8px rgba(218, 165, 32, 0.3);
    }

    .submit-button {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }

    .submit-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(139, 0, 0, 0.4);
    }

    /* ============================================
       RESPONSIVE
       ============================================ */
    
    /* Tree section responsive */
    @media (max-width: 900px) {
      #treeControls > div {
        flex-direction: column;
        align-items: stretch;
      }
      
      #treeControls > div > div {
        min-width: 100%;
      }
      
      section#activities-tree > div > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
      }
      
      #infoPanel {
        max-height: 400px;
        margin-top: 20px;
      }
    }
    
    @media (max-width: 768px) {
      .navbar-menu {
        position: fixed;
        top: 70px;
        left: -100%;
        width: 100%;
        background: #111827;
        flex-direction: column;
        padding: 20px;
        transition: left 0.3s;
      }

      .navbar-menu.active {
        left: 0;
      }

      .navbar-toggle {
        display: block;
      }

      .hero-content h1 {
        font-size: 32px;
      }

      .about-content {
        grid-template-columns: 1fr;
      }

      section {
        padding: 60px 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <a href="#home" class="navbar-logo">Ph√≤ng Tuy Bi√™n Qu·∫≠n C√¥ng ‚Äì Gia Ph·∫£ Nguy·ªÖn Ph∆∞·ªõc T·ªôc</a>
    <button class="navbar-toggle" onclick="toggleMenu()">‚ò∞</button>
    <ul class="navbar-menu" id="navbarMenu">
      <li><a href="#home" onclick="setActive(this)">Trang ch·ªß</a></li>
      <li><a href="#about" onclick="setActive(this)">Gi·ªõi thi·ªáu</a></li>
      <li><a href="/activities">Ho·∫°t ƒë·ªông</a></li>
      <li><a href="#genealogy" onclick="setActive(this)">Gia ph·∫£</a></li>
      <li><a href="/members" onclick="setActive(this)">Th√†nh vi√™n</a></li>
      <li><a href="/login">ƒêƒÉng nh·∫≠p</a></li>
      <li><a href="#contact" onclick="setActive(this)">Li√™n h·ªá</a></li>
    </ul>
  </nav>

  <!-- Section: Home -->
  <section id="home">
    <div class="hero-content">
      <h1>H·ªá Th·ªëng Gia Ph·∫£ TBQC</h1>
      <h2 style="font-size: 32px; margin-bottom: 20px; color: #FFD700;">H·∫≠u Du·ªá Vua Minh M·∫°ng</h2>
      <p>Tra c·ª©u v√† qu·∫£n l√Ω gia ph·∫£ d√≤ng h·ªç Nguy·ªÖn Ph∆∞·ªõc T·ªôc - Tuy Bi√™n Ph√≤ng, t·ª´ Vua Minh M·∫°ng ƒë·∫øn c√°c th·∫ø h·ªá con ch√°u hi·ªán t·∫°i.</p>
      <a href="#genealogy" class="cta-button" onclick="setActive(document.querySelector('a[href=\"#genealogy\"]'))">Xem Gia Ph·∫£</a>
    </div>
  </section>

  <!-- Section: About -->
  <section id="about">
    <div class="section-container">
      <h2 class="section-title">Gi·ªõi Thi·ªáu</h2>
      <div class="about-content">
        <div class="about-text">
          <p>
            <strong>Vua Minh M·∫°ng</strong> (1791-1841), t√™n th·∫≠t l√† Nguy·ªÖn Ph√∫c ƒê·∫£m, l√† v·ªã ho√†ng ƒë·∫ø th·ª© hai c·ªßa tri·ªÅu Nguy·ªÖn. 
            Ng√†i ƒë√£ c√≥ c√¥ng l·ªõn trong vi·ªác m·ªü r·ªông l√£nh th·ªï, c·ªßng c·ªë ch√≠nh quy·ªÅn v√† ph√°t tri·ªÉn vƒÉn h√≥a n∆∞·ªõc nh√†.
          </p>
          <p>
            D√≤ng h·ªç <strong>Nguy·ªÖn Ph∆∞·ªõc T·ªôc - Tuy Bi√™n Ph√≤ng</strong> l√† m·ªôt nh√°nh quan tr·ªçng trong ho√†ng t·ªôc, 
            v·ªõi nhi·ªÅu th·∫ø h·ªá con ch√°u ƒë√£ v√† ƒëang ƒë√≥ng g√≥p cho ƒë·∫•t n∆∞·ªõc.
          </p>
          <p>
            <strong>M·ª•c ti√™u c·ªßa d·ª± √°n:</strong> X√¢y d·ª±ng h·ªá th·ªëng tra c·ª©u gia ph·∫£ ƒëi·ªán t·ª≠, gi√∫p con ch√°u d·ªÖ d√†ng 
            t√¨m hi·ªÉu v·ªÅ ngu·ªìn g·ªëc, k·∫øt n·ªëi v·ªõi c√°c th√†nh vi√™n trong d√≤ng h·ªç, v√† l∆∞u tr·ªØ th√¥ng tin m·ªôt c√°ch b·ªÅn v·ªØng.
          </p>
          <p>
            <strong>Ngu·ªìn d·ªØ li·ªáu:</strong> H·ªá th·ªëng ƒë∆∞·ª£c x√¢y d·ª±ng d·ª±a tr√™n c√°c t√†i li·ªáu gia ph·∫£ g·ªëc, 
            vƒÉn b·∫£n l·ªãch s·ª≠, v√† d·ªØ li·ªáu ƒë∆∞·ª£c t·ªïng h·ª£p t·ª´ c√°c ngu·ªìn ƒë√°ng tin c·∫≠y.
          </p>
        </div>
        <div class="about-image">
          <img src="/static/images/vua-minh-mang.jpg" alt="Vua Minh M·∫°ng" title="Vua Minh M·∫°ng (1791-1841)">
        </div>
      </div>
    </div>
  </section>

  <!-- Section: Interactive Genealogy Tree -->
  <section id="activities-tree">
    <div class="section-container">
      <h2 class="section-title">C√¢y Gia Ph·∫£ T∆∞∆°ng T√°c</h2>
      
      <!-- Controls -->
      <div id="treeControls" style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
        <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
          <label style="display: flex; align-items: center; gap: 10px;">
            <span>Hi·ªÉn th·ªã ƒë·∫øn ƒë·ªùi:</span>
            <select id="genFilter" style="padding: 8px 12px; border: 2px solid #DAA520; border-radius: 6px; font-size: 14px;">
              <option value="5" selected>ƒê·∫øn ƒë·ªùi 5</option>
              <option value="6">ƒê·∫øn ƒë·ªùi 6</option>
              <option value="7">ƒê·∫øn ƒë·ªùi 7</option>
              <option value="8">ƒê·∫øn ƒë·ªùi 8</option>
            </select>
          </label>
          
          <div style="display: flex; gap: 10px; flex: 1; min-width: 300px;">
            <input id="searchInput" type="text" placeholder="T√¨m theo t√™n (v√≠ d·ª•: '∆Øng Minh M·∫°ng')" 
                   style="flex: 1; padding: 8px 12px; border: 2px solid #DAA520; border-radius: 6px; font-size: 14px;">
            <button id="searchBtn" style="padding: 8px 20px; background: #DAA520; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
              T√¨m ki·∫øm
            </button>
          </div>
        </div>
        
        <!-- Search Results -->
        <div id="searchResults" style="margin-top: 15px; display: none;"></div>
        
        <!-- Breadcrumb -->
        <div id="breadcrumb" style="margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 6px; display: none;"></div>
      </div>
      
      <!-- Tree Container -->
      <div style="display: grid; grid-template-columns: 1fr 350px; gap: 20px;">
        <div id="treeContainer" style="width: 100%; height: 700px; background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%); border: 2px solid #DAA520; border-radius: 16px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15); position: relative; overflow: hidden;">
          <div class="tree-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; color: #8B0000; font-weight: 600;">ƒêang t·∫£i c√¢y gia ph·∫£...</div>
        </div>
        
        <!-- Info Panel -->
        <div id="infoPanel" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); max-height: 600px; overflow-y: auto;">
          <h3 style="color: #8B0000; margin-bottom: 15px; font-size: 18px;">Th√¥ng tin chi ti·∫øt</h3>
          <div id="infoContent" style="color: #333; line-height: 1.6;">
            <p style="color: #666; font-style: italic;">Ch·ªçn m·ªôt ng∆∞·ªùi trong c√¢y ƒë·ªÉ xem th√¥ng tin</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Section: Activities -->
  <section id="activities">
    <div class="section-container">
      <h2 class="section-title">Ho·∫°t ƒê·ªông</h2>
      
      <!-- Mini Carousel for Activities -->
      <div id="activitiesMiniSlider" style="display:none; max-width: 1000px; margin: 20px auto 30px; position: relative;">
        <div class="mini-slider-container" style="position: relative; overflow: hidden; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); background: #fff;">
          <div id="miniSliderSlides"></div>
        </div>
        <button class="mini-slider-prev" id="miniSliderPrev" style="position: absolute; top: 50%; left: 10px; transform: translateY(-50%); background: rgba(0,0,0,0.5); border: none; color: #fff; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 20px; font-weight: bold; z-index: 10;">‚Äπ</button>
        <button class="mini-slider-next" id="miniSliderNext" style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); background: rgba(0,0,0,0.5); border: none; color: #fff; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 20px; font-weight: bold; z-index: 10;">‚Ä∫</button>
        <div class="mini-slider-dots" id="miniSliderDots" style="display: flex; justify-content: center; gap: 6px; margin-top: 10px;"></div>
      </div>
      
      <div id="activitiesPreview" class="activities-grid">
        <div class="tree-loading" style="grid-column: 1 / -1; text-align: center;">ƒêang t·∫£i ho·∫°t ƒë·ªông...</div>
      </div>
    </div>
  </section>

  <!-- Section: Genealogy -->
  <section id="genealogy">
    <div class="section-container">
      <h2 class="section-title">Tra C·ª©u Gia Ph·∫£</h2>
      <div class="genealogy-container">
        <!-- Ph·∫ßn tra c·ª©u chu·ªói ph·∫£ h·ªá -->
        <div class="lineage-section">
          <div class="lineage-header">
            <h2>üîç Tra c·ª©u chu·ªói ph·∫£ h·ªá theo d√≤ng cha</h2>
            <p>Ch·ªâ c·∫ßn nh·∫≠p t√™n (kh√¥ng c·∫ßn ƒë·ªùi) - H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t√¨m v√† g·ª£i √Ω</p>
          </div>
          
          <div class="lineage-controls">
            <div class="lineage-input-group" style="flex: 1; position: relative;">
              <label for="lineageName">T√™n (t√¨m ki·∫øm th√¥ng minh):</label>
              <input type="text" id="lineageName" placeholder="V√≠ d·ª•: B·∫£o Phong ho·∫∑c Bao Ph..." 
                     autocomplete="off" oninput="handleLineageSearchInput()">
              <div id="lineageSuggestions" class="suggestions-dropdown" style="display: none;">
                <!-- Suggestions s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
              </div>
            </div>
            <button id="btnSearchLineage" onclick="searchLineage()" style="margin-top: 28px;">üîç T√¨m chu·ªói ph·∫£ h·ªá</button>
          </div>

          <!-- Panel th√¥ng tin chi ti·∫øt v√† ch·ªânh s·ª≠a -->
          <div class="lineage-detail-panel" id="lineageDetailPanel" style="display: none;">
            <div class="detail-panel-header">
              <h3>üìã Th√¥ng tin chi ti·∫øt</h3>
              <button onclick="closeDetailPanel()" class="close-btn">&times;</button>
            </div>
            <div class="detail-panel-content" id="lineageDetailContent">
              <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
            </div>
          </div>

          <div class="lineage-result" id="lineageResult" style="display: none;">
            <div class="lineage-result-header">
              <h3 id="lineageResultTitle"></h3>
            </div>
            <div class="lineage-result-content" id="lineageResultContent">
              <!-- K·∫øt qu·∫£ s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Section: Contact -->
  <section id="contact">
    <div class="section-container">
      <h2 class="section-title">Li√™n H·ªá</h2>
      <div class="contact-form">
        <form id="contactForm" onsubmit="handleContactSubmit(event)">
          <div class="form-group">
            <label for="contactName">H·ªç v√† t√™n *</label>
            <input type="text" id="contactName" name="name" required>
          </div>
          <div class="form-group">
            <label for="contactEmail">Email / S·ªë ƒëi·ªán tho·∫°i *</label>
            <input type="text" id="contactEmail" name="contact" required>
          </div>
          <div class="form-group">
            <label for="contactType">Lo·∫°i y√™u c·∫ßu</label>
            <select id="contactType" name="type">
              <option value="update">C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi</option>
              <option value="document">G·ª≠i t√†i li·ªáu</option>
              <option value="other">Li√™n h·ªá kh√°c</option>
            </select>
          </div>
          <div class="form-group">
            <label for="contactMessage">N·ªôi dung *</label>
            <textarea id="contactMessage" name="message" required placeholder="Vui l√≤ng m√¥ t·∫£ chi ti·∫øt y√™u c·∫ßu c·ªßa b·∫°n..."></textarea>
          </div>
          <button type="submit" class="submit-button">üìß G·ª≠i Li√™n H·ªá</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Scripts -->
  <script>
    // Navbar functionality
    function toggleMenu() {
      const menu = document.getElementById('navbarMenu');
      menu.classList.toggle('active');
    }

    function setActive(element) {
      // Remove active from all links
      document.querySelectorAll('.navbar-menu a').forEach(link => {
        link.classList.remove('active');
      });
      // Add active to clicked link
      element.classList.add('active');
      // Close mobile menu
      document.getElementById('navbarMenu').classList.remove('active');
    }

    // Set active on scroll
    window.addEventListener('scroll', () => {
      const sections = ['home', 'about', 'activities', 'genealogy', 'login', 'contact'];
      const scrollPos = window.scrollY + 100;

      sections.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) {
          const top = section.offsetTop;
          const bottom = top + section.offsetHeight;
          
          if (scrollPos >= top && scrollPos < bottom) {
            document.querySelectorAll('.navbar-menu a').forEach(link => {
              link.classList.remove('active');
              if (link.getAttribute('href') === `#${sectionId}`) {
                link.classList.add('active');
              }
            });
          }
        }
      });
    });

    // Contact form
    function handleContactSubmit(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const data = Object.fromEntries(formData);
      
      console.log('Contact form submitted:', data);
      alert('‚úÖ C·∫£m ∆°n b·∫°n ƒë√£ li√™n h·ªá! Ch√∫ng t√¥i s·∫Ω ph·∫£n h·ªìi s·ªõm nh·∫•t c√≥ th·ªÉ.');
      event.target.reset();
    }

    // ============================================
    // LINEAGE SEARCH FUNCTIONALITY
    // ============================================
    
    let personsDataForLineage = [];
    let selectedPerson = null;
    let searchTimeout = null;
    let isEditMode = false;

    /**
     * X·ª≠ l√Ω khi ng∆∞·ªùi d√πng g√µ v√†o √¥ t√¨m ki·∫øm (autocomplete)
     */
    function handleLineageSearchInput() {
      const nameInput = document.getElementById('lineageName');
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      const query = nameInput.value.trim();
      
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
      
      if (!query || query.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
      }
      
      searchTimeout = setTimeout(async () => {
        try {
          // Use new API /api/search
          const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=10`);
          
          if (!response.ok) {
            suggestionsDiv.style.display = 'none';
            return;
          }
          
          const results = await response.json();
          
          if (results.length === 0) {
            suggestionsDiv.innerHTML = '<div class="suggestion-item" style="color: #999; font-style: italic;">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>';
            suggestionsDiv.style.display = 'block';
            return;
          }
          
          // Display suggestions with full format
          suggestionsDiv.innerHTML = results.map((person) => {
            const gen = person.generation_level || person.generation_number || '?';
            const name = person.full_name || 'Kh√¥ng r√µ t√™n';
            const fatherName = person.father_name || '';
            const motherName = person.mother_name || '';
            
            // Format parent info (kh√¥ng d√πng <em>)
            let parentInfo = '';
            if (fatherName && motherName) {
              parentInfo = `Con c·ªßa: √îng ${escapeHtml(fatherName)} & B√† ${escapeHtml(motherName)}`;
            } else if (fatherName) {
              parentInfo = `Con c·ªßa: √îng ${escapeHtml(fatherName)}`;
            } else if (motherName) {
              parentInfo = `Con c·ªßa: B√† ${escapeHtml(motherName)}`;
            } else {
              parentInfo = 'Ch∆∞a c√≥ th√¥ng tin cha m·∫π';
            }
            
            // Add FM_ID indicator if available to help distinguish duplicates
            const fmIdDisplay = person.father_mother_id || person.fm_id ? ` <span style="color: #999; font-size: 12px;">(FM: ${escapeHtml(person.father_mother_id || person.fm_id)})</span>` : '';
            
            return `
              <div class="suggestion-item" onclick="selectSuggestionFromSearch('${person.person_id}')" style="cursor: pointer; padding: 12px; border-bottom: 1px solid #eee;">
                <div class="suggestion-name" style="font-weight: 600; color: #7b1a1a; font-size: 16px; margin-bottom: 4px;">
                  ${escapeHtml(name)} ‚Äì ƒê·ªùi ${gen}${fmIdDisplay}
                </div>
                <div class="suggestion-details" style="color: #666; font-size: 14px;">
                  ${parentInfo}
                </div>
              </div>
            `;
          }).join('');
          
          suggestionsDiv.style.display = 'block';
        } catch (err) {
          console.error('Error in autocomplete:', err);
          suggestionsDiv.style.display = 'none';
        }
      }, 300);
    }

    /**
     * Ch·ªçn m·ªôt suggestion
     * @param {number} personId - ID duy nh·∫•t c·ªßa Person (b·∫Øt bu·ªôc d√πng personId, kh√¥ng d√πng t√™n/ƒë·ªùi)
     */
    function selectSuggestion(personId) {
      const nameInput = document.getElementById('lineageName');
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      
      suggestionsDiv.style.display = 'none';
      
      // D√πng personId ƒë·ªÉ t√¨m ƒë√∫ng Person (kh√¥ng d·ª±a v√†o t√™n/ƒë·ªùi v√¨ c√≥ th·ªÉ tr√πng)
      const allPersons = window.GenealogyLineage.getAllPersons();
      const person = allPersons.find(p => p.person_id === personId);
      
      if (!person) {
        console.error(`[Lineage] Kh√¥ng t√¨m th·∫•y Person v·ªõi person_id: ${personId}`);
        alert(`Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi v·ªõi ID: ${personId}`);
        return;
      }
      
      // C·∫≠p nh·∫≠t input v·ªõi t√™n c·ªßa ng∆∞·ªùi ƒë∆∞·ª£c ch·ªçn
      nameInput.value = person.full_name;
      
      // L∆∞u selectedPerson v√† hi·ªÉn th·ªã
      selectedPerson = person;
      displayLineageForPerson(person);
      showDetailPanel(person);
    }

    /**
     * Hi·ªÉn th·ªã chu·ªói ph·∫£ h·ªá cho m·ªôt Person
     */
    function displayLineageForPerson(person) {
      const resultDiv = document.getElementById('lineageResult');
      const resultContent = document.getElementById('lineageResultContent');
      const resultTitle = document.getElementById('lineageResultTitle');
      
      if (!person) {
        resultDiv.style.display = 'none';
        return;
      }
      
      try {
        // D√πng personId ƒë·ªÉ ƒë·∫£m b·∫£o ch·ªçn ƒë√∫ng ng∆∞·ªùi (kh√¥ng d·ª±a v√†o t√™n/ƒë·ªùi v√¨ c√≥ th·ªÉ tr√πng)
        // N·∫øu buildCompleteLineage h·ªó tr·ª£ personId, d√πng tr·ª±c ti·∫øp
        // N·∫øu kh√¥ng, d√πng t√™n + ƒë·ªùi + t√™n b·ªë ƒë·ªÉ ph√¢n gi·∫£i ch√≠nh x√°c
        let lineage;
        if (window.GenealogyLineage.buildCompleteLineageById) {
          lineage = window.GenealogyLineage.buildCompleteLineageById(person.person_id);
        } else {
          // Fallback: d√πng t√™n + ƒë·ªùi + t√™n b·ªë ƒë·ªÉ t√¨m ch√≠nh x√°c
          const foundPerson = window.GenealogyLineage.findPersonById 
            ? window.GenealogyLineage.findPersonById(person.person_id)
            : window.GenealogyLineage.findPerson(person.full_name, person.generation_number, person.father_name);
          
          if (!foundPerson) {
            resultContent.innerHTML = `<div class="lineage-error">‚ùå Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi v·ªõi ID: ${person.person_id}</div>`;
            resultTitle.textContent = 'L·ªói';
            resultDiv.style.display = 'block';
            return;
          }
          
          lineage = window.GenealogyLineage.buildCompleteLineage(foundPerson.full_name, foundPerson.generation_number, foundPerson.father_name);
        }
        
        if (!lineage || lineage.length === 0) {
          resultContent.innerHTML = `<div class="lineage-error">‚ùå Kh√¥ng th·ªÉ x√¢y d·ª±ng chu·ªói ph·∫£ h·ªá cho "${person.full_name}" (ID: ${person.person_id})</div>`;
          resultTitle.textContent = 'L·ªói';
          resultDiv.style.display = 'block';
          return;
        }
        
        // T√≠nh s·ªë ng∆∞·ªùi bao g·ªìm c·∫£ m·∫π/v·ª£
        const uniquePersons = new Set();
        lineage.forEach(p => {
          // Th√™m ng∆∞·ªùi ch√≠nh v√†o set (d√πng person_id ho·∫∑c key)
          const key = p.person_id ? `id_${p.person_id}` : `${p.full_name}|${p.generation_number}`;
          uniquePersons.add(key);
          
          // Th√™m m·∫π n·∫øu c√≥
          if (p.mother_name) {
            const motherKey = `${p.mother_name}|${(p.generation_number || 0) - 1}`;
            uniquePersons.add(motherKey);
          }
          
          // Th√™m v·ª£/ch·ªìng n·∫øu c√≥ (t·ª´ marriages)
          if (p.marriages && Array.isArray(p.marriages)) {
            p.marriages.forEach(marriage => {
              if (marriage.spouse_name) {
                const spouseKey = `${marriage.spouse_name}|${p.generation_number}`;
                uniquePersons.add(spouseKey);
              }
            });
          }
        });
        
        const html = window.GenealogyLineage.formatAsHTMLWithParents(lineage);
        resultContent.innerHTML = html;
        resultTitle.textContent = `Chu·ªói ph·∫£ h·ªá c·ªßa ${person.full_name} (ƒê·ªùi ${person.generation_number}) - ${uniquePersons.size} ng∆∞·ªùi`;
        resultDiv.style.display = 'block';
        
        resultContent.querySelectorAll('.lineage-item').forEach(item => {
          item.style.cursor = 'pointer';
          item.addEventListener('click', () => {
            const personId = item.getAttribute('data-person-id'); // Gi·ªØ nguy√™n string
            const allPersons = window.GenealogyLineage.getAllPersons();
            const clickedPerson = allPersons.find(p => p.person_id === personId);
            if (clickedPerson) {
              showDetailPanel(clickedPerson);
            }
          });
        });
        
      } catch (error) {
        console.error('L·ªói khi hi·ªÉn th·ªã lineage:', error);
        resultContent.innerHTML = `<div class="lineage-error">‚ùå L·ªói: ${error.message}</div>`;
        resultTitle.textContent = 'L·ªói';
        resultDiv.style.display = 'block';
      }
    }

    /**
     * T√¨m ki·∫øm v√† hi·ªÉn th·ªã chu·ªói ph·∫£ h·ªá
     */
    async function searchLineage() {
      const nameInput = document.getElementById('lineageName');
      const name = nameInput.value.trim();
      
      if (!name) {
        alert('Vui l√≤ng nh·∫≠p t√™n ho·∫∑c ch·ªçn t·ª´ danh s√°ch g·ª£i √Ω');
        return;
      }
      
      // Hide suggestions
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      if (suggestionsDiv) {
        suggestionsDiv.style.display = 'none';
      }
      
      try {
        // Use new API /api/search
        const response = await fetch(`/api/search?q=${encodeURIComponent(name)}&limit=20`);
        
        if (!response.ok) {
          throw new Error(`API tr·∫£ m√£ ${response.status}`);
        }
        
        const results = await response.json();
        
        if (results.length === 0) {
          alert(`Kh√¥ng t√¨m th·∫•y "${name}"`);
          return;
        }
        
        // N·∫øu c√≥ nhi·ªÅu k·∫øt qu·∫£ tr√πng t√™n, hi·ªÉn th·ªã suggestion ƒë·ªÉ ng∆∞·ªùi d√πng ch·ªçn
        if (results.length > 1) {
          // Hi·ªÉn th·ªã suggestions ƒë·ªÉ ng∆∞·ªùi d√πng ch·ªçn
          if (suggestionsDiv) {
            suggestionsDiv.innerHTML = results.map((person) => {
              const gen = person.generation_level || person.generation_number || '?';
              const name = person.full_name || 'Kh√¥ng r√µ t√™n';
              const fatherName = person.father_name || '';
              const motherName = person.mother_name || '';
              
              // Format parent info (kh√¥ng d√πng <em>)
              let parentInfo = '';
              if (fatherName && motherName) {
                parentInfo = `Con c·ªßa: √îng ${escapeHtml(fatherName)} & B√† ${escapeHtml(motherName)}`;
              } else if (fatherName) {
                parentInfo = `Con c·ªßa: √îng ${escapeHtml(fatherName)}`;
              } else if (motherName) {
                parentInfo = `Con c·ªßa: B√† ${escapeHtml(motherName)}`;
              } else {
                parentInfo = 'Ch∆∞a c√≥ th√¥ng tin cha m·∫π';
              }
              
              // Add FM_ID indicator if available to help distinguish duplicates
              const fmIdDisplay = person.father_mother_id || person.fm_id ? ` <span style="color: #999; font-size: 12px;">(FM: ${escapeHtml(person.father_mother_id || person.fm_id)})</span>` : '';
              
              return `
                <div class="suggestion-item" onclick="selectSuggestionFromSearch('${person.person_id}')" style="cursor: pointer; padding: 12px; border-bottom: 1px solid #eee;">
                  <div class="suggestion-name" style="font-weight: 600; color: #7b1a1a; font-size: 16px; margin-bottom: 4px;">
                    ${escapeHtml(name)} ‚Äì ƒê·ªùi ${gen}${fmIdDisplay}
                  </div>
                  <div class="suggestion-details" style="color: #666; font-size: 14px;">
                    ${parentInfo}
                  </div>
                </div>
              `;
            }).join('');
            suggestionsDiv.style.display = 'block';
          }
          return;
        }
        
        // Ch·ªâ c√≥ 1 k·∫øt qu·∫£, t·ª± ƒë·ªông ch·ªçn
        const person = results[0];
        await displayLineageForPersonFromAPI(person.person_id);
      } catch (err) {
        console.error('Error searching lineage:', err);
        alert(`L·ªói khi t√¨m ki·∫øm: ${err.message}`);
      }
    }
    
    /**
     * Select suggestion from search results
     */
    async function selectSuggestionFromSearch(personId) {
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      if (suggestionsDiv) {
        suggestionsDiv.style.display = 'none';
      }
      
      await displayLineageForPersonFromAPI(personId);
    }
    
    /**
     * Display lineage for person using API
     */
    async function displayLineageForPersonFromAPI(personId) {
      try {
        console.log(`[Lineage] Fetching lineage for person_id: ${personId}`);
        
        // Fetch ancestors API (includes person info)
        const ancestorsRes = await fetch(`/api/ancestors/${personId}`);
        
        if (!ancestorsRes.ok) {
          throw new Error(`API /api/ancestors/${personId} tr·∫£ m√£ ${ancestorsRes.status}`);
        }
        
        const ancestorsData = await ancestorsRes.json();
        console.log('[Lineage] Ancestors API response:', ancestorsData);
        
        // Build lineage chain: ancestors_chain + current person (avoid duplicates)
        let lineage = [];
        
        if (ancestorsData.ancestors_chain && Array.isArray(ancestorsData.ancestors_chain)) {
          lineage = ancestorsData.ancestors_chain;
        }
        
        // Add current person to lineage only if not already in ancestors_chain
        if (ancestorsData.person) {
          const currentPersonId = String(ancestorsData.person.person_id || '').trim();
          // Check with normalized comparison
          const alreadyInChain = lineage.some(p => {
            const pId = String(p.person_id || '').trim();
            return pId === currentPersonId && pId !== '';
          });
          
          if (!alreadyInChain && currentPersonId) {
            lineage.push(ancestorsData.person);
            console.log(`[Lineage] Added current person ${currentPersonId} to lineage`);
          } else {
            console.log(`[Lineage] Person ${currentPersonId} already in ancestors_chain, skipping duplicate`);
          }
        }
        
        console.log(`[Lineage] Built lineage chain with ${lineage.length} generations`);
        console.log('[Lineage] Lineage data:', lineage);
        
        // Display lineage with beautiful timeline (will remove duplicates again)
        displayLineageChain(lineage);
        
        // Show detail panel (fetch full person details)
        try {
          const personRes = await fetch(`/api/person/${personId}`);
          if (personRes.ok) {
            const person = await personRes.json();
            selectedPerson = person;
            showDetailPanel(person);
          }
        } catch (err) {
          console.warn('[Lineage] Could not fetch full person details:', err);
          // Use person from ancestors API
          if (ancestorsData.person) {
            selectedPerson = ancestorsData.person;
            showDetailPanel(ancestorsData.person);
          }
        }
      } catch (err) {
        console.error('Error displaying lineage:', err);
        alert(`L·ªói khi hi·ªÉn th·ªã chu·ªói ph·∫£ h·ªá: ${err.message}`);
      }
    }
    
    /**
     * Normalize parent names for display
     */
    function normalizeParentName(name, isFather = true) {
      if (!name) return null;
      // Remove common prefixes
      name = name.replace(/^(√îng|B√†|Vua)\s+/i, '').trim();
      return name;
    }
    
    /**
     * Get standardized parents for Generation 1 (Vua Minh M·∫°ng)
     */
    function getGen1Parents() {
      return {
        father_name: 'Vua Gia Long',
        mother_name: 'Thu·∫≠n Thi√™n Ho√†ng h·∫≠u'
      };
    }
    
    /**
     * Display lineage chain with beautiful timeline format
     */
    function displayLineageChain(lineage) {
      const resultDiv = document.getElementById('lineageResult');
      const resultContent = document.getElementById('lineageResultContent');
      const resultTitle = document.getElementById('lineageResultTitle');
      
      if (!resultDiv) return;
      
      if (!lineage || lineage.length === 0) {
        if (resultContent) {
          resultContent.innerHTML = '<div style="padding: 20px; color: #666; text-align: center;">Kh√¥ng c√≥ d·ªØ li·ªáu chu·ªói ph·∫£ h·ªá</div>';
        } else {
          resultDiv.innerHTML = '<div style="padding: 20px; color: #666; text-align: center;">Kh√¥ng c√≥ d·ªØ li·ªáu chu·ªói ph·∫£ h·ªá</div>';
        }
        resultDiv.style.display = 'block';
        return;
      }
      
      // Remove duplicates by person_id (strict check with string conversion and normalization)
      const seenIds = new Set();
      const uniqueLineage = [];
      const duplicateLog = [];
      
      for (const p of lineage) {
        // Normalize person_id: trim, convert to string, handle null/undefined
        let personId = p.person_id;
        if (personId === null || personId === undefined || personId === '') {
          console.warn(`[Lineage] Skipping person without person_id:`, p);
          continue;
        }
        
        // Convert to string and trim whitespace
        const personIdStr = String(personId).trim();
        if (!personIdStr) {
          console.warn(`[Lineage] Skipping person with empty person_id after trim:`, p);
          continue;
        }
        
        // Check for duplicate
        if (seenIds.has(personIdStr)) {
          const duplicateInfo = {
            person_id: personIdStr,
            name: p.full_name || 'N/A',
            generation: p.generation_number || p.generation_level || 'N/A'
          };
          duplicateLog.push(duplicateInfo);
          console.warn(`[Lineage] DUPLICATE DETECTED: person_id=${personIdStr}, name=${duplicateInfo.name}, generation=${duplicateInfo.generation}`);
          continue;
        }
        
        // Add to seen set and unique lineage
        seenIds.add(personIdStr);
        uniqueLineage.push(p);
      }
      
      if (duplicateLog.length > 0) {
        console.warn(`[Lineage] Found ${duplicateLog.length} duplicates:`, duplicateLog);
      }
      console.log(`[Lineage] After deduplication: ${uniqueLineage.length} unique persons (from ${lineage.length} total)`);
      
      // Log all person_ids for debugging
      const allPersonIds = uniqueLineage.map(p => `${p.person_id} (${p.full_name})`).join(', ');
      console.log(`[Lineage] Unique person_ids: ${allPersonIds}`);
      
      // Sort by generation_number (ascending), then by person_id
      const sortedLineage = [...uniqueLineage].sort((a, b) => {
        const genA = a.generation_number || a.generation_level || 0;
        const genB = b.generation_number || b.generation_level || 0;
        if (genA !== genB) {
          return genA - genB;
        }
        // If same generation, sort by person_id (string comparison for VARCHAR IDs)
        const idA = String(a.person_id || '');
        const idB = String(b.person_id || '');
        return idA.localeCompare(idB);
      });
      
      console.log(`[Lineage] After deduplication: ${sortedLineage.length} unique persons`);
      console.log('[Lineage] Generations:', sortedLineage.map(p => `${p.generation_number}: ${p.full_name}`));
      
      // Ensure Generation 1 exists (Vua Minh M·∫°ng)
      const hasGen1 = sortedLineage.some(p => (p.generation_number === 1 || p.generation_level === 1));
      if (!hasGen1) {
        // Find Vua Minh M·∫°ng or create placeholder
        const gen1Person = {
          person_id: 'P-1-1',
          full_name: 'Vua Minh M·∫°ng',
          generation_number: 1,
          generation_level: 1,
          father_name: 'Vua Gia Long',
          mother_name: 'Thu·∫≠n Thi√™n Ho√†ng h·∫≠u',
          gender: 'Nam',
          status: 'ƒê√£ m·∫•t'
        };
        sortedLineage.unshift(gen1Person);
        console.log('[Lineage] Added Generation 1 placeholder (Vua Minh M·∫°ng)');
      } else {
        // Normalize Gen 1 parents
        const gen1Index = sortedLineage.findIndex(p => (p.generation_number === 1 || p.generation_level === 1));
        if (gen1Index !== -1) {
          const gen1Parents = getGen1Parents();
          sortedLineage[gen1Index].father_name = gen1Parents.father_name;
          sortedLineage[gen1Index].mother_name = gen1Parents.mother_name;
          console.log('[Lineage] Normalized Generation 1 parents');
        }
      }
      
      // Get target person (last in chain)
      const targetPerson = sortedLineage[sortedLineage.length - 1];
      
      if (resultTitle) {
        resultTitle.textContent = `Chu·ªói ph·∫£ h·ªá c·ªßa ${targetPerson.full_name || 'Ng∆∞·ªùi ƒë∆∞·ª£c ch·ªçn'}`;
      }
      
      // Generate timeline HTML
      const timelineHTML = sortedLineage.map((p, index) => {
        const gen = p.generation_number || p.generation_level || '?';
        const name = p.full_name || 'Kh√¥ng r√µ t√™n';
        const fatherName = normalizeParentName(p.father_name, true) || p.father_name || '';
        const motherName = normalizeParentName(p.mother_name, false) || p.mother_name || '';
        
        // Format parent info according to spec: "Con c·ªßa:" in nghi√™ng
        let parentInfo = '';
        if (fatherName && motherName) {
          parentInfo = `<em>Con c·ªßa:</em> √îng ${escapeHtml(fatherName)} & B√† ${escapeHtml(motherName)}`;
        } else if (fatherName) {
          parentInfo = `<em>Con c·ªßa:</em> √îng ${escapeHtml(fatherName)}`;
        } else if (motherName) {
          parentInfo = `<em>Con c·ªßa:</em> B√† ${escapeHtml(motherName)}`;
        } else {
          parentInfo = 'Ch∆∞a c√≥ th√¥ng tin cha m·∫π';
        }
        
        // Badge color by generation
        let badgeColor = '';
        if (gen === 1) {
          badgeColor = 'background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);'; // Red
        } else if (gen === 2) {
          badgeColor = 'background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);'; // Orange
        } else if (gen === 3) {
          badgeColor = 'background: linear-gradient(135deg, #ca8a04 0%, #a16207 100%);'; // Yellow
        } else if (gen === 4) {
          badgeColor = 'background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);'; // Green
        } else if (gen === 5) {
          badgeColor = 'background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);'; // Blue
        } else if (gen >= 6) {
          badgeColor = 'background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%);'; // Purple
        } else {
          badgeColor = 'background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);'; // Gray
        }
        
        return `
          <div class="lineage-timeline-card" style="
            background: linear-gradient(180deg, #FFF8DC 0%, #FFFFFF 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px solid #DAA520;
            position: relative;
            width: 100%;
          ">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 12px;">
              <span class="generation-badge" style="
                ${badgeColor}
                color: white;
                font-weight: 700;
                font-size: 14px;
                padding: 8px 20px;
                border-radius: 50px;
                white-space: nowrap;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
                display: inline-block;
                min-width: 80px;
                text-align: center;
              ">ƒê·ªùi ${gen}</span>
              <h3 style="
                color: #7b1a1a;
                font-weight: 700;
                font-size: 20px;
                margin: 0;
                flex: 1;
              ">ƒê·ªùi ${gen} ‚Äì ${escapeHtml(name)}</h3>
            </div>
            <div style="
              color: #333;
              font-size: 15px;
              line-height: 1.6;
              padding-left: 5px;
            ">
              ${parentInfo}
            </div>
          </div>
        `;
      }).join('');
      
      if (resultContent) {
        resultContent.innerHTML = `
          <div class="lineage-timeline-container" style="
            display: flex;
            flex-direction: column;
            gap: 0;
            width: 100%;
          ">
            ${timelineHTML}
          </div>
        `;
      } else {
        resultDiv.innerHTML = `
          <div style="padding: 20px;">
            <h3 style="color: #8B0000; margin-bottom: 20px;">Chu·ªói ph·∫£ h·ªá theo d√≤ng cha</h3>
            <div class="lineage-timeline-container" style="
              display: flex;
              flex-direction: column;
              gap: 0;
              width: 100%;
            ">
              ${timelineHTML}
            </div>
          </div>
        `;
      }
      
      resultDiv.style.display = 'block';
    }

    /**
     * Hi·ªÉn th·ªã detail panel ·ªü ch·∫ø ƒë·ªô xem (read-only)
     */
    /**
     * Format text: thay d·∫•u ";" b·∫±ng xu·ªëng d√≤ng
     */
    function formatTextWithLineBreaks(text) {
      if (!text || text === 'Ch∆∞a c√≥ th√¥ng tin') return text;
      return text.split(';').map(item => item.trim()).filter(item => item).join('<br>');
    }

    function showDetailPanel(person) {
      const panel = document.getElementById('lineageDetailPanel');
      const content = document.getElementById('lineageDetailContent');
      
      if (!person) return;
      
      selectedPerson = person;
      isEditMode = false;
      
      // Fetch th√¥ng tin chi ti·∫øt t·ª´ API (bao g·ªìm h√¥n ph·ªëi)
      fetch(`/api/person/${person.person_id}`)
        .then(response => response.json())
        .then(detailedPerson => {
          // Merge th√¥ng tin chi ti·∫øt v√†o person
          Object.assign(selectedPerson, detailedPerson);
          renderDetailPanel(selectedPerson);
        })
        .catch(error => {
          console.error('L·ªói khi fetch th√¥ng tin chi ti·∫øt:', error);
          renderDetailPanel(person);
        });
    }
    
    function renderDetailPanel(person) {
      const content = document.getElementById('lineageDetailContent');
      const panel = document.getElementById('lineageDetailPanel');
      if (!content || !panel) return;
      
      // ƒê·∫£m b·∫£o lu√¥n ·ªü ch·∫ø ƒë·ªô xem khi render
      isEditMode = false;
      
      content.innerHTML = `
        <div class="detail-view-mode">
          <div class="detail-form">
            <div class="form-group">
              <label>T√™n ƒë·∫ßy ƒë·ªß:</label>
              <div class="detail-value">${person.full_name || 'Ch∆∞a c√≥ th√¥ng tin'}</div>
            </div>
            <div class="form-group">
              <label>ƒê·ªùi:</label>
              <div class="detail-value">${person.generation_number || 'Ch∆∞a c√≥ th√¥ng tin'}</div>
            </div>
            <div class="form-group">
              <label>Gi·ªõi t√≠nh:</label>
              <div class="detail-value">${person.gender || 'Ch∆∞a c√≥ th√¥ng tin'}</div>
            </div>
            <div class="form-group">
              <label>T√™n b·ªë:</label>
              <div class="detail-value">${person.father_name ? '√îng ' + person.father_name : 'Ch∆∞a c√≥ th√¥ng tin'}</div>
            </div>
            <div class="form-group">
              <label>T√™n m·∫π:</label>
              <div class="detail-value">${person.mother_name ? 'B√† ' + person.mother_name : 'Ch∆∞a c√≥ th√¥ng tin'}</div>
            </div>
            <div class="form-group">
              <label>Nh√°nh:</label>
              <div class="detail-value">${person.branch_name || 'Ch∆∞a c√≥ th√¥ng tin'}</div>
            </div>
            <div class="form-group">
              <label>Tr·∫°ng th√°i:</label>
              <div class="detail-value">${person.status || 'Ch∆∞a c√≥ th√¥ng tin'}</div>
            </div>
            ${person.birth_date_solar || person.birth_date_lunar ? `
            <div class="form-group">
              <label>NƒÉm sinh:</label>
              <div class="detail-value">
                ${(() => {
                  let yearDL = null;
                  let yearAL = null;
                  
                  if (person.birth_date_solar) {
                    try {
                      const date = new Date(person.birth_date_solar);
                      yearDL = isNaN(date.getTime()) ? (person.birth_date_solar.split('-')[0] || person.birth_date_solar) : date.getFullYear();
                    } catch {
                      yearDL = person.birth_date_solar.split('-')[0] || person.birth_date_solar;
                    }
                  }
                  
                  if (person.birth_date_lunar) {
                    try {
                      const date = new Date(person.birth_date_lunar);
                      yearAL = isNaN(date.getTime()) ? (person.birth_date_lunar.split('-')[0] || person.birth_date_lunar) : date.getFullYear();
                    } catch {
                      yearAL = person.birth_date_lunar.split('-')[0] || person.birth_date_lunar;
                    }
                  }
                  
                  // Logic hi·ªÉn th·ªã
                  if (yearDL && yearAL) {
                    if (yearDL === yearAL) {
                      return yearDL + (person.birth_location ? ' - ' + person.birth_location : '');
                    } else {
                      return `DL: ${yearDL} / AL: ${yearAL}${person.birth_location ? ' - ' + person.birth_location : ''}`;
                    }
                  } else if (yearDL) {
                    return yearDL + (person.birth_location ? ' - ' + person.birth_location : '');
                  } else if (yearAL) {
                    return yearAL + (person.birth_location ? ' - ' + person.birth_location : '');
                  }
                  return '';
                })()}
              </div>
            </div>
            ` : ''}
            ${person.death_date_solar || person.death_date_lunar ? `
            <div class="form-group">
              <label>NƒÉm m·∫•t:</label>
              <div class="detail-value">
                ${person.death_date_solar ? (() => {
                  try {
                    const date = new Date(person.death_date_solar);
                    return isNaN(date.getTime()) ? (person.death_date_solar.split('-')[0] || person.death_date_solar) : date.getFullYear();
                  } catch {
                    return person.death_date_solar.split('-')[0] || person.death_date_solar;
                  }
                })() : ''}
                ${person.death_date_solar && person.death_date_lunar ? ' / ' : ''}
                ${person.death_date_lunar ? (() => {
                  try {
                    const date = new Date(person.death_date_lunar);
                    return isNaN(date.getTime()) ? (person.death_date_lunar.split('-')[0] || person.death_date_lunar) : date.getFullYear();
                  } catch {
                    return person.death_date_lunar.split('-')[0] || person.death_date_lunar;
                  }
                })() : ''}
                ${person.sheet3_death_place || person.death_location ? ' - ' + (person.sheet3_death_place || person.death_location || '') : ''}
              </div>
            </div>
            ` : ''}
            ${person.sheet3_grave ? `
            <div class="form-group">
              <label>M·ªô ph·∫ßn:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.sheet3_grave)}</div>
            </div>
            ` : ''}
            ${person.sheet3_number ? `
            <div class="form-group">
              <label>S·ªë th·ª© t·ª± th√†nh vi√™n:</label>
              <div class="detail-value">${person.sheet3_number}</div>
            </div>
            ` : ''}
            ${person.sheet3_parents ? `
            <div class="form-group">
              <label>Th√¥ng tin B·ªë M·∫π:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.sheet3_parents)}</div>
            </div>
            ` : ''}
            ${person.origin_location ? `
            <div class="form-group">
              <label>Nguy√™n qu√°n:</label>
              <div class="detail-value">${person.origin_location}</div>
            </div>
            ` : ''}
            ${person.nationality ? `
            <div class="form-group">
              <label>Qu·ªëc t·ªãch:</label>
              <div class="detail-value">${person.nationality}</div>
            </div>
            ` : ''}
            <div class="form-group">
              <label>Anh/Ch·ªã/Em:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.siblings) || 'Ch∆∞a c√≥ th√¥ng tin'}</div>
            </div>
            ${person.marriages && person.marriages.length > 0 ? `
            <div class="form-group">
              <label>H√¥n ph·ªëi:</label>
              <div class="detail-value">
                ${person.marriages.map(m => 
                  `${m.spouse_name}${m.marriage_date_solar ? ' (' + m.marriage_date_solar + ')' : ''}${m.marriage_place ? ' - ' + m.marriage_place : ''}`
                ).join('<br>')}
              </div>
            </div>
            ` : person.spouse ? `
            <div class="form-group">
              <label>H√¥n ph·ªëi:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.spouse) || 'Ch∆∞a c√≥ th√¥ng tin'}</div>
            </div>
            ` : ''}
            <div class="form-group">
              <label>Th√¥ng tin con:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.children) || 'Ch∆∞a c√≥ th√¥ng tin'}</div>
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn-cancel" onclick="closeDetailPanel()">ƒê√≥ng</button>
            <button type="button" class="btn-request" onclick="openRequestModal()">üìù G·ª≠i y√™u c·∫ßu ch·ªânh s·ª≠a</button>
          </div>
        </div>
      `;
      
      panel.style.display = 'block';
    }

    /**
     * Hi·ªÉn th·ªã modal nh·∫≠p m·∫≠t kh·∫©u v√† cho ph√©p ch·ªânh s·ª≠a n·∫øu ƒë√∫ng
     */
    function promptPasswordAndEdit() {
      if (!selectedPerson) return;
      
      // T·∫°o modal nh·∫≠p m·∫≠t kh·∫©u
      let modal = document.getElementById('passwordModal');
      if (!modal) {
        const modalHTML = `
          <div id="passwordModal" class="modal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto;">
            <div class="modal-content" style="background: white; margin: 15% auto; padding: 30px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
              <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #8B0000; margin: 0;">üîê X√°c th·ª±c m·∫≠t kh·∫©u</h3>
                <span class="close" onclick="closePasswordModal()" style="cursor: pointer; font-size: 28px; color: #999; font-weight: bold;">&times;</span>
              </div>
              <form id="passwordForm" onsubmit="verifyPasswordAndEdit(event)">
                <div class="form-group">
                  <label style="display: block; margin-bottom: 8px; color: #8B0000; font-weight: 600;">Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ c·∫≠p nh·∫≠t th√¥ng tin:</label>
                  <input type="password" id="passwordInput" required 
                         placeholder="Nh·∫≠p m·∫≠t kh·∫©u" 
                         style="width: 100%; padding: 12px; border: 2px solid #DAA520; border-radius: 6px; font-size: 16px; font-family: 'Noto Serif TC', serif;"
                         autocomplete="off">
                </div>
                <div class="form-actions" style="display: flex; gap: 10px; margin-top: 20px;">
                  <button type="button" class="btn-cancel" onclick="closePasswordModal()" style="flex: 1;">H·ªßy</button>
                  <button type="submit" class="btn-save" style="flex: 1;">X√°c nh·∫≠n</button>
                </div>
              </form>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        modal = document.getElementById('passwordModal');
      }
      
      // Reset input
      const passwordInput = document.getElementById('passwordInput');
      if (passwordInput) {
        passwordInput.value = '';
        passwordInput.focus();
      }
      
      // Hi·ªÉn th·ªã modal
      modal.style.display = 'block';
    }
    
    /**
     * ƒê√≥ng modal m·∫≠t kh·∫©u
     */
    function closePasswordModal() {
      const modal = document.getElementById('passwordModal');
      if (modal) {
        modal.style.display = 'none';
        const form = document.getElementById('passwordForm');
        if (form) form.reset();
      }
    }
    
    /**
     * Ki·ªÉm tra m·∫≠t kh·∫©u v√† cho ph√©p ch·ªânh s·ª≠a n·∫øu ƒë√∫ng
     */
    function verifyPasswordAndEdit(event) {
      event.preventDefault();
      
      const passwordInput = document.getElementById('passwordInput');
      const password = passwordInput ? passwordInput.value.trim() : '';
      const correctPassword = '2026';
      
      if (password === correctPassword) {
        // ƒê√≥ng modal
        closePasswordModal();
        // Cho ph√©p ch·ªânh s·ª≠a
        enableEditMode();
      } else {
        alert('‚ùå M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng! Vui l√≤ng th·ª≠ l·∫°i.');
        if (passwordInput) {
          passwordInput.value = '';
          passwordInput.focus();
        }
      }
    }
    
    /**
     * Hi·ªÉn th·ªã modal x√°c nh·∫≠n x√≥a v·ªõi nh·∫≠p m·∫≠t kh·∫©u
     */
    function promptPasswordAndDelete() {
      if (!selectedPerson) return;
      
      // T·∫°o modal x√°c nh·∫≠n x√≥a
      let modal = document.getElementById('deleteConfirmModal');
      if (!modal) {
        const modalHTML = `
          <div id="deleteConfirmModal" class="modal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto;">
            <div class="modal-content" style="background: white; margin: 15% auto; padding: 30px; border-radius: 8px; width: 90%; max-width: 450px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
              <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #DC143C; margin: 0;">‚ö†Ô∏è X√°c nh·∫≠n x√≥a</h3>
                <span class="close" onclick="closeDeleteModal()" style="cursor: pointer; font-size: 28px; color: #999; font-weight: bold;">&times;</span>
              </div>
              <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                <p style="margin: 0; color: #856404; font-weight: 600;">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi n√†y?</p>
                <p style="margin: 10px 0 0 0; color: #856404;">
                  <strong id="deletePersonName">${selectedPerson.full_name}</strong> (ƒê·ªùi ${selectedPerson.generation_number || '?'})
                </p>
                <p style="margin: 10px 0 0 0; color: #856404; font-size: 14px;">
                  ‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c! T·∫•t c·∫£ d·ªØ li·ªáu li√™n quan s·∫Ω b·ªã x√≥a.
                </p>
              </div>
              <form id="deleteConfirmForm" onsubmit="verifyPasswordAndDelete(event)">
                <div class="form-group">
                  <label style="display: block; margin-bottom: 8px; color: #DC143C; font-weight: 600;">Nh·∫≠p m·∫≠t kh·∫©u admin ƒë·ªÉ x√°c nh·∫≠n:</label>
                  <input type="password" id="deletePasswordInput" required 
                         placeholder="Nh·∫≠p m·∫≠t kh·∫©u" 
                         style="width: 100%; padding: 12px; border: 2px solid #DC143C; border-radius: 6px; font-size: 16px; font-family: 'Noto Serif TC', serif;"
                         autocomplete="off">
                </div>
                <div class="form-actions" style="display: flex; gap: 10px; margin-top: 20px;">
                  <button type="button" class="btn-cancel" onclick="closeDeleteModal()" style="flex: 1;">H·ªßy</button>
                  <button type="submit" class="btn-delete" style="flex: 1; background: linear-gradient(135deg, #DC143C 0%, #8B0000 100%); color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">üóëÔ∏è X√≥a vƒ©nh vi·ªÖn</button>
                </div>
              </form>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        modal = document.getElementById('deleteConfirmModal');
      }
      
      // C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi s·∫Ω b·ªã x√≥a
      const personInfo = document.getElementById('deletePersonName');
      if (personInfo && selectedPerson) {
        personInfo.textContent = `${selectedPerson.full_name} (ƒê·ªùi ${selectedPerson.generation_number || '?'})`;
      }
      
      // Reset input
      const passwordInput = document.getElementById('deletePasswordInput');
      if (passwordInput) {
        passwordInput.value = '';
        passwordInput.focus();
      }
      
      // Hi·ªÉn th·ªã modal
      modal.style.display = 'block';
    }
    
    /**
     * ƒê√≥ng modal x√≥a
     */
    function closeDeleteModal() {
      const modal = document.getElementById('deleteConfirmModal');
      if (modal) {
        modal.style.display = 'none';
        const form = document.getElementById('deleteConfirmForm');
        if (form) form.reset();
      }
    }
    
    /**
     * Ki·ªÉm tra m·∫≠t kh·∫©u v√† x√≥a n·∫øu ƒë√∫ng
     */
    async function verifyPasswordAndDelete(event) {
      event.preventDefault();
      
      if (!selectedPerson) {
        alert('‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi c·∫ßn x√≥a');
        return;
      }
      
      const passwordInput = document.getElementById('deletePasswordInput');
      const password = passwordInput ? passwordInput.value.trim() : '';
      const correctPassword = 'tbqc2026';
      
      if (password !== correctPassword) {
        alert('‚ùå M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng! Vui l√≤ng th·ª≠ l·∫°i.');
        if (passwordInput) {
          passwordInput.value = '';
          passwordInput.focus();
        }
        return;
      }
      
      // X√°c nh·∫≠n l·∫ßn cu·ªëi
      const personName = selectedPerson.full_name || 'Ng∆∞·ªùi n√†y';
      const finalConfirm = confirm(`‚ö†Ô∏è X√ÅC NH·∫¨N CU·ªêI C√ôNG\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a:\n${personName} (ƒê·ªùi ${selectedPerson.generation_number || '?'})\n\nH√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ ho√†n t√°c!`);
      
      if (!finalConfirm) {
        return;
      }
      
      const personId = selectedPerson.person_id;
      
      try {
        const response = await fetch(`/api/person/${personId}`, {
          method: 'DELETE',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ password: password })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          alert(`‚úÖ ${result.message}`);
          
          // ƒê√≥ng modal v√† panel
          closeDeleteModal();
          closeDetailPanel();
          
          // X√≥a kh·ªèi input t√¨m ki·∫øm
          const nameInput = document.getElementById('lineageName');
          if (nameInput) {
            nameInput.value = '';
          }
          
          // ·∫®n k·∫øt qu·∫£
          const resultDiv = document.getElementById('lineageResult');
          if (resultDiv) {
            resultDiv.style.display = 'none';
          }
          
          // Reload d·ªØ li·ªáu (reload trang ƒë·ªÉ c·∫≠p nh·∫≠t)
          setTimeout(() => {
            location.reload();
          }, 1000);
        } else {
          alert('‚ùå L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ x√≥a ng∆∞·ªùi n√†y'));
        }
      } catch (error) {
        console.error('L·ªói khi x√≥a:', error);
        alert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
      }
    }
    
    /**
     * Chuy·ªÉn sang ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
     */
    function enableEditMode() {
      if (!selectedPerson) return;
      
      isEditMode = true;
      const content = document.getElementById('lineageDetailContent');
      const person = selectedPerson;
      
      content.innerHTML = `
        <form id="personEditForm" onsubmit="savePersonData(event)">
          <div class="detail-form">
            <div class="form-group">
              <label>T√™n ƒë·∫ßy ƒë·ªß:</label>
              <input type="text" name="full_name" value="${(person.full_name || '').replace(/"/g, '&quot;')}" required>
            </div>
            <div class="form-group">
              <label>ƒê·ªùi:</label>
              <input type="number" name="generation_number" value="${person.generation_number || ''}" min="1" required>
            </div>
            <div class="form-group">
              <label>Gi·ªõi t√≠nh:</label>
              <select name="gender">
                <option value="Nam" ${person.gender === 'Nam' ? 'selected' : ''}>Nam</option>
                <option value="N·ªØ" ${person.gender === 'N·ªØ' ? 'selected' : ''}>N·ªØ</option>
                <option value="Kh√°c" ${person.gender === 'Kh√°c' ? 'selected' : ''}>Kh√°c</option>
              </select>
            </div>
            <div class="form-group">
              <label>T√™n b·ªë:</label>
              <input type="text" name="father_name" value="${(person.father_name || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-group">
              <label>T√™n m·∫π:</label>
              <input type="text" name="mother_name" value="${(person.mother_name || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-group">
              <label>Nh√°nh:</label>
              <input type="text" name="branch_name" value="${(person.branch_name || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-group">
              <label>Tr·∫°ng th√°i:</label>
              <select name="status">
                <option value="C√≤n s·ªëng" ${person.status === 'C√≤n s·ªëng' ? 'selected' : ''}>C√≤n s·ªëng</option>
                <option value="ƒê√£ m·∫•t" ${person.status === 'ƒê√£ m·∫•t' ? 'selected' : ''}>ƒê√£ m·∫•t</option>
                <option value="Kh√¥ng r√µ" ${person.status === 'Kh√¥ng r√µ' || !person.status ? 'selected' : ''}>Kh√¥ng r√µ</option>
              </select>
            </div>
            <div class="form-group">
              <label>Ng√†y sinh (D∆∞∆°ng l·ªãch):</label>
              <input type="date" name="birth_date_solar" value="${person.birth_date_solar || ''}">
            </div>
            <div class="form-group">
              <label>Ng√†y sinh (√Çm l·ªãch):</label>
              <input type="date" name="birth_date_lunar" value="${person.birth_date_lunar || ''}">
            </div>
            <div class="form-group">
              <label>N∆°i sinh:</label>
              <input type="text" name="birth_location" value="${(person.birth_location || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-group">
              <label>Ng√†y m·∫•t (D∆∞∆°ng l·ªãch):</label>
              <input type="date" name="death_date_solar" value="${person.death_date_solar || ''}">
            </div>
            <div class="form-group">
              <label>Ng√†y m·∫•t (√Çm l·ªãch):</label>
              <input type="date" name="death_date_lunar" value="${person.death_date_lunar || ''}">
            </div>
            <div class="form-group">
              <label>N∆°i m·∫•t:</label>
              <input type="text" name="death_location" value="${(person.death_location || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-group">
              <label>Nguy√™n qu√°n:</label>
              <input type="text" name="origin_location" value="${(person.origin_location || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-group">
              <label>Qu·ªëc t·ªãch:</label>
              <input type="text" name="nationality" value="${(person.nationality || 'Vi·ªát Nam').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-group">
              <label>T√¥n gi√°o:</label>
              <input type="text" name="religion" value="${(person.religion || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-group">
              <label>Anh/Ch·ªã/Em:</label>
              <textarea name="siblings" rows="2">${(person.siblings || '').replace(/"/g, '&quot;')}</textarea>
            </div>
            <div class="form-group">
              <label>H√¥n ph·ªëi:</label>
              <textarea name="spouse" rows="2">${(person.spouse || '').replace(/"/g, '&quot;')}</textarea>
            </div>
            <div class="form-group">
              <label>Th√¥ng tin con:</label>
              <textarea name="children" rows="3">${(person.children || '').replace(/"/g, '&quot;')}</textarea>
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn-cancel" onclick="cancelEdit()">H·ªßy</button>
            <button type="submit" class="btn-save">üíæ L∆∞u thay ƒë·ªïi</button>
            <button type="button" class="btn-sync" onclick="syncPersonData()" style="background: #28a745; color: white; margin-left: 10px;">üîÑ ƒê·ªìng b·ªô</button>
          </div>
        </form>
      `;
    }

    /**
     * H·ªßy ch·ªânh s·ª≠a, quay v·ªÅ ch·∫ø ƒë·ªô xem
     */
    function cancelEdit() {
      isEditMode = false;
      if (selectedPerson) {
        renderDetailPanel(selectedPerson);
      }
    }
    
    /**
     * M·ªü modal g·ª≠i y√™u c·∫ßu ch·ªânh s·ª≠a
     */
    function openRequestModal() {
      if (!selectedPerson) return;
      
      let modal = document.getElementById('requestEditModal');
      if (!modal) {
        // T·∫°o modal n·∫øu ch∆∞a c√≥
        const modalHTML = `
          <div id="requestEditModal" class="modal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto;">
            <div class="modal-content" style="background: white; margin: 5% auto; padding: 30px; border-radius: 8px; width: 90%; max-width: 600px;">
              <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #8B0000; margin: 0;">üìù G·ª≠i y√™u c·∫ßu c·∫≠p nh·∫≠t th√¥ng tin</h3>
                <span class="close" onclick="closeRequestModal()" style="cursor: pointer; font-size: 28px; color: #999; font-weight: bold;">&times;</span>
              </div>
              <form id="requestEditForm" onsubmit="submitEditRequest(event)">
                <input type="hidden" id="request_person_id" value="${selectedPerson.person_id}">
                <input type="hidden" id="request_person_name" value="${selectedPerson.full_name}">
                <input type="hidden" id="request_person_generation" value="${selectedPerson.generation_number}">
                
                <div class="form-group" style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; color: #8B0000; font-weight: 600;">Ng∆∞·ªùi c·∫ßn c·∫≠p nh·∫≠t th√¥ng tin:</label>
                  <div style="padding: 12px; background: #f5f5f5; border-radius: 6px; border: 1px solid #e0e0e0;">
                    <strong style="color: #8B0000;">${selectedPerson.full_name}</strong> <span style="color: #666;">(ƒê·ªùi ${selectedPerson.generation_number})</span>
                  </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                  <label for="request_full_name" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">H·ªç v√† t√™n *</label>
                  <input type="text" id="request_full_name" name="full_name" required 
                         placeholder="Nh·∫≠p h·ªç v√† t√™n c·ªßa b·∫°n"
                         style="width: 100%; padding: 12px; border: 2px solid #DAA520; border-radius: 6px; font-size: 16px; font-family: 'Noto Serif TC', serif;">
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                  <label for="request_contact" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">Email ho·∫∑c SƒêT *</label>
                  <input type="text" id="request_contact" name="contact" required 
                         placeholder="Nh·∫≠p email ho·∫∑c s·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n"
                         style="width: 100%; padding: 12px; border: 2px solid #DAA520; border-radius: 6px; font-size: 16px; font-family: 'Noto Serif TC', serif;">
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                  <label for="request_content" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">N·ªôi dung c·∫ßn c·∫≠p nh·∫≠t *</label>
                  <textarea id="request_content" name="content" rows="6" required 
                            placeholder="Vui l√≤ng m√¥ t·∫£ chi ti·∫øt nh·ªØng th√¥ng tin b·∫°n mu·ªën c·∫≠p nh·∫≠t cho ${selectedPerson.full_name}..."
                            style="width: 100%; padding: 12px; border: 2px solid #DAA520; border-radius: 6px; font-size: 16px; font-family: 'Noto Serif TC', serif; resize: vertical;"></textarea>
                </div>
                
                <div class="form-actions" style="display: flex; gap: 10px; margin-top: 30px;">
                  <button type="button" class="btn-cancel" onclick="closeRequestModal()" style="flex: 1; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; background: #757575; color: white;">H·ªßy</button>
                  <button type="submit" class="btn-save" style="flex: 1; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%); color: #FFD700;">üì§ G·ª≠i y√™u c·∫ßu</button>
                </div>
              </form>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        modal = document.getElementById('requestEditModal');
      }
      
      // C·∫≠p nh·∫≠t gi√° tr·ªã
      document.getElementById('request_person_id').value = selectedPerson.person_id;
      document.getElementById('request_person_name').value = selectedPerson.full_name;
      document.getElementById('request_person_generation').value = selectedPerson.generation_number || '';
      document.getElementById('request_full_name').value = '';
      document.getElementById('request_contact').value = '';
      document.getElementById('request_content').value = '';
      
      modal.style.display = 'block';
    }
    
    /**
     * ƒê√≥ng modal request
     */
    function closeRequestModal() {
      const modal = document.getElementById('requestEditModal');
      if (modal) {
        modal.style.display = 'none';
        const form = document.getElementById('requestEditForm');
        if (form) form.reset();
      }
    }
    
    /**
     * G·ª≠i y√™u c·∫ßu ch·ªânh s·ª≠a
     */
    async function submitEditRequest(event) {
      event.preventDefault();
      
      const personId = document.getElementById('request_person_id').value;
      const personName = document.getElementById('request_person_name').value;
      const personGeneration = document.getElementById('request_person_generation').value;
      const fullName = document.getElementById('request_full_name').value.trim();
      const contact = document.getElementById('request_contact').value.trim();
      const content = document.getElementById('request_content').value.trim();
      
      if (!fullName || !contact || !content) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
        return;
      }
      
      try {
        const response = await fetch('/api/send-edit-request-email', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            person_id: personId, // Gi·ªØ nguy√™n string (P-1-1 format)
            person_name: personName,
            person_generation: parseInt(personGeneration),
            requester_name: fullName,
            requester_contact: contact,
            content: content
          })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          alert('‚úÖ Y√™u c·∫ßu c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i t·ªõi email baophongcmu@gmail.com. C·∫£m ∆°n b·∫°n ƒë√£ ƒë√≥ng g√≥p!');
          closeRequestModal();
        } else {
          alert('‚ùå L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ g·ª≠i y√™u c·∫ßu'));
        }
      } catch (error) {
        console.error('L·ªói khi g·ª≠i y√™u c·∫ßu:', error);
        alert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
      }
    }

    /**
     * ƒê√≥ng detail panel
     */
    function closeDetailPanel() {
      const panel = document.getElementById('lineageDetailPanel');
      panel.style.display = 'none';
    }

    /**
     * L∆∞u d·ªØ li·ªáu Person ƒë√£ ch·ªânh s·ª≠a
     */
    function savePersonData(event) {
      event.preventDefault();
      
      if (!selectedPerson || !selectedPerson.person_id) {
        alert('L·ªói: Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·ªÉ c·∫≠p nh·∫≠t');
        return;
      }
      
      const form = event.target;
      const formData = new FormData(form);
      
      // Thu th·∫≠p T·∫§T C·∫¢ d·ªØ li·ªáu t·ª´ form
      const updates = {};
      for (const [key, value] of formData.entries()) {
        if (key === 'generation_number') {
          updates[key] = parseInt(value, 10);
        } else if (value && value.trim()) {
          updates[key] = value.trim();
        }
      }
      
      // Hi·ªÉn th·ªã loading
      const submitButton = form.querySelector('button[type="submit"]');
      const originalText = submitButton ? submitButton.innerHTML : '';
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.innerHTML = '‚è≥ ƒêang l∆∞u...';
      }
      
      // G·ª≠i T·∫§T C·∫¢ d·ªØ li·ªáu l√™n server ƒë·ªÉ l∆∞u v√†o database
      fetch(`/api/person/${selectedPerson.person_id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(updates)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log('[API] ƒê√£ l∆∞u v√†o database:', data);
          
          // Reload l·∫°i d·ªØ li·ªáu t·ª´ server ƒë·ªÉ c√≥ d·ªØ li·ªáu m·ªõi nh·∫•t
          return fetch(`/api/person/${selectedPerson.person_id}`)
            .then(response => response.json())
            .then(personData => {
              if (personData && !personData.error) {
                selectedPerson = personData;
                
                // C·∫≠p nh·∫≠t trong memory (n·∫øu c√≥ GenealogyLineage)
                if (window.GenealogyLineage) {
                  window.GenealogyLineage.updatePerson(selectedPerson.person_id, updates);
                }
                
                alert('‚úÖ ƒê√£ c·∫≠p nh·∫≠t v√† ƒë·ªìng b·ªô th√¥ng tin th√†nh c√¥ng!');
                
                // Refresh hi·ªÉn th·ªã n·∫øu c√≥ thay ƒë·ªïi v·ªÅ t√™n, ƒë·ªùi, ho·∫∑c cha/m·∫π
                if (updates.father_name !== undefined || updates.mother_name !== undefined || 
                    updates.full_name !== undefined || updates.generation_number !== undefined) {
                  displayLineageForPerson(selectedPerson);
                }
                
                // Hi·ªÉn th·ªã l·∫°i panel v·ªõi d·ªØ li·ªáu m·ªõi
                isEditMode = false;
                showDetailPanel(selectedPerson);
              } else {
                throw new Error('Kh√¥ng th·ªÉ t·∫£i l·∫°i d·ªØ li·ªáu t·ª´ server');
              }
            });
        } else {
          throw new Error(data.error || 'L·ªói khi l∆∞u d·ªØ li·ªáu');
        }
      })
      .catch(error => {
        console.error('[API] L·ªói khi l∆∞u v√†o database:', error);
        alert('‚ùå L·ªói khi l∆∞u d·ªØ li·ªáu: ' + error.message);
      })
      .finally(() => {
        // Kh√¥i ph·ª•c button
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.innerHTML = originalText;
        }
      });
    }

    /**
     * ƒê·ªìng b·ªô d·ªØ li·ªáu Person sau khi c·∫≠p nh·∫≠t
     * ƒê·ªìng b·ªô relationships, marriages_spouses, v√† t√≠nh l·∫°i siblings
     */
    function syncPersonData() {
      if (!selectedPerson || !selectedPerson.person_id) {
        alert('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·ªÉ ƒë·ªìng b·ªô');
        return;
      }

      if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒë·ªìng b·ªô d·ªØ li·ªáu? D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t theo th√¥ng tin m·ªõi nh·∫•t.')) {
        return;
      }

      // Hi·ªÉn th·ªã loading
      const syncButton = document.querySelector('.btn-sync');
      const originalText = syncButton ? syncButton.innerHTML : '';
      if (syncButton) {
        syncButton.disabled = true;
        syncButton.innerHTML = '‚è≥ ƒêang ƒë·ªìng b·ªô...';
      }

      fetch(`/api/person/${selectedPerson.person_id}/sync`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('‚úÖ ƒê√£ ƒë·ªìng b·ªô d·ªØ li·ªáu th√†nh c√¥ng!\n\n' + (data.message || ''));
          
          // Reload l·∫°i d·ªØ li·ªáu person t·ª´ server
          fetch(`/api/person/${selectedPerson.person_id}`)
            .then(response => response.json())
            .then(personData => {
              if (personData && !personData.error) {
                selectedPerson = personData;
                showDetailPanel(personData);
                
                // Reload l·∫°i danh s√°ch persons n·∫øu c·∫ßn
                if (window.GenealogyLineage && personData) {
                  window.GenealogyLineage.updatePerson(personData.person_id, personData);
                }
              }
            })
            .catch(error => {
              console.error('[API] L·ªói khi reload d·ªØ li·ªáu:', error);
            });
        } else {
          alert('‚ùå L·ªói khi ƒë·ªìng b·ªô: ' + (data.error || 'Kh√¥ng x√°c ƒë·ªãnh'));
        }
      })
      .catch(error => {
        console.error('[API] L·ªói khi ƒë·ªìng b·ªô:', error);
        alert('‚ùå L·ªói khi ƒë·ªìng b·ªô d·ªØ li·ªáu: ' + error.message);
      })
      .finally(() => {
        // Kh√¥i ph·ª•c button
        if (syncButton) {
          syncButton.disabled = false;
          syncButton.innerHTML = originalText;
        }
      });
    }

    /**
     * Kh·ªüi t·∫°o lineage module khi d·ªØ li·ªáu ƒë√£ load
     */
    window.initLineageModule = function(persons) {
      if (window.GenealogyLineage && persons && persons.length > 0) {
        personsDataForLineage = persons;
        window.GenealogyLineage.init(persons);
        console.log('[Lineage] Module ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o v·ªõi', persons.length, 'ng∆∞·ªùi');
      }
    };

    // ƒê√≥ng suggestions khi click ra ngo√†i
    document.addEventListener('click', (e) => {
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      const nameInput = document.getElementById('lineageName');
      
      if (suggestionsDiv && nameInput && !suggestionsDiv.contains(e.target) && e.target !== nameInput) {
        suggestionsDiv.style.display = 'none';
      }
      
      // ƒê√≥ng modal m·∫≠t kh·∫©u khi click ra ngo√†i
      const passwordModal = document.getElementById('passwordModal');
      if (passwordModal && e.target === passwordModal) {
        closePasswordModal();
      }
      
      // ƒê√≥ng modal x√≥a khi click ra ngo√†i
      const deleteModal = document.getElementById('deleteConfirmModal');
      if (deleteModal && e.target === deleteModal) {
        closeDeleteModal();
      }
    });

    // Initialize lineage search functionality when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      console.log('[Lineage] Initializing lineage search...');
      
      const nameInput = document.getElementById('lineageName');
      const btnSearchLineage = document.getElementById('btnSearchLineage');
      
      // Enter key handler
      if (nameInput) {
        nameInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            searchLineage();
          }
        });
        console.log('[Lineage] Enter key handler attached');
      } else {
        console.warn('[Lineage] lineageName input not found');
      }
      
      // Button click handler (if not already handled by onclick)
      if (btnSearchLineage && !btnSearchLineage.onclick) {
        btnSearchLineage.addEventListener('click', (e) => {
          e.preventDefault();
          searchLineage();
        });
        console.log('[Lineage] Search button handler attached');
      }
      
      console.log('[Lineage] Lineage search initialized');
    });

    /**
     * T√≠nh to√°n v·ªã tr√≠ cho horizontal layout (generations d·ªçc, people ngang)
     */
    function calculateHorizontalPositions(node, x = 0, y = 0, levelPositions = {}) {
      if (!node) return { x: 0, nextX: 0 };

      const depth = node.depth || 0;
      if (!levelPositions[depth]) {
        levelPositions[depth] = 0;
      }

      // Y = generation (d·ªçc) - d√πng generation th·ª±c t·∫ø
      const generation = node.generation || depth;
      node.y = (generation - 1) * 120 + 50;

      const horizontalSpacing = 180;
      if (node.children.length === 0) {
        node.x = levelPositions[depth] * horizontalSpacing + 20;
        levelPositions[depth]++;
        return { x: node.x, nextX: levelPositions[depth] * horizontalSpacing };
      }

      // T√≠nh v·ªã tr√≠ cho children tr∆∞·ªõc
      let childX = levelPositions[depth] * horizontalSpacing;
      let maxChildX = childX;

      node.children.forEach((child, index) => {
        const childResult = calculateHorizontalPositions(child, 0, 0, levelPositions);
        if (index === 0) {
          childX = childResult.x;
        }
        maxChildX = Math.max(maxChildX, childResult.nextX);
      });

      // ƒê·∫∑t parent ·ªü gi·ªØa children
      if (node.children.length > 0) {
        const firstChildX = node.children[0].x;
        const lastChildX = node.children[node.children.length - 1].x;
        node.x = (firstChildX + lastChildX) / 2;
      } else {
        node.x = levelPositions[depth] * horizontalSpacing + 20;
        levelPositions[depth]++;
      }

      return { x: childX, nextX: maxChildX };
    }


    /**
     * Render family tree v√†o Activities section (ƒê·ªùi 1-5) - Horizontal Layout
     */
    function renderActivitiesTree() {
      const container = document.getElementById('activitiesTreeContainer');
      if (!container) return;
      
      // Ki·ªÉm tra data ƒë√£ load ch∆∞a
      if (typeof personMap === 'undefined' || !personMap || personMap.size === 0) {
        container.innerHTML = '<div class="tree-loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>';
        setTimeout(renderActivitiesTree, 1000);
        return;
      }
      
      if (typeof buildDefaultTree === 'undefined' || typeof createNodeElement === 'undefined') {
        container.innerHTML = '<div class="tree-loading">ƒêang t·∫£i modules...</div>';
        setTimeout(renderActivitiesTree, 1000);
        return;
      }
      
      container.innerHTML = '';
      
      if (!founderId) {
        container.innerHTML = '<div class="tree-loading">Kh√¥ng t√¨m th·∫•y Vua Minh M·∫°ng</div>';
        return;
      }
      
      try {
        // Build tree t·ª´ ƒë·ªùi 1 ƒë·∫øn ƒë·ªùi 5
        const treeRoot = buildDefaultTree(5);
        if (!treeRoot) {
          container.innerHTML = '<div class="tree-loading">Kh√¥ng th·ªÉ x√¢y d·ª±ng c√¢y gia ph·∫£</div>';
          return;
        }
        
        // Render tree v·ªõi horizontal layout
        const treeDiv = document.createElement('div');
        treeDiv.className = 'tree horizontal-tree';
        treeDiv.style.position = 'relative';
        
        const levelPositions = {};
        calculateHorizontalPositions(treeRoot, 0, 0, levelPositions);
        
        // T·∫°o SVG container cho connectors
        const svgContainer = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svgContainer.style.position = 'absolute';
        svgContainer.style.left = '0';
        svgContainer.style.top = '0';
        svgContainer.style.width = '100%';
        svgContainer.style.height = '100%';
        svgContainer.style.pointerEvents = 'none';
        svgContainer.style.zIndex = '1';
        treeDiv.appendChild(svgContainer);
        
        // Render nodes
        function renderNode(node) {
          if (!node) return;
          
          const person = personMap.get(node.id);
          if (!person) return;
          
          const isFounder = node.id === founderId;
          const nodeDiv = createNodeElement(person, false, isFounder);
          nodeDiv.style.position = 'absolute';
          nodeDiv.style.left = node.x + 'px';
          nodeDiv.style.top = node.y + 'px';
          nodeDiv.style.zIndex = '2';
          
          treeDiv.appendChild(nodeDiv);
          
          // V·∫Ω connectors (s·ª≠ d·ª•ng svgContainer ƒë√£ t·∫°o)
          if (node.parent) {
            const parentX = node.parent.x + 80;
            const parentY = node.parent.y + 30;
            const childX = node.x + 80;
            const childY = node.y + 30;

            // ƒê∆∞·ªùng d·ªçc t·ª´ parent xu·ªëng
            const line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line1.setAttribute('x1', parentX);
            line1.setAttribute('y1', parentY);
            line1.setAttribute('x2', parentX);
            line1.setAttribute('y2', childY);
            line1.setAttribute('stroke', '#DAA520');
            line1.setAttribute('stroke-width', '2');
            svgContainer.appendChild(line1);

            // ƒê∆∞·ªùng ngang ƒë·∫øn child
            const line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line2.setAttribute('x1', parentX);
            line2.setAttribute('y1', childY);
            line2.setAttribute('x2', childX);
            line2.setAttribute('y2', childY);
            line2.setAttribute('stroke', '#DAA520');
            line2.setAttribute('stroke-width', '2');
            svgContainer.appendChild(line2);
          }
          
          // Render children
          node.children.forEach(child => renderNode(child));
        }
        
        renderNode(treeRoot);
        
        // T√≠nh k√≠ch th∆∞·ªõc
        let maxX = 0, maxY = 0;
        function findMaxBounds(node) {
          if (!node) return;
          maxX = Math.max(maxX, node.x + 200);
          maxY = Math.max(maxY, node.y + 100);
          node.children.forEach(child => findMaxBounds(child));
        }
        findMaxBounds(treeRoot);
        
        treeDiv.style.width = Math.max(maxX, 1200) + 'px';
        treeDiv.style.height = Math.max(maxY, 600) + 'px';
        
        container.appendChild(treeDiv);
      } catch (error) {
        console.error('L·ªói khi render activities tree:', error);
        container.innerHTML = '<div class="tree-loading">L·ªói khi hi·ªÉn th·ªã c√¢y gia ph·∫£</div>';
      }
    }
    
    // Render tree khi data ƒë√£ load
    // S·ª≠ d·ª•ng event ho·∫∑c polling ƒë·ªÉ ch·ªù data load
    document.addEventListener('DOMContentLoaded', () => {
      // Th·ª≠ render ngay
      setTimeout(renderActivitiesTree, 2000);
      
      // Ho·∫∑c l·∫Øng nghe event khi data load xong
      const checkDataInterval = setInterval(() => {
        if (typeof personMap !== 'undefined' && personMap && personMap.size > 0) {
          clearInterval(checkDataInterval);
          renderActivitiesTree();
        }
      }, 500);
      
      // D·ª´ng sau 30 gi√¢y
      setTimeout(() => clearInterval(checkDataInterval), 30000);
    });
  </script>

  <!-- Section: Member Stats -->
  <section id="stats">
    <div class="section-container">
      <h2 class="section-title">Th·ªëng K√™ Th√†nh Vi√™n</h2>
      <p class="stats-subtitle">
        Th·ªëng k√™ nhanh s·ªë l∆∞·ª£ng th√†nh vi√™n trong gia ph·∫£ Tuy Bi√™n Ph√≤ng ‚Äì Nam, N·ªØ v√† c√°c tr∆∞·ªùng h·ª£p ch∆∞a r√µ.
      </p>

      <div class="stats-layout">
        <div class="stats-summary">
          <div class="stats-card">
            <div class="stats-label">T·ªïng th√†nh vi√™n</div>
            <div class="stats-value" id="statsTotalMembers">‚Äì</div>
          </div>
          <div class="stats-card">
            <div class="stats-label">S·ªë Nam</div>
            <div class="stats-value" id="statsMaleCount">‚Äì</div>
          </div>
          <div class="stats-card">
            <div class="stats-label">S·ªë N·ªØ</div>
            <div class="stats-value" id="statsFemaleCount">‚Äì</div>
          </div>
          <div class="stats-card">
            <div class="stats-label">Kh√¥ng r√µ / kh√°c</div>
            <div class="stats-value" id="statsUnknownCount">‚Äì</div>
          </div>
        </div>

        <div class="stats-charts">
          <div class="stats-chart-card">
            <h3>C∆° c·∫•u gi·ªõi t√≠nh</h3>
            <canvas id="genderPieChart"></canvas>
          </div>
          <div class="stats-chart-card">
            <h3>Th√†nh vi√™n theo gi·ªõi t√≠nh</h3>
            <canvas id="genderBarChart"></canvas>
          </div>
        </div>
      </div>

      <div id="statsErrorMessage" style="display:none; margin-top:20px; text-align:center; color:#b71c1c; font-weight:600;">
        L·ªói: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu th·ªëng k√™. Vui l√≤ng th·ª≠ l·∫°i sau.
      </div>
    </div>
  </section>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Load genealogy scripts -->
  <script src="/static/js/family-tree-core.js"></script>
  <script src="/static/js/family-tree-ui.js"></script>
  <script src="/static/js/genealogy-lineage.js"></script>

  <script>
    // Generic fetch helper to ensure JSON responses and better error logging
    async function fetchJson(url, options) {
      const res = await fetch(url, options);
      const contentType = res.headers.get('Content-Type') || '';
      const text = await res.text();

      if (!res.ok) {
        console.error('HTTP error for', url, res.status, text);
        throw new Error(`HTTP ${res.status} when fetching ${url}`);
      }

      if (!contentType.includes('application/json')) {
        console.error('Non-JSON response for', url, 'contentType =', contentType, 'body =', text.slice(0, 300));
        throw new Error(`Expected JSON but got non-JSON response from ${url}`);
      }

      try {
        return JSON.parse(text);
      } catch (e) {
        console.error('JSON parse error for', url, 'body =', text.slice(0, 300));
        throw e;
      }
    }
  </script>
  
  <!-- Member statistics -->
  <script>
    async function loadMemberStats() {
      const errorEl = document.getElementById('statsErrorMessage');
      try {
        const data = await fetchJson('/api/stats/members');
        const total = data.total_members || 0;
        const male = data.male_count || 0;
        const female = data.female_count || 0;
        const unknown = data.unknown_gender_count || 0;

        document.getElementById('statsTotalMembers').textContent = total.toLocaleString('vi-VN');
        document.getElementById('statsMaleCount').textContent = male.toLocaleString('vi-VN');
        document.getElementById('statsFemaleCount').textContent = female.toLocaleString('vi-VN');
        document.getElementById('statsUnknownCount').textContent = unknown.toLocaleString('vi-VN');

        renderGenderCharts({ male, female, unknown });
      } catch (err) {
        console.error('Error loading stats:', err);
        if (errorEl) errorEl.style.display = 'block';
      }
    }

    function renderGenderCharts({ male, female, unknown }) {
      const pieCtx = document.getElementById('genderPieChart')?.getContext('2d');
      const barCtx = document.getElementById('genderBarChart')?.getContext('2d');
      if (!pieCtx || !barCtx || typeof Chart === 'undefined') return;

      const labels = ['Nam', 'N·ªØ', 'Kh√¥ng r√µ / kh√°c'];
      const values = [male, female, unknown];

      new Chart(pieCtx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: ['#1976d2', '#e91e63', '#9e9e9e'],
            borderWidth: 1
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      new Chart(barCtx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'S·ªë l∆∞·ª£ng',
            data: values,
            backgroundColor: ['#1976d2', '#e91e63', '#9e9e9e']
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          }
        }
      });
    }
  </script>
  
  <!-- Load activities and stats (tree is loaded separately by initGenealogyTree) -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Load activities preview (public)
      loadActivitiesPreview(4);

      // Load member statistics
      loadMemberStats();
    });
  </script>

  <script>
    // Mini Carousel for homepage
    let miniCarouselActivities = [];
    let currentMiniSlideIndex = 0;
    let miniAutoPlayInterval = null;
    let miniAutoPlayPaused = false;

    function initMiniCarousel(activities) {
      // Filter activities with images, limit to 5
      miniCarouselActivities = activities.filter(a => {
        const img = a.thumbnail || a.image_url;
        return img && img.trim() !== '';
      }).slice(0, 5);

      if (miniCarouselActivities.length === 0) {
        document.getElementById('activitiesMiniSlider').style.display = 'none';
        return;
      }

      const sliderEl = document.getElementById('activitiesMiniSlider');
      const slidesContainer = document.getElementById('miniSliderSlides');
      const dotsContainer = document.getElementById('miniSliderDots');

      sliderEl.style.display = 'block';

      // Build slides
      slidesContainer.innerHTML = miniCarouselActivities.map((activity, index) => {
        const img = activity.thumbnail || activity.image_url;
        const date = activity.created_at ? new Date(activity.created_at).toLocaleDateString('vi-VN') : '';
        return `
          <div class="mini-slider-slide ${index === 0 ? 'active' : ''}" data-index="${index}" style="display: none; position: relative;">
            <a href="/activities?id=${activity.id || ''}" style="display:block;text-decoration:none;">
              <img src="${escapeHtml(img)}" alt="${escapeHtml(activity.title || '')}" style="width:100%;height:240px;object-fit:cover;display:block;" loading="lazy">
              <div style="position:absolute;left:0;bottom:0;right:0;padding:12px 16px;background:linear-gradient(to top, rgba(0,0,0,0.7), transparent);color:#fff;">
                <h3 style="color:#fff;font-size:18px;margin:0 0 4px 0;text-shadow:0 2px 4px rgba(0,0,0,0.5);">${escapeHtml(activity.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ')}</h3>
                <p style="color:rgba(255,255,255,0.95);font-size:12px;margin:0;text-shadow:0 1px 2px rgba(0,0,0,0.5);">${date ? 'üìÖ ' + date : ''}</p>
              </div>
            </a>
          </div>
        `;
      }).join('');

      // Show first slide
      document.querySelectorAll('.mini-slider-slide').forEach((slide, i) => {
        slide.style.display = i === 0 ? 'block' : 'none';
      });

      // Build dots
      dotsContainer.innerHTML = miniCarouselActivities.map((_, index) => 
        `<span class="mini-slider-dot ${index === 0 ? 'active' : ''}" data-index="${index}" style="width:10px;height:10px;border-radius:50%;background:${index === 0 ? '#DAA520' : '#ddd'};cursor:pointer;transition:background 0.3s;"></span>`
      ).join('');

      // Event listeners
      document.getElementById('miniSliderPrev').addEventListener('click', () => {
        pauseMiniAutoPlay();
        prevMiniSlide();
      });
      document.getElementById('miniSliderNext').addEventListener('click', () => {
        pauseMiniAutoPlay();
        nextMiniSlide();
      });

      dotsContainer.querySelectorAll('.mini-slider-dot').forEach(dot => {
        dot.addEventListener('click', () => {
          pauseMiniAutoPlay();
          const index = parseInt(dot.getAttribute('data-index'));
          showMiniSlide(index);
        });
      });

      // Start auto-play
      startMiniAutoPlay();
    }

    function showMiniSlide(index) {
      if (miniCarouselActivities.length === 0) return;
      
      currentMiniSlideIndex = index;
      if (currentMiniSlideIndex < 0) currentMiniSlideIndex = miniCarouselActivities.length - 1;
      if (currentMiniSlideIndex >= miniCarouselActivities.length) currentMiniSlideIndex = 0;

      // Update slides
      document.querySelectorAll('.mini-slider-slide').forEach((slide, i) => {
        slide.style.display = i === currentMiniSlideIndex ? 'block' : 'none';
      });

      // Update dots
      document.querySelectorAll('.mini-slider-dot').forEach((dot, i) => {
        dot.style.background = i === currentMiniSlideIndex ? '#DAA520' : '#ddd';
      });
    }

    function nextMiniSlide() {
      showMiniSlide(currentMiniSlideIndex + 1);
    }

    function prevMiniSlide() {
      showMiniSlide(currentMiniSlideIndex - 1);
    }

    function startMiniAutoPlay() {
      if (miniAutoPlayInterval) clearInterval(miniAutoPlayInterval);
      miniAutoPlayInterval = setInterval(() => {
        if (!miniAutoPlayPaused) {
          nextMiniSlide();
        }
      }, 5000); // 5 seconds
    }

    function pauseMiniAutoPlay() {
      miniAutoPlayPaused = true;
      setTimeout(() => {
        miniAutoPlayPaused = false;
      }, 8000); // Resume after 8 seconds
    }

    // Load activities preview into homepage
    async function loadActivitiesPreview(limit = 4) {
      const container = document.getElementById('activitiesPreview');
      if (!container) return;
      container.innerHTML = '<div class="tree-loading" style="grid-column:1/-1;text-align:center;">ƒêang t·∫£i ho·∫°t ƒë·ªông...</div>';
      try {
        const data = await fetchJson(`/api/activities?status=published&limit=10`);
        if (!data || !Array.isArray(data)) {
          throw new Error('Kh√¥ng th·ªÉ t·∫£i ho·∫°t ƒë·ªông');
        }
        if (data.length === 0) {
          container.innerHTML = '<div class="tree-loading" style="grid-column:1/-1;text-align:center;">Ch∆∞a c√≥ b√†i vi·∫øt</div>';
          return;
        }
        
        // Initialize mini carousel
        initMiniCarousel(data);
        
        // Render preview cards
        const cards = data.slice(0, limit).map(post => {
          const date = post.created_at ? new Date(post.created_at).toLocaleDateString('vi-VN') : '';
          const summary = post.summary || post.description || '';
          return `
            <div class="activity-card">
              <h3>${escapeHtml(post.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ')}</h3>
              <div class="activity-date">${date ? 'üìÖ ' + date : ''}</div>
              <div class="activity-description">
                ${escapeHtml(summary).substring(0, 180)}${summary && summary.length > 180 ? '...' : ''}
              </div>
              <div style="margin-top:12px;">
                <a href="/activities?id=${post.id || ''}" style="color:#8B0000;font-weight:600;text-decoration:none;">ƒê·ªçc ti·∫øp ‚Üí</a>
              </div>
            </div>
          `;
        }).join('');
        container.innerHTML = cards;
      } catch (err) {
        console.error('L·ªói khi t·∫£i ho·∫°t ƒë·ªông:', err);
        container.innerHTML = `<div class="tree-loading" style="grid-column:1/-1;text-align:center;color:#856404;background:#fff3cd;border:1px solid #ffeeba;border-radius:8px;padding:12px;">L·ªói: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ho·∫°t ƒë·ªông, vui l√≤ng th·ª≠ l·∫°i sau.</div>`;
      }
    }

    // Simple escape helper
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ============================================
    // INTERACTIVE GENEALOGY TREE
    // ============================================
    
    // Load vis-network from CDN
    const visScript = document.createElement('script');
    visScript.src = 'https://unpkg.com/vis-network@latest/standalone/umd/vis-network.min.js';
    visScript.onload = () => {
      console.log('[Tree] vis-network loaded, initializing tree...');
      try {
        initGenealogyTree();
      } catch (err) {
        console.error('[Tree] Error initializing tree:', err);
        const container = document.getElementById('treeContainer');
        if (container) {
          container.innerHTML = `
            <div style="padding: 20px; color: #d32f2f; text-align: center;">
              <h3>L·ªói khi kh·ªüi t·∫°o c√¢y gia ph·∫£</h3>
              <p>${err.message}</p>
              <p style="margin-top: 10px; font-size: 14px; color: #666;">
                Vui l√≤ng ki·ªÉm tra console ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.
              </p>
            </div>
          `;
        }
      }
    };
    visScript.onerror = () => {
      console.error('[Tree] Failed to load vis-network');
      const container = document.getElementById('treeContainer');
      if (container) {
        container.innerHTML = `
          <div style="padding: 20px; color: #d32f2f; text-align: center;">
            <h3>Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán vis-network</h3>
            <p>Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet v√† th·ª≠ l·∫°i.</p>
          </div>
        `;
      }
    };
    document.head.appendChild(visScript);
    
    const visStyle = document.createElement('link');
    visStyle.rel = 'stylesheet';
    visStyle.href = 'https://unpkg.com/vis-network@latest/styles/vis-network.min.css';
    document.head.appendChild(visStyle);

    let network = null;
    let currentRootId = 'P-1-1'; // Default: Vua Minh M·∫°ng (ph·∫£i l√† string, kh√¥ng ph·∫£i s·ªë)
    let currentMaxGen = 5;
    let treeData = null;

    async function initGenealogyTree() {
      console.log('[Tree] Initializing genealogy tree...');
      
      // Check if required elements exist
      const genFilter = document.getElementById('genFilter');
      const searchBtn = document.getElementById('searchBtn');
      const searchInput = document.getElementById('searchInput');
      const container = document.getElementById('treeContainer');
      
      if (!container) {
        console.error('[Tree] treeContainer not found');
        return;
      }
      
      // Load initial tree
      try {
        await loadTree(currentRootId, currentMaxGen);
      } catch (err) {
        console.error('[Tree] Error loading initial tree:', err);
        container.innerHTML = `
          <div style="padding: 20px; color: #d32f2f; text-align: center;">
            <h3>L·ªói khi t·∫£i c√¢y gia ph·∫£</h3>
            <p>${err.message}</p>
          </div>
        `;
        return;
      }
      
      // Event listeners - with null checks
      if (genFilter) {
        genFilter.addEventListener('change', (e) => {
          currentMaxGen = parseInt(e.target.value);
          loadTree(currentRootId, currentMaxGen);
        });
      } else {
        console.warn('[Tree] genFilter element not found');
      }
      
      if (searchBtn) {
        searchBtn.addEventListener('click', handleSearch);
      } else {
        console.warn('[Tree] searchBtn element not found');
      }
      
      if (searchInput) {
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleSearch();
        });
      } else {
        console.warn('[Tree] searchInput element not found');
      }
      
      console.log('[Tree] Tree initialization complete');
    }

    async function loadTree(rootId, maxGen) {
      const container = document.getElementById('treeContainer');
      if (!container) {
        console.error('Tree container not found');
        return;
      }
      
      // Find or create loading element
      let loading = container.querySelector('.tree-loading');
      if (!loading) {
        loading = document.createElement('div');
        loading.className = 'tree-loading';
        loading.style.cssText = 'padding: 20px; text-align: center; color: #666;';
        container.innerHTML = '';
        container.appendChild(loading);
      }
      
      try {
        loading.style.display = 'block';
        loading.textContent = 'ƒêang k·∫øt n·ªëi v·ªõi API...';
        
        // Use AbortController for timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        
        const response = await fetch(`/api/tree?root_id=${rootId}&max_generation=${maxGen}`, {
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`API /api/tree tr·∫£ m√£ ${response.status}`);
        }
        
        loading.textContent = 'ƒê√£ t·∫£i d·ªØ li·ªáu, ƒëang d·ª±ng c√¢y...';
        
        treeData = await response.json();
        
        if (!treeData) {
          throw new Error('API tr·∫£ v·ªÅ d·ªØ li·ªáu r·ªóng');
        }
        
        // Convert tree to vis-network format
        const { nodes, edges } = convertTreeToVisFormat(treeData);
        
        // Create network
        const data = { nodes, edges };
        const options = {
          layout: {
            hierarchical: {
              direction: 'UD', // Up-Down
              sortMethod: 'directed',
              levelSeparation: 150, // Increased for better visibility
              nodeSpacing: 200, // Increased spacing between nodes
              treeSpacing: 250, // Increased spacing between trees
              blockShifting: true,
              edgeMinimization: true,
              parentCentralization: true
            }
          },
          nodes: {
            shape: 'box',
            font: { 
              size: 16,
              face: 'Arial, sans-serif',
              bold: true,
              color: '#333'
            },
            borderWidth: 4,
            widthConstraint: { maximum: 280 },
            heightConstraint: { minimum: 60 },
            margin: 15,
            shadow: {
              enabled: true,
              color: 'rgba(0,0,0,0.2)',
              size: 5,
              x: 2,
              y: 2
            },
            shapeProperties: {
              borderRadius: 8
            }
          },
          edges: {
            arrows: { 
              to: { 
                enabled: true,
                scaleFactor: 1.2,
                type: 'arrow'
              } 
            },
            color: { 
              color: '#8B0000', 
              highlight: '#DAA520',
              hover: '#FF6347'
            },
            width: 3,
            smooth: {
              type: 'curvedCW',
              roundness: 0.2
            },
            shadow: {
              enabled: true,
              color: 'rgba(0,0,0,0.1)',
              size: 3
            }
          },
          physics: {
            enabled: false
          },
          interaction: {
            zoomView: true,
            dragView: true
          }
        };
        
        if (network) {
          network.destroy();
        }
        
        // Clear container and create network
        container.innerHTML = '';
        try {
          network = new vis.Network(container, data, options);
          
          // Node click handler
          network.on('click', (params) => {
            if (params.nodes.length > 0) {
              const nodeId = params.nodes[0]; // Gi·ªØ nguy√™n string, kh√¥ng parse th√†nh s·ªë
              if (nodeId && nodeId !== 'NaN' && nodeId !== 'undefined') {
                showPersonInfo(nodeId);
              } else {
                console.warn('[Tree] Invalid nodeId:', nodeId);
              }
            }
          });
          
          console.log('[Tree] Network created successfully');
        } catch (err) {
          console.error('[Tree] Error creating network:', err);
          container.innerHTML = `
            <div style="padding: 20px; color: #d32f2f; text-align: center;">
              <h3>L·ªói khi t·∫°o c√¢y gia ph·∫£</h3>
              <p>${err.message}</p>
            </div>
          `;
          throw err;
        }
        
        // Load breadcrumb
        await loadBreadcrumb(rootId);
        
        loading.style.display = 'none';
      } catch (err) {
        console.error('Error loading tree:', err);
        loading.style.display = 'block';
        if (err.name === 'AbortError') {
          loading.innerHTML = 'API kh√¥ng ph·∫£n h·ªìi sau 30 gi√¢y. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi ho·∫∑c server.';
        } else {
          loading.innerHTML = `Kh√¥ng th·ªÉ k·∫øt n·ªëi API (${err.message}).`;
        }
      }
    }

    function convertTreeToVisFormat(tree) {
      const nodes = [];
      const edges = [];
      const visited = new Set();
      
      function traverse(node, parentId = null) {
        if (!node || visited.has(node.person_id)) return;
        visited.add(node.person_id);
        
        // Add node with generation info in label
        const name = node.full_name || `Person ${node.person_id}`;
        const gen = node.generation_number || '';
        const status = node.status || '';
        
        // Label includes generation for clarity
        const label = gen ? `${name}\n(ƒê·ªùi ${gen})` : name;
        
        // Color by generation (different shades for different generations)
        let nodeColor = {
          background: '#fff',
          border: '#DAA520',
          highlight: {
            background: '#FFD700',
            border: '#8B0000'
          }
        };
        
        // Different colors for different generations - improved styling with rich colors
        if (gen === 1) {
          nodeColor.background = '#FFF8DC'; // Cream - Vua/Ancestor
          nodeColor.border = '#8B0000'; // Dark red
        } else if (gen === 2) {
          nodeColor.background = '#FFE4B5'; // Moccasin
          nodeColor.border = '#CD853F'; // Peru
        } else if (gen === 3) {
          nodeColor.background = '#FFFACD'; // Lemon chiffon
          nodeColor.border = '#DAA520'; // Goldenrod
        } else if (gen === 4) {
          nodeColor.background = '#F0E68C'; // Khaki
          nodeColor.border = '#B8860B'; // Dark goldenrod
        } else if (gen === 5) {
          nodeColor.background = '#FFFFE0'; // Light yellow
          nodeColor.border = '#9ACD32'; // Yellow green
        } else if (gen >= 6) {
          nodeColor.background = '#E6E6FA'; // Lavender
          nodeColor.border = '#9370DB'; // Medium purple
        }
        
        nodes.push({
          id: node.person_id,
          label: label,
          title: `${name}\nƒê·ªùi: ${gen || 'N/A'}\nTr·∫°ng th√°i: ${status || 'N/A'}`,
          generation: gen,
          gender: node.gender,
          status: status,
          color: nodeColor
        });
        
        // Add edge from parent
        if (parentId !== null) {
          edges.push({
            from: parentId,
            to: node.person_id
          });
        }
        
        // Traverse children
        if (node.children && Array.isArray(node.children)) {
          for (const child of node.children) {
            traverse(child, node.person_id);
          }
        }
      }
      
      traverse(tree);
      return { nodes, edges };
    }

    async function handleSearch() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return;
      
      const resultsDiv = document.getElementById('searchResults');
      resultsDiv.style.display = 'block';
      resultsDiv.innerHTML = '<div style="padding: 10px; color: #666;">ƒêang t√¨m ki·∫øm...</div>';
      
      try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=30`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const results = await response.json();
        
        if (results.length === 0) {
          resultsDiv.innerHTML = '<div style="padding: 10px; color: #666;">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>';
          return;
        }
        
        resultsDiv.innerHTML = results.map(person => {
          const gen = person.generation_number ? `ƒê·ªùi ${person.generation_number}` : '';
          const loc = person.origin_location ? `, ${person.origin_location}` : '';
          return `
            <div class="search-result" data-person-id="${person.person_id}" 
                 style="padding: 10px; margin: 5px 0; background: #f5f5f5; border-radius: 6px; cursor: pointer; border-left: 3px solid #DAA520;"
                 onmouseover="this.style.background='#FFE4B5'" 
                 onmouseout="this.style.background='#f5f5f5'">
              <strong>${escapeHtml(person.full_name)}</strong>
              ${person.common_name ? ` (${escapeHtml(person.common_name)})` : ''}
              ${gen ? ` - ${gen}` : ''}${loc}
            </div>
          `;
        }).join('');
        
        // Add click handlers
        resultsDiv.querySelectorAll('.search-result').forEach(el => {
          el.addEventListener('click', () => {
            const personId = el.getAttribute('data-person-id'); // Gi·ªØ nguy√™n string, kh√¥ng parse th√†nh s·ªë
            currentRootId = personId;
            resultsDiv.style.display = 'none';
            document.getElementById('searchInput').value = '';
            loadTree(personId, currentMaxGen);
          });
        });
      } catch (err) {
        console.error('Search error:', err);
        resultsDiv.innerHTML = `<div style="padding: 10px; color: #d32f2f;">L·ªói: ${err.message}</div>`;
      }
    }

    async function loadBreadcrumb(personId) {
      const breadcrumbDiv = document.getElementById('breadcrumb');
      
      try {
        const response = await fetch(`/api/ancestors/${personId}`);
        if (!response.ok) return;
        
        const data = await response.json();
        const chain = data.ancestors_chain || [];
        
        if (chain.length > 0) {
          breadcrumbDiv.style.display = 'block';
          breadcrumbDiv.innerHTML = chain.map((p, i) => {
            const sep = i < chain.length - 1 ? ' ‚Üí ' : '';
            return `<span style="color: ${i === chain.length - 1 ? '#8B0000' : '#666'}; font-weight: ${i === chain.length - 1 ? '600' : '400'};">${escapeHtml(p.full_name)}</span>${sep}`;
          }).join('');
        } else {
          breadcrumbDiv.style.display = 'none';
        }
      } catch (err) {
        console.error('Breadcrumb error:', err);
        breadcrumbDiv.style.display = 'none';
      }
    }

    async function showPersonInfo(personId) {
      const infoContent = document.getElementById('infoContent');
      if (!infoContent) {
        console.error('infoContent element not found');
        return;
      }
      
      infoContent.innerHTML = '<div style="padding: 10px; color: #666;">ƒêang t·∫£i th√¥ng tin...</div>';
      
      try {
        // Load person details
        const [personRes, ancestorsRes, descendantsRes] = await Promise.all([
          fetch(`/api/person/${personId}`),
          fetch(`/api/ancestors/${personId}`),
          fetch(`/api/descendants/${personId}?max_depth=5`)
        ]);
        
        if (!personRes.ok) {
          throw new Error(`API /api/person/${personId} tr·∫£ m√£ ${personRes.status}`);
        }
        if (!ancestorsRes.ok) {
          console.warn(`API /api/ancestors/${personId} tr·∫£ m√£ ${ancestorsRes.status}`);
        }
        if (!descendantsRes.ok) {
          console.warn(`API /api/descendants/${personId} tr·∫£ m√£ ${descendantsRes.status}`);
        }
        
        const person = await personRes.json();
        const ancestors = ancestorsRes.ok ? await ancestorsRes.json() : { ancestors_chain: [] };
        const descendants = descendantsRes.ok ? await descendantsRes.json() : { descendants: [] };
        
        let html = `
          <div style="margin-bottom: 20px;">
            <h4 style="color: #8B0000; margin-bottom: 10px; font-size: 20px;">${escapeHtml(person.full_name || '')}</h4>
            ${person.common_name ? `<p style="color: #666; margin-bottom: 5px;"><strong>T√™n th∆∞·ªùng g·ªçi:</strong> ${escapeHtml(person.common_name)}</p>` : ''}
            ${person.generation_number ? `<p style="color: #666; margin-bottom: 5px;"><strong>ƒê·ªùi:</strong> ${person.generation_number}</p>` : ''}
            ${person.gender ? `<p style="color: #666; margin-bottom: 5px;"><strong>Gi·ªõi t√≠nh:</strong> ${escapeHtml(person.gender)}</p>` : ''}
            ${person.status ? `<p style="color: #666; margin-bottom: 5px;"><strong>Tr·∫°ng th√°i:</strong> ${escapeHtml(person.status)}</p>` : ''}
            ${person.origin_location ? `<p style="color: #666; margin-bottom: 5px;"><strong>Nguy√™n qu√°n:</strong> ${escapeHtml(person.origin_location)}</p>` : ''}
          </div>
        `;
        
        // Ancestors
        if (ancestors.ancestors_chain && ancestors.ancestors_chain.length > 1) {
          html += `
            <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
              <h5 style="color: #8B0000; margin-bottom: 10px; font-size: 16px;">T·ªï ti√™n</h5>
              <div style="font-size: 14px; line-height: 1.8;">
                ${ancestors.ancestors_chain.slice(0, -1).reverse().map(p => 
                  `<div>${escapeHtml(p.full_name)} ${p.generation_number ? `(ƒê·ªùi ${p.generation_number})` : ''}</div>`
                ).join('')}
              </div>
            </div>
          `;
        }
        
        // Descendants
        if (descendants.descendants && descendants.descendants.length > 0) {
          const byDepth = {};
          descendants.descendants.forEach(d => {
            if (!byDepth[d.depth]) byDepth[d.depth] = [];
            byDepth[d.depth].push(d);
          });
          
          html += `
            <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
              <h5 style="color: #8B0000; margin-bottom: 10px; font-size: 16px;">Con ch√°u</h5>
              ${Object.keys(byDepth).sort((a, b) => parseInt(a) - parseInt(b)).map(depth => {
                const depthLabel = depth === '1' ? 'Con' : depth === '2' ? 'Ch√°u' : `ƒê·ªùi th·ª© ${depth}`;
                return `
                  <div style="margin-bottom: 10px;">
                    <strong style="color: #666; font-size: 14px;">${depthLabel}:</strong>
                    <div style="margin-left: 15px; font-size: 14px; line-height: 1.6;">
                      ${byDepth[depth].map(d => 
                        `<div>${escapeHtml(d.full_name)} ${d.generation_number ? `(ƒê·ªùi ${d.generation_number})` : ''}</div>`
                      ).join('')}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }
        
        infoContent.innerHTML = html;
        
        // Scroll info panel to top
        const infoPanel = document.getElementById('infoPanel');
        if (infoPanel) {
          infoPanel.scrollTop = 0;
        }
      } catch (err) {
        console.error('Error loading person info:', err);
        if (infoContent) {
          infoContent.innerHTML = `<div style="padding: 10px; color: #d32f2f;">L·ªói: ${err.message}</div>`;
        }
      }
    }
  </script>

</body>
</html>

