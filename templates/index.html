<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Phòng Tuy Biên Quận Công - Gia Phả Nguyễn Phước Tộc</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    /* CSS Variables - Desktop defaults */
    :root {
      --font-size-base: 16px;
      --font-size-sm: 14px;
      --font-size-lg: 18px;
      --font-size-xl: 20px;
      --font-size-2xl: 24px;
      --font-size-3xl: 28px;
      --font-size-4xl: 32px;
      
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      
      --navbar-height: 70px;
      --sidebar-width: 280px;
    }

    /* Mobile overrides */
    @media (max-width: 768px) {
      :root {
        --font-size-base: 14px;
        --font-size-sm: 12px;
        --font-size-lg: 16px;
        --font-size-xl: 18px;
        --font-size-2xl: 20px;
        --font-size-3xl: 24px;
        --font-size-4xl: 28px;
        
        --space-1: 3px;
        --space-2: 6px;
        --space-3: 10px;
        --space-4: 12px;
        --space-5: 16px;
        --space-6: 20px;
        --space-8: 24px;
        --space-10: 32px;
        
        --navbar-height: 60px;
        --sidebar-width: 0;
      }
    }

    /* Tablet overrides */
    @media (min-width: 769px) and (max-width: 1024px) {
      :root {
        --font-size-base: 15px;
        --space-4: 14px;
        --space-6: 22px;
      }
      
      .navbar-menu {
        gap: 10px;
      }
      
      .navbar-menu a {
        font-size: 14px;
        padding: 5px 6px;
      }
      
      .navbar-logo {
        max-width: 150px;
      }
    }

    /* Medium screens - điều chỉnh navbar */
    @media (min-width: 1025px) and (max-width: 1200px) {
      .navbar-menu {
        gap: 12px;
      }
      
      .navbar-menu a {
        font-size: 15px;
        padding: 5px 7px;
      }
      
      .navbar-logo {
        max-width: 160px;
      }
    }

    body {
      font-family: 'Noto Serif TC', 'Playfair Display', serif;
      background: #FAEBD7;
      background-attachment: fixed;
      position: relative;
      padding-top: var(--navbar-height);
      padding-left: var(--sidebar-width);
    }

    @media (max-width: 1024px) {
      body {
        padding-left: 0;
      }
    }


    /* ============================================
       NAVBAR
       ============================================ */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--navbar-height);
      background: #111827;
      color: white;
      padding: 0 var(--space-4);
      display: flex;
      justify-content: flex-end;
      align-items: center;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      gap: 10px;
      min-width: 0;
    }

    @media (max-width: 768px) {
      .navbar {
        justify-content: space-between;
      }
    }

    .navbar-logo {
      font-size: clamp(14px, 4vw, 18px);
      font-weight: 700;
      color: #FFD700;
      text-decoration: none;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 180px;
      flex-shrink: 0;
    }

    .navbar-menu {
      display: flex;
      gap: 15px;
      list-style: none;
      align-items: center;
      flex-wrap: nowrap;
      overflow: visible;
    }

    .navbar-menu li {
      flex-shrink: 0;
    }

    .navbar-menu a {
      color: white;
      text-decoration: none;
      font-size: clamp(14px, 1.5vw, 16px);
      font-weight: 500;
      transition: color 0.3s;
      padding: 5px 8px;
      border-radius: 4px;
      white-space: nowrap;
    }

    .navbar-menu a:hover,
    .navbar-menu a.active {
      color: #FFD700;
      background: rgba(255, 215, 0, 0.1);
    }

    .navbar-toggle {
      display: none;
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: var(--space-2);
      min-width: 44px;
      min-height: 44px;
    }

    @media (max-width: 768px) {
      .navbar {
        padding: 0 var(--space-2);
      }

      .navbar-menu {
        position: fixed;
        top: var(--navbar-height);
        left: 0;
        right: 0;
        background: #111827;
        flex-direction: column;
        padding: var(--space-4);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        max-height: calc(100vh - var(--navbar-height));
        overflow-y: auto;
        display: none;
        gap: 0;
      }

      .navbar-menu.active {
        display: flex;
      }

      .navbar-menu li {
        width: 100%;
        margin: var(--space-2) 0;
      }

      .navbar-menu a {
        padding: var(--space-3) var(--space-4);
        font-size: var(--font-size-base);
        display: block;
        width: 100%;
        min-height: 44px;
        display: flex;
        align-items: center;
      }

      .navbar-toggle {
        display: block;
      }
    }

    /* ============================================
       SECTIONS
       ============================================ */
    section {
      min-height: auto;
      padding: 60px 24px;
      position: relative;
    }
    
    @media (max-width: 768px) {
      section {
        padding: 40px 16px;
        min-height: auto;
      }
    }

    .section-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 24px;
    }

    @media (max-width: 768px) {
      .section-container {
        padding: 0 16px;
      }
    }

    /* Section activities-tree đã di chuyển sang /genealogy */
    /* #activities-tree .section-container {
      max-width: 100%;
      padding: 40px 20px;
    }

    /* ============================================
       HOME SECTION (#home)
       ============================================ */
    #home {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(139, 0, 0, 0.95) 0%, rgba(220, 20, 60, 0.95) 100%);
      color: #FFD700;
      text-align: center;
      padding: 80px 24px;
    }

    .hero-content {
      max-width: 900px;
      margin: 0 auto;
    }

    .hero-content h1 {
      font-size: clamp(26px, 6.5vw, 48px);
      margin-bottom: clamp(20px, 5vw, 28px);
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      color: #FFD700;
      line-height: 1.4;
      font-weight: 700;
    }

    .hero-content p {
      font-size: clamp(18px, 4.5vw, 24px);
      margin-bottom: clamp(24px, 6vw, 36px);
      line-height: 1.7;
      color: #FFD700;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
    }

    .cta-button {
      display: inline-block;
      padding: clamp(12px, 3vw, 15px) clamp(32px, 8vw, 40px);
      background: linear-gradient(135deg, #FFD700 0%, #DAA520 100%);
      color: #8B0000;
      text-decoration: none;
      border-radius: 50px;
      font-size: clamp(16px, 4vw, 18px);
      font-weight: 700;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .cta-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }

    /* ============================================
       ABOUT SECTION (#about)
       ============================================ */
    #about {
      background: #FAEBD7;
      padding: 60px 24px;
    }

    .about-content {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0;
      max-width: 900px;
      margin: 0 auto;
    }

    .about-text {
      font-size: var(--font-size-base);
      line-height: 1.8;
      color: #333;
    }

    .about-text p {
      margin-bottom: 20px;
      text-align: justify;
    }

    .about-text h3 {
      color: #8B0000;
      font-size: var(--font-size-2xl);
      font-weight: 700;
      margin-top: 40px;
      margin-bottom: 20px;
      border-bottom: 2px solid #DAA520;
      padding-bottom: 12px;
    }

    .about-text h3:first-child {
      margin-top: 0;
    }

    .about-image {
      text-align: center;
      margin: 30px 0;
    }

    .about-image img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    blockquote {
      background: #FFF8DC;
      border-left: 4px solid #DAA520;
      padding: 20px;
      margin: 24px 0;
      border-radius: 4px;
      font-style: italic;
      color: #555;
    }
    
    /* Đồng bộ màu nền cho các phần tử */
    .section-container {
      background: transparent;
    }

    #temple-interior {
      background: #FAEBD7;
      border-top: 1px solid rgba(139, 0, 0, 0.12);
      padding: 60px 24px;
    }

    #news-feed {
      background: #FAEBD7;
      padding: 60px 0;
      border-top: 1px solid rgba(139, 0, 0, 0.12);
    }

    /* External Posts Section */
    #external-posts {
      background: #FAEBD7;
      border-top: 1px solid rgba(139, 0, 0, 0.12);
      padding: 60px 24px;
    }

    .external-posts-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 20px;
    }

    @media (max-width: 768px) {
      .external-posts-container {
        padding: 0 16px;
      }
    }

    .external-post-item {
      background: #FFF8DC;
      border-radius: 8px;
      padding: 0;
      margin-bottom: 20px;
      border-left: 4px solid #DAA520;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      overflow: hidden;
      display: flex;
      flex-direction: row;
      align-items: stretch;
      border: 1px solid rgba(139, 0, 0, 0.15);
    }

    .external-post-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .external-post-thumbnail {
      flex-shrink: 0;
      width: 200px;
      min-height: 150px;
      background: #FAEBD7;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .external-post-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .external-post-thumbnail-placeholder {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #8B0000 0%, #DAA520 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 48px;
      opacity: 0.3;
    }

    .external-post-content {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .external-post-title {
      margin: 0 0 12px 0;
      font-size: 18px;
      color: #8B0000;
      line-height: 1.4;
    }

    .external-post-title a {
      color: #8B0000;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .external-post-title a:hover {
      color: #7a0000;
      text-decoration: underline;
    }

    .external-post-meta {
      font-size: 12px;
      color: #666;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .external-post-description {
      font-size: 14px;
      color: #555;
      line-height: 1.6;
      margin: 0 0 12px 0;
      flex: 1;
    }

    .external-post-source {
      margin-top: auto;
      padding-top: 12px;
      border-top: 1px solid #e0e0e0;
      font-size: 11px;
      color: #888;
      font-style: italic;
    }

    @media (max-width: 768px) {
      .external-post-item {
        flex-direction: column;
        padding: 0;
      }

      .external-post-thumbnail {
        width: 100%;
        height: 180px;
      }

      .external-post-content {
        padding: 16px;
      }

      .external-post-title {
        font-size: 16px;
      }
    }

    .documents-section,
    #documents {
      border-top: 1px solid rgba(139, 0, 0, 0.12);
    }

    .news-feed-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 24px;
    }

    @media (max-width: 768px) {
      .news-feed-container {
        padding: 0 16px;
      }
    }

    /* Featured Posts */
    .featured-posts-section {
      margin-bottom: 40px;
    }

    .featured-posts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .featured-post-card {
      background: #FFF8DC;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(139, 0, 0, 0.15);
    }

    .featured-post-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .featured-post-thumbnail {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: #FAEBD7;
    }

    .featured-post-content {
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .featured-post-title {
      font-size: 18px;
      font-weight: 700;
      color: #8B0000;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .featured-post-summary {
      color: #6b7280;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 15px;
      flex: 1;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .featured-post-link {
      color: #DAA520;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      transition: color 0.2s;
      align-self: flex-end;
    }

    .featured-post-link:hover {
      color: #8B0000;
      text-decoration: underline;
    }

    /* Hot News Section */
    .hot-news-section {
      margin-bottom: 40px;
      background: #FFF8DC;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid rgba(139, 0, 0, 0.15);
      transition: all 0.3s ease;
    }

    .hot-news-section:hover {
      box-shadow: 0 4px 16px rgba(139, 0, 0, 0.2);
      transform: translateY(-2px);
    }

    .hot-news-title {
      position: relative;
      animation: pulse-glow 2s ease-in-out infinite;
    }

    @keyframes pulse-glow {
      0%, 100% {
        text-shadow: 0 0 5px rgba(139, 0, 0, 0.3);
      }
      50% {
        text-shadow: 0 0 15px rgba(218, 165, 32, 0.6), 0 0 25px rgba(139, 0, 0, 0.4);
      }
    }

    .hot-news-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .hot-news-item {
      padding: 12px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .hot-news-item:last-child {
      border-bottom: none;
    }

    .hot-news-item a {
      color: #111827;
      text-decoration: none;
      font-size: 16px;
      transition: color 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .hot-news-item a::before {
      content: "▶";
      color: #DAA520;
      font-size: 12px;
    }

    .hot-news-item a:hover {
      color: #8B0000;
      text-decoration: underline;
    }

    /* Category Sections - Two Column Grid */
    .category-sections {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .category-section {
      background: #FFF8DC;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid rgba(139, 0, 0, 0.15);
    }

    .category-title {
      color: #8B0000;
      font-size: 18px;
      font-weight: 700;
      text-transform: uppercase;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #8B0000;
      letter-spacing: 0.5px;
    }

    .category-main-post {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .category-main-post-image {
      width: 120px;
      height: 120px;
      min-width: 120px;
      object-fit: cover;
      border-radius: 4px;
      background: #FAEBD7;
      border: 1px solid rgba(139, 0, 0, 0.15);
    }

    .category-main-post-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .category-main-post-content h4 {
      color: #111827;
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .category-main-post-content p {
      color: #6b7280;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 12px;
      flex: 1;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .category-main-post-link {
      color: #DAA520;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      transition: color 0.2s;
      align-self: flex-end;
    }

    .category-main-post-link:hover {
      color: #8B0000;
      text-decoration: underline;
    }

    .category-related-posts {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .category-related-posts li {
      padding: 8px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .category-related-posts li:last-child {
      border-bottom: none;
    }

    .category-related-posts a {
      color: #111827;
      text-decoration: none;
      font-size: 15px;
      transition: color 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .category-related-posts a::before {
      content: "•";
      color: #DAA520;
      font-size: 18px;
      font-weight: bold;
    }

    .category-related-posts a:hover {
      color: #8B0000;
      text-decoration: underline;
    }

    /* Documents Section */
    .documents-section {
      background: #FAEBD7;
      padding: 60px 24px;
      border-top: 1px solid rgba(139, 0, 0, 0.12);
    }

    .documents-section .page-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .documents-section .page-subtitle {
      font-size: var(--font-size-lg);
      color: #6b7280;
      margin-top: 12px;
      line-height: 1.6;
    }

    .documents-section .section-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 24px;
    }

    @media (max-width: 768px) {
      .documents-section .section-container {
        padding: 0 16px;
      }
    }

    .documents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
      margin-top: 30px;
    }

    .document-card {
      background: #FFF8DC;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      border: 1px solid rgba(139, 0, 0, 0.15);
      height: 100%;
    }

    .document-card:hover {
      background: #FFF8DC;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
      border-color: rgba(139, 0, 0, 0.3);
    }

    .document-icon {
      font-size: 48px;
      color: #8B0000;
      margin-bottom: 16px;
      text-align: center;
      width: 100%;
    }

    .document-title {
      font-size: 18px;
      font-weight: 600;
      color: #8B0000;
      margin: 0 0 12px 0;
      text-align: left;
      line-height: 1.4;
    }

    .document-description {
      font-size: 14px;
      color: #6b7280;
      line-height: 1.6;
      margin: 0 0 20px 0;
      text-align: left;
      flex: 1;
    }

    .document-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-start;
      flex-shrink: 0;
      width: 100%;
      margin-top: auto;
    }

    .btn-view {
      background: #8B0000;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
      font-size: 13px;
      transition: background 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .btn-view:hover {
      background: #7a0000;
    }

    .btn-download {
      background: #DAA520;
      color: #8B0000;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
      font-size: 13px;
      transition: background 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .btn-download:hover {
      background: #c4951f;
    }

    .source-reference:hover {
      color: #7a0000 !important;
      border-bottom-color: #8B0000 !important;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .category-sections {
        grid-template-columns: 1fr;
      }

      .documents-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
      }

      .document-card {
        padding: 20px;
      }

      .document-icon {
        font-size: 40px;
        margin-bottom: 12px;
      }

      .document-title {
        font-size: 17px;
        margin-bottom: 10px;
      }

      .document-description {
        font-size: 13px;
        margin-bottom: 16px;
      }

      .document-actions {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
      }

      .btn-view,
      .btn-download {
        font-size: 12px;
        padding: 8px 14px;
      }
    }

    @media (max-width: 768px) {
      .featured-posts {
        grid-template-columns: 1fr;
      }

      .category-main-post {
        flex-direction: column;
      }

      .category-main-post-image {
        width: 100%;
        height: 180px;
      }

      .news-feed-container {
        padding: 0 15px;
      }

      #news-feed {
        padding: 24px 0;
      }

      .documents-section {
        padding: 24px 0;
      }

      .document-card {
        padding: 20px;
      }

      .document-icon {
        font-size: 40px;
        margin-bottom: 12px;
      }

      .document-title {
        font-size: 17px;
        margin-bottom: 10px;
      }

      .document-description {
        font-size: 13px;
        margin-bottom: 16px;
      }

      .document-actions {
        flex-direction: column;
        width: 100%;
      }

      .btn-view,
      .btn-download {
        width: 100%;
        justify-content: center;
        padding: 10px 16px;
      }
    }

    /* Typography - Responsive */
    h1 {
      font-size: clamp(24px, 6vw, 36px);
      line-height: 1.3;
    }

    h2 {
      font-size: clamp(20px, 5vw, 28px);
      line-height: 1.3;
    }

    h3 {
      font-size: clamp(18px, 4vw, 22px);
      line-height: 1.3;
    }

    p, li {
      font-size: var(--font-size-base);
      line-height: 1.6;
    }

    @media (max-width: 768px) {
      p, li {
        line-height: 1.5;
      }
    }

    .section-title {
      font-size: clamp(24px, 5vw, 36px);
      color: #8B0000;
      margin-bottom: clamp(20px, 4vw, 30px);
      text-align: center;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
      scroll-margin-top: var(--navbar-height);
    }

    /* Fixed Sidebar Table of Contents */
    .toc-sidebar {
      position: fixed;
      left: 0;
      top: var(--navbar-height);
      width: var(--sidebar-width);
      height: calc(100vh - var(--navbar-height));
      background: #FAEBD7;
      border-right: 3px solid #DAA520;
      padding: 20px 16px;
      overflow-y: auto;
      overflow-x: hidden;
      z-index: 998; /* Below navbar (z-index: 1000) */
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, left 0.3s ease;
    }

    .toc-sidebar::-webkit-scrollbar {
      width: 8px;
    }

    .toc-sidebar::-webkit-scrollbar-track {
      background: rgba(218, 165, 32, 0.1);
    }

    .toc-sidebar::-webkit-scrollbar-thumb {
      background: #DAA520;
      border-radius: 4px;
    }

    .toc-sidebar::-webkit-scrollbar-thumb:hover {
      background: #8B0000;
    }

    .toc-sidebar h3 {
      color: #8B0000;
      font-size: 18px;
      margin-bottom: 20px;
      border-bottom: 3px solid #DAA520;
      padding-bottom: 12px;
      text-align: center;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .toc-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .toc-list li {
      margin-bottom: 8px;
      position: relative;
    }

    .toc-list li::before {
      content: "▸";
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      color: #8B0000;
      font-weight: bold;
      font-size: 12px;
      opacity: 0.6;
      transition: all 0.3s ease;
    }

    .toc-list li:hover::before {
      opacity: 1;
      color: #DAA520;
      transform: translateY(-50%) translateX(3px);
    }

    .toc-list a {
      color: #555;
      text-decoration: none;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s ease;
      display: block;
      line-height: 1.6;
      padding: 10px 12px 10px 20px;
      border-radius: 6px;
      word-wrap: break-word;
      position: relative;
      background: transparent;
    }

    .toc-list a:hover {
      color: #8B0000;
      background: rgba(218, 165, 32, 0.1);
      transform: translateX(4px);
      padding-left: 24px;
    }

    .toc-list a.active {
      color: #8B0000;
      background: rgba(218, 165, 32, 0.2);
      font-weight: bold;
      border-left: 3px solid #DAA520;
      padding-left: 17px;
    }

    .toc-list a.active::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: #DAA520;
      border-radius: 0 3px 3px 0;
    }

    /* Mobile: Hide sidebar, show toggle button */
    .toc-toggle {
      display: none;
      position: fixed;
      left: 15px;
      top: 85px;
      z-index: 1001; /* Above navbar */
      background: #8B0000;
      color: white;
      border: 2px solid #DAA520;
      border-radius: 8px;
      padding: 10px 15px;
      min-width: 44px; /* Touch target tối thiểu */
      min-height: 44px;
      cursor: pointer;
      font-size: 18px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      /* Quan trọng: bỏ 300ms delay trên mobile, tránh ghost click */
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(255, 215, 0, 0.2);
      user-select: none;
    }

    .toc-toggle:hover {
      background: #DAA520;
      color: #8B0000;
    }

    /* TOC Overlay for mobile */
    .toc-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 997;
    }

    .toc-overlay.active {
      display: block;
      touch-action: manipulation;
    }

    @media (max-width: 1024px) {
      .toc-sidebar {
        left: -280px;
        width: 280px;
      }

      .toc-sidebar.open {
        left: 0;
      }

      .toc-toggle {
        display: block;
      }

      body {
        padding-left: 0 !important;
      }
    }

    @media (max-width: 768px) {
      .toc-sidebar {
        width: 80vw;
        max-width: 280px;
        padding: 16px 12px;
      }

      .toc-sidebar h3 {
        font-size: 16px;
        margin-bottom: 16px;
        padding-bottom: 10px;
      }

      .toc-list a {
        font-size: 13px;
        padding: 8px 10px 8px 18px;
      }

      .toc-list li {
        margin-bottom: 6px;
      }
    }

    /* Scroll offset for anchor links */
    h3[id], h4[id] {
      scroll-margin-top: calc(var(--navbar-height) + 20px);
    }

    /* Responsive Images */
    img {
      max-width: 100%;
      height: auto;
      display: block;
    }

    @media (max-width: 768px) {
      img {
        border-radius: 6px;
      }
    }

    /* Touch-friendly Buttons and Links */
    button, .btn, a.btn {
      min-height: 44px;
      min-width: 44px;
      padding: var(--space-3) var(--space-4);
      font-size: var(--font-size-base);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    @media (max-width: 768px) {
      button, .btn, a.btn {
        min-height: 44px;
        padding: var(--space-3) var(--space-4);
      }
    }

    /* Responsive Forms */
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="search"],
    input[type="tel"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      font-size: var(--font-size-base);
      padding: var(--space-3);
      border-radius: 6px;
      border: 1px solid #ddd;
    }

    @media (max-width: 768px) {
      input[type="text"],
      input[type="email"],
      input[type="password"],
      input[type="search"],
      input[type="tel"],
      input[type="number"],
      textarea,
      select {
        font-size: 16px; /* Prevent zoom on iOS */
        min-height: 44px;
      }
    }

    /* Responsive Cards */
    .card, .lineage-card, .document-card, .external-post-item {
      padding: var(--space-4);
      margin-bottom: var(--space-4);
    }

    @media (max-width: 768px) {
      .card, .lineage-card, .document-card, .external-post-item {
        padding: var(--space-3);
        margin-bottom: var(--space-3);
        border-radius: 8px;
      }
    }


    /* ============================================
       GENEALOGY TREE SECTION - Đã di chuyển sang /genealogy
       ============================================ */



    /* Family Tree CSS - Đã di chuyển sang /genealogy */

    /* ============================================
       GENEALOGY SECTION (#genealogy)
       ============================================ */
    #genealogy {
      background: #FAEBD7;
      padding: 80px 30px;
    }

    .genealogy-container {
      background: #FFF8DC;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(139, 0, 0, 0.15);
    }

    /* Lineage section styles */
    .lineage-section {
      margin-top: 30px;
      padding: 30px;
      background: #FAEBD7;
      border-top: 5px solid #DAA520;
      border-radius: 0 0 20px 20px;
    }

    .lineage-header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 3px solid #DAA520;
    }

    .lineage-header h2 {
      color: #8B0000;
      font-size: 28px;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }

    .lineage-header p {
      color: #666;
      font-size: 16px;
      font-style: italic;
    }

    .lineage-controls {
      display: flex;
      gap: 15px;
      align-items: flex-end;
      flex-wrap: wrap;
      margin-bottom: 30px;
      padding: 20px;
      background: #FFF8DC;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .lineage-input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      position: relative;
    }

    .lineage-input-group label {
      font-weight: 600;
      color: #8B0000;
      font-size: 14px;
    }

    .lineage-input-group input {
      padding: 12px 18px;
      border: 2px solid #DAA520;
      border-radius: 8px;
      font-size: 16px;
      background: #FFF8DC;
      font-family: 'Noto Serif TC', serif;
      min-width: 200px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .lineage-input-group input:focus {
      outline: none;
      border-color: #8B0000;
      box-shadow: 0 0 10px rgba(218, 165, 32, 0.5);
    }

    .lineage-controls button {
      padding: 12px 30px;
      border: 2px solid #8B0000;
      border-radius: 8px;
      font-size: 16px;
      background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
      color: #FFD700;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      font-family: 'Noto Serif TC', serif;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      height: fit-content;
    }

    .lineage-controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
      background: linear-gradient(135deg, #DC143C 0%, #8B0000 100%);
    }

    .lineage-result {
      margin-top: 20px;
      padding: 25px;
      background: #FFF8DC;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      border: 3px solid #DAA520;
    }

    .lineage-result-header h3 {
      color: #8B0000;
      font-size: 22px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #DAA520;
    }

    .lineage-result-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .lineage-item {
      padding: 15px 20px;
      margin: 4px 0;
      background: #FFF8DC;
      border-left: 5px solid #DAA520;
      border-radius: 8px;
      transition: all 0.3s;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      border: 1px solid rgba(139, 0, 0, 0.1);
    }

    .lineage-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      border-left-color: #8B0000;
    }

    .lineage-item.current {
      background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
      border-left-color: #fbc02d;
      border-left-width: 6px;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(251, 192, 45, 0.3);
    }

    .lineage-item .generation {
      display: inline-block;
      min-width: 100px;
      padding: 8px 15px;
      background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
      color: #FFD700;
      border-radius: 20px;
      font-weight: 700;
      font-size: 14px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      margin-right: 20px;
    }

    .lineage-item.current .generation {
      background: linear-gradient(135deg, #fbc02d 0%, #f9a825 100%);
      color: #8B0000;
    }

    .lineage-item .name {
      color: #8B0000;
      font-size: 16px;
      font-weight: 600;
    }

    .lineage-item.current .name {
      font-size: 18px;
    }

    .lineage-parents {
      margin-top: 10px;
      font-size: 16px;
      color: #8B0000;
      font-style: italic;
      font-weight: 500;
      padding-left: 10px;
    }

    .lineage-parents strong {
      color: #8B0000;
      font-style: normal;
      font-weight: 700;
      font-size: 17px;
    }

    .lineage-error {
      padding: 20px;
      background: #ffebee;
      color: #c62828;
      border-radius: 8px;
      border-left: 5px solid #c62828;
      text-align: center;
      font-weight: 600;
    }

    .lineage-loading {
      padding: 20px;
      text-align: center;
      color: #8B0000;
      font-size: 16px;
    }

    .suggestions-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #FFF8DC;
      border: 2px solid #DAA520;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      margin-top: 5px;
    }

    .suggestion-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }

    .suggestion-item:hover {
      background: rgba(250, 235, 215, 0.5);
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-item .suggestion-name {
      font-weight: 600;
      color: #8B0000;
      font-size: 15px;
    }

    .suggestion-item .suggestion-details {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
      font-weight: 400;
    }
    
    .suggestion-item {
      display: flex;
      flex-direction: column;
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-item:hover {
      background: #f9f9f9;
    }

    .lineage-detail-panel {
      margin-top: 20px;
      padding: 25px;
      background: #FFF8DC;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      border: 3px solid #DAA520;
    }

    .detail-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #DAA520;
    }

    .detail-panel-header h3 {
      color: #8B0000;
      font-size: 22px;
      margin: 0;
    }

    .close-btn {
      background: #DC143C;
      color: white;
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .close-btn:hover {
      background: #8B0000;
      transform: scale(1.1);
    }

    .detail-form {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px 20px;
    }
    
    @media (max-width: 768px) {
      .detail-form {
        grid-template-columns: 1fr;
      }
    }

    .detail-form .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .detail-form .form-group label {
      font-weight: 600;
      color: #8B0000;
      font-size: 14px;
    }

    .detail-form .form-group input,
    .detail-form .form-group select,
    .detail-form .form-group textarea {
      padding: 10px;
      border: 2px solid #DAA520;
      border-radius: 6px;
      font-size: 14px;
      font-family: 'Noto Serif TC', serif;
    }

    .detail-value {
      padding: 10px;
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
      min-height: 20px;
      line-height: 1.6;
      white-space: pre-line; /* Cho phép xuống dòng */
    }

    .btn-edit {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-edit:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4);
    }

    .detail-form .form-group input:focus,
    .detail-form .form-group select:focus,
    .detail-form .form-group textarea:focus {
      outline: none;
      border-color: #8B0000;
      box-shadow: 0 0 8px rgba(218, 165, 32, 0.3);
    }

    .form-actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .form-actions button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-save {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }

    .btn-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4);
    }

    .btn-cancel {
      background: #FFF8DC;
      color: #333;
      border: 1px solid rgba(139, 0, 0, 0.2);
    }

    .btn-cancel:hover {
      background: #e0e0e0;
    }

    .btn-delete {
      background: linear-gradient(135deg, #DC143C 0%, #8B0000 100%);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-delete:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(220, 20, 60, 0.4);
      background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
    }

    /* ============================================
       RESPONSIVE
       ============================================ */
    
    /* Tree section responsive */
    @media (max-width: 900px) {
      #treeControls > div {
        flex-direction: column;
        align-items: stretch;
      }
      
      #treeControls > div > div {
        min-width: 100%;
      }
      
      /* section#activities-tree đã di chuyển sang /genealogy */
      /* section#activities-tree > div > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
      }
      
      #infoPanel {
        max-height: 400px;
        margin-top: 20px;
      }
    }
    
    @media (max-width: 768px) {
      .navbar-menu {
        position: fixed;
        top: 70px;
        left: -100%;
        width: 100%;
        background: #111827;
        flex-direction: column;
        padding: 20px;
        transition: left 0.3s;
      }

      .navbar-menu.active {
        left: 0;
      }

      .navbar-toggle {
        display: block;
      }

      .hero-content h1 {
        font-size: clamp(26px, 6.5vw, 48px);
      }
      
      .hero-content p {
        font-size: clamp(18px, 4.5vw, 24px);
      }
      
      .hero-content {
        padding: 0 16px;
      }

      .about-content {
        grid-template-columns: 1fr;
      }

      section {
        padding: 60px 20px;
      }
    }

    /* Photo Carousel Styles */
    .photo-carousel-section {
      margin-top: var(--space-10);
      padding: var(--space-8) 0;
      border-top: 2px solid rgba(139, 0, 0, 0.15);
      background: #FAEBD7;
    }
    
    .carousel-header {
      text-align: center;
      margin-bottom: var(--space-6);
      padding: 0 var(--space-4);
    }
    
    .carousel-header h2 {
      font-size: var(--font-size-3xl);
      margin-bottom: var(--space-2);
      color: var(--color-primary);
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .carousel-header p {
      color: var(--color-text-muted);
      font-size: var(--font-size-lg);
      margin-bottom: var(--space-4);
    }
    
    .btn-view-all {
      display: inline-block;
      padding: var(--space-3) var(--space-6);
      background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
      color: white;
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(139, 0, 0, 0.2);
    }
    
    .btn-view-all:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 0, 0, 0.3);
    }
    
    .photo-carousel {
      position: relative;
      width: 100%;
      max-width: 1200px;
      height: 600px;
      margin: 0 auto;
      overflow: hidden;
      border-radius: var(--radius-lg);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      background: #FAEBD7;
      border: 2px solid rgba(139, 0, 0, 0.2);
    }
    
    .carousel-container {
      display: flex;
      width: 100%;
      height: 100%;
      transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .carousel-slide {
      min-width: 100%;
      height: 100%;
      position: relative;
    }
    
    .carousel-slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    
    .carousel-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.85) 0%, rgba(0, 0, 0, 0.5) 50%, transparent 100%);
      padding: var(--space-8) var(--space-6);
      color: white;
      transform: translateY(0);
      transition: transform 0.3s ease;
    }
    
    .carousel-slide:hover .carousel-overlay {
      transform: translateY(-5px);
    }
    
    .carousel-overlay h3 {
      margin: 0 0 var(--space-2) 0;
      font-size: var(--font-size-2xl);
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }
    
    .carousel-overlay p {
      margin: 0;
      font-size: var(--font-size-base);
      opacity: 0.95;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }
    
    .carousel-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid rgba(139, 0, 0, 0.2);
      width: 56px;
      height: 56px;
      border-radius: 50%;
      font-size: var(--font-size-2xl);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      z-index: 10;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      color: #8B0000;
    }
    
    .carousel-nav:hover {
      background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
      color: white;
      transform: translateY(-50%) scale(1.15);
      box-shadow: 0 6px 20px rgba(139, 0, 0, 0.4);
    }
    
    .carousel-nav.prev {
      left: var(--space-6);
    }
    
    .carousel-nav.next {
      right: var(--space-6);
    }
    
    .carousel-indicators {
      position: absolute;
      bottom: var(--space-6);
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: var(--space-3);
      z-index: 10;
      background: rgba(0, 0, 0, 0.3);
      padding: var(--space-2) var(--space-4);
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }
    
    .carousel-indicator {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.6);
      border: 2px solid rgba(255, 255, 255, 0.8);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .carousel-indicator:hover {
      background: rgba(255, 255, 255, 0.9);
      transform: scale(1.2);
    }
    
    .carousel-indicator.active {
      background: #FFD700;
      border-color: #FFD700;
      transform: scale(1.3);
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
    }
    
    .carousel-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--color-text-muted);
      font-size: var(--font-size-lg);
      background: #FAEBD7;
      flex-direction: column;
      gap: var(--space-4);
    }
    
    .carousel-loading::after {
      content: '';
      width: 40px;
      height: 40px;
      border: 4px solid rgba(139, 0, 0, 0.1);
      border-top-color: #8B0000;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media (max-width: 1024px) {
      .photo-carousel {
        height: 500px;
      }
      
      .carousel-nav {
        width: 48px;
        height: 48px;
        font-size: var(--font-size-xl);
      }
      
      .carousel-nav.prev {
        left: var(--space-4);
      }
      
      .carousel-nav.next {
        right: var(--space-4);
      }
    }
    
    @media (max-width: 767px) {
      .photo-carousel {
        height: 400px;
        border-radius: var(--radius-md);
      }
      
      .carousel-header h2 {
        font-size: var(--font-size-2xl);
      }
      
      .carousel-overlay {
        padding: var(--space-6) var(--space-4);
      }
      
      .carousel-overlay h3 {
        font-size: var(--font-size-xl);
      }
      
      .carousel-overlay p {
        font-size: var(--font-size-sm);
      }
      
      .carousel-nav {
        width: 40px;
        height: 40px;
        font-size: var(--font-size-lg);
      }
      
      .carousel-nav.prev {
        left: var(--space-2);
      }
      
      .carousel-nav.next {
        right: var(--space-2);
      }
      
      .carousel-indicators {
        bottom: var(--space-4);
        gap: var(--space-2);
        padding: var(--space-1) var(--space-3);
      }
      
      .carousel-indicator {
        width: 10px;
        height: 10px;
      }
    }
    
    /* Albums Grid Container */
    .albums-grid-container {
      margin-top: var(--space-8);
      background: #FFF8DC;
      padding: var(--space-6);
      border-radius: var(--radius-lg);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(139, 0, 0, 0.15);
    }
    
    .albums-grid-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-6);
      padding-bottom: var(--space-5);
      border-bottom: 2px solid #e8e8e8;
      flex-wrap: wrap;
      gap: var(--space-4);
    }
    
    .albums-grid-title h3 {
      margin: 0;
      font-size: var(--font-size-2xl);
      color: var(--color-primary);
      font-weight: 700;
    }
    
    .albums-grid-title p {
      margin: var(--space-2) 0 0 0;
      color: var(--color-text-muted);
      font-size: var(--font-size-base);
    }
    
    .btn-create-album {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-6);
      background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(139, 0, 0, 0.25);
      text-decoration: none;
    }
    
    .btn-create-album:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(139, 0, 0, 0.35);
    }
    
    .btn-create-album:active {
      transform: translateY(0);
    }
    
    .btn-create-album .btn-icon {
      font-size: var(--font-size-xl);
      font-weight: bold;
      line-height: 1;
    }
    
    /* Albums Grid */
    .albums-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: var(--space-6);
      margin-top: var(--space-6);
    }
    
    /* Gallery View */
    .gallery-view {
      margin-top: var(--space-8);
      background: #FFF8DC;
      padding: var(--space-6);
      border-radius: var(--radius-lg);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
      animation: fadeIn 0.4s ease;
      border: 1px solid rgba(139, 0, 0, 0.15);
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .gallery-view-header {
      display: flex;
      align-items: flex-start;
      gap: var(--space-4);
      margin-bottom: var(--space-6);
      padding-bottom: var(--space-5);
      border-bottom: 2px solid #e8e8e8;
      flex-wrap: wrap;
    }
    
    .btn-back {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-5);
      background: #FFF8DC;
      color: var(--color-text);
      border: 2px solid rgba(139, 0, 0, 0.2);
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
    }
    
    .btn-back:hover {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
      transform: translateX(-4px);
    }
    
    .btn-back span {
      font-size: var(--font-size-xl);
      line-height: 1;
    }
    
    .gallery-view-info {
      flex: 1;
    }
    
    .gallery-view-info h3 {
      margin: 0;
      font-size: var(--font-size-2xl);
      color: var(--color-primary);
      font-weight: 700;
    }
    
    .gallery-view-info p {
      margin: var(--space-2) 0 0 0;
      color: #666;
      font-size: var(--font-size-base);
    }
    
    .gallery-container {
      min-height: 300px;
    }
    
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: var(--space-4);
      margin-top: var(--space-6);
    }
    
    .gallery-item {
      position: relative;
      overflow: hidden;
      border-radius: 12px;
      background: #FAEBD7;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      aspect-ratio: 1;
      border: 1px solid rgba(139, 0, 0, 0.1);
    }
    
    .gallery-item:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      z-index: 1;
    }
    
    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 0.3s ease;
    }
    
    .gallery-item:hover img {
      transform: scale(1.1);
    }
    
    .gallery-item-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.3) 0%, transparent 50%);
      opacity: 0;
      transition: opacity 0.3s ease;
      display: flex;
      align-items: flex-start;
      justify-content: flex-end;
      padding: var(--space-2);
    }
    
    .gallery-item:hover .gallery-item-overlay {
      opacity: 1;
    }
    
    .gallery-item-number {
      background: rgba(255, 255, 255, 0.9);
      color: var(--color-primary);
      padding: var(--space-1) var(--space-2);
      border-radius: 12px;
      font-size: var(--font-size-xs);
      font-weight: 600;
    }
    
    .gallery-loading {
      text-align: center;
      padding: var(--space-8);
      color: var(--color-text-muted);
    }
    
    .gallery-error {
      text-align: center;
      padding: var(--space-8);
      color: var(--color-error);
    }
    
    /* Album Card Styles - Redesigned */
    .album-card {
      background: #FFF8DC;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      border: 2px solid rgba(139, 0, 0, 0.15);
      position: relative;
      height: 100%;
    }
    
    .album-card:hover {
      transform: translateY(-12px) scale(1.02);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
      border-color: var(--color-primary);
    }
    
    .album-card.selected {
      border-color: var(--color-primary);
      border-width: 3px;
      box-shadow: 0 12px 32px rgba(139, 0, 0, 0.25);
    }
    
    .album-card-thumbnail {
      width: 100%;
      height: 240px;
      background: linear-gradient(135deg, #FAEBD7 0%, #FFF8DC 100%);
      position: relative;
      overflow: hidden;
    }
    
    .album-card-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .album-card:hover .album-card-thumbnail img {
      transform: scale(1.1);
    }
    
    .album-card-thumbnail-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 64px;
      color: rgba(139, 0, 0, 0.3);
      background: linear-gradient(135deg, #FAEBD7 0%, #FFF8DC 100%);
    }
    
    .album-card-thumbnail-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to bottom, rgba(139, 0, 0, 0.7) 0%, rgba(139, 0, 0, 0.5) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: var(--font-size-xl);
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .album-card:hover .album-card-thumbnail-overlay {
      opacity: 1;
    }
    
    .album-card-content {
      padding: var(--space-5);
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
      flex: 1;
      min-height: 140px;
    }
    
    .album-card-header {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }
    
    .album-name {
      font-weight: 700;
      font-size: var(--font-size-lg);
      color: #1a1a1a;
      line-height: 1.4;
      margin: 0;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      transition: color 0.3s ease;
    }
    
    .album-card:hover .album-name {
      color: var(--color-primary);
    }
    
    .album-theme {
      color: #666;
      font-size: var(--font-size-sm);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .album-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: var(--space-4);
      border-top: 2px solid #f5f5f5;
      margin-top: auto;
    }
    
    .album-meta {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--space-3);
      font-size: var(--font-size-xs);
      color: #888;
    }
    
    .album-meta-item {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      white-space: nowrap;
    }
    
    .album-image-count {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-2) var(--space-3);
      background: linear-gradient(135deg, rgba(139, 0, 0, 0.1) 0%, rgba(220, 20, 60, 0.1) 100%);
      color: var(--color-primary);
      border-radius: 20px;
      font-weight: 700;
      font-size: var(--font-size-xs);
      border: 1px solid rgba(139, 0, 0, 0.2);
    }
    
    .album-card-actions {
      display: flex;
      gap: var(--space-2);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .album-card:hover .album-card-actions {
      opacity: 1;
    }
    
    .album-card-action-btn {
      width: 32px;
      height: 32px;
      padding: 0;
      background: #FFF8DC;
      border: 1px solid rgba(139, 0, 0, 0.2);
      border-radius: 8px;
      font-size: var(--font-size-base);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .album-card-action-btn:hover {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
      transform: scale(1.1);
    }
    
    @media (max-width: 1200px) {
      .albums-grid {
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: var(--space-5);
      }
    }
    
    @media (max-width: 1024px) {
      .albums-grid {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: var(--space-4);
      }
      
      .albums-grid-container {
        padding: var(--space-4);
      }
    }
    
    @media (max-width: 767px) {
      .albums-grid {
        grid-template-columns: 1fr;
        gap: var(--space-4);
      }
      
      .albums-grid-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .albums-grid-container {
        padding: var(--space-3);
      }
      
      .gallery-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: var(--space-3);
      }
      
      .album-card-thumbnail {
        height: 200px;
      }
      
      .gallery-view {
        padding: var(--space-4);
      }
    }
    
    .album-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .album-name {
      font-weight: var(--font-weight-semibold);
      font-size: var(--font-size-xl);
      color: var(--color-primary);
      flex: 1;
      line-height: 1.4;
      margin-bottom: var(--space-1);
    }
    
    .album-theme {
      color: var(--color-text-muted);
      font-size: var(--font-size-base);
      margin-top: var(--space-2);
      line-height: 1.5;
    }
    
    .album-meta {
      font-size: var(--font-size-sm);
      color: var(--color-text-muted);
      margin-top: var(--space-3);
      padding-top: var(--space-3);
      border-top: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .album-actions {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      margin-top: var(--space-2);
    }
    
    .album-actions-primary {
      width: 100%;
    }
    
    .album-actions-secondary {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      width: 100%;
    }
    
    .album-actions-tertiary {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-2);
      width: 100%;
    }
    
    .album-actions button {
      padding: var(--space-3) var(--space-4);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-medium);
      border-radius: var(--radius-md);
      transition: all 0.2s ease;
      white-space: nowrap;
      width: 100%;
    }
    
    .album-actions button:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    .album-actions-primary button {
      padding: var(--space-4) var(--space-5);
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
    }
    
    @media (max-width: 767px) {
      .album-actions-tertiary {
        grid-template-columns: 1fr;
        gap: var(--space-2);
      }
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      overflow: auto;
    }
    
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background-color: #FFF8DC;
      margin: auto;
      padding: var(--space-6);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      position: relative;
      border: 1px solid rgba(139, 0, 0, 0.2);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }
    
    .modal-header h3 {
      margin: 0;
      color: var(--color-primary);
    }
    
    .modal-close {
      font-size: 28px;
      font-weight: bold;
      color: var(--color-text-muted);
      cursor: pointer;
      line-height: 1;
    }
    
    .modal-close:hover {
      color: var(--color-text);
    }
    
    .modal-body {
      margin-bottom: var(--space-4);
    }
    
    .modal-footer {
      display: flex;
      gap: var(--space-3);
      justify-content: flex-end;
    }
    
    .form-group {
      margin-bottom: var(--space-4);
    }
    
    .form-group label {
      display: block;
      margin-bottom: var(--space-2);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
    }
    
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: var(--space-3);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-family: inherit;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
      outline: 2px solid rgba(139, 0, 0, 0.25);
      border-color: var(--color-primary);
    }
    
    /* Lightbox Modal */
    .lightbox-modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      cursor: pointer;
    }
    
    .lightbox-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .lightbox-content {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      cursor: default;
    }
    
    .lightbox-close {
      position: absolute;
      top: 20px;
      right: 40px;
      color: #fff;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
      z-index: 10000;
    }
    
    .lightbox-close:hover {
      opacity: 0.7;
    }
    
    .lightbox-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      color: #fff;
      font-size: 30px;
      font-weight: bold;
      cursor: pointer;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 4px;
      z-index: 10000;
    }
    
    .lightbox-nav:hover {
      background: rgba(0, 0, 0, 0.7);
    }
    
    .lightbox-prev {
      left: 20px;
    }
    
    .lightbox-next {
      right: 20px;
    }
    
    @media (max-width: 767px) {
      .lightbox-close {
        top: 10px;
        right: 20px;
        font-size: 30px;
      }
      
      .lightbox-nav {
        font-size: 24px;
        padding: 8px 16px;
      }
      
      .lightbox-prev {
        left: 10px;
      }
      
      .lightbox-next {
        right: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- TOC Toggle Button (Mobile) -->
  <button class="toc-toggle" onclick="toggleTOC()" id="tocToggle">📑 Mục Lục</button>

  <!-- TOC Overlay -->
  <div class="toc-overlay" id="tocOverlay"></div>

  <!-- Fixed Sidebar Table of Contents -->
  <div class="toc-sidebar" id="tocSidebar">
    <h3>📑 Mục Lục</h3>
    <ul class="toc-list">
      <li><a href="#gioi-thieu">Giới thiệu</a></li>
      <li><a href="#de-he-thi">Từ Tầm Nhìn Của Vua Minh Mạng Đến Bài Thơ "Đế Hệ Thi"</a></li>
      <li><a href="#tuy-bien-quan-cong">Ngài Tuy Biên Quận Công – Khởi Nguồn Một Nhánh Diệp Chi</a></li>
      <li><a href="#phu-he-to-he">Phụ Hệ và Tổ Hệ của Tuy Biên Quận Công Nguyễn Phúc Miên Sủng</a></li>
      <li><a href="#to-tien-dong-chua-nguyen">Tổ Tiên Dòng Chúa Nguyễn và Cao Tổ Đại Tộc</a></li>
          <li><a href="#so-hoa-gia-pha">Số Hóa Gia Phả – Kết Nối Quá Khứ Đến Tương Lai</a></li>
          <li><a href="#ket-tu">Kết Từ</a></li>
          <li><a href="#hinh-anh-nha-tho">Hình Ảnh Bên Trong Nhà Thờ</a></li>
          <li><a href="#album-anh">📷 Album Ảnh</a></li>
          <li><a href="#noi-dung-chinh">Thông tin hoạt động Phủ Tuy Biên</a></li>
          <li><a href="#hoat-dong-npt-vn">Hoạt động Hội đồng NPT VN</a></li>
          <li><a href="#tai-lieu">Tài liệu</a></li>
        </ul>
      </div>

  <!-- Navbar -->
  <nav class="navbar">
    <button class="navbar-toggle" onclick="toggleMenu()">☰</button>
    <ul class="navbar-menu" id="navbarMenu">
      <li><a href="/" onclick="setActive(this)">Trang chủ</a></li>
      <li><a href="/genealogy" onclick="setActive(this)">Gia phả</a></li>
      <li style="display: none;"><a href="/activities">Hoạt động</a></li>
      <li><a href="/members" onclick="setActive(this)">Thành viên</a></li>
      <li><a href="/contact" onclick="setActive(this)">Liên hệ</a></li>
      <li><a href="/vr-tour" onclick="setActive(this)">VR Tour</a></li>
      <li><a href="/admin/login">Admin</a></li>
    </ul>
  </nav>

  <!-- Section: Home -->
  <section id="home">
    <div class="hero-content">
      <h1>Gia Phả Nguyễn Phước Tộc<br>Phòng Tuy Biên Quận Công<br>Hậu duệ Vua Minh Mạng</h1>
      <p>Nhằm tra cứu, lưu trữ và quản lý gia phả dòng họ Nguyễn Phước Tộc - Tuy Biên Phòng đến thời điểm hiện tại.</p>
      <a href="/genealogy" class="cta-button">Xem Gia Phả</a>
    </div>
  </section>

  <!-- Section: About -->
  <section id="about">
    <div class="section-container">
      <h2 class="section-title" id="gioi-thieu">Giới Thiệu</h2>
      
      <div class="about-content">
        <div class="about-text">
          <h3>TUY BIÊN QUẬN CÔNG – DÒNG CHẢY HUY HOÀNG TRONG LÒNG NGUYỄN PHƯỚC TỘC</h3>
          
          <p>
            Trong dòng chảy hàng trăm năm của lịch sử Việt Nam, triều Nguyễn hiện lên như một chương sử rực rỡ, kết tinh những thành tựu lớn lao về văn hóa, thể chế và tư tưởng trị quốc. Triều đại này được khởi đầu bởi <strong>Vua Gia Long</strong> (1802–1820), vị hoàng đế đầu tiên của nhà Nguyễn, người đã thống nhất đất nước và đặt nền móng cho một triều đại kéo dài hơn 140 năm.
          </p>
          
          <div class="about-image" style="text-align: center; margin: var(--space-6) 0;">
            <img src="/static/images/1. vua-gia-long.jpg" alt="Vua Gia Long" style="max-width: 100%; height: auto; border-radius: var(--radius-md); box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          </div>
          
          <p>
            Giữa bức tranh ấy, triều đại <strong>vua Minh Mạng</strong> (trị vì 1820–1841) nổi bật như một giai đoạn đỉnh cao của sự củng cố và hoàn thiện quốc gia phong kiến trung ương tập quyền. Với tầm nhìn xa rộng và ý chí sắt đá, nhà vua không chỉ đặt nền móng cho một bộ máy hành chính chặt chẽ mà còn dành tâm huyết đặc biệt cho việc xây dựng, duy trì và phát triển bền vững dòng tộc hoàng gia – Nguyễn Phước Tộc.
          </p>
          
          <div class="about-image" style="text-align: center; margin: var(--space-6) 0;">
            <img src="/static/images/2. vua-minh-mang.jpg" alt="Vua Minh Mạng" style="max-width: 100%; height: auto; border-radius: var(--radius-md); box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          </div>
          
          <p>
            Chính trong tinh thần ấy, tư tưởng "gốc sâu thì cành lá mới bền vững" đã trở thành kim chỉ nam cho mọi cải cách của nhà vua, không chỉ ở bình diện quốc gia mà còn trong phạm vi huyết thống hoàng tộc.
          </p>

          <h3 id="de-he-thi">Từ Tầm Nhìn Của Vua Minh Mạng Đến Bài Thơ "Đế Hệ Thi"</h3>
          
          <p>
            Vua Minh Mạng không chỉ là một nhà chính trị quyết đoán mà còn là một học giả uyên thâm Nho học, thấu hiểu sâu sắc quy luật vận hành của xã hội và gia tộc. Với khát vọng để dòng dõi hoàng gia "trăm đời truyền nối, muôn năm không dứt", vào năm 1823, nhà vua đã ngự soạn bài thơ nổi tiếng mang tên <strong>Đế Hệ Thi</strong>.
          </p>
          
          <p>
            Bài thơ không đơn thuần là một tác phẩm văn chương, mà là một hệ thống quy tắc đặt tên mang tính khoa học, chặt chẽ và lâu dài. Hai mươi chữ trong bài thơ được quy định làm chữ lót cho các thế hệ hậu duệ kể từ sau vua Minh Mạng, qua đó xác lập trật tự tôn ti, phân định rõ ràng thứ bậc trong nội tộc, tránh sự nhầm lẫn về vai vế, thân – sơ trong hoàng phái.
          </p>
          
          <blockquote>
            <strong>Bốn câu thơ ngũ ngôn tứ tuyệt:</strong><br><br>
            <em>Miên Hồng Ưng Bửu Vĩnh</em><br>
            <em>Bảo Quý Định Long Trường</em><br>
            <em>Hiền Năng Khang Kế Thuật</em><br>
            <em>Thế Thụy Quốc Gia Xương</em>
          </blockquote>
          
          <div class="about-image" style="text-align: center; margin: var(--space-6) 0;">
            <img src="/static/images/3. kim sach de he thi.jpg" alt="Kim sách Đế Hệ Thi" style="max-width: 100%; height: auto; border-radius: var(--radius-md); box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          </div>
          
          <p>
            Hệ thống này đã giúp Nguyễn Phước Tộc duy trì được sự mạch lạc, chuẩn mực trong suốt nhiều thế hệ, đúng như lời vua Minh Mạng từng kỳ vọng: <em>"Thế thứ rõ ràng mà không lẫn, thân sơ phân biệt mà ai cũng có thể biết."</em>
          </p>
          
          <div class="about-image" style="text-align: center; margin: var(--space-6) 0;">
            <img src="/static/images/4. kinh-thanh-hue.jpg" alt="Kinh thành Huế" style="max-width: 100%; height: auto; border-radius: var(--radius-md); box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          </div>

          <h3 id="tuy-bien-quan-cong">Ngài Tuy Biên Quận Công – Khởi Nguồn Một Nhánh Diệp Chi</h3>
          
          <p>
            Trong hệ thống tôn phả đồ sộ của hoàng tộc Nguyễn Phước, mỗi phòng hệ đều mang trong mình một dấu ấn riêng, phản ánh vai trò, công đức và vị thế của người khai phòng. <strong>Nguyễn Phúc Miên Sủng (1831–1865)</strong> – hoàng tử thứ 53 của vua Minh Mạng – chính là vị khai phong của Phòng Tuy Biên Quận Công, mở đầu cho một nhánh diệp chi độc lập, có danh xưng, quy ước và truyền thống riêng trong đại gia đình Nguyễn Phước.
          </p>
          
          <p>
            Ngài sinh ngày mùng 8 tháng 4 năm Tân Mão (1831), là trưởng nam của Lục giai Tiệp dư Nguyễn Thị Viên – một phi tần nổi tiếng đoan trang, tiết hạnh trong nội đình. Ngay từ thuở thiếu thời, hoàng tử Miên Sủng đã được nuôi dạy theo khuôn phép nghiêm cẩn của hoàng gia, sớm bộc lộ tư chất điềm đạm, cẩn trọng, hiếu học và trọng lễ nghi. Trong sinh hoạt thường nhật cũng như học tập, ngài luôn giữ phong thái mực thước, không phô trương, không thiên lệch, đúng với chuẩn mực của một bậc vương tôn được kỳ vọng lâu dài.
          </p>
          
          <p>
            Năm Canh Tý (1840), dưới triều vua Minh Mạng, ngài được sách phong <strong>Tuy Nhân Quận Công</strong> – một tước hiệu thể hiện sự tín nhiệm của triều đình đối với phẩm hạnh và tư chất của hoàng tử. Tuy nhiên, đến năm Nhâm Dần (1842), dưới triều vua Thiệu Trị, do chữ "Nhân" trùng với thụy hiệu của Tiên đế Minh Mạng, triều đình đã chuẩn y cải phong tước hiệu thành <strong>Tuy Biên Quận Công</strong>. Từ đây, danh xưng Tuy Biên chính thức gắn liền với ngài và trở thành định danh vĩnh viễn của toàn bộ hậu duệ phòng hệ.
          </p>
          
          <p>
            Trên phương diện tôn thất, Tuy Biên Quận Công Nguyễn Phúc Miên Sủng không chỉ là một hoàng tử được phong tước, mà còn là người đặt nền móng tổ chức cho một phòng hệ hoàn chỉnh: từ nghi lễ thờ tự, quy ước nội phòng, đến trật tự xưng danh của hậu duệ. Dù không nổi bật trên chính trường hay quân vụ, ngài được ghi nhận là bậc hoàng thân lấy đức làm gốc, giữ tròn bổn phận với triều đình, hòa mục với tôn thất, và nêu gương chuẩn mực cho con cháu.
          </p>
          
          <p>
            Năm Ất Sửu (1865), ngài qua đời, hưởng dương 35 tuổi. Triều đình truy ban thụy hiệu <strong>Cẩn Mục</strong> – một thụy hiệu mang ý nghĩa sâu sắc:
          </p>
          
          <ul>
            <li><strong>"Cẩn":</strong> cẩn trọng, nghiêm túc, giữ lễ không sai lệch</li>
            <li><strong>"Mục":</strong> nhu hòa, đôn hậu, lấy đức để cảm hóa</li>
          </ul>
          
          <p>
            Sau khi ngài mất, tẩm mộ và phủ thờ của Tuy Biên Quận Công trở thành nơi con cháu các đời về phụng tế, tưởng niệm, không chỉ như một vị tổ khai phòng, mà còn như biểu tượng của nếp nhà lấy lễ – đức – kỷ cương làm trọng.
          </p>
          
          <p>
            Để định danh rõ ràng và tạo sự thống nhất cho hậu duệ phòng Tuy Biên, vua Minh Mạng đã ban riêng bộ chữ <strong>"Phong" (風 – nghĩa là gió)</strong> làm chữ lót đặt tên cho các công tử trong phòng. Việc ban chữ này không chỉ mang ý nghĩa quản lý tôn phả, mà còn hàm chứa tư tưởng biểu trưng: "Phong" – gió tuy vô hình nhưng lan tỏa bền bỉ, mềm mại mà không suy, linh hoạt mà vẫn có quy luật.
          </p>
          
          <p>
            Chính từ đây, Phòng Tuy Biên Quận Công được xác lập như một nhánh diệp chi riêng biệt, có:
          </p>
          
          <ul>
            <li>Tổ khai phòng rõ ràng</li>
            <li>Tước hệ ổn định</li>
            <li>Quy ước đặt tên đặc thù</li>
            <li>Truyền thống gia phong xuyên suốt qua nhiều thế hệ</li>
          </ul>
          
          <p>
            Trong đại tộc Nguyễn Phước, Tuy Biên Quận Công Nguyễn Phúc Miên Sủng vì thế không chỉ được nhớ đến với tư cách một hoàng tử, mà còn là người đặt nền móng cho một dòng hậu duệ có căn cơ, danh phận và bản sắc riêng, góp phần làm phong phú và bền vững cho cấu trúc toàn thể của hoàng tộc triều Nguyễn.
          </p>

          <h3 id="phu-he-to-he">Phụ Hệ và Tổ Hệ của Tuy Biên Quận Công Nguyễn Phúc Miên Sủng</h3>
          
          <p>
            Về phụ hệ trực tiếp, Tuy Biên Quận Công Nguyễn Phúc Miên Sủng xuất thân từ dòng chính thống của hoàng tộc triều Nguyễn, kế thừa liên tục từ các đời chúa Nguyễn đến hoàng đế khai sáng vương triều.
          </p>
          
          <p>
            <strong>Cha của ngài là vua Minh Mạng</strong> – Nguyễn Phúc Đảm (阮福膽, 1791–1841), vị hoàng đế thứ hai của triều Nguyễn, trị vì từ năm 1820 đến 1841. Minh Mạng hoàng đế nổi tiếng là bậc minh quân có tầm nhìn sâu rộng, củng cố nền hành chính trung ương tập quyền, hoàn chỉnh thể chế quốc gia và đặc biệt chú trọng việc định danh, sắp xếp và quản lý tôn thất. <strong>Mẹ của Tuy Biên Quận Công là Lục giai Tiệp dư Nguyễn Thị Viên</strong>, người được ghi nhận với đức hạnh đoan trang, nề nếp, góp phần hình thành nhân cách cẩn trọng và khuôn phép của hoàng tử Miên Sủng.
          </p>
          
          <p>
            <strong>Ông nội của ngài là vua Gia Long</strong> – Nguyễn Phúc Ánh (阮福暎, 1762–1820), vị hoàng đế khai sáng triều Nguyễn, trị vì từ năm 1802 đến 1820. Gia Long là người thống nhất sơn hà sau nhiều thập niên binh biến, đặt nền móng cho triều đại kéo dài hơn một thế kỷ trong lịch sử Việt Nam.
          </p>
          
          <p>
            Lên một đời nữa, <strong>ông cố của ngài là Nguyễn Phúc Luân</strong> (阮福㫻, 1733–1765), được tôn xưng là Đức Hưng Tổ. Dù không trực tiếp trị vì, Nguyễn Phúc Luân giữ vai trò đặc biệt quan trọng trong việc truyền thừa chính thống của dòng chúa Nguyễn, là thân phụ của vua Gia Long.
          </p>
          
          <p>
            Trước đó, <strong>ông sơ của ngài là Nguyễn Phúc Khoát</strong> (阮福濶, 1714–1765), được tôn hiệu Vũ Vương (武王), trị vì Đàng Trong từ năm 1738 đến 1765. Thời kỳ của Vũ Vương đánh dấu sự phát triển ổn định về chính trị, văn hóa và lễ chế, đặt tiền đề cho việc hình thành vương quyền về sau.
          </p>
          
          <h4 id="to-tien-dong-chua-nguyen">Tổ Tiên Dòng Chúa Nguyễn và Cao Tổ Đại Tộc</h4>
          
          <p>
            Từ Nguyễn Phúc Khoát trở ngược lên, Tuy Biên Quận Công Nguyễn Phúc Miên Sủng thuộc về chuỗi truyền thừa liên tục của các đời chúa Nguyễn, bắt đầu từ thời Nguyễn Hoàng vào Thuận Hóa:
          </p>
          
          <ul>
            <li><strong>Nguyễn Phúc Thụ</strong> (1697–1738) – Ninh Vương (寧王), trị vì giai đoạn 1725–1738</li>
            <li><strong>Nguyễn Phúc Chu</strong> (阮福淍, 1675–1725) – Chúa Minh, người mở mang văn hóa, Phật giáo và giáo dục Đàng Trong</li>
            <li><strong>Nguyễn Phúc Thái</strong> (阮福溙, 1649–1691) – Chúa Nghĩa</li>
            <li><strong>Nguyễn Phúc Tần</strong> (阮福瀕, 1620–1687) – Chúa Hiền, củng cố quân sự và phòng thủ phương Nam</li>
            <li><strong>Nguyễn Phúc Lan</strong> (阮福瀾, 1601–1648) – Chúa Thượng (上王)</li>
            <li><strong>Nguyễn Phúc Nguyên</strong> (阮福源, 1563–1635) – Chúa Sãi, người đặt nền móng cai trị ổn định tại Thuận – Quảng</li>
            <li><strong>Nguyễn Hoàng</strong> (阮潢, 1525–1613) – Chúa Tiên, vị tổ khai sáng cơ nghiệp các chúa Nguyễn tại Đàng Trong</li>
          </ul>
          
          <p>
            Trước thời các chúa Nguyễn, dòng họ tiếp tục nối dài qua các bậc công thần và danh tướng thời Lê – Trần, tiêu biểu như:
          </p>
          
          <ul>
            <li><strong>Nguyễn Kim</strong> (阮淦, 1468–1545) – Triệu Tổ, người trung hưng nhà Lê</li>
            <li><strong>Nguyễn Văn Lựu</strong> (阮文溜) – Trừng Quốc Công</li>
            <li><strong>Nguyễn Như Trác</strong> (阮如琢) – Phó Quốc Công</li>
            <li><strong>Nguyễn Công Duẩn</strong> (阮公笋) – Thái Bảo Hoằng Quốc Công</li>
            <li><strong>Nguyễn Sừ</strong> (阮儲) – Chiêu Quang Hầu</li>
            <li><strong>Nguyễn Chiêm</strong> (阮佔) – Quản Nội</li>
            <li><strong>Nguyễn Biện</strong> (阮忭) – Phụ Đạo Huệ Quốc Công</li>
          </ul>
          
          <p>
            Xa hơn nữa, tổ hệ của dòng Nguyễn Phước được truy nguyên đến các nhân vật thời Trần – Đinh:
          </p>
          
          <ul>
            <li><strong>Nguyễn Minh Du</strong> (阮明俞, 1330–1390) – Du Cần Công</li>
            <li><strong>Nguyễn Công Luật</strong> (阮公律) – Hữu Hiểu Điểm</li>
            <li><strong>Nguyễn Nạp Hoa</strong> (阮納和) – Bình Man Đại Tướng Quân</li>
            <li><strong>Nguyễn Thế Tứ</strong> (阮世賜) – Đô Hiệu Kiểm</li>
            <li><strong>Nguyễn Nộn</strong> (阮嫩) – Hoài Đạo Hiếu Vũ Vương</li>
            <li><strong>Nguyễn Phụng</strong> (阮奉) – Tả Đô Đốc</li>
            <li><strong>Nguyễn Viễn</strong> (阮遠) – Tả Quốc Công</li>
            <li><strong>Nguyễn Đê</strong> (阮低) – Đức Đô Hiệu Kiểm</li>
          </ul>
          
          <p>
            Khởi nguyên của toàn bộ dòng tộc là <strong>Nguyễn Bặc</strong> (阮匐, 924–979) – Đức Định Quốc Công, khai quốc công thần triều Đinh, người được tôn làm Thủy tổ của đại tộc Nguyễn, từ đó mở ra dòng truyền thừa kéo dài hơn một thiên niên kỷ trong lịch sử Việt Nam.
          </p>

          <h3 id="so-hoa-gia-pha">Số Hóa Gia Phả – Kết Nối Quá Khứ Đến Tương Lai</h3>
          
          <p>
            Trải qua bao biến thiên của lịch sử, con cháu Phòng Tuy Biên Quận Công ngày nay đã tản cư, sinh sống và lập nghiệp ở nhiều vùng miền trong nước cũng như khắp năm châu. Trong bối cảnh ấy, việc bảo tồn những trang <strong>Ngọc phả</strong>, vốn được lưu giữ bằng kim sách hoặc bản in giấy truyền thống, đang đối mặt với thách thức lớn từ thời gian, môi trường và sự đứt gãy thế hệ.
          </p>
          
          <p>
            Xuất phát từ nhận thức đó, <strong>dự án xây dựng hệ thống tra cứu gia phả điện tử</strong> được hình thành như một nhịp cầu hiện đại, kết nối quá khứ hào hùng với tương lai bền vững. Dự án mang lại những giá trị cốt lõi:
          </p>
          
          <ul>
            <li><strong>Bảo tồn vĩnh cửu:</strong> Toàn bộ dữ liệu thế phả được chuyển đổi sang định dạng số, giảm thiểu tối đa nguy cơ mai một, thất lạc hay hư hỏng theo năm tháng.</li>
            <li><strong>Tra cứu thuận tiện:</strong> Con cháu dù ở bất cứ nơi đâu cũng có thể dễ dàng tìm hiểu về nguồn gốc, vai thứ và hành trạng của tổ tiên; từ đó hiểu rõ ý nghĩa các chữ lót như <em>Miên, Hồng, Ưng, Bửu…</em> trong chính tên gọi của mình.</li>
            <li><strong>Kết nối huyết thống:</strong> Hệ thống tạo ra một không gian chung để các thành viên trong dòng họ giao lưu, chia sẻ, hỗ trợ lẫn nhau, góp phần thắt chặt tình cốt nhục – giá trị nền tảng của Nguyễn Phước Tộc.</li>
            <li><strong>Lưu trữ bền vững:</strong> Thông tin về các thế hệ mới được cập nhật liên tục, bảo đảm dòng chảy của Phòng Tuy Biên Quận Công luôn được ghi chép đầy đủ, liền mạch cho mai sau.</li>
          </ul>

          <h3 id="ket-tu">Kết Từ</h3>
          
          <p>
            Sứ mệnh của con cháu hôm nay không chỉ dừng lại ở niềm tự hào về quá khứ, mà còn là trách nhiệm gìn giữ và tiếp nối niềm tự hào ấy trong kỷ nguyên số. Hệ thống gia phả điện tử chính là <strong>nén tâm nhang hiện đại</strong> mà thế hệ hôm nay kính dâng lên ngài Tuy Biên Quận Công và đức Thánh Tổ Minh Mạng – một lời khẳng định vững chắc rằng:
          </p>
          
          <blockquote>
            <strong>Gốc có sâu thì chí mới vững, chí có vững thì cành lá mới sum suê, xanh tốt muôn đời.</strong>
          </blockquote>
          
          <div class="about-image" style="text-align: center; margin: var(--space-6) 0;">
            <img src="/static/images/5. phu-tuy-bien.jpg" alt="Phủ Tuy Biên" style="max-width: 100%; height: auto; border-radius: var(--radius-md); box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          </div>
          
          <!-- Google Maps -->
          <div class="about-map" style="text-align: center; margin: var(--space-6) 0;">
            <iframe 
              src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3826.8494473948927!2d107.59601731485532!3d16.49516058864719!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3141a0c29d9b7599%3A0xe46d1cf33efaad01!2zUGjDsm5nIFR1eSBCacOqbiBRdeG6rW4gQ8O0bmc!5e0!3m2!1svi!2s!4v1736438400000!5m2!1svi!2s&output=embed" 
              width="100%" 
              height="450" 
              style="border:0; border-radius: var(--radius-md); box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 100%;" 
              allowfullscreen="" 
              loading="lazy" 
              referrerpolicy="no-referrer-when-downgrade"
              title="Bản đồ Phòng Tuy Biên Quận Công">
            </iframe>
          </div>
          
          <p style="margin-top: 16px; font-style: italic; color: #666; border-top: 1px solid #ddd; padding-top: 12px;">
            <em>Thông tin trong bài viết được tổng hợp và đối chiếu từ các sử liệu triều Nguyễn và thế phả Nguyễn Phước Tộc.</em>
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Section: Temple Interior -->
  <section id="temple-interior">
    <div class="section-container">
      <h2 class="section-title" id="hinh-anh-nha-tho">Hình Ảnh Bên Trong Nhà Thờ</h2>
      <div class="about-content">
        <div class="about-text">
          <p>
            Bên trong nhà thờ Phòng Tuy Biên Quận Công, nơi thờ tự trang nghiêm với những hoành phi và câu đối mang đậm giá trị văn hóa truyền thống. Các văn tự Hán cổ không chỉ là trang trí mà còn chứa đựng những ý nghĩa sâu sắc về công đức, phúc thọ và sự kế thừa của dòng tộc.
          </p>
          
          <div class="about-image" style="text-align: center; margin: var(--space-6) 0;">
            <img src="/static/images/6-trong-nha-tho.jpg" alt="Hình ảnh bên trong nhà thờ Phòng Tuy Biên Quận Công" style="max-width: 100%; height: auto; border-radius: var(--radius-md); box-shadow: 0 4px 15px rgba(0,0,0,0.1);" onerror="console.error('Failed to load image: 6-trong-nha-tho.jpg'); this.style.display='none';">
          </div>

          <h3 style="font-size: clamp(18px, 5vw, 24px);">1️⃣ Hoành phi ở chính giữa (phía trên)</h3>
          
          <div style="background: #f8f5f0; padding: clamp(16px, 4vw, 20px); border-radius: 8px; margin: clamp(16px, 4vw, 20px) 0; border-left: 4px solid #d8b45c;">
            <p style="font-size: clamp(20px, 6vw, 32px); font-weight: bold; text-align: center; margin-bottom: clamp(12px, 3vw, 15px); color: #8B4513;">
              📜 繼述郡公祠
            </p>
            
            <p style="font-size: clamp(14px, 4vw, 16px);"><strong>Đọc Hán–Việt:</strong> Kế Thuật Quận Công Từ</p>
            
            <p style="font-size: clamp(14px, 4vw, 16px);"><strong>Ý nghĩa:</strong></p>
            <ul style="margin-left: clamp(16px, 4vw, 20px); line-height: 1.8; font-size: clamp(13px, 3.5vw, 15px);">
              <li><strong>繼述 (Kế thuật):</strong> nối tiếp, kế thừa công đức – sự nghiệp của tiền nhân</li>
              <li><strong>郡公 (Quận công):</strong> tước vị quý tộc cao (thường phong cho công thần, hoàng thân)</li>
              <li><strong>祠 (Từ):</strong> đền thờ, từ đường</li>
            </ul>
            
            <p style="margin-top: clamp(12px, 3vw, 15px); padding: clamp(12px, 3vw, 15px); background: #FFF8DC; border-radius: 5px; border: 1px solid #d8b45c; font-size: clamp(13px, 3.5vw, 15px);">
              <strong>👉 Toàn bộ có thể hiểu là:</strong><br>
              "Đền thờ Quận Công – nơi kế thừa và tôn vinh công đức của bậc tiền nhân."
            </p>
          </div>

          <h3 style="font-size: clamp(18px, 5vw, 24px);">2️⃣ Câu đối bên trái (nhìn từ ngoài vào)</h3>
          
          <div style="background: #f8f5f0; padding: clamp(16px, 4vw, 20px); border-radius: 8px; margin: clamp(16px, 4vw, 20px) 0; border-left: 4px solid #d8b45c;">
            <p style="font-size: clamp(18px, 5vw, 28px); font-weight: bold; text-align: center; margin-bottom: clamp(12px, 3vw, 15px); color: #8B4513;">
              📜 九勳重書延定喜肇王芝季
            </p>
            
            <p style="font-size: clamp(14px, 4vw, 16px);"><strong>Đặc điểm:</strong></p>
            <ul style="margin-left: clamp(16px, 4vw, 20px); line-height: 1.8; font-size: clamp(13px, 3.5vw, 15px);">
              <li>Là câu đối Hán văn cổ, bố cục dọc</li>
              <li>Có các từ khóa mang tính vinh danh – phúc thọ – dòng tộc</li>
            </ul>
            
            <p style="font-size: clamp(14px, 4vw, 16px);"><strong>Phân tích ý nghĩa (theo cụm):</strong></p>
            <ul style="margin-left: clamp(16px, 4vw, 20px); line-height: 1.8; font-size: clamp(13px, 3.5vw, 15px);">
              <li><strong>九勳:</strong> chín công lao lớn (ám chỉ đại công thần)</li>
              <li><strong>重書:</strong> ghi chép, lưu danh nhiều lần</li>
              <li><strong>延定:</strong> kéo dài sự ổn định, bền vững</li>
              <li><strong>喜肇:</strong> khởi đầu tốt lành</li>
              <li><strong>王芝季:</strong> tên húy / pháp danh / thụy hiệu của nhân vật được thờ (thường không dịch nghĩa)</li>
            </ul>
            
            <p style="margin-top: clamp(12px, 3vw, 15px); padding: clamp(12px, 3vw, 15px); background: #FFF8DC; border-radius: 5px; border: 1px solid #d8b45c; font-size: clamp(13px, 3.5vw, 15px);">
              <strong>👉 Ý chung:</strong><br>
              Ca ngợi công lao lớn, lưu danh muôn đời, mang lại nền tảng ổn định và khởi đầu cát tường cho dòng tộc.
            </p>
          </div>

          <h3 style="font-size: clamp(18px, 5vw, 24px);">3️⃣ Câu đối bên phải</h3>
          
          <div style="background: #f8f5f0; padding: clamp(16px, 4vw, 20px); border-radius: 8px; margin: clamp(16px, 4vw, 20px) 0; border-left: 4px solid #d8b45c;">
            <p style="font-size: clamp(18px, 5vw, 28px); font-weight: bold; text-align: center; margin-bottom: clamp(12px, 3vw, 15px); color: #8B4513;">
              📜 國運昌隆壽福合慶萬年
            </p>
            
            <p style="font-size: clamp(14px, 4vw, 16px);"><strong>Đọc Hán–Việt:</strong> Quốc vận xương long, thọ phúc hợp khánh vạn niên</p>
            
            <p style="font-size: clamp(14px, 4vw, 16px);"><strong>Ý nghĩa từng phần:</strong></p>
            <ul style="margin-left: clamp(16px, 4vw, 20px); line-height: 1.8; font-size: clamp(13px, 3.5vw, 15px);">
              <li><strong>國運昌隆:</strong> vận nước hưng thịnh</li>
              <li><strong>壽福:</strong> trường thọ và phúc đức</li>
              <li><strong>合慶:</strong> hội tụ điều lành</li>
              <li><strong>萬年:</strong> muôn năm</li>
            </ul>
            
            <p style="margin-top: clamp(12px, 3vw, 15px); padding: clamp(12px, 3vw, 15px); background: #FFF8DC; border-radius: 5px; border: 1px solid #d8b45c; font-size: clamp(13px, 3.5vw, 15px);">
              <strong>👉 Câu này mang ý nghĩa chúc tụng rất rõ:</strong><br>
              "Vận nước hưng thịnh, phúc thọ viên mãn, cát khánh hội tụ muôn đời."
            </p>
          </div>

          <h3 style="font-size: clamp(18px, 5vw, 24px);">4️⃣ Tổng thể phong cách chữ & ngữ cảnh</h3>
          
          <p style="font-size: clamp(14px, 4vw, 16px);">Chữ viết là Hán tự truyền thống, thường dùng trong:</p>
          <ul style="margin-left: clamp(16px, 4vw, 20px); line-height: 1.8; font-size: clamp(13px, 3.5vw, 15px);">
            <li>Đền thờ</li>
            <li>Từ đường</li>
            <li>Miếu thờ công thần, tổ tiên</li>
            <li>Văn phong trang trọng – điển chế – tôn vinh</li>
          </ul>
          
          <p style="font-size: clamp(14px, 4vw, 16px);">Không phải chữ Trung Quốc hiện đại, mà là <strong>Hán văn cổ</strong> dùng trong văn hóa Việt – Hoa – Nho giáo.</p>

          <h3 style="font-size: clamp(18px, 5vw, 24px);">Nhận định chung</h3>
          
          <div style="background: #fff5e6; padding: clamp(16px, 4vw, 20px); border-radius: 8px; margin: clamp(16px, 4vw, 20px) 0; border: 2px solid #d8b45c;">
            <p style="font-size: clamp(14px, 4vw, 16px);">Đây không phải câu chữ trang trí ngẫu nhiên. Nội dung cho thấy:</p>
            <ul style="margin-left: clamp(16px, 4vw, 20px); line-height: 1.8; font-size: clamp(13px, 3.5vw, 15px);">
              <li>Thờ nhân vật có tước vị cao (Quận Công)</li>
              <li>Nhấn mạnh công lao – phúc đức – dòng tộc – vận nước</li>
              <li>Bố cục chuẩn mực của từ đường / công thần miếu</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Photo Carousel Section -->
  <section class="photo-carousel-section" id="album-anh">
    <div class="section-container">
      <div class="carousel-header">
        <h2>📷 Album Ảnh</h2>
        <p>Bộ sưu tập hình ảnh từ các hoạt động và sự kiện</p>
        <a href="/activities#albums" class="btn-view-all">Xem tất cả albums →</a>
      </div>
      <div id="photoCarousel" class="photo-carousel">
        <div class="carousel-loading">Đang tải ảnh...</div>
      </div>
    </div>
  </section>

  <!-- Section: News Feed / Nội dung chính -->
  <section id="news-feed">
    <div class="section-container">
      <h2 class="section-title" id="noi-dung-chinh">Thông tin hoạt động Phủ Tuy Biên</h2>
      <div class="news-feed-container">
        <!-- Bài nổi bật -->
        <div class="featured-posts-section">
          <h3 style="color: #8B0000; font-size: clamp(20px, 4vw, 24px); margin-bottom: var(--space-4); border-bottom: 2px solid #DAA520; padding-bottom: var(--space-2);">Bài nổi bật</h3>
          <div id="featuredPosts" class="featured-posts">
            <div style="text-align: center; padding: var(--space-8); color: var(--color-text-muted, #6b7280);">
              Đang tải...
            </div>
          </div>
        </div>

        <!-- Tin nổi bật -->
        <div class="hot-news-section">
          <h3 class="hot-news-title" style="color: #8B0000; font-size: clamp(20px, 4vw, 24px); margin-bottom: var(--space-4); border-bottom: 2px solid #DAA520; padding-bottom: var(--space-2);">TIN NỔI BẬT</h3>
          <ul id="hotNewsList" class="hot-news-list">
            <li style="text-align: center; padding: var(--space-4); color: var(--color-text-muted, #6b7280);">Đang tải...</li>
          </ul>
        </div>

        <!-- Chuyên mục -->
        <div id="categorySections" class="category-sections">
          <div style="text-align: center; padding: var(--space-8); color: var(--color-text-muted, #6b7280);">
            Đang tải...
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Section: External Posts / Bài đăng từ NPT VN -->
  <section id="external-posts" class="external-posts-section">
    <div class="section-container">
      <div style="text-align: center; margin-bottom: 30px;">
        <h2 class="section-title" id="hoat-dong-npt-vn">Hoạt động Hội đồng NPT VN</h2>
        <p style="font-size: 14px; color: #666; margin-top: 8px; font-style: italic;">
          <strong>Nguồn:</strong> 
          <a href="https://nguyenphuoctoc.info/hoat-dong-hoi-dong-npt-vn/"
             target="_blank"
             rel="noopener noreferrer"
             style="color: #8B0000; text-decoration: underline;">
            nguyenphuoctoc.info
          </a>
        </p>
      </div>
      
      <div id="externalPosts" class="external-posts-container">
        <div style="text-align: center; padding: 40px; color: #6b7280;">
          Đang tải...
        </div>
      </div>
    </div>
  </section>

  <!-- Section: Documents / Tài liệu -->
  <section id="documents" class="documents-section">
    <div class="section-container">
      <div class="page-header">
        <h2 class="section-title" id="tai-lieu">Tài liệu</h2>
        <p class="page-subtitle">Các tài liệu lịch sử và gia phả quý giá</p>
      </div>

      <!-- Phần 1: Tài liệu lịch sử chính -->
      <div style="margin-bottom: 40px;">
        <div style="text-align: center; margin-bottom: 30px;">
          <h2 style="font-size: 24px; color: #8B0000; margin-bottom: 10px;">
            Phần 1: Tài liệu lịch sử chính
          </h2>
          <p style="color: #6b7280; font-size: 14px;">
            Các tài liệu quý giá về lịch sử và phả hệ hoàng tộc triều Nguyễn
          </p>
        </div>
        <div class="documents-grid">
          <!-- Document 1: Hoàng Tộc Biên Lược -->
          <div class="document-card">
            <h2 class="document-title">Hoàng Tộc Biên Lược</h2>
            <p class="document-description">
              Tài liệu quý giá ghi chép về lịch sử và phả hệ của hoàng tộc triều Nguyễn, 
              bao gồm các thông tin chi tiết về các đời vua, hoàng tử, và các phòng hệ trong hoàng tộc.
            </p>
            <div class="document-actions">
              <a href="https://nguyenphuoctoc.info/download/hoang-toc-luoc-bien.pdf" target="_blank" class="btn-view">
                Xem tài liệu
              </a>
              <a href="https://nguyenphuoctoc.info/download/hoang-toc-luoc-bien.pdf" download class="btn-download">
                Tải xuống
              </a>
            </div>
          </div>

          <!-- Document 2: Nguyễn Phúc Tộc Thế Phả -->
          <div class="document-card">
            <h2 class="document-title">Nguyễn Phúc Tộc Thế Phả</h2>
            <p class="document-description">
              Bộ thế phả đầy đủ và chi tiết về dòng họ Nguyễn Phước, ghi chép đầy đủ 
              về các thế hệ, quan hệ huyết thống, và lịch sử phát triển của dòng tộc qua nhiều thế kỷ.
            </p>
            <p style="font-size: 14px; color: #6b7280; margin-top: 15px; margin-bottom: 20px; text-align: center;">
              <strong>Nguồn tham khảo:</strong> 
              <a href="https://tonpha.nguyenphuoctoc.info" target="_blank" rel="noopener noreferrer" style="color: #8B0000; text-decoration: none; font-weight: 600;">
                Tôn Phả - Nguyễn Phúc Tộc
              </a>
            </p>
            <div class="document-actions">
              <a href="https://nguyenphuoctoc.info/download/NGUYEN-PHUC-TOC-THE-PHA.pdf" target="_blank" class="btn-view">
                Xem tài liệu
              </a>
              <a href="https://nguyenphuoctoc.info/download/NGUYEN-PHUC-TOC-THE-PHA.pdf" download class="btn-download">
                Tải xuống
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Phần 2: Tài liệu Phòng Tuy Biên Quận Công -->
      <div style="margin-bottom: 40px;">
        <div style="text-align: center; margin-bottom: 30px;">
          <h2 style="font-size: 24px; color: #8B0000; margin-bottom: 10px;">
            Phần 2: Tài liệu Phòng Tuy Biên Quận Công
          </h2>
          <p style="color: #6b7280; font-size: 14px;">
            Các tài liệu về thành viên và lăng mộ của Phòng Tuy Biên Quận Công
          </p>
        </div>

        <!-- 2.1: Tài liệu lưu trữ trước năm 2024 -->
        <div style="margin-bottom: 40px;">
          <h3 style="font-size: 20px; color: #8B0000; margin-bottom: 20px; text-align: center; padding-top: 20px; border-top: 2px solid #e0e0e0;">
            2.1. Tài liệu lưu trữ trước năm 2024
          </h3>
          <p style="text-align: center; color: #6b7280; margin-bottom: 15px; font-size: 14px; font-style: italic;">
            Do Ông Vĩnh Phong lưu trữ
          </p>
          <div style="text-align: center; margin-bottom: 25px;">
            <a href="https://drive.google.com/drive/folders/157o0V4dWa7QKkf5t0hlLqjMnyQxAjf6s?usp=drive_link" target="_blank" rel="noopener noreferrer" style="display: inline-flex; align-items: center; gap: 8px; background: #8B0000; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; transition: background 0.3s ease; font-size: 16px;">
              Xem tài liệu trên Google Drive
            </a>
          </div>
          <div class="documents-grid">
            <div class="document-card">
              <h2 class="document-title">Danh sách con cháu Phòng Tuy Biên</h2>
              <p class="document-description">
                Tài liệu Excel ghi chép danh sách con cháu Phòng Tuy Biên do Ông Vĩnh Phong lưu trữ từ trước năm 2024.
              </p>
              <div class="document-actions">
                <a href="/static/documents/danh sach con chau phong Tuy Biên_VinhPhong.xls" target="_blank" class="btn-view">
                  Xem tài liệu
                </a>
                <a href="/static/documents/danh sach con chau phong Tuy Biên_VinhPhong.xls" download class="btn-download">
                  Tải xuống
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- 2.2: Tài liệu từ năm 2024 -->
        <div style="margin-bottom: 40px;">
          <h3 style="font-size: 20px; color: #8B0000; margin-bottom: 20px; text-align: center; padding-top: 20px; border-top: 2px solid #e0e0e0;">
            2.2. Tài liệu từ năm 2024
          </h3>
          <p style="text-align: center; color: #6b7280; margin-bottom: 25px; font-size: 14px; font-style: italic;">
            Do con cháu Phòng Tuy Biên bổ sung
          </p>
          
          <!-- 2.2.1: Danh sách thành viên -->
          <div style="margin-bottom: 30px;">
            <h4 style="font-size: 18px; color: #8B0000; margin-bottom: 20px; text-align: center; font-weight: 600;">
              Danh sách thành viên
            </h4>
            <div class="documents-grid">
              <!-- Excel: Danh sách thành viên 2024 -->
              <div class="document-card">
                <h2 class="document-title">Danh sách thành viên (Excel)</h2>
                <p class="document-description">
                  Danh sách thành viên Phòng Tuy Biên Quận Công (Ngày xuất bản: 28/12/2024)
                </p>
                <div class="document-actions">
                  <a href="https://drive.google.com/drive/folders/157o0V4dWa7QKkf5t0hlLqjMnyQxAjf6s?usp=sharing" target="_blank" class="btn-view">
                    Xem tài liệu
                  </a>
                  <a href="https://drive.google.com/drive/folders/157o0V4dWa7QKkf5t0hlLqjMnyQxAjf6s?usp=sharing" target="_blank" class="btn-download">
                    Tải xuống
                  </a>
                </div>
              </div>

              <!-- Word: Danh sách thành viên 1-300 -->
              <div class="document-card">
                <h2 class="document-title">Danh sách thành viên (1-300)</h2>
                <p class="document-description">
                  Danh sách thành viên từ số 1 đến 300 (Ngày xuất bản: 08/02/2025)
                </p>
                <div class="document-actions">
                  <a href="https://drive.google.com/drive/folders/157o0V4dWa7QKkf5t0hlLqjMnyQxAjf6s?usp=sharing" target="_blank" class="btn-view">
                    Xem tài liệu
                  </a>
                  <a href="https://drive.google.com/drive/folders/157o0V4dWa7QKkf5t0hlLqjMnyQxAjf6s?usp=sharing" target="_blank" class="btn-download">
                    Tải xuống
                  </a>
                </div>
              </div>

              <!-- Word: Danh sách thành viên 301-600 -->
              <div class="document-card">
                <h2 class="document-title">Danh sách thành viên (301-600)</h2>
                <p class="document-description">
                  Danh sách thành viên từ số 301 đến 600 (Ngày xuất bản: 08/02/2025)
                </p>
                <div class="document-actions">
                  <a href="https://drive.google.com/drive/folders/157o0V4dWa7QKkf5t0hlLqjMnyQxAjf6s?usp=sharing" target="_blank" class="btn-view">
                    Xem tài liệu
                  </a>
                  <a href="https://drive.google.com/drive/folders/157o0V4dWa7QKkf5t0hlLqjMnyQxAjf6s?usp=sharing" target="_blank" class="btn-download">
                    Tải xuống
                  </a>
                </div>
              </div>

              <!-- Word: Danh sách thành viên 601-900 -->
              <div class="document-card">
                <h2 class="document-title">Danh sách thành viên (601-900)</h2>
                <p class="document-description">
                  Danh sách thành viên từ số 601 đến 900 (Ngày xuất bản: 08/02/2025)
                </p>
                <div class="document-actions">
                  <a href="https://drive.google.com/drive/folders/157o0V4dWa7QKkf5t0hlLqjMnyQxAjf6s?usp=sharing" target="_blank" class="btn-view">
                    Xem tài liệu
                  </a>
                  <a href="https://drive.google.com/drive/folders/157o0V4dWa7QKkf5t0hlLqjMnyQxAjf6s?usp=sharing" target="_blank" class="btn-download">
                    Tải xuống
                  </a>
                </div>
              </div>

              <!-- Word: Danh sách thành viên 901-1200 -->
              <div class="document-card">
                <h2 class="document-title">Danh sách thành viên (901-1200)</h2>
                <p class="document-description">
                  Danh sách thành viên từ số 901 đến 1200 (Ngày xuất bản: 08/02/2025)
                </p>
                <div class="document-actions">
                  <a href="https://drive.google.com/drive/folders/157o0V4dWa7QKkf5t0hlLqjMnyQxAjf6s?usp=sharing" target="_blank" class="btn-view">
                    Xem tài liệu
                  </a>
                  <a href="https://drive.google.com/drive/folders/157o0V4dWa7QKkf5t0hlLqjMnyQxAjf6s?usp=sharing" target="_blank" class="btn-download">
                    Tải xuống
                  </a>
                </div>
              </div>
            </div>
          </div>

          <!-- 2.2.2: Danh sách lăng mộ -->
          <div style="margin-bottom: 30px;">
            <h4 style="font-size: 18px; color: #8B0000; margin-bottom: 20px; text-align: center; font-weight: 600;">
              Danh sách lăng mộ
            </h4>
            <div class="documents-grid">
              <div class="document-card">
                <h2 class="document-title">Danh sách lăng mộ (13/04/2016)</h2>
                <p class="document-description">
                  Danh sách lăng mộ Phòng Tuy Biên Quận Công (Ngày: 13/04/2016)
                </p>
                <div class="document-actions">
                  <a href="https://drive.google.com/drive/folders/157o0V4dWa7QKkf5t0hlLqjMnyQxAjf6s?usp=sharing" target="_blank" class="btn-view">
                    Xem tài liệu
                  </a>
                  <a href="https://drive.google.com/drive/folders/157o0V4dWa7QKkf5t0hlLqjMnyQxAjf6s?usp=sharing" target="_blank" class="btn-download">
                    Tải xuống
                  </a>
                </div>
              </div>

              <div class="document-card">
                <h2 class="document-title">Danh sách lăng mộ (16/03/2013)</h2>
                <p class="document-description">
                  Danh sách lăng mộ Phòng Tuy Biên Quận Công (Ngày: 16/03/2013 - 97 format)
                </p>
                <div class="document-actions">
                  <a href="https://drive.google.com/drive/folders/157o0V4dWa7QKkf5t0hlLqjMnyQxAjf6s?usp=sharing" target="_blank" class="btn-view">
                    Xem tài liệu
                  </a>
                  <a href="https://drive.google.com/drive/folders/157o0V4dWa7QKkf5t0hlLqjMnyQxAjf6s?usp=sharing" target="_blank" class="btn-download">
                    Tải xuống
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Source Reference -->
      <div style="margin-top: 40px; padding: 30px; background: #FFF8DC; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); text-align: center;">
        <p style="font-size: 14px; color: #6b7280; margin-bottom: 10px;">
          <strong>Nguồn tham khảo:</strong>
        </p>
        <p style="font-size: 16px; margin: 0;">
          <a href="https://tonpha.nguyenphuoctoc.info/Default.aspx" target="_blank" rel="noopener noreferrer" class="source-reference" style="color: #8B0000; text-decoration: none; font-weight: 600; transition: color 0.3s ease; border-bottom: 1px solid transparent;">
            Tôn Phả - Nguyễn Phúc Tộc
          </a>
          <span style="color: #6b7280;"> (https://tonpha.nguyenphuoctoc.info)</span>
        </p>
      </div>
    </div>
  </section>

  <!-- Section: Interactive Genealogy Tree -->
  <!-- Section: Cây Gia Phả Tương Tác - Đã di chuyển sang /genealogy -->


  <!-- Section: Genealogy - Đã di chuyển sang /genealogy -->


  <!-- Scripts -->
  <script>
    // Navbar functionality
    function toggleMenu() {
      const menu = document.getElementById('navbarMenu');
      if (menu) {
        menu.classList.toggle('active');
      }
    }

    // Guard để tránh ghost click trên overlay
    var _tocLastOpenedAt = 0;
    var _TOC_OPEN_GUARD_MS = 400;

    // Helper function để đóng TOC
    function closeTOC() {
      const sidebar = document.getElementById('tocSidebar');
      const overlay = document.getElementById('tocOverlay');
      
      if (sidebar) {
        sidebar.classList.remove('open');
      }
      
      if (overlay) {
        overlay.classList.remove('active');
      }
    }

    // Helper function để mở TOC
    function openTOC() {
      const sidebar = document.getElementById('tocSidebar');
      const overlay = document.getElementById('tocOverlay');
      
      if (sidebar) {
        sidebar.classList.add('open');
      }
      
      if (overlay) {
        overlay.classList.add('active');
      }
      
      // Ghi lại thời điểm mở để guard ghost click
      _tocLastOpenedAt = Date.now();
    }

    function toggleTOC() {
      const sidebar = document.getElementById('tocSidebar');
      const overlay = document.getElementById('tocOverlay');
      
      if (sidebar) {
        const isOpen = sidebar.classList.contains('open');
        
        if (isOpen) {
          // Đóng
          closeTOC();
        } else {
          // Mở
          openTOC();
        }
      }
    }

    // Khởi tạo event listener cho overlay với guard ghost click
    function initTOCOverlay() {
      var overlay = document.getElementById('tocOverlay');
      if (!overlay) return;
      
      overlay.addEventListener('click', function() {
        // Guard: không đóng nếu vừa mở TOC (< 400ms)
        if (Date.now() - _tocLastOpenedAt < _TOC_OPEN_GUARD_MS) {
          return;
        }
        toggleTOC();
      });
    }

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(event) {
      const sidebar = document.getElementById('tocSidebar');
      const toggleBtn = document.getElementById('tocToggle');
      const overlay = document.getElementById('tocOverlay');
      
      if (window.innerWidth <= 1024 && sidebar && toggleBtn) {
        // Nếu click bên ngoài sidebar, toggle button, và không phải overlay
        if (!sidebar.contains(event.target) && 
            !toggleBtn.contains(event.target) && 
            event.target !== overlay) {
          closeTOC();
        }
      }
    });

    // Close sidebar when clicking on a link (mobile) and smooth scroll
    document.querySelectorAll('.toc-list a').forEach(link => {
      link.addEventListener('click', function(e) {
        const href = this.getAttribute('href');
        if (href && href.startsWith('#')) {
          e.preventDefault();
          const targetId = href.substring(1);
          const targetElement = document.getElementById(targetId) || document.querySelector(`[id="${targetId}"]`);
          
          if (targetElement) {
            const navbarHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--navbar-height')) || 70;
            const targetPosition = targetElement.offsetTop - navbarHeight - 20;
            
            window.scrollTo({
              top: targetPosition,
              behavior: 'smooth'
            });
          }
        }
        
        if (window.innerWidth <= 1024) {
          // Đóng overlay ngay lập tức để không che màn hình
          const overlay = document.getElementById('tocOverlay');
          if (overlay) {
            overlay.classList.remove('active');
          }
          
          // Đóng sidebar sau delay để smooth scroll hoạt động tốt
          const sidebar = document.getElementById('tocSidebar');
          if (sidebar) {
            setTimeout(() => {
              sidebar.classList.remove('open');
            }, 300); // Delay to allow smooth scroll
          }
        }
      });
    });

    function setActive(element) {
      if (!element) return;
      
      // Remove active from all links
      document.querySelectorAll('.navbar-menu a').forEach(link => {
        if (link) {
          link.classList.remove('active');
        }
      });
      // Add active to clicked link
      element.classList.add('active');
      // Close mobile menu
      const navbarMenu = document.getElementById('navbarMenu');
      if (navbarMenu) {
        navbarMenu.classList.remove('active');
      }
    }

    // Update TOC active state on scroll
    function updateTOCActiveState() {
      const tocLinks = document.querySelectorAll('.toc-list a');
      const sections = document.querySelectorAll('section[id], h2[id], h3[id], h4[id]');
      
      let currentSection = '';
      const navbarHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--navbar-height')) || 70;
      const scrollPosition = window.scrollY + navbarHeight + 100;
      
      sections.forEach(section => {
        const sectionTop = section.offsetTop;
        const sectionHeight = section.offsetHeight;
        const sectionId = section.getAttribute('id');
        
        if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
          currentSection = sectionId;
        }
      });
      
      // Update TOC links
      tocLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href && href.startsWith('#')) {
          const targetId = href.substring(1);
          if (targetId === currentSection) {
            link.classList.add('active');
            // Scroll TOC item into view if needed
            const tocItem = link.closest('li');
            if (tocItem) {
              const tocSidebar = document.getElementById('tocSidebar');
              if (tocSidebar) {
                const itemTop = tocItem.offsetTop;
                const itemHeight = tocItem.offsetHeight;
                const sidebarTop = tocSidebar.scrollTop;
                const sidebarHeight = tocSidebar.clientHeight;
                
                if (itemTop < sidebarTop || itemTop + itemHeight > sidebarTop + sidebarHeight) {
                  tocSidebar.scrollTo({
                    top: itemTop - 20,
                    behavior: 'smooth'
                  });
                }
              }
            }
          } else {
            link.classList.remove('active');
          }
        }
      });
    }

    // Throttle scroll event
    let scrollTimeout;
    window.addEventListener('scroll', () => {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        updateTOCActiveState();
      }, 100);
    });

    // Update on page load
    document.addEventListener('DOMContentLoaded', () => {
      updateTOCActiveState();
    });

    // Set active on scroll (for navbar)
    window.addEventListener('scroll', () => {
      const sections = ['home', 'about', 'temple-interior', 'genealogy', 'login'];
      const scrollPos = window.scrollY + 100;

      sections.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) {
          const top = section.offsetTop;
          const bottom = top + section.offsetHeight;
          
          if (scrollPos >= top && scrollPos < bottom) {
            document.querySelectorAll('.navbar-menu a').forEach(link => {
              if (link) {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${sectionId}`) {
                  link.classList.add('active');
                }
              }
            });
          }
        }
      });
    });

    // ============================================
    // LINEAGE SEARCH FUNCTIONALITY
    // ============================================
    
    let personsDataForLineage = [];
    let selectedPerson = null;
    let searchTimeout = null;
    let isEditMode = false;

    /**
     * Xử lý khi người dùng gõ vào ô tìm kiếm (autocomplete)
     */
    function handleLineageSearchInput() {
      const nameInput = document.getElementById('lineageName');
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      
      if (!nameInput || !suggestionsDiv) {
        console.warn('[Lineage] Required elements not found for search input');
        return;
      }
      
      const query = nameInput.value.trim();
      
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
      
      if (!query || query.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
      }
      
      searchTimeout = setTimeout(async () => {
        try {
          // Use new API /api/search
          const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=10`);
          
          if (!response.ok) {
            suggestionsDiv.style.display = 'none';
            return;
          }
          
          const results = await response.json();
          
          if (results.length === 0) {
            suggestionsDiv.innerHTML = '<div class="suggestion-item" style="color: #999; font-style: italic;">Không tìm thấy kết quả</div>';
            suggestionsDiv.style.display = 'block';
            return;
          }
          
          // Display suggestions with full format
          suggestionsDiv.innerHTML = results.map((person) => {
            const gen = person.generation_level || person.generation_number || '?';
            const name = person.full_name || 'Không rõ tên';
            const fatherName = person.father_name || '';
            const motherName = person.mother_name || '';
            
            // Format parent info (không dùng <em>)
            let parentInfo = '';
            if (fatherName && motherName) {
              parentInfo = `Con của: Ông ${escapeHtml(fatherName)} & Bà ${escapeHtml(motherName)}`;
            } else if (fatherName) {
              parentInfo = `Con của: Ông ${escapeHtml(fatherName)}`;
            } else if (motherName) {
              parentInfo = `Con của: Bà ${escapeHtml(motherName)}`;
            }
            // Bỏ hiển thị "Chưa có thông tin cha mẹ" khi không có cả cha lẫn mẹ
            
            // Add FM_ID indicator if available to help distinguish duplicates
            const fmIdDisplay = person.father_mother_id || person.fm_id ? ` <span style="color: #999; font-size: 12px;">(FM: ${escapeHtml(person.father_mother_id || person.fm_id)})</span>` : '';
            
            return `
              <div class="suggestion-item" onclick="selectSuggestionFromSearch('${person.person_id}')" style="cursor: pointer; padding: 12px; border-bottom: 1px solid #eee;">
                <div class="suggestion-name" style="font-weight: 600; color: #7b1a1a; font-size: 16px; margin-bottom: 4px;">
                  ${escapeHtml(name)} – Đời ${gen}${fmIdDisplay}
                </div>
                ${parentInfo ? `<div class="suggestion-details" style="color: #666; font-size: 14px;">${parentInfo}</div>` : ''}
              </div>
            `;
          }).join('');
          
          suggestionsDiv.style.display = 'block';
        } catch (err) {
          console.error('Error in autocomplete:', err);
          suggestionsDiv.style.display = 'none';
        }
      }, 300);
    }

    /**
     * Chọn một suggestion
     * @param {number} personId - ID duy nhất của Person (bắt buộc dùng personId, không dùng tên/đời)
     */
    function selectSuggestion(personId) {
      const nameInput = document.getElementById('lineageName');
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      
      if (!nameInput || !suggestionsDiv) {
        console.warn('[Lineage] Required elements not found for suggestion selection');
        return;
      }
      
      suggestionsDiv.style.display = 'none';
      
      // Dùng personId để tìm đúng Person (không dựa vào tên/đời vì có thể trùng)
      const allPersons = window.GenealogyLineage.getAllPersons();
      const person = allPersons.find(p => p.person_id === personId);
      
      if (!person) {
        console.error(`[Lineage] Không tìm thấy Person với person_id: ${personId}`);
        alert(`Không tìm thấy người với ID: ${personId}`);
        return;
      }
      
      // Cập nhật input với tên của người được chọn
      if (nameInput) {
        nameInput.value = person.full_name;
      }
      
      // Lưu selectedPerson và hiển thị
      selectedPerson = person;
      displayLineageForPerson(person);
      showDetailPanel(person);
    }

    /**
     * Hiển thị chuỗi phả hệ cho một Person
     */
    function displayLineageForPerson(person) {
      const resultDiv = document.getElementById('lineageResult');
      const resultContent = document.getElementById('lineageResultContent');
      const resultTitle = document.getElementById('lineageResultTitle');
      
      if (!person) {
        resultDiv.style.display = 'none';
        return;
      }
      
      try {
        // Dùng personId để đảm bảo chọn đúng người (không dựa vào tên/đời vì có thể trùng)
        // Nếu buildCompleteLineage hỗ trợ personId, dùng trực tiếp
        // Nếu không, dùng tên + đời + tên bố để phân giải chính xác
        let lineage;
        if (window.GenealogyLineage.buildCompleteLineageById) {
          lineage = window.GenealogyLineage.buildCompleteLineageById(person.person_id);
        } else {
          // Fallback: dùng tên + đời + tên bố để tìm chính xác
          const foundPerson = window.GenealogyLineage.findPersonById 
            ? window.GenealogyLineage.findPersonById(person.person_id)
            : window.GenealogyLineage.findPerson(person.full_name, person.generation_number, person.father_name);
          
          if (!foundPerson) {
            resultContent.innerHTML = `<div class="lineage-error">❌ Không tìm thấy người với ID: ${person.person_id}</div>`;
            resultTitle.textContent = 'Lỗi';
            resultDiv.style.display = 'block';
            return;
          }
          
          lineage = window.GenealogyLineage.buildCompleteLineage(foundPerson.full_name, foundPerson.generation_number, foundPerson.father_name);
        }
        
        if (!lineage || lineage.length === 0) {
          resultContent.innerHTML = `<div class="lineage-error">❌ Không thể xây dựng chuỗi phả hệ cho "${person.full_name}" (ID: ${person.person_id})</div>`;
          resultTitle.textContent = 'Lỗi';
          resultDiv.style.display = 'block';
          return;
        }
        
        // Tính số người bao gồm cả mẹ/vợ
        const uniquePersons = new Set();
        lineage.forEach(p => {
          // Thêm người chính vào set (dùng person_id hoặc key)
          const key = p.person_id ? `id_${p.person_id}` : `${p.full_name}|${p.generation_number}`;
          uniquePersons.add(key);
          
          // Thêm mẹ nếu có
          if (p.mother_name) {
            const motherKey = `${p.mother_name}|${(p.generation_number || 0) - 1}`;
            uniquePersons.add(motherKey);
          }
          
          // Thêm vợ/chồng nếu có (từ marriages)
          if (p.marriages && Array.isArray(p.marriages)) {
            p.marriages.forEach(marriage => {
              if (marriage.spouse_name) {
                const spouseKey = `${marriage.spouse_name}|${p.generation_number}`;
                uniquePersons.add(spouseKey);
              }
            });
          }
        });
        
        const html = window.GenealogyLineage.formatAsHTMLWithParents(lineage);
        resultContent.innerHTML = html;
        resultTitle.textContent = `Chuỗi phả hệ của ${person.full_name} (Đời ${person.generation_number}) - ${uniquePersons.size} người`;
        resultDiv.style.display = 'block';
        
        if (resultContent) {
          resultContent.querySelectorAll('.lineage-item').forEach(item => {
            if (item) {
              item.style.cursor = 'pointer';
              item.addEventListener('click', () => {
                const personId = item.getAttribute('data-person-id'); // Giữ nguyên string
                const allPersons = window.GenealogyLineage.getAllPersons();
                const clickedPerson = allPersons.find(p => p.person_id === personId);
                if (clickedPerson) {
                  showDetailPanel(clickedPerson);
                }
              });
            }
          });
        }
        
      } catch (error) {
        console.error('Lỗi khi hiển thị lineage:', error);
        resultContent.innerHTML = `<div class="lineage-error">❌ Lỗi: ${error.message}</div>`;
        resultTitle.textContent = 'Lỗi';
        resultDiv.style.display = 'block';
      }
    }

    /**
     * Tìm kiếm và hiển thị chuỗi phả hệ
     */
    async function searchLineage() {
      const nameInput = document.getElementById('lineageName');
      
      if (!nameInput) {
        console.error('[Lineage] lineageName input not found');
        alert('Lỗi: Không tìm thấy ô nhập liệu');
        return;
      }
      
      const name = nameInput.value.trim();
      
      if (!name) {
        alert('Vui lòng nhập tên hoặc chọn từ danh sách gợi ý');
        return;
      }
      
      // Hide suggestions
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      if (suggestionsDiv) {
        suggestionsDiv.style.display = 'none';
      }
      
      try {
        // Use new API /api/search
        const response = await fetch(`/api/search?q=${encodeURIComponent(name)}&limit=20`);
        
        if (!response.ok) {
          throw new Error(`API trả mã ${response.status}`);
        }
        
        const results = await response.json();
        
        if (results.length === 0) {
          alert(`Không tìm thấy "${name}"`);
          return;
        }
        
        // Nếu có nhiều kết quả trùng tên, hiển thị suggestion để người dùng chọn
        if (results.length > 1) {
          // Hiển thị suggestions để người dùng chọn
          if (suggestionsDiv) {
            suggestionsDiv.innerHTML = results.map((person) => {
              const gen = person.generation_level || person.generation_number || '?';
              const name = person.full_name || 'Không rõ tên';
              const fatherName = person.father_name || '';
              const motherName = person.mother_name || '';
              
              // Format parent info (không dùng <em>)
              let parentInfo = '';
              if (fatherName && motherName) {
                parentInfo = `Con của: Ông ${escapeHtml(fatherName)} & Bà ${escapeHtml(motherName)}`;
              } else if (fatherName) {
                parentInfo = `Con của: Ông ${escapeHtml(fatherName)}`;
              } else if (motherName) {
                parentInfo = `Con của: Bà ${escapeHtml(motherName)}`;
              }
              // Bỏ hiển thị "Chưa có thông tin cha mẹ" khi không có cả cha lẫn mẹ
              
              // Add FM_ID indicator if available to help distinguish duplicates
              const fmIdDisplay = person.father_mother_id || person.fm_id ? ` <span style="color: #999; font-size: 12px;">(FM: ${escapeHtml(person.father_mother_id || person.fm_id)})</span>` : '';
              
              return `
                <div class="suggestion-item" onclick="selectSuggestionFromSearch('${person.person_id}')" style="cursor: pointer; padding: 12px; border-bottom: 1px solid #eee;">
                  <div class="suggestion-name" style="font-weight: 600; color: #7b1a1a; font-size: 16px; margin-bottom: 4px;">
                    ${escapeHtml(name)} – Đời ${gen}${fmIdDisplay}
                  </div>
                  ${parentInfo ? `<div class="suggestion-details" style="color: #666; font-size: 14px;">${parentInfo}</div>` : ''}
                </div>
              `;
            }).join('');
            suggestionsDiv.style.display = 'block';
          }
          return;
        }
        
        // Chỉ có 1 kết quả, tự động chọn
        const person = results[0];
        await displayLineageForPersonFromAPI(person.person_id);
      } catch (err) {
        console.error('Error searching lineage:', err);
        alert(`Lỗi khi tìm kiếm: ${err.message}`);
      }
    }
    
    /**
     * Select suggestion from search results
     */
    async function selectSuggestionFromSearch(personId) {
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      if (suggestionsDiv) {
        suggestionsDiv.style.display = 'none';
      }
      
      await displayLineageForPersonFromAPI(personId);
    }
    
    /**
     * Display lineage for person using API
     */
    async function displayLineageForPersonFromAPI(personId) {
      try {
        console.log(`[Lineage] Fetching lineage for person_id: ${personId}`);
        
        // Fetch ancestors API (includes person info)
        const ancestorsRes = await fetch(`/api/ancestors/${personId}`);
        
        if (!ancestorsRes.ok) {
          throw new Error(`API /api/ancestors/${personId} trả mã ${ancestorsRes.status}`);
        }
        
        const ancestorsData = await ancestorsRes.json();
        console.log('[Lineage] Ancestors API response:', ancestorsData);
        
        // Build lineage chain: ancestors_chain + current person (avoid duplicates)
        let lineage = [];
        
        if (ancestorsData.ancestors_chain && Array.isArray(ancestorsData.ancestors_chain)) {
          lineage = ancestorsData.ancestors_chain;
        }
        
        // Add current person to lineage only if not already in ancestors_chain
        if (ancestorsData.person) {
          const currentPersonId = String(ancestorsData.person.person_id || '').trim();
          // Check with normalized comparison
          const alreadyInChain = lineage.some(p => {
            const pId = String(p.person_id || '').trim();
            return pId === currentPersonId && pId !== '';
          });
          
          if (!alreadyInChain && currentPersonId) {
            lineage.push(ancestorsData.person);
            console.log(`[Lineage] Added current person ${currentPersonId} to lineage`);
          } else {
            console.log(`[Lineage] Person ${currentPersonId} already in ancestors_chain, skipping duplicate`);
          }
        }
        
        console.log(`[Lineage] Built lineage chain with ${lineage.length} generations`);
        console.log('[Lineage] Lineage data:', lineage);
        
        // Display lineage with beautiful timeline (will remove duplicates again)
        displayLineageChain(lineage);
        
        // Show detail panel (fetch full person details)
        try {
          const personRes = await fetch(`/api/person/${personId}`);
          if (personRes.ok) {
            const person = await personRes.json();
            selectedPerson = person;
            showDetailPanel(person);
          }
        } catch (err) {
          console.warn('[Lineage] Could not fetch full person details:', err);
          // Use person from ancestors API (có thể thiếu một số thông tin nhưng vẫn hiển thị được)
          if (ancestorsData.person) {
            selectedPerson = ancestorsData.person;
            showDetailPanel(ancestorsData.person);
          } else {
            // Nếu không có dữ liệu từ ancestors API, hiển thị lỗi
            const resultDiv = document.getElementById('lineageResult');
            const resultContent = document.getElementById('lineageResultContent');
            const resultTitle = document.getElementById('lineageResultTitle');
            if (resultDiv && resultContent) {
              resultContent.innerHTML = `<div class="lineage-error" style="padding: 20px; color: #d32f2f;">❌ Không thể tải thông tin chi tiết cho người này (ID: ${personId})</div>`;
              if (resultTitle) {
                resultTitle.textContent = 'Lỗi';
              }
              resultDiv.style.display = 'block';
            }
          }
        }
      } catch (err) {
        console.error('Error displaying lineage:', err);
        // Hiển thị lỗi thân thiện hơn
        const errorMessage = err.message || 'Không xác định';
        if (errorMessage.includes('404') || errorMessage.includes('not found')) {
          alert(`Không tìm thấy người với ID: ${personId}\n\nVui lòng kiểm tra lại dữ liệu.`);
        } else if (errorMessage.includes('500')) {
          alert(`Lỗi server khi tải dữ liệu.\n\nVui lòng thử lại sau hoặc liên hệ quản trị viên.\n\nChi tiết: ${errorMessage}`);
        } else {
          alert(`Lỗi khi hiển thị chuỗi phả hệ: ${errorMessage}`);
        }
      }
    }
    
    /**
     * Normalize parent names for display
     */
    function normalizeParentName(name, isFather = true) {
      if (!name) return null;
      // Remove common prefixes
      name = name.replace(/^(Ông|Bà|Vua)\s+/i, '').trim();
      return name;
    }
    
    /**
     * Get standardized parents for Generation 1 (Vua Minh Mạng)
     */
    function getGen1Parents() {
      return {
        father_name: 'Vua Gia Long',
        mother_name: 'Thuận Thiên Hoàng hậu'
      };
    }
    
    /**
     * Display lineage chain with beautiful timeline format
     */
    function displayLineageChain(lineage) {
      const resultDiv = document.getElementById('lineageResult');
      const resultContent = document.getElementById('lineageResultContent');
      const resultTitle = document.getElementById('lineageResultTitle');
      
      if (!resultDiv) return;
      
      if (!lineage || lineage.length === 0) {
        if (resultContent) {
          resultContent.innerHTML = '<div style="padding: 20px; color: #666; text-align: center;">Không có dữ liệu chuỗi phả hệ</div>';
        } else {
          resultDiv.innerHTML = '<div style="padding: 20px; color: #666; text-align: center;">Không có dữ liệu chuỗi phả hệ</div>';
        }
        resultDiv.style.display = 'block';
        return;
      }
      
      // Remove duplicates by person_id (strict check with string conversion and normalization)
      const seenIds = new Set();
      const uniqueLineage = [];
      const duplicateLog = [];
      
      for (const p of lineage) {
        // Normalize person_id: trim, convert to string, handle null/undefined
        let personId = p.person_id;
        if (personId === null || personId === undefined || personId === '') {
          console.warn(`[Lineage] Skipping person without person_id:`, p);
          continue;
        }
        
        // Convert to string and trim whitespace
        const personIdStr = String(personId).trim();
        if (!personIdStr) {
          console.warn(`[Lineage] Skipping person with empty person_id after trim:`, p);
          continue;
        }
        
        // Check for duplicate
        if (seenIds.has(personIdStr)) {
          const duplicateInfo = {
            person_id: personIdStr,
            name: p.full_name || 'N/A',
            generation: p.generation_number || p.generation_level || 'N/A'
          };
          duplicateLog.push(duplicateInfo);
          console.warn(`[Lineage] DUPLICATE DETECTED: person_id=${personIdStr}, name=${duplicateInfo.name}, generation=${duplicateInfo.generation}`);
          continue;
        }
        
        // Add to seen set and unique lineage
        seenIds.add(personIdStr);
        uniqueLineage.push(p);
      }
      
      if (duplicateLog.length > 0) {
        console.warn(`[Lineage] Found ${duplicateLog.length} duplicates:`, duplicateLog);
      }
      console.log(`[Lineage] After deduplication: ${uniqueLineage.length} unique persons (from ${lineage.length} total)`);
      
      // Log all person_ids for debugging
      const allPersonIds = uniqueLineage.map(p => `${p.person_id} (${p.full_name})`).join(', ');
      console.log(`[Lineage] Unique person_ids: ${allPersonIds}`);
      
      // Sort by generation_number (ascending), then by person_id
      const sortedLineage = [...uniqueLineage].sort((a, b) => {
        const genA = a.generation_number || a.generation_level || 0;
        const genB = b.generation_number || b.generation_level || 0;
        if (genA !== genB) {
          return genA - genB;
        }
        // If same generation, sort by person_id (string comparison for VARCHAR IDs)
        const idA = String(a.person_id || '');
        const idB = String(b.person_id || '');
        return idA.localeCompare(idB);
      });
      
      console.log(`[Lineage] After deduplication: ${sortedLineage.length} unique persons`);
      console.log('[Lineage] Generations:', sortedLineage.map(p => `${p.generation_number || p.generation_level}: ${p.full_name}`));
      
      // Kiểm tra xem có thiếu đời nào không (từ đời 1 đến đời của người tìm kiếm)
      if (sortedLineage.length > 0) {
        const maxGen = Math.max(...sortedLineage.map(p => p.generation_number || p.generation_level || 0));
        const minGen = Math.min(...sortedLineage.map(p => p.generation_number || p.generation_level || 0));
        const presentGens = new Set(sortedLineage.map(p => p.generation_number || p.generation_level || 0));
        const missingGens = [];
        for (let gen = minGen; gen <= maxGen; gen++) {
          if (!presentGens.has(gen)) {
            missingGens.push(gen);
          }
        }
        if (missingGens.length > 0) {
          console.warn(`[Lineage] WARNING: Missing generations: ${missingGens.join(', ')}`);
          console.warn(`[Lineage] Present generations: ${Array.from(presentGens).sort((a, b) => a - b).join(', ')}`);
        } else {
          console.log(`[Lineage] All generations present from ${minGen} to ${maxGen}`);
        }
      }
      
      // Thêm Vua Gia Long (Đời 0) nếu chưa có
      const hasGen0 = sortedLineage.some(p => (p.generation_number === 0 || p.generation_level === 0));
      if (!hasGen0) {
        const gen0Person = {
          person_id: 'P-0-1',
          full_name: 'Vua Gia Long',
          generation_number: 0,
          generation_level: 0,
          father_name: 'Chưa có thông tin',
          mother_name: 'Chưa có thông tin',
          gender: 'Nam',
          status: 'Đã mất'
        };
        sortedLineage.unshift(gen0Person);
        console.log('[Lineage] Added Generation 0 placeholder (Vua Gia Long)');
      }
      
      // Ensure Generation 1 exists (Vua Minh Mạng)
      const hasGen1 = sortedLineage.some(p => (p.generation_number === 1 || p.generation_level === 1));
      if (!hasGen1) {
        // Find Vua Minh Mạng or create placeholder
        const gen1Person = {
          person_id: 'P-1-1',
          full_name: 'Vua Minh Mạng',
          generation_number: 1,
          generation_level: 1,
          father_name: 'Vua Gia Long',
          mother_name: 'Thuận Thiên Hoàng hậu',
          gender: 'Nam',
          status: 'Đã mất'
        };
        sortedLineage.unshift(gen1Person);
        console.log('[Lineage] Added Generation 1 placeholder (Vua Minh Mạng)');
      } else {
        // Normalize Gen 1 parents
        const gen1Index = sortedLineage.findIndex(p => (p.generation_number === 1 || p.generation_level === 1));
        if (gen1Index !== -1) {
          const gen1Parents = getGen1Parents();
          sortedLineage[gen1Index].father_name = gen1Parents.father_name;
          sortedLineage[gen1Index].mother_name = gen1Parents.mother_name;
          console.log('[Lineage] Normalized Generation 1 parents');
        }
      }
      
      // Đảm bảo Đời 1 có parent là Vua Gia Long nếu có Đời 0
      const gen0Index = sortedLineage.findIndex(p => (p.generation_number === 0 || p.generation_level === 0));
      const gen1Index = sortedLineage.findIndex(p => (p.generation_number === 1 || p.generation_level === 1));
      if (gen0Index !== -1 && gen1Index !== -1) {
        if (!sortedLineage[gen1Index].father_name || sortedLineage[gen1Index].father_name === 'Chưa có thông tin') {
          sortedLineage[gen1Index].father_name = 'Vua Gia Long';
        }
        if (!sortedLineage[gen1Index].mother_name || sortedLineage[gen1Index].mother_name === 'Chưa có thông tin') {
          sortedLineage[gen1Index].mother_name = 'Thuận Thiên Hoàng hậu';
        }
      }
      
      // Get target person (last in chain)
      const targetPerson = sortedLineage[sortedLineage.length - 1];
      
      if (resultTitle) {
        resultTitle.textContent = `Chuỗi phả hệ của ${targetPerson.full_name || 'Người được chọn'}`;
      }
      
      // Group by generation for special handling of Đời 1 (vợ chồng song song)
      const groupedByGen = {};
      sortedLineage.forEach(p => {
        const gen = p.generation_number || p.generation_level || 0;
        if (!groupedByGen[gen]) {
          groupedByGen[gen] = [];
        }
        groupedByGen[gen].push(p);
      });
      
      // Generate timeline HTML grouped by generation
      let timelineHTML = '';
      Object.keys(groupedByGen).sort((a, b) => parseInt(a) - parseInt(b)).forEach(gen => {
        const personsInGen = groupedByGen[gen];
        const genNum = parseInt(gen);
        
        // Special handling for Đời 1: display vợ chồng song song
        if (genNum === 1 && personsInGen.length > 1) {
          timelineHTML += '<div style="display: flex; flex-direction: row; gap: 16px; width: 100%; margin-bottom: 16px;">';
          personsInGen.forEach(p => {
            timelineHTML += generatePersonCard(p, genNum, false); // 50% width for Đời 1 couple
          });
          timelineHTML += '</div>';
        } else {
          // Normal display for other generations (one person per card, full width)
          personsInGen.forEach(p => {
            timelineHTML += generatePersonCard(p, genNum, true);
          });
        }
      });
      
      function generatePersonCard(p, gen, isFullWidth = true) {
        const name = p.full_name || 'Không rõ tên';
        const fatherName = normalizeParentName(p.father_name, true) || p.father_name || '';
        const motherName = normalizeParentName(p.mother_name, false) || p.mother_name || '';
        
        // Hiển thị "Tổ tiên" cho Đời 0, "Đời X" cho các đời khác
        const genLabel = gen === 0 ? 'Tổ tiên' : `Đời ${gen}`;
        const titleLine = `${genLabel} – ${escapeHtml(name)}`;
        
        // Format parent info: "Con của Ông ... và Bà ..." (không có "Con của:" in nghiêng)
        let parentInfo = '';
        if (fatherName && motherName) {
          parentInfo = `Con của Ông ${escapeHtml(fatherName)} và Bà ${escapeHtml(motherName)}`;
        } else if (fatherName) {
          parentInfo = `Con của Ông ${escapeHtml(fatherName)}`;
        } else if (motherName) {
          parentInfo = `Con của Bà ${escapeHtml(motherName)}`;
        }
        // Bỏ hiển thị "Chưa có thông tin" khi không có cả cha lẫn mẹ
        
        // Badge color by generation
        let badgeColor = '';
        if (gen === 0) {
          badgeColor = 'background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);'; // Màu xanh đậm cho Tổ tiên
        } else if (gen === 1) {
          badgeColor = 'background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);'; // Red
        } else if (gen === 2) {
          badgeColor = 'background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);'; // Orange
        } else if (gen === 3) {
          badgeColor = 'background: linear-gradient(135deg, #ca8a04 0%, #a16207 100%);'; // Yellow
        } else if (gen === 4) {
          badgeColor = 'background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);'; // Green
        } else if (gen === 5) {
          badgeColor = 'background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);'; // Blue
        } else if (gen >= 6) {
          badgeColor = 'background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%);'; // Purple
        } else {
          badgeColor = 'background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);'; // Gray
        }
        
        // For Đời 1 with multiple people, use 50% width, otherwise 100%
        const cardWidth = (!isFullWidth) ? 'calc(50% - 8px)' : '100%';
        const cardMargin = (!isFullWidth) ? '0' : '0 0 16px 0';
        
        return `
          <div class="lineage-timeline-card" style="
            background: #FFF8DC;
            border-radius: 8px;
            padding: 16px 20px;
            margin: ${cardMargin};
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #DAA520;
            position: relative;
            width: ${cardWidth};
          ">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
              <span class="generation-badge" style="
                ${badgeColor}
                color: white;
                font-weight: 700;
                font-size: 13px;
                padding: 6px 16px;
                border-radius: 20px;
                white-space: nowrap;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
                display: inline-block;
                min-width: 70px;
                text-align: center;
              ">${genLabel}</span>
              <h3 style="
                color: #8B0000;
                font-weight: 700;
                font-size: 18px;
                margin: 0;
                flex: 1;
                line-height: 1.4;
              ">${titleLine}</h3>
            </div>
            ${parentInfo ? `<div style="
              color: #333;
              font-size: 14px;
              line-height: 1.6;
              padding-left: 0;
              margin-top: 6px;
            ">
              ${parentInfo}
            </div>` : ''}
          </div>
        `;
      }
      
      if (resultContent) {
        resultContent.innerHTML = `
          <div class="lineage-timeline-container" style="
            display: flex;
            flex-direction: column;
            gap: 0;
            width: 100%;
          ">
            ${timelineHTML}
          </div>
        `;
      } else {
        resultDiv.innerHTML = `
          <div style="padding: 20px;">
            <h3 style="color: #8B0000; margin-bottom: 20px;">Chuỗi phả hệ theo dòng cha</h3>
            <div class="lineage-timeline-container" style="
              display: flex;
              flex-direction: column;
              gap: 0;
              width: 100%;
            ">
              ${timelineHTML}
            </div>
          </div>
        `;
      }
      
      resultDiv.style.display = 'block';
    }

    /**
     * Hiển thị detail panel ở chế độ xem (read-only)
     */
    /**
     * Format text: thay dấu ";" bằng xuống dòng
     */
    function formatTextWithLineBreaks(text) {
      if (!text || text === 'Chưa có thông tin') return text;
      return text.split(';').map(item => item.trim()).filter(item => item).join('<br>');
    }
    
    /**
     * Chuẩn hóa dữ liệu Hôn phối từ person object
     * Thống nhất logic: ưu tiên marriages array, sau đó spouse_name, sau đó spouse
     * @param {Object} person - Person object
     * @returns {string} - Formatted spouse display text
     */
    function getSpouseDisplay(person) {
      if (!person) return 'Chưa có thông tin';
      
      // Ưu tiên 1: marriages array (đầy đủ thông tin nhất)
      if (person.marriages && Array.isArray(person.marriages) && person.marriages.length > 0) {
        return person.marriages.map(m => {
          let display = m.spouse_name || '';
          if (m.marriage_date_solar) {
            display += ` (${m.marriage_date_solar})`;
          }
          if (m.marriage_place) {
            display += ` - ${m.marriage_place}`;
          }
          return display;
        }).join('<br>');
      }
      
      // Ưu tiên 2: spouse_name (string)
      if (person.spouse_name) {
        return formatTextWithLineBreaks(person.spouse_name);
      }
      
      // Ưu tiên 3: spouse (string)
      if (person.spouse) {
        return formatTextWithLineBreaks(person.spouse);
      }
      
      return 'Chưa có thông tin';
    }

    function showDetailPanel(person) {
      const panel = document.getElementById('lineageDetailPanel');
      const content = document.getElementById('lineageDetailContent');
      
      if (!person) return;
      
      selectedPerson = person;
      isEditMode = false;
      
      // Fetch thông tin chi tiết từ API (bao gồm hôn phối)
      fetch(`/api/person/${person.person_id}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`API trả mã ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          // API có thể trả về {person: {...}} hoặc {...} trực tiếp
          const detailedPerson = data.person || data;
          if (detailedPerson.error) {
            console.error('API trả về lỗi:', detailedPerson.error);
            renderDetailPanel(person);
            return;
          }
          
          // Debug: Log data từ API
          console.log('[Detail Panel] API Response:', detailedPerson);
          console.log('[Detail Panel] Fields:', {
            full_name: detailedPerson.full_name,
            alias: detailedPerson.alias,
            generation_level: detailedPerson.generation_level,
            father_id: detailedPerson.father_id,
            father_name: detailedPerson.father_name,
            mother_id: detailedPerson.mother_id,
            mother_name: detailedPerson.mother_name,
            birth_date_solar: detailedPerson.birth_date_solar,
            birth_date_lunar: detailedPerson.birth_date_lunar,
            home_town: detailedPerson.home_town,
            occupation: detailedPerson.occupation,
            education: detailedPerson.education,
            religion: detailedPerson.religion,
            events: detailedPerson.events,
            titles: detailedPerson.titles,
            blood_type: detailedPerson.blood_type,
            genetic_disease: detailedPerson.genetic_disease,
            place_of_death: detailedPerson.place_of_death,
            grave_info: detailedPerson.grave_info,
            contact: detailedPerson.contact,
            social: detailedPerson.social,
            note: detailedPerson.note
          });
          
          // Merge thông tin chi tiết vào person
          Object.assign(selectedPerson, detailedPerson);
          // Đảm bảo generation_number được set
          if (!selectedPerson.generation_number && selectedPerson.generation_level) {
            selectedPerson.generation_number = selectedPerson.generation_level;
          }
          
          console.log('[Detail Panel] Merged person:', selectedPerson);
          renderDetailPanel(selectedPerson);
        })
        .catch(error => {
          console.error('Lỗi khi fetch thông tin chi tiết:', error);
          renderDetailPanel(person);
        });
    }
    
    function renderDetailPanel(person) {
      const content = document.getElementById('lineageDetailContent');
      const panel = document.getElementById('lineageDetailPanel');
      if (!content || !panel) return;
      
      // Đảm bảo luôn ở chế độ xem khi render
      isEditMode = false;
      
      content.innerHTML = `
        <div class="detail-view-mode">
          <div class="detail-form">
            <div class="form-group">
              <label>Person ID:</label>
              <div class="detail-value">${person.person_id || 'Chưa có thông tin'}</div>
            </div>
            <div class="form-group">
              <label>Tên đầy đủ:</label>
              <div class="detail-value">${person.full_name || 'Chưa có thông tin'}</div>
            </div>
            ${person.alias ? `
            <div class="form-group">
              <label>Tên thường gọi:</label>
              <div class="detail-value">${person.alias}</div>
            </div>
            ` : ''}
            <div class="form-group">
              <label>Đời:</label>
              <div class="detail-value">${person.generation_number || person.generation_level || 'Chưa có thông tin'}</div>
            </div>
            <div class="form-group">
              <label>Giới tính:</label>
              <div class="detail-value">${person.gender || 'Chưa có thông tin'}</div>
            </div>
            <div class="form-group">
              <label>Tên bố:</label>
              <div class="detail-value">${(() => {
                const fatherDisplay = person.father_name || person.father || null;
                return fatherDisplay ? 'Ông ' + fatherDisplay : 'Chưa có thông tin';
              })()}</div>
            </div>
            <div class="form-group">
              <label>Tên mẹ:</label>
              <div class="detail-value">${(() => {
                const motherDisplay = person.mother_name || person.mother || null;
                return motherDisplay ? 'Bà ' + motherDisplay : 'Chưa có thông tin';
              })()}</div>
            </div>
            <div class="form-group">
              <label>Nhánh:</label>
              <div class="detail-value">${person.branch_name || 'Chưa có thông tin'}</div>
            </div>
            <div class="form-group">
              <label>Trạng thái:</label>
              <div class="detail-value">${person.status || 'Chưa có thông tin'}</div>
            </div>
            ${person.birth_date_solar || person.birth_date_lunar ? `
            <div class="form-group">
              <label>Năm sinh:</label>
              <div class="detail-value">
                ${(() => {
                  // Helper function để parse năm từ date
                  function parseYear(dateValue) {
                    if (!dateValue) return null;
                    
                    // Nếu là số (có thể là serial date từ Excel hoặc timestamp)
                    if (typeof dateValue === 'number') {
                      // Nếu số lớn hơn 10000, có thể là serial date (Excel: days since 1900-01-01)
                      if (dateValue > 10000) {
                        // Excel serial date: 1900-01-01 = 1
                        // MySQL DATE có thể trả về số ngày từ epoch hoặc serial
                        try {
                          // Thử convert từ Excel serial (1900-01-01 = 1)
                          const excelEpoch = new Date(1899, 11, 30); // 1899-12-30 (Excel epoch)
                          const date = new Date(excelEpoch.getTime() + (dateValue - 1) * 86400000);
                          if (!isNaN(date.getTime()) && date.getFullYear() > 1900 && date.getFullYear() < 2100) {
                            return date.getFullYear();
                          }
                          // Thử convert từ Unix timestamp (milliseconds)
                          const date2 = new Date(dateValue);
                          if (!isNaN(date2.getTime()) && date2.getFullYear() > 1900 && date2.getFullYear() < 2100) {
                            return date2.getFullYear();
                          }
                        } catch (e) {
                          // Ignore
                        }
                      }
                      // Nếu số nhỏ (có thể là năm trực tiếp)
                      if (dateValue >= 1800 && dateValue <= 2100) {
                        return dateValue;
                      }
                      return null;
                    }
                    
                    // Nếu là chuỗi
                    if (typeof dateValue === 'string') {
                      // Format YYYY-MM-DD hoặc YYYY/MM/DD
                      const dateMatch = dateValue.match(/^(\d{4})[-/]/);
                      if (dateMatch) {
                        const year = parseInt(dateMatch[1]);
                        if (year >= 1800 && year <= 2100) {
                          return year;
                        }
                      }
                      
                      // Thử parse bằng Date
                      try {
                        const date = new Date(dateValue);
                        if (!isNaN(date.getTime())) {
                          const year = date.getFullYear();
                          if (year >= 1800 && year <= 2100) {
                            return year;
                          }
                        }
                      } catch (e) {
                        // Ignore
                      }
                      
                      // Nếu chỉ là số trong chuỗi (năm)
                      const numMatch = dateValue.match(/^\d{4}$/);
                      if (numMatch) {
                        const year = parseInt(numMatch[0]);
                        if (year >= 1800 && year <= 2100) {
                          return year;
                        }
                      }
                    }
                    
                    return null;
                  }
                  
                  let yearDL = parseYear(person.birth_date_solar);
                  let yearAL = parseYear(person.birth_date_lunar);
                  
                  // Logic hiển thị
                  if (yearDL && yearAL) {
                    if (yearDL === yearAL) {
                      return yearDL + (person.birth_location ? ' - ' + person.birth_location : '');
                    } else {
                      return `DL: ${yearDL} / AL: ${yearAL}${person.birth_location ? ' - ' + person.birth_location : ''}`;
                    }
                  } else if (yearDL) {
                    return yearDL + (person.birth_location ? ' - ' + person.birth_location : '');
                  } else if (yearAL) {
                    return yearAL + (person.birth_location ? ' - ' + person.birth_location : '');
                  }
                  // Nếu không parse được, hiển thị giá trị gốc (tránh hiển thị số serial)
                  return person.birth_date_solar || person.birth_date_lunar || '';
                })()}
              </div>
            </div>
            ` : ''}
            ${person.death_date_solar || person.death_date_lunar ? `
            <div class="form-group">
              <label>Năm mất:</label>
              <div class="detail-value">
                ${(() => {
                  // Helper function để parse năm từ date (dùng lại logic từ birth_date)
                  function parseYear(dateValue) {
                    if (!dateValue) return null;
                    
                    if (typeof dateValue === 'number') {
                      if (dateValue > 10000) {
                        try {
                          const excelEpoch = new Date(1899, 11, 30);
                          const date = new Date(excelEpoch.getTime() + (dateValue - 1) * 86400000);
                          if (!isNaN(date.getTime()) && date.getFullYear() > 1900 && date.getFullYear() < 2100) {
                            return date.getFullYear();
                          }
                          const date2 = new Date(dateValue);
                          if (!isNaN(date2.getTime()) && date2.getFullYear() > 1900 && date2.getFullYear() < 2100) {
                            return date2.getFullYear();
                          }
                        } catch (e) {}
                      }
                      if (dateValue >= 1800 && dateValue <= 2100) {
                        return dateValue;
                      }
                      return null;
                    }
                    
                    if (typeof dateValue === 'string') {
                      const dateMatch = dateValue.match(/^(\d{4})[-/]/);
                      if (dateMatch) {
                        const year = parseInt(dateMatch[1]);
                        if (year >= 1800 && year <= 2100) {
                          return year;
                        }
                      }
                      try {
                        const date = new Date(dateValue);
                        if (!isNaN(date.getTime())) {
                          const year = date.getFullYear();
                          if (year >= 1800 && year <= 2100) {
                            return year;
                          }
                        }
                      } catch (e) {}
                      const numMatch = dateValue.match(/^\d{4}$/);
                      if (numMatch) {
                        const year = parseInt(numMatch[0]);
                        if (year >= 1800 && year <= 2100) {
                          return year;
                        }
                      }
                    }
                    
                    return null;
                  }
                  
                  const yearDL = parseYear(person.death_date_solar);
                  const yearAL = parseYear(person.death_date_lunar);
                  
                  let result = '';
                  if (yearDL && yearAL) {
                    result = `DL: ${yearDL} / AL: ${yearAL}`;
                  } else if (yearDL) {
                    result = yearDL.toString();
                  } else if (yearAL) {
                    result = yearAL.toString();
                  }
                  
                  if (result && (person.sheet3_death_place || person.death_location)) {
                    result += ' - ' + (person.sheet3_death_place || person.death_location);
                  }
                  
                  return result || '';
                })()}
              </div>
            </div>
            ` : ''}
            ${person.sheet3_grave ? `
            <div class="form-group">
              <label>Mộ phần:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.sheet3_grave)}</div>
            </div>
            ` : ''}
            ${person.sheet3_number ? `
            <div class="form-group">
              <label>Số thứ tự thành viên:</label>
              <div class="detail-value">${person.sheet3_number}</div>
            </div>
            ` : ''}
            ${person.sheet3_parents ? `
            <div class="form-group">
              <label>Thông tin Bố Mẹ:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.sheet3_parents)}</div>
            </div>
            ` : ''}
            ${person.home_town || person.origin_location ? `
            <div class="form-group">
              <label>Nguyên quán:</label>
              <div class="detail-value">${person.home_town || person.origin_location || 'Chưa có thông tin'}</div>
            </div>
            ` : ''}
            ${person.occupation ? `
            <div class="form-group">
              <label>Nghề nghiệp:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.occupation)}</div>
            </div>
            ` : ''}
            ${person.education ? `
            <div class="form-group">
              <label>Học vấn:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.education)}</div>
            </div>
            ` : ''}
            ${person.events ? `
            <div class="form-group">
              <label>Sự kiện:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.events)}</div>
            </div>
            ` : ''}
            ${person.titles ? `
            <div class="form-group">
              <label>Danh hiệu:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.titles)}</div>
            </div>
            ` : ''}
            ${person.blood_type ? `
            <div class="form-group">
              <label>Nhóm máu:</label>
              <div class="detail-value">${person.blood_type}</div>
            </div>
            ` : ''}
            ${person.genetic_disease ? `
            <div class="form-group">
              <label>Bệnh di truyền:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.genetic_disease)}</div>
            </div>
            ` : ''}
            ${person.place_of_death || person.sheet3_death_place || person.death_location ? `
            <div class="form-group">
              <label>Nơi mất:</label>
              <div class="detail-value">${person.place_of_death || person.sheet3_death_place || person.death_location || 'Chưa có thông tin'}</div>
            </div>
            ` : ''}
            ${person.grave_info || person.sheet3_grave ? `
            <div class="form-group">
              <label>Mộ phần:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.grave_info || person.sheet3_grave)}</div>
            </div>
            ` : ''}
            ${person.contact ? `
            <div class="form-group">
              <label>Thông tin liên lạc:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.contact)}</div>
            </div>
            ` : ''}
            ${person.social ? `
            <div class="form-group">
              <label>Mạng xã hội:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.social)}</div>
            </div>
            ` : ''}
            ${person.note ? `
            <div class="form-group">
              <label>Ghi chú:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.note)}</div>
            </div>
            ` : ''}
            <div class="form-group">
              <label>Hôn phối:</label>
              <div class="detail-value">${getSpouseDisplay(person)}</div>
            </div>
            <div class="form-group">
              <label>Anh/Chị/Em:</label>
              <div class="detail-value">${(() => {
                const siblingsDisplay = person.siblings || person.siblingsText || null;
                if (Array.isArray(siblingsDisplay)) {
                  return siblingsDisplay.join(', ');
                }
                return siblingsDisplay ? formatTextWithLineBreaks(siblingsDisplay) : 'Chưa có thông tin';
              })()}</div>
            </div>
            <div class="form-group">
              <label>Thông tin con:</label>
              <div class="detail-value">${(() => {
                const childrenDisplay = person.children || person.childrenText || null;
                if (Array.isArray(childrenDisplay)) {
                  return childrenDisplay.join(', ');
                }
                return childrenDisplay ? formatTextWithLineBreaks(childrenDisplay) : 'Chưa có thông tin';
              })()}</div>
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn-cancel" onclick="closeDetailPanel()">Đóng</button>
            <button type="button" class="btn-request" onclick="openRequestModal()">📝 Gửi yêu cầu chỉnh sửa</button>
          </div>
        </div>
      `;
      
      panel.style.display = 'block';
    }

    /**
     * Hiển thị modal nhập mật khẩu và cho phép chỉnh sửa nếu đúng
     */
    function promptPasswordAndEdit() {
      if (!selectedPerson) return;
      
      // Tạo modal nhập mật khẩu
      let modal = document.getElementById('passwordModal');
      if (!modal) {
        const modalHTML = `
          <div id="passwordModal" class="modal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto;">
            <div class="modal-content" style="background: #FFF8DC; margin: 15% auto; padding: 30px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); border: 1px solid rgba(139, 0, 0, 0.2);">
              <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #8B0000; margin: 0;">🔐 Xác thực mật khẩu</h3>
                <span class="close" onclick="closePasswordModal()" style="cursor: pointer; font-size: 28px; color: #999; font-weight: bold;">&times;</span>
              </div>
              <form id="passwordForm" onsubmit="verifyPasswordAndEdit(event)">
                <div class="form-group">
                  <label style="display: block; margin-bottom: 8px; color: #8B0000; font-weight: 600;">Nhập mật khẩu để cập nhật thông tin:</label>
                  <input type="password" id="passwordInput" required 
                         placeholder="Nhập mật khẩu" 
                         style="width: 100%; padding: 12px; border: 2px solid #DAA520; border-radius: 6px; font-size: 16px; font-family: 'Noto Serif TC', serif;"
                         autocomplete="off">
                </div>
                <div class="form-actions" style="display: flex; gap: 10px; margin-top: 20px;">
                  <button type="button" class="btn-cancel" onclick="closePasswordModal()" style="flex: 1;">Hủy</button>
                  <button type="submit" class="btn-save" style="flex: 1;">Xác nhận</button>
                </div>
              </form>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        modal = document.getElementById('passwordModal');
      }
      
      // Reset input
      const passwordInput = document.getElementById('passwordInput');
      if (passwordInput) {
        passwordInput.value = '';
        passwordInput.focus();
      }
      
      // Hiển thị modal
      modal.style.display = 'block';
    }
    
    /**
     * Đóng modal mật khẩu
     */
    function closePasswordModal() {
      const modal = document.getElementById('passwordModal');
      if (modal) {
        modal.style.display = 'none';
        const form = document.getElementById('passwordForm');
        if (form) form.reset();
      }
    }
    
    /**
     * Kiểm tra mật khẩu và cho phép chỉnh sửa nếu đúng
     */
    function verifyPasswordAndEdit(event) {
      event.preventDefault();
      
      const passwordInput = document.getElementById('passwordInput');
      const password = passwordInput ? passwordInput.value.trim() : '';
      
      if (!password) {
        alert('❌ Vui lòng nhập mật khẩu!');
        if (passwordInput) {
          passwordInput.focus();
        }
        return;
      }
      
      // Verify password via API instead of hardcoding
      try {
        const verifyResponse = await fetch('/api/admin/verify-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: password, action: 'edit_person' })
        });
        const verifyResult = await verifyResponse.json();
        
        if (verifyResult.success) {
          // Đóng modal
          closePasswordModal();
          // Cho phép chỉnh sửa
          enableEditMode();
        } else {
          alert('❌ Mật khẩu không đúng! Vui lòng thử lại.');
          if (passwordInput) {
            passwordInput.value = '';
            passwordInput.focus();
          }
        }
      } catch (error) {
        console.error('Error verifying password:', error);
        alert('❌ Lỗi xác thực mật khẩu. Vui lòng thử lại.');
      }
    }
    
    /**
     * Hiển thị modal xác nhận xóa với nhập mật khẩu
     */
    function promptPasswordAndDelete() {
      if (!selectedPerson) return;
      
      // Tạo modal xác nhận xóa
      let modal = document.getElementById('deleteConfirmModal');
      if (!modal) {
        const modalHTML = `
          <div id="deleteConfirmModal" class="modal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto;">
            <div class="modal-content" style="background: #FFF8DC; margin: 15% auto; padding: 30px; border-radius: 8px; width: 90%; max-width: 450px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); border: 1px solid rgba(139, 0, 0, 0.2);">
              <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #DC143C; margin: 0;">⚠️ Xác nhận xóa</h3>
                <span class="close" onclick="closeDeleteModal()" style="cursor: pointer; font-size: 28px; color: #999; font-weight: bold;">&times;</span>
              </div>
              <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                <p style="margin: 0; color: #856404; font-weight: 600;">Bạn có chắc chắn muốn xóa người này?</p>
                <p style="margin: 10px 0 0 0; color: #856404;">
                  <strong id="deletePersonName">${selectedPerson.full_name}</strong> (Đời ${selectedPerson.generation_number || '?'})
                </p>
                <p style="margin: 10px 0 0 0; color: #856404; font-size: 14px;">
                  ⚠️ Hành động này không thể hoàn tác! Tất cả dữ liệu liên quan sẽ bị xóa.
                </p>
              </div>
              <form id="deleteConfirmForm" onsubmit="verifyPasswordAndDelete(event)">
                <div class="form-group">
                  <label style="display: block; margin-bottom: 8px; color: #DC143C; font-weight: 600;">Nhập mật khẩu admin để xác nhận:</label>
                  <input type="password" id="deletePasswordInput" required 
                         placeholder="Nhập mật khẩu" 
                         style="width: 100%; padding: 12px; border: 2px solid #DC143C; border-radius: 6px; font-size: 16px; font-family: 'Noto Serif TC', serif;"
                         autocomplete="off">
                </div>
                <div class="form-actions" style="display: flex; gap: 10px; margin-top: 20px;">
                  <button type="button" class="btn-cancel" onclick="closeDeleteModal()" style="flex: 1;">Hủy</button>
                  <button type="submit" class="btn-delete" style="flex: 1; background: linear-gradient(135deg, #DC143C 0%, #8B0000 100%); color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">🗑️ Xóa vĩnh viễn</button>
                </div>
              </form>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        modal = document.getElementById('deleteConfirmModal');
      }
      
      // Cập nhật thông tin người sẽ bị xóa
      const personInfo = document.getElementById('deletePersonName');
      if (personInfo && selectedPerson) {
        personInfo.textContent = `${selectedPerson.full_name} (Đời ${selectedPerson.generation_number || '?'})`;
      }
      
      // Reset input
      const passwordInput = document.getElementById('deletePasswordInput');
      if (passwordInput) {
        passwordInput.value = '';
        passwordInput.focus();
      }
      
      // Hiển thị modal
      modal.style.display = 'block';
    }
    
    /**
     * Đóng modal xóa
     */
    function closeDeleteModal() {
      const modal = document.getElementById('deleteConfirmModal');
      if (modal) {
        modal.style.display = 'none';
        const form = document.getElementById('deleteConfirmForm');
        if (form) form.reset();
      }
    }
    
    /**
     * Kiểm tra mật khẩu và xóa nếu đúng
     */
    async function verifyPasswordAndDelete(event) {
      event.preventDefault();
      
      if (!selectedPerson) {
        alert('❌ Không tìm thấy thông tin người cần xóa');
        return;
      }
      
      const passwordInput = document.getElementById('deletePasswordInput');
      const password = passwordInput ? passwordInput.value.trim() : '';
      
      // Verify password via API instead of hardcoding
      if (!password) {
        alert('❌ Vui lòng nhập mật khẩu!');
        if (passwordInput) {
          passwordInput.focus();
        }
        return;
      }
      
      // Verify password via API
      try {
        const verifyResponse = await fetch('/api/admin/verify-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: password, action: 'delete_person' })
        });
        const verifyResult = await verifyResponse.json();
        
        if (!verifyResult.success) {
          alert('❌ Mật khẩu không đúng! Vui lòng thử lại.');
          if (passwordInput) {
            passwordInput.value = '';
            passwordInput.focus();
          }
          return;
        }
      } catch (error) {
        console.error('Error verifying password:', error);
        alert('❌ Lỗi xác thực mật khẩu. Vui lòng thử lại.');
        return;
      }
      
      // Xác nhận lần cuối
      const personName = selectedPerson.full_name || 'Người này';
      const finalConfirm = confirm(`⚠️ XÁC NHẬN CUỐI CÙNG\n\nBạn có chắc chắn muốn xóa:\n${personName} (Đời ${selectedPerson.generation_number || '?'})\n\nHành động này KHÔNG THỂ hoàn tác!`);
      
      if (!finalConfirm) {
        return;
      }
      
      const personId = selectedPerson.person_id;
      
      try {
        const response = await fetch(`/api/person/${personId}`, {
          method: 'DELETE',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ password: password })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          alert(`✅ ${result.message}`);
          
          // Đóng modal và panel
          closeDeleteModal();
          closeDetailPanel();
          
          // Xóa khỏi input tìm kiếm
          const nameInput = document.getElementById('lineageName');
          if (nameInput) {
            const nameInput = document.getElementById('lineageName');
            if (nameInput) {
              nameInput.value = '';
            }
          }
          
          // Ẩn kết quả
          const resultDiv = document.getElementById('lineageResult');
          if (resultDiv) {
            resultDiv.style.display = 'none';
          }
          
          // Reload dữ liệu (reload trang để cập nhật)
          setTimeout(() => {
            location.reload();
          }, 1000);
        } else {
          alert('❌ Lỗi: ' + (result.error || 'Không thể xóa người này'));
        }
      } catch (error) {
        console.error('Lỗi khi xóa:', error);
        alert('❌ Lỗi kết nối: ' + error.message);
      }
    }
    
    /**
     * Chuyển sang chế độ chỉnh sửa
     */
    function enableEditMode() {
      if (!selectedPerson) return;
      
      isEditMode = true;
      const content = document.getElementById('lineageDetailContent');
      const person = selectedPerson;
      
      content.innerHTML = `
        <form id="personEditForm" onsubmit="savePersonData(event)">
          <div class="detail-form">
            <div class="form-group">
              <label>Person ID:</label>
              <div class="detail-value">${person.person_id || 'Chưa có thông tin'}</div>
            </div>
            <div class="form-group">
              <label>Tên đầy đủ:</label>
              <input type="text" name="full_name" value="${(person.full_name || '').replace(/"/g, '&quot;')}" required>
            </div>
            <div class="form-group">
              <label>Đời:</label>
              <input type="number" name="generation_number" value="${person.generation_number || ''}" min="1" required>
            </div>
            <div class="form-group">
              <label>Giới tính:</label>
              <select name="gender">
                <option value="Nam" ${person.gender === 'Nam' ? 'selected' : ''}>Nam</option>
                <option value="Nữ" ${person.gender === 'Nữ' ? 'selected' : ''}>Nữ</option>
                <option value="Khác" ${person.gender === 'Khác' ? 'selected' : ''}>Khác</option>
              </select>
            </div>
            <div class="form-group">
              <label>Tên bố:</label>
              <input type="text" name="father_name" value="${(person.father_name || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-group">
              <label>Tên mẹ:</label>
              <input type="text" name="mother_name" value="${(person.mother_name || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-group">
              <label>Nhánh:</label>
              <input type="text" name="branch_name" value="${(person.branch_name || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-group">
              <label>Trạng thái:</label>
              <select name="status">
                <option value="Còn sống" ${person.status === 'Còn sống' ? 'selected' : ''}>Còn sống</option>
                <option value="Đã mất" ${person.status === 'Đã mất' ? 'selected' : ''}>Đã mất</option>
                <option value="Không rõ" ${person.status === 'Không rõ' || !person.status ? 'selected' : ''}>Không rõ</option>
              </select>
            </div>
            <div class="form-group">
              <label>Ngày sinh (Dương lịch):</label>
              <input type="date" name="birth_date_solar" value="${person.birth_date_solar || ''}">
            </div>
            <div class="form-group">
              <label>Ngày sinh (Âm lịch):</label>
              <input type="date" name="birth_date_lunar" value="${person.birth_date_lunar || ''}">
            </div>
            <div class="form-group">
              <label>Nơi sinh:</label>
              <input type="text" name="birth_location" value="${(person.birth_location || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-group">
              <label>Ngày mất (Dương lịch):</label>
              <input type="date" name="death_date_solar" value="${person.death_date_solar || ''}">
            </div>
            <div class="form-group">
              <label>Ngày mất (Âm lịch):</label>
              <input type="date" name="death_date_lunar" value="${person.death_date_lunar || ''}">
            </div>
            <div class="form-group">
              <label>Nơi mất:</label>
              <input type="text" name="death_location" value="${(person.death_location || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-group">
              <label>Nguyên quán:</label>
              <input type="text" name="origin_location" value="${(person.origin_location || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-group">
              <label>Anh/Chị/Em:</label>
              <textarea name="siblings" rows="2">${(person.siblings || '').replace(/"/g, '&quot;')}</textarea>
            </div>
            <div class="form-group">
              <label>Hôn phối:</label>
              <textarea name="spouse" rows="2">${(person.spouse || '').replace(/"/g, '&quot;')}</textarea>
            </div>
            <div class="form-group">
              <label>Thông tin con:</label>
              <textarea name="children" rows="3">${(person.children || '').replace(/"/g, '&quot;')}</textarea>
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn-cancel" onclick="cancelEdit()">Hủy</button>
            <button type="submit" class="btn-save">💾 Lưu thay đổi</button>
            <button type="button" class="btn-sync" onclick="syncPersonData()" style="background: #28a745; color: white; margin-left: 10px;">🔄 Đồng bộ</button>
          </div>
        </form>
      `;
    }

    /**
     * Hủy chỉnh sửa, quay về chế độ xem
     */
    function cancelEdit() {
      isEditMode = false;
      if (selectedPerson) {
        renderDetailPanel(selectedPerson);
      }
    }
    
    /**
     * Mở modal gửi yêu cầu chỉnh sửa
     */
    function openRequestModal() {
      if (!selectedPerson) return;
      
      let modal = document.getElementById('requestEditModal');
      if (!modal) {
        // Tạo modal nếu chưa có
        const modalHTML = `
          <div id="requestEditModal" class="modal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto;">
            <div class="modal-content" style="background: #FFF8DC; margin: 5% auto; padding: 30px; border-radius: 8px; width: 90%; max-width: 600px; border: 1px solid rgba(139, 0, 0, 0.2);">
              <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #8B0000; margin: 0;">📝 Gửi yêu cầu cập nhật thông tin</h3>
                <span class="close" onclick="closeRequestModal()" style="cursor: pointer; font-size: 28px; color: #999; font-weight: bold;">&times;</span>
              </div>
              <form id="requestEditForm" onsubmit="submitEditRequest(event)">
                <input type="hidden" id="request_person_id" value="${selectedPerson.person_id}">
                <input type="hidden" id="request_person_name" value="${selectedPerson.full_name}">
                <input type="hidden" id="request_person_generation" value="${selectedPerson.generation_number}">
                
                <div class="form-group" style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; color: #8B0000; font-weight: 600;">Người cần cập nhật thông tin:</label>
                  <div style="padding: 12px; background: #FFF8DC; border-radius: 6px; border: 1px solid rgba(139, 0, 0, 0.15);">
                    <strong style="color: #8B0000;">${selectedPerson.full_name}</strong> <span style="color: #666;">(Đời ${selectedPerson.generation_number})</span>
                  </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                  <label for="request_full_name" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">Họ và tên *</label>
                  <input type="text" id="request_full_name" name="full_name" required 
                         placeholder="Nhập họ và tên của bạn"
                         style="width: 100%; padding: 12px; border: 2px solid #DAA520; border-radius: 6px; font-size: 16px; font-family: 'Noto Serif TC', serif;">
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                  <label for="request_contact" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">Email hoặc SĐT *</label>
                  <input type="text" id="request_contact" name="contact" required 
                         placeholder="Nhập email hoặc số điện thoại của bạn"
                         style="width: 100%; padding: 12px; border: 2px solid #DAA520; border-radius: 6px; font-size: 16px; font-family: 'Noto Serif TC', serif;">
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                  <label for="request_content" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">Nội dung cần cập nhật *</label>
                  <textarea id="request_content" name="content" rows="6" required 
                            placeholder="Vui lòng mô tả chi tiết những thông tin bạn muốn cập nhật cho ${selectedPerson.full_name}..."
                            style="width: 100%; padding: 12px; border: 2px solid #DAA520; border-radius: 6px; font-size: 16px; font-family: 'Noto Serif TC', serif; resize: vertical;"></textarea>
                </div>
                
                <div class="form-actions" style="display: flex; gap: 10px; margin-top: 30px;">
                  <button type="button" class="btn-cancel" onclick="closeRequestModal()" style="flex: 1; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; background: #757575; color: white;">Hủy</button>
                  <button type="submit" class="btn-save" style="flex: 1; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%); color: #FFD700;">📤 Gửi yêu cầu</button>
                </div>
              </form>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        modal = document.getElementById('requestEditModal');
      }
      
      // Cập nhật giá trị
      const personIdInput = document.getElementById('request_person_id');
      const personNameInput = document.getElementById('request_person_name');
      const personGenInput = document.getElementById('request_person_generation');
      const fullNameInput = document.getElementById('request_full_name');
      const contactInput = document.getElementById('request_contact');
      const contentInput = document.getElementById('request_content');
      
      if (personIdInput) personIdInput.value = selectedPerson.person_id;
      if (personNameInput) personNameInput.value = selectedPerson.full_name;
      if (personGenInput) personGenInput.value = selectedPerson.generation_number || '';
      if (fullNameInput) fullNameInput.value = '';
      if (contactInput) contactInput.value = '';
      if (contentInput) contentInput.value = '';
      
      if (modal) {
        modal.style.display = 'block';
      }
    }
    
    /**
     * Đóng modal request
     */
    function closeRequestModal() {
      const modal = document.getElementById('requestEditModal');
      if (modal) {
        modal.style.display = 'none';
        const form = document.getElementById('requestEditForm');
        if (form) form.reset();
      }
    }
    
    /**
     * Gửi yêu cầu chỉnh sửa
     */
    async function submitEditRequest(event) {
      event.preventDefault();
      
      const personIdInput = document.getElementById('request_person_id');
      const personNameInput = document.getElementById('request_person_name');
      const personGenInput = document.getElementById('request_person_generation');
      const fullNameInput = document.getElementById('request_full_name');
      const contactInput = document.getElementById('request_contact');
      const contentInput = document.getElementById('request_content');
      
      if (!personIdInput || !personNameInput || !personGenInput || !fullNameInput || !contactInput || !contentInput) {
        console.error('[EditRequest] Required form elements not found');
        alert('Lỗi: Không tìm thấy các trường form');
        return;
      }
      
      const personId = personIdInput.value;
      const personName = personNameInput.value;
      const personGeneration = personGenInput.value;
      const fullName = fullNameInput.value.trim();
      const contact = contactInput.value.trim();
      const content = contentInput.value.trim();
      
      if (!fullName || !contact || !content) {
        alert('Vui lòng điền đầy đủ thông tin');
        return;
      }
      
      try {
        const response = await fetch('/api/send-edit-request-email', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            person_id: personId, // Giữ nguyên string (P-1-1 format)
            person_name: personName,
            person_generation: parseInt(personGeneration),
            requester_name: fullName,
            requester_contact: contact,
            content: content
          })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          alert('✅ Yêu cầu của bạn đã được gửi tới email baophongcmu@gmail.com. Cảm ơn bạn đã đóng góp!');
          closeRequestModal();
        } else {
          alert('❌ Lỗi: ' + (result.error || 'Không thể gửi yêu cầu'));
        }
      } catch (error) {
        console.error('Lỗi khi gửi yêu cầu:', error);
        alert('❌ Lỗi kết nối: ' + error.message);
      }
    }

    /**
     * Đóng detail panel
     */
    function closeDetailPanel() {
      const panel = document.getElementById('lineageDetailPanel');
      panel.style.display = 'none';
    }

    /**
     * Lưu dữ liệu Person đã chỉnh sửa
     */
    function savePersonData(event) {
      event.preventDefault();
      
      if (!selectedPerson || !selectedPerson.person_id) {
        alert('Lỗi: Không tìm thấy dữ liệu để cập nhật');
        return;
      }
      
      const form = event.target;
      const formData = new FormData(form);
      
      // Thu thập TẤT CẢ dữ liệu từ form
      const updates = {};
      for (const [key, value] of formData.entries()) {
        if (key === 'generation_number') {
          updates[key] = parseInt(value, 10);
        } else if (value && value.trim()) {
          updates[key] = value.trim();
        }
      }
      
      // Hiển thị loading
      const submitButton = form.querySelector('button[type="submit"]');
      const originalText = submitButton ? submitButton.innerHTML : '';
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.innerHTML = '⏳ Đang lưu...';
      }
      
      // Gửi TẤT CẢ dữ liệu lên server để lưu vào database
      fetch(`/api/person/${selectedPerson.person_id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(updates)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log('[API] Đã lưu vào database:', data);
          
          // Reload lại dữ liệu từ server để có dữ liệu mới nhất
          return fetch(`/api/person/${selectedPerson.person_id}`)
            .then(response => response.json())
            .then(personData => {
              if (personData && !personData.error) {
                selectedPerson = personData;
                
                // Cập nhật trong memory (nếu có GenealogyLineage)
                if (window.GenealogyLineage) {
                  window.GenealogyLineage.updatePerson(selectedPerson.person_id, updates);
                }
                
                alert('✅ Đã cập nhật và đồng bộ thông tin thành công!');
                
                // Refresh hiển thị nếu có thay đổi về tên, đời, hoặc cha/mẹ
                if (updates.father_name !== undefined || updates.mother_name !== undefined || 
                    updates.full_name !== undefined || updates.generation_number !== undefined) {
                  displayLineageForPerson(selectedPerson);
                }
                
                // Hiển thị lại panel với dữ liệu mới
                isEditMode = false;
                showDetailPanel(selectedPerson);
              } else {
                throw new Error('Không thể tải lại dữ liệu từ server');
              }
            });
        } else {
          throw new Error(data.error || 'Lỗi khi lưu dữ liệu');
        }
      })
      .catch(error => {
        console.error('[API] Lỗi khi lưu vào database:', error);
        alert('❌ Lỗi khi lưu dữ liệu: ' + error.message);
      })
      .finally(() => {
        // Khôi phục button
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.innerHTML = originalText;
        }
      });
    }

    /**
     * Đồng bộ dữ liệu Person sau khi cập nhật
     * Đồng bộ relationships, marriages_spouses, và tính lại siblings
     */
    function syncPersonData() {
      if (!selectedPerson || !selectedPerson.person_id) {
        alert('❌ Lỗi: Không tìm thấy dữ liệu để đồng bộ');
        return;
      }

      if (!confirm('Bạn có chắc muốn đồng bộ dữ liệu? Dữ liệu sẽ được cập nhật theo thông tin mới nhất.')) {
        return;
      }

      // Hiển thị loading
      const syncButton = document.querySelector('.btn-sync');
      const originalText = syncButton ? syncButton.innerHTML : '';
      if (syncButton) {
        syncButton.disabled = true;
        syncButton.innerHTML = '⏳ Đang đồng bộ...';
      }

      fetch(`/api/person/${selectedPerson.person_id}/sync`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('✅ Đã đồng bộ dữ liệu thành công!\n\n' + (data.message || ''));
          
          // Reload lại dữ liệu person từ server
          fetch(`/api/person/${selectedPerson.person_id}`)
            .then(response => response.json())
            .then(personData => {
              if (personData && !personData.error) {
                selectedPerson = personData;
                showDetailPanel(personData);
                
                // Reload lại danh sách persons nếu cần
                if (window.GenealogyLineage && personData) {
                  window.GenealogyLineage.updatePerson(personData.person_id, personData);
                }
              }
            })
            .catch(error => {
              console.error('[API] Lỗi khi reload dữ liệu:', error);
            });
        } else {
          alert('❌ Lỗi khi đồng bộ: ' + (data.error || 'Không xác định'));
        }
      })
      .catch(error => {
        console.error('[API] Lỗi khi đồng bộ:', error);
        alert('❌ Lỗi khi đồng bộ dữ liệu: ' + error.message);
      })
      .finally(() => {
        // Khôi phục button
        if (syncButton) {
          syncButton.disabled = false;
          syncButton.innerHTML = originalText;
        }
      });
    }

    /**
     * Khởi tạo lineage module khi dữ liệu đã load
     */
    window.initLineageModule = function(persons) {
      if (window.GenealogyLineage && persons && persons.length > 0) {
        personsDataForLineage = persons;
        window.GenealogyLineage.init(persons);
        console.log('[Lineage] Module đã được khởi tạo với', persons.length, 'người');
      }
    };

    // Đóng suggestions khi click ra ngoài
    document.addEventListener('click', (e) => {
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      const nameInput = document.getElementById('lineageName');
      
      if (suggestionsDiv && nameInput && !suggestionsDiv.contains(e.target) && e.target !== nameInput) {
        suggestionsDiv.style.display = 'none';
      }
      
      // Đóng modal mật khẩu khi click ra ngoài
      const passwordModal = document.getElementById('passwordModal');
      if (passwordModal && e.target === passwordModal) {
        closePasswordModal();
      }
      
      // Đóng modal xóa khi click ra ngoài
      const deleteModal = document.getElementById('deleteConfirmModal');
      if (deleteModal && e.target === deleteModal) {
        closeDeleteModal();
      }
    });

    // Initialize lineage search functionality when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      console.log('[Lineage] Initializing lineage search...');
      
      const nameInput = document.getElementById('lineageName');
      const btnSearchLineage = document.getElementById('btnSearchLineage');
      
      // Enter key handler
      if (nameInput) {
        nameInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            searchLineage();
          }
        });
        console.log('[Lineage] Enter key handler attached');
      } else {
        console.warn('[Lineage] lineageName input not found');
      }
      
      // Button click handler (if not already handled by onclick)
      if (btnSearchLineage && !btnSearchLineage.onclick) {
        btnSearchLineage.addEventListener('click', (e) => {
          e.preventDefault();
          searchLineage();
        });
        console.log('[Lineage] Search button handler attached');
      }
      
      console.log('[Lineage] Lineage search initialized');
    });

    /**
     * Tính toán vị trí cho horizontal layout (generations dọc, people ngang)
     */
    function calculateHorizontalPositions(node, x = 0, y = 0, levelPositions = {}) {
      if (!node) return { x: 0, nextX: 0 };

      const depth = node.depth || 0;
      if (!levelPositions[depth]) {
        levelPositions[depth] = 0;
      }

      // Y = generation (dọc) - dùng generation thực tế
      const generation = node.generation || depth;
      node.y = (generation - 1) * 120 + 50;

      const horizontalSpacing = 180;
      if (node.children.length === 0) {
        node.x = levelPositions[depth] * horizontalSpacing + 20;
        levelPositions[depth]++;
        return { x: node.x, nextX: levelPositions[depth] * horizontalSpacing };
      }

      // Tính vị trí cho children trước
      let childX = levelPositions[depth] * horizontalSpacing;
      let maxChildX = childX;

      node.children.forEach((child, index) => {
        const childResult = calculateHorizontalPositions(child, 0, 0, levelPositions);
        if (index === 0) {
          childX = childResult.x;
        }
        maxChildX = Math.max(maxChildX, childResult.nextX);
      });

      // Đặt parent ở giữa children
      if (node.children.length > 0) {
        const firstChildX = node.children[0].x;
        const lastChildX = node.children[node.children.length - 1].x;
        node.x = (firstChildX + lastChildX) / 2;
      } else {
        node.x = levelPositions[depth] * horizontalSpacing + 20;
        levelPositions[depth]++;
      }

      return { x: childX, nextX: maxChildX };
    }


    /**
     * Render family tree vào Activities section (Đời 1-5) - Horizontal Layout
     */
  </script>


  <!-- Load genealogy scripts -->
  <!-- Family tree scripts đã di chuyển sang /genealogy -->
  <script src="/static/js/device-detection.js"></script>
  <script src="/static/js/genealogy-lineage.js"></script>

  <script>
    // Generic fetch helper to ensure JSON responses and better error logging
    async function fetchJson(url, options) {
      const res = await fetch(url, options);
      const contentType = res.headers.get('Content-Type') || '';
      const text = await res.text();

      if (!res.ok) {
        console.error('HTTP error for', url, res.status, text);
        throw new Error(`HTTP ${res.status} when fetching ${url}`);
      }

      if (!contentType.includes('application/json')) {
        console.error('Non-JSON response for', url, 'contentType =', contentType, 'body =', text.slice(0, 300));
        throw new Error(`Expected JSON but got non-JSON response from ${url}`);
      }

      try {
        return JSON.parse(text);
      } catch (e) {
        console.error('JSON parse error for', url, 'body =', text.slice(0, 300));
        throw e;
      }
    }
  </script>
  
  <script>
    // ============================================
    // INTERACTIVE GENEALOGY TREE
    // ============================================
    
    // Load vis-network from CDN
    const visScript = document.createElement('script');
    visScript.src = 'https://unpkg.com/vis-network@latest/standalone/umd/vis-network.min.js';
    visScript.onload = () => {
      console.log('[Tree] vis-network loaded, initializing tree...');
      try {
        // initGenealogyTree(); // Đã di chuyển sang /genealogy
      } catch (err) {
        console.error('[Tree] Error initializing tree:', err);
        const container = document.getElementById('treeContainer');
        if (container) {
          container.innerHTML = `
            <div style="padding: 20px; color: #d32f2f; text-align: center;">
              <h3>Lỗi khi khởi tạo cây gia phả</h3>
              <p>${err.message}</p>
              <p style="margin-top: 10px; font-size: 14px; color: #666;">
                Vui lòng kiểm tra console để biết thêm chi tiết.
              </p>
            </div>
          `;
        }
      }
    };
    visScript.onerror = () => {
      console.error('[Tree] Failed to load vis-network');
      const container = document.getElementById('treeContainer');
      if (container) {
        container.innerHTML = `
          <div style="padding: 20px; color: #d32f2f; text-align: center;">
            <h3>Không thể tải thư viện vis-network</h3>
            <p>Vui lòng kiểm tra kết nối internet và thử lại.</p>
          </div>
        `;
      }
    };
    document.head.appendChild(visScript);
    
    const visStyle = document.createElement('link');
    visStyle.rel = 'stylesheet';
    visStyle.href = 'https://unpkg.com/vis-network@latest/styles/vis-network.min.css';
    document.head.appendChild(visStyle);

    let network = null;
    let currentRootId = 'P-1-1'; // Default: Vua Minh Mạng (phải là string, không phải số)
    let currentMaxGen = 5;
    let treeData = null;

    async function initGenealogyTree() {
      console.log('[Tree] Initializing genealogy tree...');
      
      // Check if required elements exist
      const genFilter = document.getElementById('genFilter');
      const searchBtn = document.getElementById('searchBtn');
      const searchInput = document.getElementById('searchInput');
      const container = document.getElementById('treeContainer');
      
      if (!container) {
        console.error('[Tree] treeContainer not found');
        return;
      }
      
      // Load initial tree
      try {
        await loadTree(currentRootId, currentMaxGen);
      } catch (err) {
        console.error('[Tree] Error loading initial tree:', err);
        container.innerHTML = `
          <div style="padding: 20px; color: #d32f2f; text-align: center;">
            <h3>Lỗi khi tải cây gia phả</h3>
            <p>${err.message}</p>
          </div>
        `;
        return;
      }
      
      // Event listeners - with null checks
      if (genFilter) {
        genFilter.addEventListener('change', (e) => {
          currentMaxGen = parseInt(e.target.value);
          loadTree(currentRootId, currentMaxGen);
        });
      } else {
        console.warn('[Tree] genFilter element not found');
      }
      
      if (searchBtn) {
        searchBtn.addEventListener('click', handleSearch);
      } else {
        console.warn('[Tree] searchBtn element not found');
      }
      
      if (searchInput) {
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleSearch();
        });
      } else {
        console.warn('[Tree] searchInput element not found');
      }
      
      console.log('[Tree] Tree initialization complete');
    }

    async function loadTree(rootId, maxGen) {
      const container = document.getElementById('treeContainer');
      if (!container) {
        console.error('Tree container not found');
        return;
      }
      
      // Find or create loading element
      let loading = container.querySelector('.tree-loading');
      if (!loading) {
        loading = document.createElement('div');
        loading.className = 'tree-loading';
        loading.style.cssText = 'padding: 20px; text-align: center; color: #666;';
        container.innerHTML = '';
        container.appendChild(loading);
      }
      
      try {
        loading.style.display = 'block';
        loading.textContent = 'Đang kết nối với API...';
        
        // Use AbortController for timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        
        const response = await fetch(`/api/tree?root_id=${rootId}&max_generation=${maxGen}`, {
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`API /api/tree trả mã ${response.status}`);
        }
        
        loading.textContent = 'Đã tải dữ liệu, đang dựng cây...';
        
        treeData = await response.json();
        
        if (!treeData) {
          throw new Error('API trả về dữ liệu rỗng');
        }
        
        // Convert tree to vis-network format
        const { nodes, edges } = convertTreeToVisFormat(treeData);
        
        // Create network
        const data = { nodes, edges };
        const options = {
          layout: {
            hierarchical: {
              direction: 'UD', // Up-Down
              sortMethod: 'directed',
              levelSeparation: 150, // Increased for better visibility
              nodeSpacing: 200, // Increased spacing between nodes
              treeSpacing: 250, // Increased spacing between trees
              blockShifting: true,
              edgeMinimization: true,
              parentCentralization: true
            }
          },
          nodes: {
            shape: 'box',
            font: { 
              size: 16,
              face: 'Arial, sans-serif',
              color: '#333'
            },
            borderWidth: 4,
            widthConstraint: { maximum: 280 },
            heightConstraint: { minimum: 60 },
            margin: 15,
            shadow: {
              enabled: true,
              color: 'rgba(0,0,0,0.2)',
              size: 5,
              x: 2,
              y: 2
            },
            shapeProperties: {
              borderRadius: 8
            }
          },
          edges: {
            arrows: { 
              to: { 
                enabled: true,
                scaleFactor: 1.2,
                type: 'arrow'
              } 
            },
            color: { 
              color: '#8B0000', 
              highlight: '#DAA520',
              hover: '#FF6347'
            },
            width: 3,
            smooth: {
              type: 'curvedCW',
              roundness: 0.2
            },
            shadow: {
              enabled: true,
              color: 'rgba(0,0,0,0.1)',
              size: 3
            }
          },
          physics: {
            enabled: false
          },
          interaction: {
            zoomView: true,
            dragView: true
          }
        };
        
        if (network) {
          network.destroy();
        }
        
        // Clear container and create network
        container.innerHTML = '';
        try {
          network = new vis.Network(container, data, options);
          
          // Node click handler
          network.on('click', (params) => {
            if (params.nodes.length > 0) {
              const nodeId = params.nodes[0]; // Giữ nguyên string, không parse thành số
              if (nodeId && nodeId !== 'NaN' && nodeId !== 'undefined') {
                showPersonInfo(nodeId);
              } else {
                console.warn('[Tree] Invalid nodeId:', nodeId);
              }
            }
          });
          
          console.log('[Tree] Network created successfully');
        } catch (err) {
          console.error('[Tree] Error creating network:', err);
          container.innerHTML = `
            <div style="padding: 20px; color: #d32f2f; text-align: center;">
              <h3>Lỗi khi tạo cây gia phả</h3>
              <p>${err.message}</p>
            </div>
          `;
          throw err;
        }
        
        // Load breadcrumb - ĐÃ XÓA (Nâng cấp 1)
        // await loadBreadcrumb(rootId);
        
        loading.style.display = 'none';
      } catch (err) {
        console.error('Error loading tree:', err);
        loading.style.display = 'block';
        if (err.name === 'AbortError') {
          loading.innerHTML = 'API không phản hồi sau 30 giây. Vui lòng kiểm tra kết nối hoặc server.';
        } else {
          loading.innerHTML = `Không thể kết nối API (${err.message}).`;
        }
      }
    }

    function convertTreeToVisFormat(tree) {
      const nodes = [];
      const edges = [];
      const visited = new Set();
      
      function traverse(node, parentId = null) {
        if (!node || visited.has(node.person_id)) return;
        visited.add(node.person_id);
        
        // Add node with generation info in label
        const name = node.full_name || `Person ${node.person_id}`;
        const gen = node.generation_number || '';
        const status = node.status || '';
        
        // Label includes generation for clarity
        const label = gen ? `${name}\n(Đời ${gen})` : name;
        
        // Color by generation (different shades for different generations)
        let nodeColor = {
          background: '#fff',
          border: '#DAA520',
          highlight: {
            background: '#FFD700',
            border: '#8B0000'
          }
        };
        
        // Different colors for different generations - improved styling with rich colors
        if (gen === 1) {
          nodeColor.background = '#FFF8DC'; // Cream - Vua/Ancestor
          nodeColor.border = '#8B0000'; // Dark red
        } else if (gen === 2) {
          nodeColor.background = '#FFE4B5'; // Moccasin
          nodeColor.border = '#CD853F'; // Peru
        } else if (gen === 3) {
          nodeColor.background = '#FFFACD'; // Lemon chiffon
          nodeColor.border = '#DAA520'; // Goldenrod
        } else if (gen === 4) {
          nodeColor.background = '#F0E68C'; // Khaki
          nodeColor.border = '#B8860B'; // Dark goldenrod
        } else if (gen === 5) {
          nodeColor.background = '#FFFFE0'; // Light yellow
          nodeColor.border = '#9ACD32'; // Yellow green
        } else if (gen >= 6) {
          nodeColor.background = '#E6E6FA'; // Lavender
          nodeColor.border = '#9370DB'; // Medium purple
        }
        
        nodes.push({
          id: node.person_id,
          label: label,
          title: `${name}\nĐời: ${gen || 'N/A'}\nTrạng thái: ${status || 'N/A'}`,
          generation: gen,
          gender: node.gender,
          status: status,
          color: nodeColor
        });
        
        // Add edge from parent
        if (parentId !== null) {
          edges.push({
            from: parentId,
            to: node.person_id
          });
        }
        
        // Traverse children
        if (node.children && Array.isArray(node.children)) {
          for (const child of node.children) {
            traverse(child, node.person_id);
          }
        }
      }
      
      traverse(tree);
      return { nodes, edges };
    }

    async function handleSearch() {
      const searchInput = document.getElementById('searchInput');
      if (!searchInput) {
        console.warn('[Tree] searchInput not found');
        return;
      }
      const query = searchInput.value.trim();
      if (!query) return;
      
      const resultsDiv = document.getElementById('searchResults');
      if (!resultsDiv) {
        console.warn('[Tree] searchResults not found');
        return;
      }
      resultsDiv.style.display = 'block';
      resultsDiv.innerHTML = '<div style="padding: 10px; color: #666;">Đang tìm kiếm...</div>';
      
      try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=30`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const results = await response.json();
        
        if (results.length === 0) {
          resultsDiv.innerHTML = '<div style="padding: 10px; color: #666;">Không tìm thấy kết quả</div>';
          return;
        }
        
        resultsDiv.innerHTML = results.map(person => {
          const gen = person.generation_number ? `Đời ${person.generation_number}` : '';
          const loc = person.origin_location ? `, ${person.origin_location}` : '';
          return `
            <div class="search-result" data-person-id="${person.person_id}" 
                 style="padding: 10px; margin: 5px 0; background: #FFF8DC; border-radius: 6px; cursor: pointer; border-left: 3px solid #DAA520; border: 1px solid rgba(139, 0, 0, 0.1);"
                 onmouseover="this.style.background='#FFE4B5'" 
                 onmouseout="this.style.background='#FFF8DC'">
              <strong>${escapeHtml(person.full_name)}</strong>
              ${person.common_name ? ` (${escapeHtml(person.common_name)})` : ''}
              ${gen ? ` - ${gen}` : ''}${loc}
            </div>
          `;
        }).join('');
        
        // Add click handlers
        if (resultsDiv) {
          resultsDiv.querySelectorAll('.search-result').forEach(el => {
            if (el) {
              el.addEventListener('click', () => {
                const personId = el.getAttribute('data-person-id'); // Giữ nguyên string, không parse thành số
                currentRootId = personId;
                if (resultsDiv) {
                  resultsDiv.style.display = 'none';
                }
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                  searchInput.value = '';
                }
                loadTree(personId, currentMaxGen);
              });
            }
          });
        }
      } catch (err) {
        console.error('Search error:', err);
        resultsDiv.innerHTML = `<div style="padding: 10px; color: #d32f2f;">Lỗi: ${err.message}</div>`;
      }
    }

    // Hàm loadBreadcrumb - ĐÃ XÓA (Nâng cấp 1)
    /*
    async function loadBreadcrumb(personId) {
      const breadcrumbDiv = document.getElementById('breadcrumb');
      
      try {
        const response = await fetch(`/api/ancestors/${personId}`);
        if (!response.ok) return;
        
        const data = await response.json();
        const chain = data.ancestors_chain || [];
        
        if (chain.length > 0) {
          breadcrumbDiv.style.display = 'block';
          breadcrumbDiv.innerHTML = chain.map((p, i) => {
            const sep = i < chain.length - 1 ? ' → ' : '';
            return `<span style="color: ${i === chain.length - 1 ? '#8B0000' : '#666'}; font-weight: ${i === chain.length - 1 ? '600' : '400'};">${escapeHtml(p.full_name)}</span>${sep}`;
          }).join('');
        } else {
          breadcrumbDiv.style.display = 'none';
        }
      } catch (err) {
        console.error('Breadcrumb error:', err);
        breadcrumbDiv.style.display = 'none';
      }
    }
    */

    async function showPersonInfo(personId) {
      const infoContent = document.getElementById('infoContent');
      if (!infoContent) {
        console.error('infoContent element not found');
        return;
      }
      
      infoContent.innerHTML = '<div style="padding: 10px; color: #666;">Đang tải thông tin...</div>';
      
      try {
        // Load person details
        const [personRes, ancestorsRes, descendantsRes] = await Promise.all([
          fetch(`/api/person/${personId}`),
          fetch(`/api/ancestors/${personId}`),
          fetch(`/api/descendants/${personId}?max_depth=5`)
        ]);
        
        if (!personRes.ok) {
          throw new Error(`API /api/person/${personId} trả mã ${personRes.status}`);
        }
        if (!ancestorsRes.ok) {
          console.warn(`API /api/ancestors/${personId} trả mã ${ancestorsRes.status}`);
        }
        if (!descendantsRes.ok) {
          console.warn(`API /api/descendants/${personId} trả mã ${descendantsRes.status}`);
        }
        
        const person = await personRes.json();
        const ancestors = ancestorsRes.ok ? await ancestorsRes.json() : { ancestors_chain: [] };
        const descendants = descendantsRes.ok ? await descendantsRes.json() : { descendants: [] };
        
        // FALLBACK: Nếu ancestors.ancestors_chain rỗng, thử dùng person.ancestors_chain
        let ancestors_chain = ancestors.ancestors_chain || [];
        if (!ancestors_chain || ancestors_chain.length === 0) {
            ancestors_chain = person.ancestors_chain || [];
            console.log(`[PersonInfo] Using fallback ancestors_chain from /api/person, length: ${ancestors_chain.length}`);
        }
        
        let html = `
          <div style="margin-bottom: 20px;">
            <h4 style="color: #8B0000; margin-bottom: 10px; font-size: 20px;">${escapeHtml(person.full_name || '')}</h4>
            ${person.common_name ? `<p style="color: #666; margin-bottom: 5px;"><strong>Tên thường gọi:</strong> ${escapeHtml(person.common_name)}</p>` : ''}
            ${person.generation_number ? `<p style="color: #666; margin-bottom: 5px;"><strong>Đời:</strong> ${person.generation_number}</p>` : ''}
            ${person.gender ? `<p style="color: #666; margin-bottom: 5px;"><strong>Giới tính:</strong> ${escapeHtml(person.gender)}</p>` : ''}
            ${person.status ? `<p style="color: #666; margin-bottom: 5px;"><strong>Trạng thái:</strong> ${escapeHtml(person.status)}</p>` : ''}
            ${person.origin_location ? `<p style="color: #666; margin-bottom: 5px;"><strong>Nguyên quán:</strong> ${escapeHtml(person.origin_location)}</p>` : ''}
          </div>
        `;
        
        // Ancestors - Debug log
        console.log(`[PersonInfo] ancestors_chain length: ${ancestors_chain ? ancestors_chain.length : 0}`);
        if (ancestors_chain && ancestors_chain.length > 0) {
          // Filter: loại bỏ người hiện tại (dựa trên person_id) thay vì slice(0, -1)
          // Đảm bảo không bỏ sót bất kỳ tổ tiên nào
          const currentPersonId = String(person.person_id || '').trim();
          const ancestorsOnly = ancestors_chain.filter(p => {
            const pId = String(p.person_id || '').trim();
            return pId !== currentPersonId;
          });
          
          // Sắp xếp tổ tiên theo đời tăng dần (đời 1 → đời 2 → ... → đời n)
          const sortedAncestors = ancestorsOnly.sort((a, b) => {
            const genA = a.generation_number || a.generation_level || 999;
            const genB = b.generation_number || b.generation_level || 999;
            return genA - genB;
          });
          
          if (sortedAncestors.length > 0) {
            html += `
              <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                <h5 style="color: #8B0000; margin-bottom: 10px; font-size: 16px;">Tổ tiên</h5>
                <div style="font-size: 14px; line-height: 1.8;">
                  ${sortedAncestors.map(p => 
                    `<div>${escapeHtml(p.full_name)} ${p.generation_number ? `(Đời ${p.generation_number})` : (p.generation_level ? `(Đời ${p.generation_level})` : '')}</div>`
                  ).join('')}
                </div>
              </div>
            `;
          }
        }
        
        // Descendants
        if (descendants.descendants && descendants.descendants.length > 0) {
          const byDepth = {};
          descendants.descendants.forEach(d => {
            if (!byDepth[d.depth]) byDepth[d.depth] = [];
            byDepth[d.depth].push(d);
          });
          
          html += `
            <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
              <h5 style="color: #8B0000; margin-bottom: 10px; font-size: 16px;">Con cháu</h5>
              ${Object.keys(byDepth).sort((a, b) => parseInt(a) - parseInt(b)).map(depth => {
                const depthLabel = depth === '1' ? 'Con' : depth === '2' ? 'Cháu' : `Đời thứ ${depth}`;
                return `
                  <div style="margin-bottom: 10px;">
                    <strong style="color: #666; font-size: 14px;">${depthLabel}:</strong>
                    <div style="margin-left: 15px; font-size: 14px; line-height: 1.6;">
                      ${byDepth[depth].map(d => 
                        `<div>${escapeHtml(d.full_name)} ${d.generation_number ? `(Đời ${d.generation_number})` : ''}</div>`
                      ).join('')}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }
        
        infoContent.innerHTML = html;
        
        // Scroll info panel to top
        const infoPanel = document.getElementById('infoPanel');
        if (infoPanel) {
          infoPanel.scrollTop = 0;
        }
      } catch (err) {
        console.error('Error loading person info:', err);
        if (infoContent) {
          infoContent.innerHTML = `<div style="padding: 10px; color: #d32f2f;">Lỗi: ${err.message}</div>`;
        }
      }
    }
    */
  </script>

  <!-- News Feed Script -->
  <script>
    // Helper function để escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Helper function để lấy thumbnail
    function getThumbnail(activity) {
      if (activity.thumbnail) {
        return activity.thumbnail.startsWith('/') ? activity.thumbnail : `/static/images/${activity.thumbnail}`;
      }
      if (activity.images && Array.isArray(activity.images) && activity.images.length > 0) {
        const img = activity.images[0];
        return img.startsWith('/') ? img : `/static/images/${img}`;
      }
      return null; // Không có ảnh
    }

    // Helper function để cắt text
    function truncateText(text, maxLength) {
      if (!text) return '';
      if (text.length <= maxLength) return text;
      return text.substring(0, maxLength) + '...';
    }

    // Load và render news feed
    async function loadNewsFeed() {
      try {
        const response = await fetch('/api/activities?status=published&limit=100');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const activities = await response.json();
        
        if (!Array.isArray(activities) || activities.length === 0) {
          renderEmptyState();
          return;
        }

        // Render bài nổi bật (4 bài mới nhất có thumbnail)
        renderFeaturedPosts(activities);
        
        // Render tin nổi bật (7 bài mới nhất)
        renderHotNews(activities);
        
        // Render chuyên mục
        renderCategories(activities);
        
      } catch (error) {
        console.error('Error loading news feed:', error);
        renderErrorState();
      }
    }

    function renderEmptyState() {
      document.getElementById('featuredPosts').innerHTML = '<div style="text-align: center; padding: var(--space-8); color: var(--color-text-muted, #6b7280);">Chưa có bài viết</div>';
      document.getElementById('hotNewsList').innerHTML = '<li style="text-align: center; padding: var(--space-4); color: var(--color-text-muted, #6b7280);">Chưa có bài viết</li>';
      document.getElementById('categorySections').innerHTML = '<div style="text-align: center; padding: var(--space-8); color: var(--color-text-muted, #6b7280);">Chưa có bài viết</div>';
    }

    function renderErrorState() {
      document.getElementById('featuredPosts').innerHTML = '<div style="text-align: center; padding: var(--space-8); color: #ef4444;">Lỗi tải dữ liệu</div>';
      document.getElementById('hotNewsList').innerHTML = '<li style="text-align: center; padding: var(--space-4); color: #ef4444;">Lỗi tải dữ liệu</li>';
      document.getElementById('categorySections').innerHTML = '<div style="text-align: center; padding: var(--space-8); color: #ef4444;">Lỗi tải dữ liệu</div>';
    }

    function renderFeaturedPosts(activities) {
      // Chọn 4 bài có thumbnail hoặc images, ưu tiên bài mới nhất
      const withThumbnail = activities.filter(a => getThumbnail(a)).slice(0, 4);
      const featured = withThumbnail.length >= 4 ? withThumbnail : activities.slice(0, 4);
      
      const featuredHtml = featured.map(activity => {
        const thumbnail = getThumbnail(activity);
        const thumbnailHtml = thumbnail 
          ? `<img src="${escapeHtml(thumbnail)}" alt="${escapeHtml(activity.title || '')}" class="featured-post-thumbnail" onerror="this.style.display='none'">`
          : '<div class="featured-post-thumbnail" style="background: linear-gradient(135deg, #8B0000 0%, #DAA520 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px;">📰</div>';
        
        return `
          <div class="featured-post-card">
            ${thumbnailHtml}
            <div class="featured-post-content">
              <h4 class="featured-post-title">${escapeHtml(activity.title || 'Chưa có tiêu đề')}</h4>
              <p class="featured-post-summary">${escapeHtml(truncateText(activity.summary || '', 150))}</p>
              <a href="/activities/${activity.id}" class="featured-post-link">Xem tiếp ▸</a>
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('featuredPosts').innerHTML = featuredHtml || '<div style="text-align: center; padding: var(--space-8); color: var(--color-text-muted, #6b7280);">Chưa có bài viết</div>';
    }

    function renderHotNews(activities) {
      // Chọn 7 bài mới nhất
      const hotNews = activities.slice(0, 7);
      
      const hotNewsHtml = hotNews.map(activity => {
        return `
          <li class="hot-news-item">
            <a href="/activities/${activity.id}">${escapeHtml(activity.title || 'Chưa có tiêu đề')}</a>
          </li>
        `;
      }).join('');
      
      document.getElementById('hotNewsList').innerHTML = hotNewsHtml || '<li style="text-align: center; padding: var(--space-4); color: var(--color-text-muted, #6b7280);">Chưa có bài viết</li>';
    }

    function renderCategories(activities) {
      // Nhóm theo category
      const categoriesMap = {};
      
      activities.forEach(activity => {
        const category = activity.category || 'Tin tức chung';
        if (!categoriesMap[category]) {
          categoriesMap[category] = [];
        }
        categoriesMap[category].push(activity);
      });
      
      // Lọc bỏ category "Tin tức chung"
      const filteredCategories = Object.keys(categoriesMap).filter(category => category !== 'Tin tức chung');
      
      const categoriesHtml = filteredCategories.map(category => {
        const categoryActivities = categoriesMap[category];
        const mainPost = categoryActivities[0]; // Bài mới nhất
        const relatedPosts = categoryActivities.slice(1, 4); // 2-3 bài tiếp theo
        
        const thumbnail = getThumbnail(mainPost);
        const thumbnailHtml = thumbnail 
          ? `<img src="${escapeHtml(thumbnail)}" alt="${escapeHtml(mainPost.title || '')}" class="category-main-post-image" onerror="this.style.display='none'">`
          : '<div class="category-main-post-image" style="background: linear-gradient(135deg, #8B0000 0%, #DAA520 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px;">📰</div>';
        
        const relatedHtml = relatedPosts.map(post => {
          return `
            <li>
              <a href="/activities/${post.id}">${escapeHtml(post.title || 'Chưa có tiêu đề')}</a>
            </li>
          `;
        }).join('');
        
        return `
          <div class="category-section">
            <h2 class="category-title">${escapeHtml(category)}</h2>
            <div class="category-main-post">
              ${thumbnailHtml}
              <div class="category-main-post-content">
                <h4>${escapeHtml(mainPost.title || 'Chưa có tiêu đề')}</h4>
                <p>${escapeHtml(truncateText(mainPost.summary || '', 200))}</p>
                <a href="/activities/${mainPost.id}" class="category-main-post-link">Xem tiếp ▸</a>
              </div>
            </div>
            ${relatedPosts.length > 0 ? `<ul class="category-related-posts">${relatedHtml}</ul>` : ''}
          </div>
        `;
      }).join('');
      
      document.getElementById('categorySections').innerHTML = categoriesHtml || '<div style="text-align: center; padding: var(--space-8); color: var(--color-text-muted, #6b7280);">Chưa có bài viết</div>';
    }

    // Load external posts from nguyenphuoctoc.info
    async function loadExternalPosts() {
      const container = document.getElementById('externalPosts');
      if (!container) return;
      
      try {
        const response = await fetch('/api/external-posts');
        const result = await response.json();
        
        if (result.success && result.data && result.data.length > 0) {
          let html = '';
          
          result.data.forEach(post => {
            html += `
              <div class="external-post-item">
                <div class="external-post-thumbnail">
                  ${post.thumbnail ? `
                    <img src="${escapeHtml(post.thumbnail)}" alt="${escapeHtml(post.title)}" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'external-post-thumbnail-placeholder\\'>📰</div>'">
                  ` : `
                    <div class="external-post-thumbnail-placeholder">📰</div>
                  `}
                </div>
                <div class="external-post-content">
                  <h3 class="external-post-title">
                    <a href="${escapeHtml(post.link)}" target="_blank" rel="noopener noreferrer">
                      ${escapeHtml(post.title)}
                    </a>
                  </h3>
                  ${post.date ? `
                    <div class="external-post-meta">
                      <span>📅</span>
                      <span>${escapeHtml(post.date)}</span>
                    </div>
                  ` : ''}
                  ${post.description ? `
                    <p class="external-post-description">${escapeHtml(post.description)}</p>
                  ` : ''}
                  <div class="external-post-source">
                    <strong>Nguồn:</strong> 
                    <a href="https://nguyenphuoctoc.info/hoat-dong-hoi-dong-npt-vn/"
                       target="_blank"
                       rel="noopener noreferrer"
                       style="color: #8B0000; text-decoration: underline;">
                      nguyenphuoctoc.info
                    </a>
                  </div>
                </div>
              </div>
            `;
          });
          
          container.innerHTML = html;
        } else {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #6b7280;">
              Chưa có bài viết
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading external posts:', error);
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #ef4444;">
            Lỗi tải dữ liệu. Vui lòng thử lại sau.
          </div>
        `;
      }
    }

    // Touch-friendly interactions for mobile
    function initTouchFriendly() {
      if (window.DeviceDetection && window.DeviceDetection.detectDevice().isTouchDevice) {
        // Add touch-friendly class
        document.body.classList.add('touch-device');
        
        // Increase tap target sizes for buttons and links
        document.querySelectorAll('button, .btn, a.btn, .navbar-menu a, .toc-list a').forEach(el => {
          if (el.offsetHeight < 44 || el.offsetWidth < 44) {
            el.style.minHeight = '44px';
            el.style.minWidth = '44px';
            if (el.tagName === 'A' || el.classList.contains('btn')) {
              el.style.display = 'flex';
              el.style.alignItems = 'center';
              el.style.justifyContent = 'center';
            }
          }
        });
      }
    }

    // Load news feed khi DOM ready
    document.addEventListener('DOMContentLoaded', () => {
      loadNewsFeed();
      loadExternalPosts();
      initTouchFriendly();
      initTOCOverlay(); // Khởi tạo overlay với guard ghost click
    });
  </script>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h3>Phòng Tuy Biên Quận Công</h3>
          <p>Gia Phả Nguyễn Phước Tộc</p>
        </div>
        
        <div class="footer-section">
          <h3>Liên Hệ</h3>
          <ul>
            <li>
              <a href="https://www.facebook.com/PhongTuyBienQuanCong" target="_blank" rel="noopener noreferrer">
                📘 Facebook Phòng Tuy Biên Quận Công
              </a>
            </li>
          </ul>
        </div>
        
        <div class="footer-section">
          <h3>Thông Tin</h3>
          <ul>
            <li><a href="/">Trang chủ</a></li>
            <li><a href="/genealogy">Gia phả</a></li>
            <li><a href="/activities">Hoạt động</a></li>
            <li><a href="/members">Thành viên</a></li>
          </ul>
          <div style="margin-top: 20px;">
            <a href="/admin/activities" class="btn-footer-login" style="display: inline-flex; align-items: center; gap: 8px; background: #DAA520; color: #8B0000; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; font-size: 14px;">
              🔐 Đăng nhập bài đăng
            </a>
          </div>
        </div>
      </div>
      
      <!-- Countdown Section -->
      <div class="countdown-section">
        <div class="countdown-item">
          <div class="countdown-label">Giỗ Xuân 2026 (07/2 ÂL)</div>
          <div class="countdown-date">Nhằm ngày 25/03/2026</div>
          <div class="countdown-timer" id="countdown-xuan">
            <span class="countdown-value">--</span> ngày 
            <span class="countdown-value">--</span> giờ 
            <span class="countdown-value">--</span> phút 
            <span class="countdown-value">--</span> giây
          </div>
        </div>
        <div class="countdown-item">
          <div class="countdown-label">Giỗ Thu 2026 (03/7 ÂL)</div>
          <div class="countdown-date">Nhằm ngày 15/08/2026</div>
          <div class="countdown-timer" id="countdown-thu">
            <span class="countdown-value">--</span> ngày 
            <span class="countdown-value">--</span> giờ 
            <span class="countdown-value">--</span> phút 
            <span class="countdown-value">--</span> giây
          </div>
        </div>
      </div>
      
      <div class="footer-bottom">
        <p>&copy; 2025 Phòng Tuy Biên Quận Công - Gia Phả Nguyễn Phước Tộc. Tất cả quyền được bảo lưu.</p>
      </div>
    </div>
  </footer>

  <style>
    /* Footer Styles */
    .footer {
      background: linear-gradient(135deg, rgba(139, 0, 0, 0.95) 0%, rgba(220, 20, 60, 0.95) 100%);
      color: #FFD700;
      padding: 60px 0 40px;
      margin-top: 80px;
      position: relative;
      overflow: hidden;
    }

    .footer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.05) 0%, rgba(218, 165, 32, 0.05) 100%);
      pointer-events: none;
    }

    .footer .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      position: relative;
      z-index: 1;
    }

    .footer-content {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 48px;
      margin-bottom: 48px;
    }

    .footer-section h3 {
      color: #FFD700;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .footer-section p,
    .footer-section ul {
      font-size: 14px;
      line-height: 1.8;
      color: #FFD700;
    }

    .footer-section ul {
      list-style: none;
      padding: 0;
    }

    .footer-section ul li {
      margin-bottom: 12px;
    }

    .footer-section a {
      color: #FFD700;
      text-decoration: none;
      transition: all 0.3s ease;
      display: inline-block;
    }

    .footer-section a:hover {
      color: #FFFFFF;
      transform: translateX(3px);
    }

    .btn-footer-login {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .btn-footer-login:hover {
      background: #FFD700 !important;
      color: #8B0000 !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .countdown-section {
      margin: 40px 0;
      padding: 30px 0;
      border-top: 1px solid rgba(255, 215, 0, 0.3);
      border-bottom: 1px solid rgba(255, 215, 0, 0.3);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
    }
    
    .countdown-item {
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(218, 165, 32, 0.15) 100%);
      border-radius: 8px;
      border: 1px solid rgba(255, 215, 0, 0.5);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .countdown-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 215, 0, 0.2);
    }
    
    .countdown-label {
      font-size: 18px;
      font-weight: 600;
      color: #FFD700;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .countdown-date {
      font-size: 14px;
      color: #FFD700;
      margin-bottom: 15px;
    }
    
    .countdown-timer {
      font-size: 16px;
      color: #FFD700;
      font-weight: 500;
    }
    
    .countdown-value {
      color: #FFD700;
      font-weight: 700;
      font-size: 18px;
      margin: 0 4px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    @media (max-width: 768px) {
      .countdown-section {
        grid-template-columns: 1fr;
        gap: 20px;
      }
    }

    .footer-bottom {
      padding-top: 30px;
      border-top: 1px solid rgba(255, 215, 0, 0.3);
      text-align: center;
      font-size: 14px;
      color: #FFD700;
    }

    @media (max-width: 767px) {
      .footer-content {
        grid-template-columns: 1fr;
        gap: 30px;
      }
    }
  </style>

  <script>
    // Countdown timer cho Giỗ Xuân và Giỗ Thu
    function updateCountdown() {
      // Ngày Giỗ Xuân 2026: 25/03/2026
      const xuanDate = new Date('2026-03-25T00:00:00');
      // Ngày Giỗ Thu 2026: 15/08/2026
      const thuDate = new Date('2026-08-15T00:00:00');
      
      const now = new Date();
      
      // Tính toán cho Giỗ Xuân
      let xuanDiff = xuanDate - now;
      const xuanTimer = document.getElementById('countdown-xuan');
      if (xuanTimer) {
        if (xuanDiff < 0) {
          xuanTimer.innerHTML = '<span style="color: #94A3B8;">Đã qua</span>';
        } else {
          const xuanDays = Math.floor(xuanDiff / (1000 * 60 * 60 * 24));
          const xuanHours = Math.floor((xuanDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const xuanMinutes = Math.floor((xuanDiff % (1000 * 60 * 60)) / (1000 * 60));
          const xuanSeconds = Math.floor((xuanDiff % (1000 * 60)) / 1000);
          
          xuanTimer.innerHTML = `
            <span class="countdown-value">${xuanDays}</span> ngày 
            <span class="countdown-value">${xuanHours}</span> giờ 
            <span class="countdown-value">${xuanMinutes}</span> phút 
            <span class="countdown-value">${xuanSeconds}</span> giây
          `;
        }
      }
      
      // Tính toán cho Giỗ Thu
      let thuDiff = thuDate - now;
      const thuTimer = document.getElementById('countdown-thu');
      if (thuTimer) {
        if (thuDiff < 0) {
          thuTimer.innerHTML = '<span style="color: #94A3B8;">Đã qua</span>';
        } else {
          const thuDays = Math.floor(thuDiff / (1000 * 60 * 60 * 24));
          const thuHours = Math.floor((thuDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const thuMinutes = Math.floor((thuDiff % (1000 * 60 * 60)) / (1000 * 60));
          const thuSeconds = Math.floor((thuDiff % (1000 * 60)) / 1000);
          
          thuTimer.innerHTML = `
            <span class="countdown-value">${thuDays}</span> ngày 
            <span class="countdown-value">${thuHours}</span> giờ 
            <span class="countdown-value">${thuMinutes}</span> phút 
            <span class="countdown-value">${thuSeconds}</span> giây
          `;
        }
      }
    }
    
    // Cập nhật countdown mỗi giây
    updateCountdown();
    setInterval(updateCountdown, 1000);
  </script>

  <script src="/static/js/common.js"></script>
  <script>
    // Photo Carousel Functionality
    let carouselImages = [];
    let currentCarouselIndex = 0;
    let carouselInterval = null;
    
    async function loadCarousel() {
      const carouselEl = document.getElementById('photoCarousel');
      if (!carouselEl) return;
      
      try {
        // Load tất cả albums
        const albumsResponse = await fetch('/api/albums');
        const albumsData = await albumsResponse.json();
        
        if (!albumsData.success || !albumsData.albums || albumsData.albums.length === 0) {
          carouselEl.innerHTML = '<div class="carousel-loading">Chưa có album nào</div>';
          return;
        }
        
        // Chỉ tìm và hiển thị ảnh từ album "Ảnh khuôn viên"
        const khuonVienAlbum = albumsData.albums.find(album => 
          album.name && (
            album.name.toLowerCase().includes('khuôn viên') || 
            album.name.toLowerCase().includes('khuon vien') ||
            album.name.toLowerCase().includes('khuonvien')
          )
        );
        
        if (!khuonVienAlbum) {
          carouselEl.innerHTML = '<div class="carousel-loading">Không tìm thấy album "Ảnh khuôn viên"</div>';
          return;
        }
        
        // Load ảnh chỉ từ album "Ảnh khuôn viên"
        const allImages = [];
        try {
          const imagesResponse = await fetch(`/api/albums/${khuonVienAlbum.album_id}/images`);
          const imagesData = await imagesResponse.json();
          
          if (imagesData.success && imagesData.images && imagesData.images.length > 0) {
            // Lấy tất cả ảnh từ album này
            const albumImages = imagesData.images.map(img => ({
              url: img.url,
              filename: img.filename,
              albumName: khuonVienAlbum.name,
              albumTheme: khuonVienAlbum.theme
            }));
            allImages.push(...albumImages);
          } else {
            carouselEl.innerHTML = '<div class="carousel-loading">Album "Ảnh khuôn viên" chưa có ảnh</div>';
            return;
          }
        } catch (error) {
          console.error(`Error loading images for album ${khuonVienAlbum.album_id}:`, error);
          carouselEl.innerHTML = '<div class="carousel-loading">Lỗi khi tải ảnh từ album "Ảnh khuôn viên"</div>';
          return;
        }
        
        if (allImages.length === 0) {
          carouselEl.innerHTML = '<div class="carousel-loading">Chưa có ảnh nào trong albums</div>';
          return;
        }
        
        carouselImages = allImages;
        renderCarousel();
        startCarousel();
      } catch (error) {
        console.error('Error loading carousel:', error);
        carouselEl.innerHTML = '<div class="carousel-loading">Lỗi khi tải ảnh</div>';
      }
    }
    
    function renderCarousel() {
      const carouselEl = document.getElementById('photoCarousel');
      if (!carouselEl || carouselImages.length === 0) return;
      
      const html = `
        <div class="carousel-container" id="carouselContainer">
          ${carouselImages.map((img, index) => `
            <div class="carousel-slide ${index === 0 ? 'active' : ''}" data-index="${index}">
              <img src="${escapeHtml(img.url)}" alt="${escapeHtml(img.filename)}" loading="lazy">
              <div class="carousel-overlay">
                <h3>${escapeHtml(img.albumName || 'Album')}</h3>
                ${img.albumTheme ? `<p>${escapeHtml(img.albumTheme)}</p>` : ''}
              </div>
            </div>
          `).join('')}
        </div>
        <button class="carousel-nav prev" onclick="prevSlide()" aria-label="Previous slide">&#10094;</button>
        <button class="carousel-nav next" onclick="nextSlide()" aria-label="Next slide">&#10095;</button>
        <div class="carousel-indicators" id="carouselIndicators">
          ${carouselImages.map((_, index) => `
            <span class="carousel-indicator ${index === 0 ? 'active' : ''}" onclick="goToSlide(${index})" aria-label="Go to slide ${index + 1}"></span>
          `).join('')}
        </div>
      `;
      
      carouselEl.innerHTML = html;
      updateCarouselPosition();
      
      // Pause carousel on hover
      carouselEl.addEventListener('mouseenter', () => {
        if (carouselInterval) {
          clearInterval(carouselInterval);
        }
      });
      
      carouselEl.addEventListener('mouseleave', () => {
        resetCarouselInterval();
      });
    }
    
    function updateCarouselPosition() {
      const container = document.getElementById('carouselContainer');
      const indicators = document.querySelectorAll('.carousel-indicator');
      const slides = document.querySelectorAll('.carousel-slide');
      
      if (container) {
        container.style.transform = `translateX(-${currentCarouselIndex * 100}%)`;
      }
      
      // Update active slide for fade effect
      slides.forEach((slide, index) => {
        slide.classList.toggle('active', index === currentCarouselIndex);
      });
      
      // Update indicators
      indicators.forEach((indicator, index) => {
        indicator.classList.toggle('active', index === currentCarouselIndex);
      });
    }
    
    function nextSlide() {
      currentCarouselIndex = (currentCarouselIndex + 1) % carouselImages.length;
      updateCarouselPosition();
      resetCarouselInterval();
    }
    
    function prevSlide() {
      currentCarouselIndex = (currentCarouselIndex - 1 + carouselImages.length) % carouselImages.length;
      updateCarouselPosition();
      resetCarouselInterval();
    }
    
    function goToSlide(index) {
      currentCarouselIndex = index;
      updateCarouselPosition();
      resetCarouselInterval();
    }
    
    function startCarousel() {
      resetCarouselInterval();
    }
    
    function resetCarouselInterval() {
      if (carouselInterval) {
        clearInterval(carouselInterval);
      }
      carouselInterval = setInterval(() => {
        nextSlide();
      }, 6000); // Tự động chuyển slide mỗi 6 giây (tăng thời gian để người dùng xem kỹ hơn)
    }
    
    // Initialize carousel on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadCarousel();
    });
    
    async function renderAlbums(albumsList) {
      const albumsListEl = document.getElementById('albumsList');
      if (!albumsListEl) return;
      
      if (!albumsList || albumsList.length === 0) {
        albumsListEl.innerHTML = '<div class="gallery-error">Chưa có album nào. Hãy tạo album mới!</div>';
        return;
      }
      
      // Load thumbnail cho mỗi album (chỉ lấy ảnh đầu tiên)
      const albumsWithThumbnails = await Promise.all(albumsList.map(async (album) => {
        try {
          const response = await fetch(`/api/albums/${album.album_id}/images`);
          const data = await response.json();
          if (data.success && data.images && data.images.length > 0) {
            album.thumbnail = data.images[0].url; // Lấy ảnh đầu tiên làm thumbnail
            album.imageCount = data.images.length;
          } else {
            album.thumbnail = null;
            album.imageCount = 0;
          }
        } catch (error) {
          console.error(`Error loading thumbnail for album ${album.album_id}:`, error);
          album.thumbnail = null;
          album.imageCount = 0;
        }
        return album;
      }));
      
      const html = albumsWithThumbnails.map(album => {
        const isSelected = selectedAlbumId === album.album_id;
        const dateStr = album.created_at ? formatDate(album.created_at) : '';
        return `
          <div class="album-card ${isSelected ? 'selected' : ''}" data-album-id="${album.album_id}" onclick="selectAlbum(${album.album_id})">
            <div class="album-card-thumbnail">
              ${album.thumbnail ? `
                <img src="${escapeHtml(album.thumbnail)}" alt="${escapeHtml(album.name || 'Album')}" loading="lazy">
              ` : `
                <div class="album-card-thumbnail-placeholder">📷</div>
              `}
              <div class="album-card-thumbnail-overlay">
                Xem album
              </div>
            </div>
            <div class="album-card-content">
              <div class="album-card-header">
                <h4 class="album-name">${escapeHtml(album.name || 'Không có tên')}</h4>
                ${album.theme ? `<div class="album-theme">${escapeHtml(album.theme)}</div>` : ''}
              </div>
              <div class="album-card-footer">
                <div class="album-meta">
                  ${album.imageCount > 0 ? `
                    <div class="album-image-count">
                      📷 ${album.imageCount}
                    </div>
                  ` : ''}
                  ${dateStr ? `
                    <div class="album-meta-item">
                      📅 ${dateStr}
                    </div>
                  ` : ''}
                  ${album.created_by ? `
                    <div class="album-meta-item">
                      👤 ${escapeHtml(album.created_by)}
                    </div>
                  ` : ''}
                </div>
                <div class="album-card-actions" onclick="event.stopPropagation()">
                  <button class="album-card-action-btn" onclick="showUploadImagesModal(${album.album_id})" title="Upload ảnh">
                    ⬆️
                  </button>
                  <button class="album-card-action-btn" onclick="showUpdateAlbumModal(${album.album_id})" title="Cập nhật">
                    ✏️
                  </button>
                  <button class="album-card-action-btn" onclick="showDeleteAlbumConfirm(${album.album_id})" title="Xóa" style="color: var(--color-error);">
                    🗑️
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      albumsListEl.innerHTML = html;
    }
    
    function selectAlbum(albumId) {
      selectedAlbumId = albumId;
      
      // Ẩn grid albums, hiện gallery view
      const albumsGridContainer = document.querySelector('.albums-grid-container');
      const galleryView = document.getElementById('galleryView');
      
      if (albumsGridContainer) albumsGridContainer.style.display = 'none';
      if (galleryView) galleryView.style.display = 'block';
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      renderAlbums(albums);
      loadGallery();
    }
    
    function closeGalleryView() {
      selectedAlbumId = null;
      
      // Hiện grid albums, ẩn gallery view
      const albumsGridContainer = document.querySelector('.albums-grid-container');
      const galleryView = document.getElementById('galleryView');
      
      if (albumsGridContainer) albumsGridContainer.style.display = 'block';
      if (galleryView) galleryView.style.display = 'none';
      
      renderAlbums(albums);
      
      // Clear gallery
      const galleryContainer = document.getElementById('galleryContainer');
      if (galleryContainer) {
        galleryContainer.innerHTML = '';
      }
    }
    
    function showCreateAlbumModal() {
      pendingAction = 'create';
      currentAlbumEditId = null;
      document.getElementById('albumModalTitle').textContent = 'Tạo album mới';
      document.getElementById('albumNameInput').value = '';
      document.getElementById('albumThemeInput').value = '';
      document.getElementById('albumCreatedByInput').value = '';
      document.getElementById('albumError').style.display = 'none';
      showPasswordModal();
    }
    
    function showUpdateAlbumModal(albumId) {
      const album = albums.find(a => a.album_id === albumId);
      if (!album) return;
      
      pendingAction = 'update';
      currentAlbumEditId = albumId;
      document.getElementById('albumModalTitle').textContent = 'Cập nhật album';
      document.getElementById('albumNameInput').value = album.name || '';
      document.getElementById('albumThemeInput').value = album.theme || '';
      document.getElementById('albumCreatedByInput').value = album.created_by || '';
      document.getElementById('albumError').style.display = 'none';
      showPasswordModal();
    }
    
    function showDeleteAlbumConfirm(albumId) {
      const album = albums.find(a => a.album_id === albumId);
      if (!album) return;
      
      if (confirm(`Bạn có chắc chắn muốn xóa album "${album.name}"?`)) {
        pendingAction = 'delete';
        currentAlbumEditId = albumId;
        showPasswordModal();
      }
    }
    
    function showPasswordModal() {
      const modal = document.getElementById('passwordModal');
      const input = document.getElementById('passwordInput');
      const errorEl = document.getElementById('passwordError');
      
      if (modal) {
        modal.classList.add('active');
        input.value = '';
        errorEl.style.display = 'none';
        setTimeout(() => input.focus(), 100);
      }
    }
    
    function closePasswordModal() {
      const modal = document.getElementById('passwordModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }
    
    function cancelAlbumAction() {
      closeAlbumModal();
      closePasswordModal();
      resetAlbumState();
    }
    
    async function handlePasswordSubmit() {
      const input = document.getElementById('passwordInput');
      const errorEl = document.getElementById('passwordError');
      const password = input.value.trim();
      
      if (!password) {
        errorEl.textContent = 'Vui lòng nhập mật khẩu';
        errorEl.style.display = 'block';
        return;
      }
      
      try {
        authenticatedPassword = password;
        closePasswordModal();
        
        if (pendingAction === 'create') {
          showAlbumModal();
        } else if (pendingAction === 'update') {
          showAlbumModal();
        } else if (pendingAction === 'delete') {
          await deleteAlbum(currentAlbumEditId);
        }
      } catch (error) {
        errorEl.textContent = 'Mật khẩu không đúng';
        errorEl.style.display = 'block';
      }
    }
    
    function showAlbumModal() {
      const modal = document.getElementById('albumModal');
      if (modal) {
        modal.classList.add('active');
        document.getElementById('albumNameInput').focus();
      }
    }
    
    function closeAlbumModal() {
      const modal = document.getElementById('albumModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }
    
    function resetAlbumState() {
      pendingAction = null;
      currentAlbumEditId = null;
      authenticatedPassword = null;
    }
    
    async function handleAlbumSubmit() {
      const nameInput = document.getElementById('albumNameInput');
      const themeInput = document.getElementById('albumThemeInput');
      const createdByInput = document.getElementById('albumCreatedByInput');
      const errorEl = document.getElementById('albumError');
      
      const name = nameInput.value.trim();
      if (!name) {
        errorEl.textContent = 'Tên album không được để trống';
        errorEl.style.display = 'block';
        return;
      }
      
      if (!authenticatedPassword) {
        errorEl.textContent = 'Mật khẩu đã hết hạn. Vui lòng thử lại.';
        errorEl.style.display = 'block';
        closeAlbumModal();
        resetAlbumState();
        showPasswordModal();
        return;
      }
      
      if (!pendingAction || (pendingAction !== 'create' && pendingAction !== 'update')) {
        errorEl.textContent = 'Phiên làm việc đã hết hạn. Vui lòng thử lại.';
        errorEl.style.display = 'block';
        closeAlbumModal();
        resetAlbumState();
        return;
      }
      
      const data = {
        name: name,
        theme: themeInput.value.trim(),
        created_by: createdByInput.value.trim(),
        password: authenticatedPassword
      };
      
      try {
        let response;
        if (pendingAction === 'create') {
          response = await fetch('/api/albums', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else if (pendingAction === 'update') {
          response = await fetch(`/api/albums/${currentAlbumEditId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          return;
        }
        
        const result = await response.json();
        
        if (result.success) {
          const wasCreating = pendingAction === 'create';
          const newAlbumId = result.album ? result.album.album_id : null;
          const savedPassword = authenticatedPassword;
          
          closeAlbumModal();
          resetAlbumState();
          await loadAlbums();
          
          if (wasCreating && newAlbumId) {
            selectedAlbumId = newAlbumId;
            authenticatedPassword = savedPassword;
            // Hiển thị gallery view và load album mới
            const albumsGridContainer = document.querySelector('.albums-grid-container');
            const galleryView = document.getElementById('galleryView');
            if (albumsGridContainer) albumsGridContainer.style.display = 'none';
            if (galleryView) galleryView.style.display = 'block';
            await loadGallery();
            showUploadImagesModal(newAlbumId);
          }
        } else {
          if (result.error && result.error.includes('mật khẩu')) {
            errorEl.textContent = result.error;
            errorEl.style.display = 'block';
            closeAlbumModal();
            resetAlbumState();
            showPasswordModal();
          } else {
            errorEl.textContent = result.error || 'Có lỗi xảy ra';
            errorEl.style.display = 'block';
          }
        }
      } catch (error) {
        console.error('Error submitting album:', error);
        errorEl.textContent = 'Lỗi khi lưu album. Vui lòng thử lại.';
        errorEl.style.display = 'block';
      }
    }
    
    async function deleteAlbum(albumId) {
      try {
        const response = await fetch(`/api/albums/${albumId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: authenticatedPassword })
        });
        
        const result = await response.json();
        
        if (result.success) {
          if (selectedAlbumId === albumId) {
            // Nếu đang xem album bị xóa, quay lại danh sách
            closeGalleryView();
          }
          await loadAlbums();
        } else {
          alert(result.error || 'Có lỗi xảy ra khi xóa album');
        }
      } catch (error) {
        console.error('Error deleting album:', error);
        alert('Lỗi khi xóa album. Vui lòng thử lại.');
      } finally {
        pendingAction = null;
        currentAlbumEditId = null;
        authenticatedPassword = null;
      }
    }
    
    // Gallery Album Functionality
    let galleryImages = [];
    let currentLightboxIndex = 0;
    
    async function loadGallery() {
      const galleryContainer = document.getElementById('galleryContainer');
      const selectedAlbumTitle = document.getElementById('selectedAlbumTitle');
      const selectedAlbumInfo = document.getElementById('selectedAlbumInfo');
      
      if (!galleryContainer) return;
      
      if (selectedAlbumId) {
        try {
          const response = await fetch(`/api/albums/${selectedAlbumId}/images`);
          const data = await response.json();
          
          if (data.success && data.images && data.images.length > 0) {
            galleryImages = data.images.map(img => ({
              url: img.url,
              filename: img.filename
            }));
            renderGallery(galleryImages);
          } else {
            renderGallery([]);
          }
        } catch (error) {
          console.error('Error loading gallery:', error);
          galleryContainer.innerHTML = '<div class="gallery-error">Lỗi khi tải ảnh. Vui lòng thử lại sau.</div>';
        }
      }
    }
    
    function renderGallery(images) {
      const galleryContainer = document.getElementById('galleryContainer');
      const selectedAlbumTitle = document.getElementById('selectedAlbumTitle');
      const selectedAlbumInfo = document.getElementById('selectedAlbumInfo');
      
      if (!galleryContainer) return;
      
      // Hiển thị thông tin album đã chọn
      const selectedAlbum = albums.find(a => a.album_id === selectedAlbumId);
      if (selectedAlbum && selectedAlbumTitle && selectedAlbumInfo) {
        selectedAlbumTitle.textContent = selectedAlbum.name || 'Album không có tên';
        
        let infoParts = [];
        if (selectedAlbum.theme) {
          infoParts.push(`Chủ đề: ${selectedAlbum.theme}`);
        }
        if (selectedAlbum.created_by) {
          infoParts.push(`Người đăng: ${selectedAlbum.created_by}`);
        }
        infoParts.push(`Tổng cộng: ${images.length} ảnh`);
        
        selectedAlbumInfo.textContent = infoParts.join(' • ');
      }
      
      if (images.length === 0) {
        galleryContainer.innerHTML = `
          <div style="text-align: center; padding: var(--space-10); color: var(--color-text-muted);">
            <div style="font-size: 64px; margin-bottom: var(--space-4);">📷</div>
            <p style="font-size: var(--font-size-lg); margin-bottom: var(--space-2);">Album này chưa có ảnh</p>
            <p style="font-size: var(--font-size-base);">Hãy upload ảnh vào album để bắt đầu</p>
          </div>
        `;
        return;
      }
      
      const html = `
        <div class="gallery-grid">
          ${images.map((image, index) => `
            <div class="gallery-item" onclick="openLightbox(${index})">
              <img src="${escapeHtml(image.url)}" alt="${escapeHtml(image.filename)}" loading="lazy"
                   onerror="this.parentElement.style.display='none';">
              <div class="gallery-item-overlay">
                <span class="gallery-item-number">${index + 1}</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      galleryContainer.innerHTML = html;
    }
    
    function openLightbox(index) {
      currentLightboxIndex = index;
      const lightboxModal = document.getElementById('lightboxModal');
      const lightboxImage = document.getElementById('lightboxImage');
      
      if (lightboxModal && lightboxImage && galleryImages[index]) {
        lightboxImage.src = galleryImages[index].url;
        lightboxImage.alt = galleryImages[index].filename;
        lightboxModal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
    }
    
    function closeLightbox() {
      const lightboxModal = document.getElementById('lightboxModal');
      if (lightboxModal) {
        lightboxModal.classList.remove('active');
        document.body.style.overflow = '';
      }
    }
    
    function changeLightboxImage(direction) {
      if (galleryImages.length === 0) return;
      
      currentLightboxIndex += direction;
      if (currentLightboxIndex < 0) {
        currentLightboxIndex = galleryImages.length - 1;
      } else if (currentLightboxIndex >= galleryImages.length) {
        currentLightboxIndex = 0;
      }
      
      const lightboxImage = document.getElementById('lightboxImage');
      if (lightboxImage && galleryImages[currentLightboxIndex]) {
        lightboxImage.src = galleryImages[currentLightboxIndex].url;
        lightboxImage.alt = galleryImages[currentLightboxIndex].filename;
      }
    }
    
    // Upload Images Functionality
    let currentUploadAlbumId = null;
    
    function showUploadImagesModal(albumId) {
      currentUploadAlbumId = albumId;
      const modal = document.getElementById('uploadImagesModal');
      const album = albums.find(a => a.album_id === albumId);
      const title = document.getElementById('uploadImagesModalTitle');
      
      if (modal && title) {
        title.textContent = album ? `Upload ảnh vào album: ${escapeHtml(album.name)}` : 'Upload ảnh vào album';
        document.getElementById('imageFileInput').value = '';
        document.getElementById('uploadError').style.display = 'none';
        document.getElementById('uploadSuccess').style.display = 'none';
        document.getElementById('uploadProgress').style.display = 'none';
        modal.classList.add('active');
      }
    }
    
    function closeUploadImagesModal() {
      const modal = document.getElementById('uploadImagesModal');
      if (modal) {
        modal.classList.remove('active');
      }
      currentUploadAlbumId = null;
    }
    
    async function handleUploadImages() {
      const fileInput = document.getElementById('imageFileInput');
      const errorEl = document.getElementById('uploadError');
      const successEl = document.getElementById('uploadSuccess');
      const progressEl = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('uploadProgressBar');
      const progressText = document.getElementById('uploadProgressText');
      
      if (!currentUploadAlbumId) {
        errorEl.textContent = 'Không có album được chọn';
        errorEl.style.display = 'block';
        return;
      }
      
      if (!fileInput.files || fileInput.files.length === 0) {
        errorEl.textContent = 'Vui lòng chọn ít nhất một ảnh';
        errorEl.style.display = 'block';
        return;
      }
      
      if (!authenticatedPassword) {
        errorEl.textContent = 'Mật khẩu đã hết hạn. Vui lòng tạo album lại hoặc nhập mật khẩu.';
        errorEl.style.display = 'block';
        return;
      }
      
      const files = Array.from(fileInput.files);
      const totalFiles = files.length;
      let uploadedCount = 0;
      let failedCount = 0;
      
      errorEl.style.display = 'none';
      successEl.style.display = 'none';
      progressEl.style.display = 'block';
      progressBar.style.width = '0%';
      progressText.textContent = `0/${totalFiles}`;
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const formData = new FormData();
        formData.append('image', file);
        formData.append('album_id', currentUploadAlbumId);
        formData.append('password', authenticatedPassword);
        
        try {
          const response = await fetch('/api/upload-image', {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            uploadedCount++;
          } else {
            failedCount++;
            console.error(`Failed to upload ${file.name}:`, result.error);
          }
        } catch (error) {
          failedCount++;
          console.error(`Error uploading ${file.name}:`, error);
        }
        
        const progress = ((i + 1) / totalFiles) * 100;
        progressBar.style.width = `${progress}%`;
        progressText.textContent = `${i + 1}/${totalFiles}`;
      }
      
      if (uploadedCount > 0) {
        successEl.textContent = `Upload thành công ${uploadedCount} ảnh${uploadedCount > 1 ? '' : ''}`;
        if (failedCount > 0) {
          successEl.textContent += `. ${failedCount} ảnh thất bại.`;
        }
        successEl.style.display = 'block';
        
        // Reload albums và gallery sau khi upload thành công
        await loadAlbums();
        if (selectedAlbumId === currentUploadAlbumId) {
          await loadGallery();
        }
        
        setTimeout(() => {
          closeUploadImagesModal();
        }, 2000);
      } else {
        errorEl.textContent = `Không thể upload ảnh. Vui lòng thử lại.`;
        errorEl.style.display = 'block';
      }
    }
    
      // Initialize gallery on page load
      document.addEventListener('DOMContentLoaded', function() {
        const lightboxModal = document.getElementById('lightboxModal');
        if (lightboxModal) {
          lightboxModal.addEventListener('click', function(e) {
            if (e.target === lightboxModal || e.target.classList.contains('lightbox-content')) {
              closeLightbox();
            }
          });
          
          document.addEventListener('keydown', function(e) {
            if (lightboxModal.classList.contains('active')) {
              if (e.key === 'Escape') {
                closeLightbox();
              } else if (e.key === 'ArrowLeft') {
                changeLightboxImage(-1);
              } else if (e.key === 'ArrowRight') {
                changeLightboxImage(1);
              }
            }
          });
        }
        
        // Tự động load và hiển thị tất cả albums khi trang load
        loadAlbums();
      });
  </script>

</body>
</html>

