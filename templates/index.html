<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>PhÃ²ng Tuy BiÃªn Quáº­n CÃ´ng - Gia Pháº£ Nguyá»…n PhÆ°á»›c Tá»™c| Há»‡ Thá»‘ng Tra Cá»©u Gia Pháº£ Nguyá»…n PhÆ°á»›c Tá»™c</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Noto Serif TC', 'Playfair Display', serif;
      background: #ffffff;
      background-attachment: fixed;
      position: relative;
      padding-top: 70px; /* Space for fixed navbar */
    }


    /* ============================================
       NAVBAR
       ============================================ */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #111827;
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .navbar-logo {
      font-size: 24px;
      font-weight: 700;
      color: #FFD700;
      text-decoration: none;
    }

    .navbar-menu {
      display: flex;
      gap: 30px;
      list-style: none;
    }

    .navbar-menu a {
      color: white;
      text-decoration: none;
      font-size: 16px;
      font-weight: 500;
      transition: color 0.3s;
      padding: 5px 10px;
      border-radius: 4px;
    }

    .navbar-menu a:hover,
    .navbar-menu a.active {
      color: #FFD700;
      background: rgba(255, 215, 0, 0.1);
    }

    .navbar-toggle {
      display: none;
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
    }

    /* ============================================
       SECTIONS
       ============================================ */
    section {
      min-height: 100vh;
      padding: 80px 30px;
      position: relative;
    }
    
    @media (max-width: 768px) {
      section {
        padding: 40px 16px;
        min-height: auto;
      }
    }

    .section-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 60px 20px;
    }

    /* Section activities-tree Ä‘Ã£ di chuyá»ƒn sang /genealogy */
    /* #activities-tree .section-container {
      max-width: 100%;
      padding: 40px 20px;
    }

    /* ============================================
       HOME SECTION (#home)
       ============================================ */
    #home {
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(139, 0, 0, 0.95) 0%, rgba(220, 20, 60, 0.95) 100%);
      color: #FFD700;
      text-align: center;
    }

    .hero-content {
      max-width: 800px;
    }

    .hero-content h1 {
      font-size: clamp(26px, 6.5vw, 48px);
      margin-bottom: clamp(20px, 5vw, 28px);
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      color: #FFD700;
      line-height: 1.4;
      font-weight: 700;
    }

    .hero-content p {
      font-size: clamp(18px, 4.5vw, 24px);
      margin-bottom: clamp(24px, 6vw, 36px);
      line-height: 1.7;
      color: #FFD700;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
    }

    .cta-button {
      display: inline-block;
      padding: clamp(12px, 3vw, 15px) clamp(32px, 8vw, 40px);
      background: linear-gradient(135deg, #FFD700 0%, #DAA520 100%);
      color: #8B0000;
      text-decoration: none;
      border-radius: 50px;
      font-size: clamp(16px, 4vw, 18px);
      font-weight: 700;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .cta-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }

    /* ============================================
       ABOUT SECTION (#about)
       ============================================ */
    #about {
      background: linear-gradient(180deg, #FFF8DC 0%, #FFEBCD 100%);
    }

    #temple-interior {
      background: linear-gradient(180deg, #FFF8DC 0%, #FFEBCD 100%);
    }

    .section-title {
      font-size: clamp(24px, 5vw, 36px);
      color: #8B0000;
      margin-bottom: clamp(20px, 4vw, 30px);
      text-align: center;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }

    .about-content {
      display: grid;
      grid-template-columns: 1fr;
      gap: 40px;
      align-items: start;
      max-width: 1000px;
      margin: 0 auto;
    }

    .about-text {
      font-size: 18px;
      line-height: 1.8;
      color: #333;
    }

    .about-text p {
      margin-bottom: 20px;
    }

    .about-text h3 {
      color: #8B0000;
      font-size: 24px;
      font-weight: 700;
      margin-top: 30px;
      margin-bottom: 15px;
      border-bottom: 2px solid #DAA520;
      padding-bottom: 10px;
    }

    .about-text h3:first-of-type {
      margin-top: 0;
    }

    .about-text h4 {
      color: #8B0000;
      font-size: 20px;
      font-weight: 700;
      margin-top: 25px;
      margin-bottom: 12px;
      border-bottom: 2px solid #DAA520;
      padding-bottom: 8px;
    }

    .about-text blockquote {
      border-left: 4px solid #8B0000;
      padding-left: 20px;
      margin: 20px 0;
      font-style: italic;
      color: #555;
      background: #FFF8DC;
      padding: 15px 20px;
      border-radius: 4px;
    }

    .about-text ul {
      margin: 15px 0;
      padding-left: 30px;
    }

    .about-text ul li {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    .about-text strong {
      color: #8B0000;
      font-weight: 700;
    }

    .about-text em {
      color: #666;
      font-style: italic;
    }

    .about-image {
      text-align: center;
      margin: 40px 0;
    }

    .about-image img {
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }

    .about-image img:hover {
      transform: scale(1.02);
    }

    @media (max-width: 768px) {
      .about-image {
        margin: 30px 0;
      }
      
      .about-image img {
        border-radius: 8px;
      }
    }

    .about-image {
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .about-image img {
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
      border: 4px solid #DAA520;
      background: white;
      padding: 10px;
      transition: transform 0.3s;
    }

    .about-image img:hover {
      transform: scale(1.05);
    }

    @media (max-width: 768px) {
      .about-content {
        grid-template-columns: 1fr;
      }
      
      .about-image {
        order: -1;
        margin-bottom: 30px;
      }
    }

    /* ============================================
       GENEALOGY TREE SECTION - ÄÃ£ di chuyá»ƒn sang /genealogy
       ============================================ */



    /* Family Tree CSS - ÄÃ£ di chuyá»ƒn sang /genealogy */

    /* ============================================
       GENEALOGY SECTION (#genealogy)
       ============================================ */
    #genealogy {
      background: linear-gradient(180deg, #FFF8DC 0%, #FFEBCD 100%);
      padding: 80px 30px;
    }

    .genealogy-container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    /* Lineage section styles */
    .lineage-section {
      margin-top: 30px;
      padding: 30px;
      background: linear-gradient(180deg, #FFF8DC 0%, #FFEBCD 100%);
      border-top: 5px solid #DAA520;
      border-radius: 0 0 20px 20px;
    }

    .lineage-header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 3px solid #DAA520;
    }

    .lineage-header h2 {
      color: #8B0000;
      font-size: 28px;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }

    .lineage-header p {
      color: #666;
      font-size: 16px;
      font-style: italic;
    }

    .lineage-controls {
      display: flex;
      gap: 15px;
      align-items: flex-end;
      flex-wrap: wrap;
      margin-bottom: 30px;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .lineage-input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      position: relative;
    }

    .lineage-input-group label {
      font-weight: 600;
      color: #8B0000;
      font-size: 14px;
    }

    .lineage-input-group input {
      padding: 12px 18px;
      border: 2px solid #DAA520;
      border-radius: 8px;
      font-size: 16px;
      background: white;
      font-family: 'Noto Serif TC', serif;
      min-width: 200px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .lineage-input-group input:focus {
      outline: none;
      border-color: #8B0000;
      box-shadow: 0 0 10px rgba(218, 165, 32, 0.5);
    }

    .lineage-controls button {
      padding: 12px 30px;
      border: 2px solid #8B0000;
      border-radius: 8px;
      font-size: 16px;
      background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
      color: #FFD700;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      font-family: 'Noto Serif TC', serif;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      height: fit-content;
    }

    .lineage-controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
      background: linear-gradient(135deg, #DC143C 0%, #8B0000 100%);
    }

    .lineage-result {
      margin-top: 20px;
      padding: 25px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      border: 3px solid #DAA520;
    }

    .lineage-result-header h3 {
      color: #8B0000;
      font-size: 22px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #DAA520;
    }

    .lineage-result-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .lineage-item {
      padding: 15px 20px;
      margin: 4px 0;
      background: linear-gradient(180deg, #FFF8DC 0%, #FFEBCD 100%);
      border-left: 5px solid #DAA520;
      border-radius: 8px;
      transition: all 0.3s;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      cursor: pointer;
    }

    .lineage-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      border-left-color: #8B0000;
    }

    .lineage-item.current {
      background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
      border-left-color: #fbc02d;
      border-left-width: 6px;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(251, 192, 45, 0.3);
    }

    .lineage-item .generation {
      display: inline-block;
      min-width: 100px;
      padding: 8px 15px;
      background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
      color: #FFD700;
      border-radius: 20px;
      font-weight: 700;
      font-size: 14px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      margin-right: 20px;
    }

    .lineage-item.current .generation {
      background: linear-gradient(135deg, #fbc02d 0%, #f9a825 100%);
      color: #8B0000;
    }

    .lineage-item .name {
      color: #8B0000;
      font-size: 16px;
      font-weight: 600;
    }

    .lineage-item.current .name {
      font-size: 18px;
    }

    .lineage-parents {
      margin-top: 10px;
      font-size: 16px;
      color: #8B0000;
      font-style: italic;
      font-weight: 500;
      padding-left: 10px;
    }

    .lineage-parents strong {
      color: #8B0000;
      font-style: normal;
      font-weight: 700;
      font-size: 17px;
    }

    .lineage-error {
      padding: 20px;
      background: #ffebee;
      color: #c62828;
      border-radius: 8px;
      border-left: 5px solid #c62828;
      text-align: center;
      font-weight: 600;
    }

    .lineage-loading {
      padding: 20px;
      text-align: center;
      color: #8B0000;
      font-size: 16px;
    }

    .suggestions-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #DAA520;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      margin-top: 5px;
    }

    .suggestion-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }

    .suggestion-item:hover {
      background: #FFF8DC;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-item .suggestion-name {
      font-weight: 600;
      color: #8B0000;
      font-size: 15px;
    }

    .suggestion-item .suggestion-details {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
      font-weight: 400;
    }
    
    .suggestion-item {
      display: flex;
      flex-direction: column;
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-item:hover {
      background: #f9f9f9;
    }

    .lineage-detail-panel {
      margin-top: 20px;
      padding: 25px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      border: 3px solid #DAA520;
    }

    .detail-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #DAA520;
    }

    .detail-panel-header h3 {
      color: #8B0000;
      font-size: 22px;
      margin: 0;
    }

    .close-btn {
      background: #DC143C;
      color: white;
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .close-btn:hover {
      background: #8B0000;
      transform: scale(1.1);
    }

    .detail-form {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px 20px;
    }
    
    @media (max-width: 768px) {
      .detail-form {
        grid-template-columns: 1fr;
      }
    }

    .detail-form .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .detail-form .form-group label {
      font-weight: 600;
      color: #8B0000;
      font-size: 14px;
    }

    .detail-form .form-group input,
    .detail-form .form-group select,
    .detail-form .form-group textarea {
      padding: 10px;
      border: 2px solid #DAA520;
      border-radius: 6px;
      font-size: 14px;
      font-family: 'Noto Serif TC', serif;
    }

    .detail-value {
      padding: 10px;
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
      min-height: 20px;
      line-height: 1.6;
      white-space: pre-line; /* Cho phÃ©p xuá»‘ng dÃ²ng */
    }

    .btn-edit {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-edit:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4);
    }

    .detail-form .form-group input:focus,
    .detail-form .form-group select:focus,
    .detail-form .form-group textarea:focus {
      outline: none;
      border-color: #8B0000;
      box-shadow: 0 0 8px rgba(218, 165, 32, 0.3);
    }

    .form-actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .form-actions button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-save {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }

    .btn-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4);
    }

    .btn-cancel {
      background: #f5f5f5;
      color: #333;
    }

    .btn-cancel:hover {
      background: #e0e0e0;
    }

    .btn-delete {
      background: linear-gradient(135deg, #DC143C 0%, #8B0000 100%);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-delete:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(220, 20, 60, 0.4);
      background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
    }

    /* ============================================
       RESPONSIVE
       ============================================ */
    
    /* Tree section responsive */
    @media (max-width: 900px) {
      #treeControls > div {
        flex-direction: column;
        align-items: stretch;
      }
      
      #treeControls > div > div {
        min-width: 100%;
      }
      
      /* section#activities-tree Ä‘Ã£ di chuyá»ƒn sang /genealogy */
      /* section#activities-tree > div > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
      }
      
      #infoPanel {
        max-height: 400px;
        margin-top: 20px;
      }
    }
    
    @media (max-width: 768px) {
      .navbar-menu {
        position: fixed;
        top: 70px;
        left: -100%;
        width: 100%;
        background: #111827;
        flex-direction: column;
        padding: 20px;
        transition: left 0.3s;
      }

      .navbar-menu.active {
        left: 0;
      }

      .navbar-toggle {
        display: block;
      }

      .hero-content h1 {
        font-size: clamp(26px, 6.5vw, 48px);
      }
      
      .hero-content p {
        font-size: clamp(18px, 4.5vw, 24px);
      }
      
      .hero-content {
        padding: 0 16px;
      }

      .about-content {
        grid-template-columns: 1fr;
      }

      section {
        padding: 60px 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <a href="#home" class="navbar-logo">PhÃ²ng Tuy BiÃªn Quáº­n CÃ´ng</a>
    <button class="navbar-toggle" onclick="toggleMenu()">â˜°</button>
    <ul class="navbar-menu" id="navbarMenu">
      <li><a href="/" onclick="setActive(this)">Trang chá»§</a></li>
      <li><a href="/genealogy" onclick="setActive(this)">Gia pháº£</a></li>
      <li><a href="/activities">Hoáº¡t Ä‘á»™ng</a></li>
      <li><a href="/members" onclick="setActive(this)">ThÃ nh viÃªn</a></li>
      <li><a href="/contact" onclick="setActive(this)">LiÃªn há»‡</a></li>
      <li><a href="/documents" onclick="setActive(this)">TÃ i liá»‡u</a></li>
      <li><a href="/admin/login">Admin</a></li>
    </ul>
  </nav>

  <!-- Section: Home -->
  <section id="home">
    <div class="hero-content">
      <h1>Gia Pháº£ Nguyá»…n PhÆ°á»›c Tá»™c<br>Háº­u duá»‡ Vua Minh Máº¡ng<br><span style="white-space: nowrap;">Gia Pháº£ PhÃ²ng Tuy BiÃªn Quáº­n CÃ´ng</span></h1>
      <p>Nháº±m tra cá»©u, lÆ°u trá»¯ vÃ  quáº£n lÃ½ gia pháº£ dÃ²ng há» Nguyá»…n PhÆ°á»›c Tá»™c - Tuy BiÃªn PhÃ²ng Ä‘áº¿n thá»i Ä‘iá»ƒm hiá»‡n táº¡i.</p>
      <a href="/genealogy" class="cta-button">Xem Gia Pháº£</a>
    </div>
  </section>

  <!-- Section: About -->
  <section id="about">
    <div class="section-container">
      <h2 class="section-title">Giá»›i Thiá»‡u</h2>
      <div class="about-content">
        <div class="about-text">
          <h3>TUY BIÃŠN QUáº¬N CÃ”NG â€“ DÃ’NG CHáº¢Y HUY HOÃ€NG TRONG LÃ’NG NGUYá»„N PHÆ¯á»šC Tá»˜C</h3>
          
          <p>
            Trong dÃ²ng cháº£y hÃ ng trÄƒm nÄƒm cá»§a lá»‹ch sá»­ Viá»‡t Nam, triá»u Nguyá»…n hiá»‡n lÃªn nhÆ° má»™t chÆ°Æ¡ng sá»­ rá»±c rá»¡, káº¿t tinh nhá»¯ng thÃ nh tá»±u lá»›n lao vá» vÄƒn hÃ³a, thá»ƒ cháº¿ vÃ  tÆ° tÆ°á»Ÿng trá»‹ quá»‘c. Triá»u Ä‘áº¡i nÃ y Ä‘Æ°á»£c khá»Ÿi Ä‘áº§u bá»Ÿi <strong>Vua Gia Long</strong> (1802â€“1820), vá»‹ hoÃ ng Ä‘áº¿ Ä‘áº§u tiÃªn cá»§a nhÃ  Nguyá»…n, ngÆ°á»i Ä‘Ã£ thá»‘ng nháº¥t Ä‘áº¥t nÆ°á»›c vÃ  Ä‘áº·t ná»n mÃ³ng cho má»™t triá»u Ä‘áº¡i kÃ©o dÃ i hÆ¡n 140 nÄƒm.
          </p>
          
          <div class="about-image" style="text-align: center; margin: var(--space-6) 0;">
            <img src="/static/images/1. vua-gia-long.jpg" alt="Vua Gia Long" style="max-width: 100%; height: auto; border-radius: var(--radius-md); box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          </div>
          
          <p>
            Giá»¯a bá»©c tranh áº¥y, triá»u Ä‘áº¡i <strong>vua Minh Máº¡ng</strong> (trá»‹ vÃ¬ 1820â€“1841) ná»•i báº­t nhÆ° má»™t giai Ä‘oáº¡n Ä‘á»‰nh cao cá»§a sá»± cá»§ng cá»‘ vÃ  hoÃ n thiá»‡n quá»‘c gia phong kiáº¿n trung Æ°Æ¡ng táº­p quyá»n. Vá»›i táº§m nhÃ¬n xa rá»™ng vÃ  Ã½ chÃ­ sáº¯t Ä‘Ã¡, nhÃ  vua khÃ´ng chá»‰ Ä‘áº·t ná»n mÃ³ng cho má»™t bá»™ mÃ¡y hÃ nh chÃ­nh cháº·t cháº½ mÃ  cÃ²n dÃ nh tÃ¢m huyáº¿t Ä‘áº·c biá»‡t cho viá»‡c xÃ¢y dá»±ng, duy trÃ¬ vÃ  phÃ¡t triá»ƒn bá»n vá»¯ng dÃ²ng tá»™c hoÃ ng gia â€“ Nguyá»…n PhÆ°á»›c Tá»™c.
          </p>
          
          <div class="about-image" style="text-align: center; margin: var(--space-6) 0;">
            <img src="/static/images/2. vua-minh-mang.jpg" alt="Vua Minh Máº¡ng" style="max-width: 100%; height: auto; border-radius: var(--radius-md); box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          </div>
          
          <p>
            ChÃ­nh trong tinh tháº§n áº¥y, tÆ° tÆ°á»Ÿng "gá»‘c sÃ¢u thÃ¬ cÃ nh lÃ¡ má»›i bá»n vá»¯ng" Ä‘Ã£ trá»Ÿ thÃ nh kim chá»‰ nam cho má»i cáº£i cÃ¡ch cá»§a nhÃ  vua, khÃ´ng chá»‰ á»Ÿ bÃ¬nh diá»‡n quá»‘c gia mÃ  cÃ²n trong pháº¡m vi huyáº¿t thá»‘ng hoÃ ng tá»™c.
          </p>

          <h3>Tá»« Táº§m NhÃ¬n Cá»§a Vua Minh Máº¡ng Äáº¿n BÃ i ThÆ¡ "Äáº¿ Há»‡ Thi"</h3>
          
          <p>
            Vua Minh Máº¡ng khÃ´ng chá»‰ lÃ  má»™t nhÃ  chÃ­nh trá»‹ quyáº¿t Ä‘oÃ¡n mÃ  cÃ²n lÃ  má»™t há»c giáº£ uyÃªn thÃ¢m Nho há»c, tháº¥u hiá»ƒu sÃ¢u sáº¯c quy luáº­t váº­n hÃ nh cá»§a xÃ£ há»™i vÃ  gia tá»™c. Vá»›i khÃ¡t vá»ng Ä‘á»ƒ dÃ²ng dÃµi hoÃ ng gia "trÄƒm Ä‘á»i truyá»n ná»‘i, muÃ´n nÄƒm khÃ´ng dá»©t", vÃ o nÄƒm 1823, nhÃ  vua Ä‘Ã£ ngá»± soáº¡n bÃ i thÆ¡ ná»•i tiáº¿ng mang tÃªn <strong>Äáº¿ Há»‡ Thi</strong>.
          </p>
          
          <p>
            BÃ i thÆ¡ khÃ´ng Ä‘Æ¡n thuáº§n lÃ  má»™t tÃ¡c pháº©m vÄƒn chÆ°Æ¡ng, mÃ  lÃ  má»™t há»‡ thá»‘ng quy táº¯c Ä‘áº·t tÃªn mang tÃ­nh khoa há»c, cháº·t cháº½ vÃ  lÃ¢u dÃ i. Hai mÆ°Æ¡i chá»¯ trong bÃ i thÆ¡ Ä‘Æ°á»£c quy Ä‘á»‹nh lÃ m chá»¯ lÃ³t cho cÃ¡c tháº¿ há»‡ háº­u duá»‡ ká»ƒ tá»« sau vua Minh Máº¡ng, qua Ä‘Ã³ xÃ¡c láº­p tráº­t tá»± tÃ´n ti, phÃ¢n Ä‘á»‹nh rÃµ rÃ ng thá»© báº­c trong ná»™i tá»™c, trÃ¡nh sá»± nháº§m láº«n vá» vai váº¿, thÃ¢n â€“ sÆ¡ trong hoÃ ng phÃ¡i.
          </p>
          
          <blockquote>
            <strong>Bá»‘n cÃ¢u thÆ¡ ngÅ© ngÃ´n tá»© tuyá»‡t:</strong><br><br>
            <em>MiÃªn Há»“ng Æ¯ng Bá»­u VÄ©nh</em><br>
            <em>Báº£o QuÃ½ Äá»‹nh Long TrÆ°á»ng</em><br>
            <em>Hiá»n NÄƒng Khang Káº¿ Thuáº­t</em><br>
            <em>Tháº¿ Thá»¥y Quá»‘c Gia XÆ°Æ¡ng</em>
          </blockquote>
          
          <div class="about-image" style="text-align: center; margin: var(--space-6) 0;">
            <img src="/static/images/3. kim sach de he thi.jpg" alt="Kim sÃ¡ch Äáº¿ Há»‡ Thi" style="max-width: 100%; height: auto; border-radius: var(--radius-md); box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          </div>
          
          <p>
            Há»‡ thá»‘ng nÃ y Ä‘Ã£ giÃºp Nguyá»…n PhÆ°á»›c Tá»™c duy trÃ¬ Ä‘Æ°á»£c sá»± máº¡ch láº¡c, chuáº©n má»±c trong suá»‘t nhiá»u tháº¿ há»‡, Ä‘Ãºng nhÆ° lá»i vua Minh Máº¡ng tá»«ng ká»³ vá»ng: <em>"Tháº¿ thá»© rÃµ rÃ ng mÃ  khÃ´ng láº«n, thÃ¢n sÆ¡ phÃ¢n biá»‡t mÃ  ai cÅ©ng cÃ³ thá»ƒ biáº¿t."</em>
          </p>
          
          <div class="about-image" style="text-align: center; margin: var(--space-6) 0;">
            <img src="/static/images/4. kinh-thanh-hue.jpg" alt="Kinh thÃ nh Huáº¿" style="max-width: 100%; height: auto; border-radius: var(--radius-md); box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          </div>

          <h3>NgÃ i Tuy BiÃªn Quáº­n CÃ´ng â€“ Khá»Ÿi Nguá»“n Má»™t NhÃ¡nh Diá»‡p Chi</h3>
          
          <p>
            Trong há»‡ thá»‘ng tÃ´n pháº£ Ä‘á»“ sá»™ cá»§a hoÃ ng tá»™c Nguyá»…n PhÆ°á»›c, má»—i phÃ²ng há»‡ Ä‘á»u mang trong mÃ¬nh má»™t dáº¥u áº¥n riÃªng, pháº£n Ã¡nh vai trÃ², cÃ´ng Ä‘á»©c vÃ  vá»‹ tháº¿ cá»§a ngÆ°á»i khai phÃ²ng. <strong>Nguyá»…n PhÃºc MiÃªn Sá»§ng (1831â€“1865)</strong> â€“ hoÃ ng tá»­ thá»© 53 cá»§a vua Minh Máº¡ng â€“ chÃ­nh lÃ  vá»‹ khai phong cá»§a PhÃ²ng Tuy BiÃªn Quáº­n CÃ´ng, má»Ÿ Ä‘áº§u cho má»™t nhÃ¡nh diá»‡p chi Ä‘á»™c láº­p, cÃ³ danh xÆ°ng, quy Æ°á»›c vÃ  truyá»n thá»‘ng riÃªng trong Ä‘áº¡i gia Ä‘Ã¬nh Nguyá»…n PhÆ°á»›c.
          </p>
          
          <p>
            NgÃ i sinh ngÃ y mÃ¹ng 8 thÃ¡ng 4 nÄƒm TÃ¢n MÃ£o (1831), lÃ  trÆ°á»Ÿng nam cá»§a Lá»¥c giai Tiá»‡p dÆ° Nguyá»…n Thá»‹ ViÃªn â€“ má»™t phi táº§n ná»•i tiáº¿ng Ä‘oan trang, tiáº¿t háº¡nh trong ná»™i Ä‘Ã¬nh. Ngay tá»« thuá»Ÿ thiáº¿u thá»i, hoÃ ng tá»­ MiÃªn Sá»§ng Ä‘Ã£ Ä‘Æ°á»£c nuÃ´i dáº¡y theo khuÃ´n phÃ©p nghiÃªm cáº©n cá»§a hoÃ ng gia, sá»›m bá»™c lá»™ tÆ° cháº¥t Ä‘iá»m Ä‘áº¡m, cáº©n trá»ng, hiáº¿u há»c vÃ  trá»ng lá»… nghi. Trong sinh hoáº¡t thÆ°á»ng nháº­t cÅ©ng nhÆ° há»c táº­p, ngÃ i luÃ´n giá»¯ phong thÃ¡i má»±c thÆ°á»›c, khÃ´ng phÃ´ trÆ°Æ¡ng, khÃ´ng thiÃªn lá»‡ch, Ä‘Ãºng vá»›i chuáº©n má»±c cá»§a má»™t báº­c vÆ°Æ¡ng tÃ´n Ä‘Æ°á»£c ká»³ vá»ng lÃ¢u dÃ i.
          </p>
          
          <p>
            NÄƒm Canh TÃ½ (1840), dÆ°á»›i triá»u vua Minh Máº¡ng, ngÃ i Ä‘Æ°á»£c sÃ¡ch phong <strong>Tuy NhÃ¢n Quáº­n CÃ´ng</strong> â€“ má»™t tÆ°á»›c hiá»‡u thá»ƒ hiá»‡n sá»± tÃ­n nhiá»‡m cá»§a triá»u Ä‘Ã¬nh Ä‘á»‘i vá»›i pháº©m háº¡nh vÃ  tÆ° cháº¥t cá»§a hoÃ ng tá»­. Tuy nhiÃªn, Ä‘áº¿n nÄƒm NhÃ¢m Dáº§n (1842), dÆ°á»›i triá»u vua Thiá»‡u Trá»‹, do chá»¯ "NhÃ¢n" trÃ¹ng vá»›i thá»¥y hiá»‡u cá»§a TiÃªn Ä‘áº¿ Minh Máº¡ng, triá»u Ä‘Ã¬nh Ä‘Ã£ chuáº©n y cáº£i phong tÆ°á»›c hiá»‡u thÃ nh <strong>Tuy BiÃªn Quáº­n CÃ´ng</strong>. Tá»« Ä‘Ã¢y, danh xÆ°ng Tuy BiÃªn chÃ­nh thá»©c gáº¯n liá»n vá»›i ngÃ i vÃ  trá»Ÿ thÃ nh Ä‘á»‹nh danh vÄ©nh viá»…n cá»§a toÃ n bá»™ háº­u duá»‡ phÃ²ng há»‡.
          </p>
          
          <p>
            TrÃªn phÆ°Æ¡ng diá»‡n tÃ´n tháº¥t, Tuy BiÃªn Quáº­n CÃ´ng Nguyá»…n PhÃºc MiÃªn Sá»§ng khÃ´ng chá»‰ lÃ  má»™t hoÃ ng tá»­ Ä‘Æ°á»£c phong tÆ°á»›c, mÃ  cÃ²n lÃ  ngÆ°á»i Ä‘áº·t ná»n mÃ³ng tá»• chá»©c cho má»™t phÃ²ng há»‡ hoÃ n chá»‰nh: tá»« nghi lá»… thá» tá»±, quy Æ°á»›c ná»™i phÃ²ng, Ä‘áº¿n tráº­t tá»± xÆ°ng danh cá»§a háº­u duá»‡. DÃ¹ khÃ´ng ná»•i báº­t trÃªn chÃ­nh trÆ°á»ng hay quÃ¢n vá»¥, ngÃ i Ä‘Æ°á»£c ghi nháº­n lÃ  báº­c hoÃ ng thÃ¢n láº¥y Ä‘á»©c lÃ m gá»‘c, giá»¯ trÃ²n bá»•n pháº­n vá»›i triá»u Ä‘Ã¬nh, hÃ²a má»¥c vá»›i tÃ´n tháº¥t, vÃ  nÃªu gÆ°Æ¡ng chuáº©n má»±c cho con chÃ¡u.
          </p>
          
          <p>
            NÄƒm áº¤t Sá»­u (1865), ngÃ i qua Ä‘á»i, hÆ°á»Ÿng dÆ°Æ¡ng 35 tuá»•i. Triá»u Ä‘Ã¬nh truy ban thá»¥y hiá»‡u <strong>Cáº©n Má»¥c</strong> â€“ má»™t thá»¥y hiá»‡u mang Ã½ nghÄ©a sÃ¢u sáº¯c:
          </p>
          
          <ul>
            <li><strong>"Cáº©n":</strong> cáº©n trá»ng, nghiÃªm tÃºc, giá»¯ lá»… khÃ´ng sai lá»‡ch</li>
            <li><strong>"Má»¥c":</strong> nhu hÃ²a, Ä‘Ã´n háº­u, láº¥y Ä‘á»©c Ä‘á»ƒ cáº£m hÃ³a</li>
          </ul>
          
          <p>
            Sau khi ngÃ i máº¥t, táº©m má»™ vÃ  phá»§ thá» cá»§a Tuy BiÃªn Quáº­n CÃ´ng trá»Ÿ thÃ nh nÆ¡i con chÃ¡u cÃ¡c Ä‘á»i vá» phá»¥ng táº¿, tÆ°á»Ÿng niá»‡m, khÃ´ng chá»‰ nhÆ° má»™t vá»‹ tá»• khai phÃ²ng, mÃ  cÃ²n nhÆ° biá»ƒu tÆ°á»£ng cá»§a náº¿p nhÃ  láº¥y lá»… â€“ Ä‘á»©c â€“ ká»· cÆ°Æ¡ng lÃ m trá»ng.
          </p>
          
          <p>
            Äá»ƒ Ä‘á»‹nh danh rÃµ rÃ ng vÃ  táº¡o sá»± thá»‘ng nháº¥t cho háº­u duá»‡ phÃ²ng Tuy BiÃªn, vua Minh Máº¡ng Ä‘Ã£ ban riÃªng bá»™ chá»¯ <strong>"Phong" (é¢¨ â€“ nghÄ©a lÃ  giÃ³)</strong> lÃ m chá»¯ lÃ³t Ä‘áº·t tÃªn cho cÃ¡c cÃ´ng tá»­ trong phÃ²ng. Viá»‡c ban chá»¯ nÃ y khÃ´ng chá»‰ mang Ã½ nghÄ©a quáº£n lÃ½ tÃ´n pháº£, mÃ  cÃ²n hÃ m chá»©a tÆ° tÆ°á»Ÿng biá»ƒu trÆ°ng: "Phong" â€“ giÃ³ tuy vÃ´ hÃ¬nh nhÆ°ng lan tá»a bá»n bá»‰, má»m máº¡i mÃ  khÃ´ng suy, linh hoáº¡t mÃ  váº«n cÃ³ quy luáº­t.
          </p>
          
          <p>
            ChÃ­nh tá»« Ä‘Ã¢y, PhÃ²ng Tuy BiÃªn Quáº­n CÃ´ng Ä‘Æ°á»£c xÃ¡c láº­p nhÆ° má»™t nhÃ¡nh diá»‡p chi riÃªng biá»‡t, cÃ³:
          </p>
          
          <ul>
            <li>Tá»• khai phÃ²ng rÃµ rÃ ng</li>
            <li>TÆ°á»›c há»‡ á»•n Ä‘á»‹nh</li>
            <li>Quy Æ°á»›c Ä‘áº·t tÃªn Ä‘áº·c thÃ¹</li>
            <li>Truyá»n thá»‘ng gia phong xuyÃªn suá»‘t qua nhiá»u tháº¿ há»‡</li>
          </ul>
          
          <p>
            Trong Ä‘áº¡i tá»™c Nguyá»…n PhÆ°á»›c, Tuy BiÃªn Quáº­n CÃ´ng Nguyá»…n PhÃºc MiÃªn Sá»§ng vÃ¬ tháº¿ khÃ´ng chá»‰ Ä‘Æ°á»£c nhá»› Ä‘áº¿n vá»›i tÆ° cÃ¡ch má»™t hoÃ ng tá»­, mÃ  cÃ²n lÃ  ngÆ°á»i Ä‘áº·t ná»n mÃ³ng cho má»™t dÃ²ng háº­u duá»‡ cÃ³ cÄƒn cÆ¡, danh pháº­n vÃ  báº£n sáº¯c riÃªng, gÃ³p pháº§n lÃ m phong phÃº vÃ  bá»n vá»¯ng cho cáº¥u trÃºc toÃ n thá»ƒ cá»§a hoÃ ng tá»™c triá»u Nguyá»…n.
          </p>

          <h3>Phá»¥ Há»‡ vÃ  Tá»• Há»‡ cá»§a Tuy BiÃªn Quáº­n CÃ´ng Nguyá»…n PhÃºc MiÃªn Sá»§ng</h3>
          
          <p>
            Vá» phá»¥ há»‡ trá»±c tiáº¿p, Tuy BiÃªn Quáº­n CÃ´ng Nguyá»…n PhÃºc MiÃªn Sá»§ng xuáº¥t thÃ¢n tá»« dÃ²ng chÃ­nh thá»‘ng cá»§a hoÃ ng tá»™c triá»u Nguyá»…n, káº¿ thá»«a liÃªn tá»¥c tá»« cÃ¡c Ä‘á»i chÃºa Nguyá»…n Ä‘áº¿n hoÃ ng Ä‘áº¿ khai sÃ¡ng vÆ°Æ¡ng triá»u.
          </p>
          
          <p>
            <strong>Cha cá»§a ngÃ i lÃ  vua Minh Máº¡ng</strong> â€“ Nguyá»…n PhÃºc Äáº£m (é˜®ç¦è†½, 1791â€“1841), vá»‹ hoÃ ng Ä‘áº¿ thá»© hai cá»§a triá»u Nguyá»…n, trá»‹ vÃ¬ tá»« nÄƒm 1820 Ä‘áº¿n 1841. Minh Máº¡ng hoÃ ng Ä‘áº¿ ná»•i tiáº¿ng lÃ  báº­c minh quÃ¢n cÃ³ táº§m nhÃ¬n sÃ¢u rá»™ng, cá»§ng cá»‘ ná»n hÃ nh chÃ­nh trung Æ°Æ¡ng táº­p quyá»n, hoÃ n chá»‰nh thá»ƒ cháº¿ quá»‘c gia vÃ  Ä‘áº·c biá»‡t chÃº trá»ng viá»‡c Ä‘á»‹nh danh, sáº¯p xáº¿p vÃ  quáº£n lÃ½ tÃ´n tháº¥t. <strong>Máº¹ cá»§a Tuy BiÃªn Quáº­n CÃ´ng lÃ  Lá»¥c giai Tiá»‡p dÆ° Nguyá»…n Thá»‹ ViÃªn</strong>, ngÆ°á»i Ä‘Æ°á»£c ghi nháº­n vá»›i Ä‘á»©c háº¡nh Ä‘oan trang, ná» náº¿p, gÃ³p pháº§n hÃ¬nh thÃ nh nhÃ¢n cÃ¡ch cáº©n trá»ng vÃ  khuÃ´n phÃ©p cá»§a hoÃ ng tá»­ MiÃªn Sá»§ng.
          </p>
          
          <p>
            <strong>Ã”ng ná»™i cá»§a ngÃ i lÃ  vua Gia Long</strong> â€“ Nguyá»…n PhÃºc Ãnh (é˜®ç¦æš, 1762â€“1820), vá»‹ hoÃ ng Ä‘áº¿ khai sÃ¡ng triá»u Nguyá»…n, trá»‹ vÃ¬ tá»« nÄƒm 1802 Ä‘áº¿n 1820. Gia Long lÃ  ngÆ°á»i thá»‘ng nháº¥t sÆ¡n hÃ  sau nhiá»u tháº­p niÃªn binh biáº¿n, Ä‘áº·t ná»n mÃ³ng cho triá»u Ä‘áº¡i kÃ©o dÃ i hÆ¡n má»™t tháº¿ ká»· trong lá»‹ch sá»­ Viá»‡t Nam.
          </p>
          
          <p>
            LÃªn má»™t Ä‘á»i ná»¯a, <strong>Ã´ng cá»‘ cá»§a ngÃ i lÃ  Nguyá»…n PhÃºc LuÃ¢n</strong> (é˜®ç¦ã«», 1733â€“1765), Ä‘Æ°á»£c tÃ´n xÆ°ng lÃ  Äá»©c HÆ°ng Tá»•. DÃ¹ khÃ´ng trá»±c tiáº¿p trá»‹ vÃ¬, Nguyá»…n PhÃºc LuÃ¢n giá»¯ vai trÃ² Ä‘áº·c biá»‡t quan trá»ng trong viá»‡c truyá»n thá»«a chÃ­nh thá»‘ng cá»§a dÃ²ng chÃºa Nguyá»…n, lÃ  thÃ¢n phá»¥ cá»§a vua Gia Long.
          </p>
          
          <p>
            TrÆ°á»›c Ä‘Ã³, <strong>Ã´ng sÆ¡ cá»§a ngÃ i lÃ  Nguyá»…n PhÃºc KhoÃ¡t</strong> (é˜®ç¦æ¿¶, 1714â€“1765), Ä‘Æ°á»£c tÃ´n hiá»‡u VÅ© VÆ°Æ¡ng (æ­¦ç‹), trá»‹ vÃ¬ ÄÃ ng Trong tá»« nÄƒm 1738 Ä‘áº¿n 1765. Thá»i ká»³ cá»§a VÅ© VÆ°Æ¡ng Ä‘Ã¡nh dáº¥u sá»± phÃ¡t triá»ƒn á»•n Ä‘á»‹nh vá» chÃ­nh trá»‹, vÄƒn hÃ³a vÃ  lá»… cháº¿, Ä‘áº·t tiá»n Ä‘á» cho viá»‡c hÃ¬nh thÃ nh vÆ°Æ¡ng quyá»n vá» sau.
          </p>
          
          <h4>Tá»• TiÃªn DÃ²ng ChÃºa Nguyá»…n vÃ  Cao Tá»• Äáº¡i Tá»™c</h4>
          
          <p>
            Tá»« Nguyá»…n PhÃºc KhoÃ¡t trá»Ÿ ngÆ°á»£c lÃªn, Tuy BiÃªn Quáº­n CÃ´ng Nguyá»…n PhÃºc MiÃªn Sá»§ng thuá»™c vá» chuá»—i truyá»n thá»«a liÃªn tá»¥c cá»§a cÃ¡c Ä‘á»i chÃºa Nguyá»…n, báº¯t Ä‘áº§u tá»« thá»i Nguyá»…n HoÃ ng vÃ o Thuáº­n HÃ³a:
          </p>
          
          <ul>
            <li><strong>Nguyá»…n PhÃºc Thá»¥</strong> (1697â€“1738) â€“ Ninh VÆ°Æ¡ng (å¯§ç‹), trá»‹ vÃ¬ giai Ä‘oáº¡n 1725â€“1738</li>
            <li><strong>Nguyá»…n PhÃºc Chu</strong> (é˜®ç¦æ·, 1675â€“1725) â€“ ChÃºa Minh, ngÆ°á»i má»Ÿ mang vÄƒn hÃ³a, Pháº­t giÃ¡o vÃ  giÃ¡o dá»¥c ÄÃ ng Trong</li>
            <li><strong>Nguyá»…n PhÃºc ThÃ¡i</strong> (é˜®ç¦æº™, 1649â€“1691) â€“ ChÃºa NghÄ©a</li>
            <li><strong>Nguyá»…n PhÃºc Táº§n</strong> (é˜®ç¦ç€•, 1620â€“1687) â€“ ChÃºa Hiá»n, cá»§ng cá»‘ quÃ¢n sá»± vÃ  phÃ²ng thá»§ phÆ°Æ¡ng Nam</li>
            <li><strong>Nguyá»…n PhÃºc Lan</strong> (é˜®ç¦ç€¾, 1601â€“1648) â€“ ChÃºa ThÆ°á»£ng (ä¸Šç‹)</li>
            <li><strong>Nguyá»…n PhÃºc NguyÃªn</strong> (é˜®ç¦æº, 1563â€“1635) â€“ ChÃºa SÃ£i, ngÆ°á»i Ä‘áº·t ná»n mÃ³ng cai trá»‹ á»•n Ä‘á»‹nh táº¡i Thuáº­n â€“ Quáº£ng</li>
            <li><strong>Nguyá»…n HoÃ ng</strong> (é˜®æ½¢, 1525â€“1613) â€“ ChÃºa TiÃªn, vá»‹ tá»• khai sÃ¡ng cÆ¡ nghiá»‡p cÃ¡c chÃºa Nguyá»…n táº¡i ÄÃ ng Trong</li>
          </ul>
          
          <p>
            TrÆ°á»›c thá»i cÃ¡c chÃºa Nguyá»…n, dÃ²ng há» tiáº¿p tá»¥c ná»‘i dÃ i qua cÃ¡c báº­c cÃ´ng tháº§n vÃ  danh tÆ°á»›ng thá»i LÃª â€“ Tráº§n, tiÃªu biá»ƒu nhÆ°:
          </p>
          
          <ul>
            <li><strong>Nguyá»…n Kim</strong> (é˜®æ·¦, 1468â€“1545) â€“ Triá»‡u Tá»•, ngÆ°á»i trung hÆ°ng nhÃ  LÃª</li>
            <li><strong>Nguyá»…n VÄƒn Lá»±u</strong> (é˜®æ–‡æºœ) â€“ Trá»«ng Quá»‘c CÃ´ng</li>
            <li><strong>Nguyá»…n NhÆ° TrÃ¡c</strong> (é˜®å¦‚ç¢) â€“ PhÃ³ Quá»‘c CÃ´ng</li>
            <li><strong>Nguyá»…n CÃ´ng Duáº©n</strong> (é˜®å…¬ç¬‹) â€“ ThÃ¡i Báº£o Hoáº±ng Quá»‘c CÃ´ng</li>
            <li><strong>Nguyá»…n Sá»«</strong> (é˜®å„²) â€“ ChiÃªu Quang Háº§u</li>
            <li><strong>Nguyá»…n ChiÃªm</strong> (é˜®ä½”) â€“ Quáº£n Ná»™i</li>
            <li><strong>Nguyá»…n Biá»‡n</strong> (é˜®å¿­) â€“ Phá»¥ Äáº¡o Huá»‡ Quá»‘c CÃ´ng</li>
          </ul>
          
          <p>
            Xa hÆ¡n ná»¯a, tá»• há»‡ cá»§a dÃ²ng Nguyá»…n PhÆ°á»›c Ä‘Æ°á»£c truy nguyÃªn Ä‘áº¿n cÃ¡c nhÃ¢n váº­t thá»i Tráº§n â€“ Äinh:
          </p>
          
          <ul>
            <li><strong>Nguyá»…n Minh Du</strong> (é˜®æ˜ä¿, 1330â€“1390) â€“ Du Cáº§n CÃ´ng</li>
            <li><strong>Nguyá»…n CÃ´ng Luáº­t</strong> (é˜®å…¬å¾‹) â€“ Há»¯u Hiá»ƒu Äiá»ƒm</li>
            <li><strong>Nguyá»…n Náº¡p Hoa</strong> (é˜®ç´å’Œ) â€“ BÃ¬nh Man Äáº¡i TÆ°á»›ng QuÃ¢n</li>
            <li><strong>Nguyá»…n Tháº¿ Tá»©</strong> (é˜®ä¸–è³œ) â€“ ÄÃ´ Hiá»‡u Kiá»ƒm</li>
            <li><strong>Nguyá»…n Ná»™n</strong> (é˜®å«©) â€“ HoÃ i Äáº¡o Hiáº¿u VÅ© VÆ°Æ¡ng</li>
            <li><strong>Nguyá»…n Phá»¥ng</strong> (é˜®å¥‰) â€“ Táº£ ÄÃ´ Äá»‘c</li>
            <li><strong>Nguyá»…n Viá»…n</strong> (é˜®é ) â€“ Táº£ Quá»‘c CÃ´ng</li>
            <li><strong>Nguyá»…n ÄÃª</strong> (é˜®ä½) â€“ Äá»©c ÄÃ´ Hiá»‡u Kiá»ƒm</li>
          </ul>
          
          <p>
            Khá»Ÿi nguyÃªn cá»§a toÃ n bá»™ dÃ²ng tá»™c lÃ  <strong>Nguyá»…n Báº·c</strong> (é˜®åŒ, 924â€“979) â€“ Äá»©c Äá»‹nh Quá»‘c CÃ´ng, khai quá»‘c cÃ´ng tháº§n triá»u Äinh, ngÆ°á»i Ä‘Æ°á»£c tÃ´n lÃ m Thá»§y tá»• cá»§a Ä‘áº¡i tá»™c Nguyá»…n, tá»« Ä‘Ã³ má»Ÿ ra dÃ²ng truyá»n thá»«a kÃ©o dÃ i hÆ¡n má»™t thiÃªn niÃªn ká»· trong lá»‹ch sá»­ Viá»‡t Nam.
          </p>

          <h3>Sá»‘ HÃ³a Gia Pháº£ â€“ Káº¿t Ná»‘i QuÃ¡ Khá»© Äáº¿n TÆ°Æ¡ng Lai</h3>
          
          <p>
            Tráº£i qua bao biáº¿n thiÃªn cá»§a lá»‹ch sá»­, con chÃ¡u PhÃ²ng Tuy BiÃªn Quáº­n CÃ´ng ngÃ y nay Ä‘Ã£ táº£n cÆ°, sinh sá»‘ng vÃ  láº­p nghiá»‡p á»Ÿ nhiá»u vÃ¹ng miá»n trong nÆ°á»›c cÅ©ng nhÆ° kháº¯p nÄƒm chÃ¢u. Trong bá»‘i cáº£nh áº¥y, viá»‡c báº£o tá»“n nhá»¯ng trang <strong>Ngá»c pháº£</strong>, vá»‘n Ä‘Æ°á»£c lÆ°u giá»¯ báº±ng kim sÃ¡ch hoáº·c báº£n in giáº¥y truyá»n thá»‘ng, Ä‘ang Ä‘á»‘i máº·t vá»›i thÃ¡ch thá»©c lá»›n tá»« thá»i gian, mÃ´i trÆ°á»ng vÃ  sá»± Ä‘á»©t gÃ£y tháº¿ há»‡.
          </p>
          
          <p>
            Xuáº¥t phÃ¡t tá»« nháº­n thá»©c Ä‘Ã³, <strong>dá»± Ã¡n xÃ¢y dá»±ng há»‡ thá»‘ng tra cá»©u gia pháº£ Ä‘iá»‡n tá»­</strong> Ä‘Æ°á»£c hÃ¬nh thÃ nh nhÆ° má»™t nhá»‹p cáº§u hiá»‡n Ä‘áº¡i, káº¿t ná»‘i quÃ¡ khá»© hÃ o hÃ¹ng vá»›i tÆ°Æ¡ng lai bá»n vá»¯ng. Dá»± Ã¡n mang láº¡i nhá»¯ng giÃ¡ trá»‹ cá»‘t lÃµi:
          </p>
          
          <ul>
            <li><strong>Báº£o tá»“n vÄ©nh cá»­u:</strong> ToÃ n bá»™ dá»¯ liá»‡u tháº¿ pháº£ Ä‘Æ°á»£c chuyá»ƒn Ä‘á»•i sang Ä‘á»‹nh dáº¡ng sá»‘, giáº£m thiá»ƒu tá»‘i Ä‘a nguy cÆ¡ mai má»™t, tháº¥t láº¡c hay hÆ° há»ng theo nÄƒm thÃ¡ng.</li>
            <li><strong>Tra cá»©u thuáº­n tiá»‡n:</strong> Con chÃ¡u dÃ¹ á»Ÿ báº¥t cá»© nÆ¡i Ä‘Ã¢u cÅ©ng cÃ³ thá»ƒ dá»… dÃ ng tÃ¬m hiá»ƒu vá» nguá»“n gá»‘c, vai thá»© vÃ  hÃ nh tráº¡ng cá»§a tá»• tiÃªn; tá»« Ä‘Ã³ hiá»ƒu rÃµ Ã½ nghÄ©a cÃ¡c chá»¯ lÃ³t nhÆ° <em>MiÃªn, Há»“ng, Æ¯ng, Bá»­uâ€¦</em> trong chÃ­nh tÃªn gá»i cá»§a mÃ¬nh.</li>
            <li><strong>Káº¿t ná»‘i huyáº¿t thá»‘ng:</strong> Há»‡ thá»‘ng táº¡o ra má»™t khÃ´ng gian chung Ä‘á»ƒ cÃ¡c thÃ nh viÃªn trong dÃ²ng há» giao lÆ°u, chia sáº», há»— trá»£ láº«n nhau, gÃ³p pháº§n tháº¯t cháº·t tÃ¬nh cá»‘t nhá»¥c â€“ giÃ¡ trá»‹ ná»n táº£ng cá»§a Nguyá»…n PhÆ°á»›c Tá»™c.</li>
            <li><strong>LÆ°u trá»¯ bá»n vá»¯ng:</strong> ThÃ´ng tin vá» cÃ¡c tháº¿ há»‡ má»›i Ä‘Æ°á»£c cáº­p nháº­t liÃªn tá»¥c, báº£o Ä‘áº£m dÃ²ng cháº£y cá»§a PhÃ²ng Tuy BiÃªn Quáº­n CÃ´ng luÃ´n Ä‘Æ°á»£c ghi chÃ©p Ä‘áº§y Ä‘á»§, liá»n máº¡ch cho mai sau.</li>
          </ul>

          <h3>Káº¿t Tá»«</h3>
          
          <p>
            Sá»© má»‡nh cá»§a con chÃ¡u hÃ´m nay khÃ´ng chá»‰ dá»«ng láº¡i á»Ÿ niá»m tá»± hÃ o vá» quÃ¡ khá»©, mÃ  cÃ²n lÃ  trÃ¡ch nhiá»‡m gÃ¬n giá»¯ vÃ  tiáº¿p ná»‘i niá»m tá»± hÃ o áº¥y trong ká»· nguyÃªn sá»‘. Há»‡ thá»‘ng gia pháº£ Ä‘iá»‡n tá»­ chÃ­nh lÃ  <strong>nÃ©n tÃ¢m nhang hiá»‡n Ä‘áº¡i</strong> mÃ  tháº¿ há»‡ hÃ´m nay kÃ­nh dÃ¢ng lÃªn ngÃ i Tuy BiÃªn Quáº­n CÃ´ng vÃ  Ä‘á»©c ThÃ¡nh Tá»• Minh Máº¡ng â€“ má»™t lá»i kháº³ng Ä‘á»‹nh vá»¯ng cháº¯c ráº±ng:
          </p>
          
          <blockquote>
            <strong>Gá»‘c cÃ³ sÃ¢u thÃ¬ chÃ­ má»›i vá»¯ng, chÃ­ cÃ³ vá»¯ng thÃ¬ cÃ nh lÃ¡ má»›i sum suÃª, xanh tá»‘t muÃ´n Ä‘á»i.</strong>
          </blockquote>
          
          <div class="about-image" style="text-align: center; margin: var(--space-6) 0;">
            <img src="/static/images/5. phu-tuy-bien.jpg" alt="Phá»§ Tuy BiÃªn" style="max-width: 100%; height: auto; border-radius: var(--radius-md); box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          </div>
          
          <!-- Google Maps -->
          <div class="about-map" style="text-align: center; margin: var(--space-6) 0;">
            <iframe 
              src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3826.8494473948927!2d107.59601731485532!3d16.49516058864719!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3141a0c29d9b7599%3A0xe46d1cf33efaad01!2zUGjDsm5nIFR1eSBCacOqbiBRdeG6rW4gQ8O0bmc!5e0!3m2!1svi!2s!4v1736438400000!5m2!1svi!2s&output=embed" 
              width="100%" 
              height="450" 
              style="border:0; border-radius: var(--radius-md); box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 100%;" 
              allowfullscreen="" 
              loading="lazy" 
              referrerpolicy="no-referrer-when-downgrade"
              title="Báº£n Ä‘á»“ PhÃ²ng Tuy BiÃªn Quáº­n CÃ´ng">
            </iframe>
          </div>
          
          <p style="margin-top: 30px; font-style: italic; color: #666; border-top: 1px solid #ddd; padding-top: 20px;">
            <em>ThÃ´ng tin trong bÃ i viáº¿t Ä‘Æ°á»£c tá»•ng há»£p vÃ  Ä‘á»‘i chiáº¿u tá»« cÃ¡c sá»­ liá»‡u triá»u Nguyá»…n vÃ  tháº¿ pháº£ Nguyá»…n PhÆ°á»›c Tá»™c.</em>
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Section: Temple Interior -->
  <section id="temple-interior">
    <div class="section-container">
      <h2 class="section-title">HÃ¬nh áº¢nh BÃªn Trong NhÃ  Thá»</h2>
      <div class="about-content">
        <div class="about-text">
          <p>
            BÃªn trong nhÃ  thá» PhÃ²ng Tuy BiÃªn Quáº­n CÃ´ng, nÆ¡i thá» tá»± trang nghiÃªm vá»›i nhá»¯ng hoÃ nh phi vÃ  cÃ¢u Ä‘á»‘i mang Ä‘áº­m giÃ¡ trá»‹ vÄƒn hÃ³a truyá»n thá»‘ng. CÃ¡c vÄƒn tá»± HÃ¡n cá»• khÃ´ng chá»‰ lÃ  trang trÃ­ mÃ  cÃ²n chá»©a Ä‘á»±ng nhá»¯ng Ã½ nghÄ©a sÃ¢u sáº¯c vá» cÃ´ng Ä‘á»©c, phÃºc thá» vÃ  sá»± káº¿ thá»«a cá»§a dÃ²ng tá»™c.
          </p>
          
          <div class="about-image" style="text-align: center; margin: var(--space-6) 0;">
            <img src="/static/images/6. trong nha tho.jpg" alt="HÃ¬nh áº£nh bÃªn trong nhÃ  thá» PhÃ²ng Tuy BiÃªn Quáº­n CÃ´ng" style="max-width: 100%; height: auto; border-radius: var(--radius-md); box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          </div>

          <h3 style="font-size: clamp(18px, 5vw, 24px);">1ï¸âƒ£ HoÃ nh phi á»Ÿ chÃ­nh giá»¯a (phÃ­a trÃªn)</h3>
          
          <div style="background: #f8f5f0; padding: clamp(16px, 4vw, 20px); border-radius: 8px; margin: clamp(16px, 4vw, 20px) 0; border-left: 4px solid #d8b45c;">
            <p style="font-size: clamp(20px, 6vw, 32px); font-weight: bold; text-align: center; margin-bottom: clamp(12px, 3vw, 15px); color: #8B4513;">
              ğŸ“œ ç¹¼è¿°éƒ¡å…¬ç¥ 
            </p>
            
            <p style="font-size: clamp(14px, 4vw, 16px);"><strong>Äá»c HÃ¡nâ€“Viá»‡t:</strong> Káº¿ Thuáº­t Quáº­n CÃ´ng Tá»«</p>
            
            <p style="font-size: clamp(14px, 4vw, 16px);"><strong>Ã nghÄ©a:</strong></p>
            <ul style="margin-left: clamp(16px, 4vw, 20px); line-height: 1.8; font-size: clamp(13px, 3.5vw, 15px);">
              <li><strong>ç¹¼è¿° (Káº¿ thuáº­t):</strong> ná»‘i tiáº¿p, káº¿ thá»«a cÃ´ng Ä‘á»©c â€“ sá»± nghiá»‡p cá»§a tiá»n nhÃ¢n</li>
              <li><strong>éƒ¡å…¬ (Quáº­n cÃ´ng):</strong> tÆ°á»›c vá»‹ quÃ½ tá»™c cao (thÆ°á»ng phong cho cÃ´ng tháº§n, hoÃ ng thÃ¢n)</li>
              <li><strong>ç¥  (Tá»«):</strong> Ä‘á»n thá», tá»« Ä‘Æ°á»ng</li>
            </ul>
            
            <p style="margin-top: clamp(12px, 3vw, 15px); padding: clamp(12px, 3vw, 15px); background: #fff; border-radius: 5px; border: 1px solid #d8b45c; font-size: clamp(13px, 3.5vw, 15px);">
              <strong>ğŸ‘‰ ToÃ n bá»™ cÃ³ thá»ƒ hiá»ƒu lÃ :</strong><br>
              "Äá»n thá» Quáº­n CÃ´ng â€“ nÆ¡i káº¿ thá»«a vÃ  tÃ´n vinh cÃ´ng Ä‘á»©c cá»§a báº­c tiá»n nhÃ¢n."
            </p>
          </div>

          <h3 style="font-size: clamp(18px, 5vw, 24px);">2ï¸âƒ£ CÃ¢u Ä‘á»‘i bÃªn trÃ¡i (nhÃ¬n tá»« ngoÃ i vÃ o)</h3>
          
          <div style="background: #f8f5f0; padding: clamp(16px, 4vw, 20px); border-radius: 8px; margin: clamp(16px, 4vw, 20px) 0; border-left: 4px solid #d8b45c;">
            <p style="font-size: clamp(18px, 5vw, 28px); font-weight: bold; text-align: center; margin-bottom: clamp(12px, 3vw, 15px); color: #8B4513;">
              ğŸ“œ ä¹å‹³é‡æ›¸å»¶å®šå–œè‚‡ç‹èŠå­£
            </p>
            
            <p style="font-size: clamp(14px, 4vw, 16px);"><strong>Äáº·c Ä‘iá»ƒm:</strong></p>
            <ul style="margin-left: clamp(16px, 4vw, 20px); line-height: 1.8; font-size: clamp(13px, 3.5vw, 15px);">
              <li>LÃ  cÃ¢u Ä‘á»‘i HÃ¡n vÄƒn cá»•, bá»‘ cá»¥c dá»c</li>
              <li>CÃ³ cÃ¡c tá»« khÃ³a mang tÃ­nh vinh danh â€“ phÃºc thá» â€“ dÃ²ng tá»™c</li>
            </ul>
            
            <p style="font-size: clamp(14px, 4vw, 16px);"><strong>PhÃ¢n tÃ­ch Ã½ nghÄ©a (theo cá»¥m):</strong></p>
            <ul style="margin-left: clamp(16px, 4vw, 20px); line-height: 1.8; font-size: clamp(13px, 3.5vw, 15px);">
              <li><strong>ä¹å‹³:</strong> chÃ­n cÃ´ng lao lá»›n (Ã¡m chá»‰ Ä‘áº¡i cÃ´ng tháº§n)</li>
              <li><strong>é‡æ›¸:</strong> ghi chÃ©p, lÆ°u danh nhiá»u láº§n</li>
              <li><strong>å»¶å®š:</strong> kÃ©o dÃ i sá»± á»•n Ä‘á»‹nh, bá»n vá»¯ng</li>
              <li><strong>å–œè‚‡:</strong> khá»Ÿi Ä‘áº§u tá»‘t lÃ nh</li>
              <li><strong>ç‹èŠå­£:</strong> tÃªn hÃºy / phÃ¡p danh / thá»¥y hiá»‡u cá»§a nhÃ¢n váº­t Ä‘Æ°á»£c thá» (thÆ°á»ng khÃ´ng dá»‹ch nghÄ©a)</li>
            </ul>
            
            <p style="margin-top: clamp(12px, 3vw, 15px); padding: clamp(12px, 3vw, 15px); background: #fff; border-radius: 5px; border: 1px solid #d8b45c; font-size: clamp(13px, 3.5vw, 15px);">
              <strong>ğŸ‘‰ Ã chung:</strong><br>
              Ca ngá»£i cÃ´ng lao lá»›n, lÆ°u danh muÃ´n Ä‘á»i, mang láº¡i ná»n táº£ng á»•n Ä‘á»‹nh vÃ  khá»Ÿi Ä‘áº§u cÃ¡t tÆ°á»ng cho dÃ²ng tá»™c.
            </p>
          </div>

          <h3 style="font-size: clamp(18px, 5vw, 24px);">3ï¸âƒ£ CÃ¢u Ä‘á»‘i bÃªn pháº£i</h3>
          
          <div style="background: #f8f5f0; padding: clamp(16px, 4vw, 20px); border-radius: 8px; margin: clamp(16px, 4vw, 20px) 0; border-left: 4px solid #d8b45c;">
            <p style="font-size: clamp(18px, 5vw, 28px); font-weight: bold; text-align: center; margin-bottom: clamp(12px, 3vw, 15px); color: #8B4513;">
              ğŸ“œ åœ‹é‹æ˜Œéš†å£½ç¦åˆæ…¶è¬å¹´
            </p>
            
            <p style="font-size: clamp(14px, 4vw, 16px);"><strong>Äá»c HÃ¡nâ€“Viá»‡t:</strong> Quá»‘c váº­n xÆ°Æ¡ng long, thá» phÃºc há»£p khÃ¡nh váº¡n niÃªn</p>
            
            <p style="font-size: clamp(14px, 4vw, 16px);"><strong>Ã nghÄ©a tá»«ng pháº§n:</strong></p>
            <ul style="margin-left: clamp(16px, 4vw, 20px); line-height: 1.8; font-size: clamp(13px, 3.5vw, 15px);">
              <li><strong>åœ‹é‹æ˜Œéš†:</strong> váº­n nÆ°á»›c hÆ°ng thá»‹nh</li>
              <li><strong>å£½ç¦:</strong> trÆ°á»ng thá» vÃ  phÃºc Ä‘á»©c</li>
              <li><strong>åˆæ…¶:</strong> há»™i tá»¥ Ä‘iá»u lÃ nh</li>
              <li><strong>è¬å¹´:</strong> muÃ´n nÄƒm</li>
            </ul>
            
            <p style="margin-top: clamp(12px, 3vw, 15px); padding: clamp(12px, 3vw, 15px); background: #fff; border-radius: 5px; border: 1px solid #d8b45c; font-size: clamp(13px, 3.5vw, 15px);">
              <strong>ğŸ‘‰ CÃ¢u nÃ y mang Ã½ nghÄ©a chÃºc tá»¥ng ráº¥t rÃµ:</strong><br>
              "Váº­n nÆ°á»›c hÆ°ng thá»‹nh, phÃºc thá» viÃªn mÃ£n, cÃ¡t khÃ¡nh há»™i tá»¥ muÃ´n Ä‘á»i."
            </p>
          </div>

          <h3 style="font-size: clamp(18px, 5vw, 24px);">4ï¸âƒ£ Tá»•ng thá»ƒ phong cÃ¡ch chá»¯ & ngá»¯ cáº£nh</h3>
          
          <p style="font-size: clamp(14px, 4vw, 16px);">Chá»¯ viáº¿t lÃ  HÃ¡n tá»± truyá»n thá»‘ng, thÆ°á»ng dÃ¹ng trong:</p>
          <ul style="margin-left: clamp(16px, 4vw, 20px); line-height: 1.8; font-size: clamp(13px, 3.5vw, 15px);">
            <li>Äá»n thá»</li>
            <li>Tá»« Ä‘Æ°á»ng</li>
            <li>Miáº¿u thá» cÃ´ng tháº§n, tá»• tiÃªn</li>
            <li>VÄƒn phong trang trá»ng â€“ Ä‘iá»ƒn cháº¿ â€“ tÃ´n vinh</li>
          </ul>
          
          <p style="font-size: clamp(14px, 4vw, 16px);">KhÃ´ng pháº£i chá»¯ Trung Quá»‘c hiá»‡n Ä‘áº¡i, mÃ  lÃ  <strong>HÃ¡n vÄƒn cá»•</strong> dÃ¹ng trong vÄƒn hÃ³a Viá»‡t â€“ Hoa â€“ Nho giÃ¡o.</p>

          <h3 style="font-size: clamp(18px, 5vw, 24px);">Nháº­n Ä‘á»‹nh chung</h3>
          
          <div style="background: #fff5e6; padding: clamp(16px, 4vw, 20px); border-radius: 8px; margin: clamp(16px, 4vw, 20px) 0; border: 2px solid #d8b45c;">
            <p style="font-size: clamp(14px, 4vw, 16px);">ÄÃ¢y khÃ´ng pháº£i cÃ¢u chá»¯ trang trÃ­ ngáº«u nhiÃªn. Ná»™i dung cho tháº¥y:</p>
            <ul style="margin-left: clamp(16px, 4vw, 20px); line-height: 1.8; font-size: clamp(13px, 3.5vw, 15px);">
              <li>Thá» nhÃ¢n váº­t cÃ³ tÆ°á»›c vá»‹ cao (Quáº­n CÃ´ng)</li>
              <li>Nháº¥n máº¡nh cÃ´ng lao â€“ phÃºc Ä‘á»©c â€“ dÃ²ng tá»™c â€“ váº­n nÆ°á»›c</li>
              <li>Bá»‘ cá»¥c chuáº©n má»±c cá»§a tá»« Ä‘Æ°á»ng / cÃ´ng tháº§n miáº¿u</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Section: Interactive Genealogy Tree -->
  <!-- Section: CÃ¢y Gia Pháº£ TÆ°Æ¡ng TÃ¡c - ÄÃ£ di chuyá»ƒn sang /genealogy -->


  <!-- Section: Genealogy - ÄÃ£ di chuyá»ƒn sang /genealogy -->


  <!-- Scripts -->
  <script>
    // Navbar functionality
    function toggleMenu() {
      const menu = document.getElementById('navbarMenu');
      if (menu) {
        menu.classList.toggle('active');
      }
    }

    function setActive(element) {
      if (!element) return;
      
      // Remove active from all links
      document.querySelectorAll('.navbar-menu a').forEach(link => {
        if (link) {
          link.classList.remove('active');
        }
      });
      // Add active to clicked link
      element.classList.add('active');
      // Close mobile menu
      const navbarMenu = document.getElementById('navbarMenu');
      if (navbarMenu) {
        navbarMenu.classList.remove('active');
      }
    }

    // Set active on scroll
    window.addEventListener('scroll', () => {
      const sections = ['home', 'about', 'temple-interior', 'genealogy', 'login'];
      const scrollPos = window.scrollY + 100;

      sections.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) {
          const top = section.offsetTop;
          const bottom = top + section.offsetHeight;
          
          if (scrollPos >= top && scrollPos < bottom) {
            document.querySelectorAll('.navbar-menu a').forEach(link => {
              if (link) {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${sectionId}`) {
                  link.classList.add('active');
                }
              }
            });
          }
        }
      });
    });

    // ============================================
    // LINEAGE SEARCH FUNCTIONALITY
    // ============================================
    
    let personsDataForLineage = [];
    let selectedPerson = null;
    let searchTimeout = null;
    let isEditMode = false;

    /**
     * Xá»­ lÃ½ khi ngÆ°á»i dÃ¹ng gÃµ vÃ o Ã´ tÃ¬m kiáº¿m (autocomplete)
     */
    function handleLineageSearchInput() {
      const nameInput = document.getElementById('lineageName');
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      
      if (!nameInput || !suggestionsDiv) {
        console.warn('[Lineage] Required elements not found for search input');
        return;
      }
      
      const query = nameInput.value.trim();
      
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
      
      if (!query || query.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
      }
      
      searchTimeout = setTimeout(async () => {
        try {
          // Use new API /api/search
          const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=10`);
          
          if (!response.ok) {
            suggestionsDiv.style.display = 'none';
            return;
          }
          
          const results = await response.json();
          
          if (results.length === 0) {
            suggestionsDiv.innerHTML = '<div class="suggestion-item" style="color: #999; font-style: italic;">KhÃ´ng tÃ¬m tháº¥y káº¿t quáº£</div>';
            suggestionsDiv.style.display = 'block';
            return;
          }
          
          // Display suggestions with full format
          suggestionsDiv.innerHTML = results.map((person) => {
            const gen = person.generation_level || person.generation_number || '?';
            const name = person.full_name || 'KhÃ´ng rÃµ tÃªn';
            const fatherName = person.father_name || '';
            const motherName = person.mother_name || '';
            
            // Format parent info (khÃ´ng dÃ¹ng <em>)
            let parentInfo = '';
            if (fatherName && motherName) {
              parentInfo = `Con cá»§a: Ã”ng ${escapeHtml(fatherName)} & BÃ  ${escapeHtml(motherName)}`;
            } else if (fatherName) {
              parentInfo = `Con cá»§a: Ã”ng ${escapeHtml(fatherName)}`;
            } else if (motherName) {
              parentInfo = `Con cá»§a: BÃ  ${escapeHtml(motherName)}`;
            } else {
              parentInfo = 'ChÆ°a cÃ³ thÃ´ng tin cha máº¹';
            }
            
            // Add FM_ID indicator if available to help distinguish duplicates
            const fmIdDisplay = person.father_mother_id || person.fm_id ? ` <span style="color: #999; font-size: 12px;">(FM: ${escapeHtml(person.father_mother_id || person.fm_id)})</span>` : '';
            
            return `
              <div class="suggestion-item" onclick="selectSuggestionFromSearch('${person.person_id}')" style="cursor: pointer; padding: 12px; border-bottom: 1px solid #eee;">
                <div class="suggestion-name" style="font-weight: 600; color: #7b1a1a; font-size: 16px; margin-bottom: 4px;">
                  ${escapeHtml(name)} â€“ Äá»i ${gen}${fmIdDisplay}
                </div>
                <div class="suggestion-details" style="color: #666; font-size: 14px;">
                  ${parentInfo}
                </div>
              </div>
            `;
          }).join('');
          
          suggestionsDiv.style.display = 'block';
        } catch (err) {
          console.error('Error in autocomplete:', err);
          suggestionsDiv.style.display = 'none';
        }
      }, 300);
    }

    /**
     * Chá»n má»™t suggestion
     * @param {number} personId - ID duy nháº¥t cá»§a Person (báº¯t buá»™c dÃ¹ng personId, khÃ´ng dÃ¹ng tÃªn/Ä‘á»i)
     */
    function selectSuggestion(personId) {
      const nameInput = document.getElementById('lineageName');
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      
      if (!nameInput || !suggestionsDiv) {
        console.warn('[Lineage] Required elements not found for suggestion selection');
        return;
      }
      
      suggestionsDiv.style.display = 'none';
      
      // DÃ¹ng personId Ä‘á»ƒ tÃ¬m Ä‘Ãºng Person (khÃ´ng dá»±a vÃ o tÃªn/Ä‘á»i vÃ¬ cÃ³ thá»ƒ trÃ¹ng)
      const allPersons = window.GenealogyLineage.getAllPersons();
      const person = allPersons.find(p => p.person_id === personId);
      
      if (!person) {
        console.error(`[Lineage] KhÃ´ng tÃ¬m tháº¥y Person vá»›i person_id: ${personId}`);
        alert(`KhÃ´ng tÃ¬m tháº¥y ngÆ°á»i vá»›i ID: ${personId}`);
        return;
      }
      
      // Cáº­p nháº­t input vá»›i tÃªn cá»§a ngÆ°á»i Ä‘Æ°á»£c chá»n
      if (nameInput) {
        nameInput.value = person.full_name;
      }
      
      // LÆ°u selectedPerson vÃ  hiá»ƒn thá»‹
      selectedPerson = person;
      displayLineageForPerson(person);
      showDetailPanel(person);
    }

    /**
     * Hiá»ƒn thá»‹ chuá»—i pháº£ há»‡ cho má»™t Person
     */
    function displayLineageForPerson(person) {
      const resultDiv = document.getElementById('lineageResult');
      const resultContent = document.getElementById('lineageResultContent');
      const resultTitle = document.getElementById('lineageResultTitle');
      
      if (!person) {
        resultDiv.style.display = 'none';
        return;
      }
      
      try {
        // DÃ¹ng personId Ä‘á»ƒ Ä‘áº£m báº£o chá»n Ä‘Ãºng ngÆ°á»i (khÃ´ng dá»±a vÃ o tÃªn/Ä‘á»i vÃ¬ cÃ³ thá»ƒ trÃ¹ng)
        // Náº¿u buildCompleteLineage há»— trá»£ personId, dÃ¹ng trá»±c tiáº¿p
        // Náº¿u khÃ´ng, dÃ¹ng tÃªn + Ä‘á»i + tÃªn bá»‘ Ä‘á»ƒ phÃ¢n giáº£i chÃ­nh xÃ¡c
        let lineage;
        if (window.GenealogyLineage.buildCompleteLineageById) {
          lineage = window.GenealogyLineage.buildCompleteLineageById(person.person_id);
        } else {
          // Fallback: dÃ¹ng tÃªn + Ä‘á»i + tÃªn bá»‘ Ä‘á»ƒ tÃ¬m chÃ­nh xÃ¡c
          const foundPerson = window.GenealogyLineage.findPersonById 
            ? window.GenealogyLineage.findPersonById(person.person_id)
            : window.GenealogyLineage.findPerson(person.full_name, person.generation_number, person.father_name);
          
          if (!foundPerson) {
            resultContent.innerHTML = `<div class="lineage-error">âŒ KhÃ´ng tÃ¬m tháº¥y ngÆ°á»i vá»›i ID: ${person.person_id}</div>`;
            resultTitle.textContent = 'Lá»—i';
            resultDiv.style.display = 'block';
            return;
          }
          
          lineage = window.GenealogyLineage.buildCompleteLineage(foundPerson.full_name, foundPerson.generation_number, foundPerson.father_name);
        }
        
        if (!lineage || lineage.length === 0) {
          resultContent.innerHTML = `<div class="lineage-error">âŒ KhÃ´ng thá»ƒ xÃ¢y dá»±ng chuá»—i pháº£ há»‡ cho "${person.full_name}" (ID: ${person.person_id})</div>`;
          resultTitle.textContent = 'Lá»—i';
          resultDiv.style.display = 'block';
          return;
        }
        
        // TÃ­nh sá»‘ ngÆ°á»i bao gá»“m cáº£ máº¹/vá»£
        const uniquePersons = new Set();
        lineage.forEach(p => {
          // ThÃªm ngÆ°á»i chÃ­nh vÃ o set (dÃ¹ng person_id hoáº·c key)
          const key = p.person_id ? `id_${p.person_id}` : `${p.full_name}|${p.generation_number}`;
          uniquePersons.add(key);
          
          // ThÃªm máº¹ náº¿u cÃ³
          if (p.mother_name) {
            const motherKey = `${p.mother_name}|${(p.generation_number || 0) - 1}`;
            uniquePersons.add(motherKey);
          }
          
          // ThÃªm vá»£/chá»“ng náº¿u cÃ³ (tá»« marriages)
          if (p.marriages && Array.isArray(p.marriages)) {
            p.marriages.forEach(marriage => {
              if (marriage.spouse_name) {
                const spouseKey = `${marriage.spouse_name}|${p.generation_number}`;
                uniquePersons.add(spouseKey);
              }
            });
          }
        });
        
        const html = window.GenealogyLineage.formatAsHTMLWithParents(lineage);
        resultContent.innerHTML = html;
        resultTitle.textContent = `Chuá»—i pháº£ há»‡ cá»§a ${person.full_name} (Äá»i ${person.generation_number}) - ${uniquePersons.size} ngÆ°á»i`;
        resultDiv.style.display = 'block';
        
        if (resultContent) {
          resultContent.querySelectorAll('.lineage-item').forEach(item => {
            if (item) {
              item.style.cursor = 'pointer';
              item.addEventListener('click', () => {
                const personId = item.getAttribute('data-person-id'); // Giá»¯ nguyÃªn string
                const allPersons = window.GenealogyLineage.getAllPersons();
                const clickedPerson = allPersons.find(p => p.person_id === personId);
                if (clickedPerson) {
                  showDetailPanel(clickedPerson);
                }
              });
            }
          });
        }
        
      } catch (error) {
        console.error('Lá»—i khi hiá»ƒn thá»‹ lineage:', error);
        resultContent.innerHTML = `<div class="lineage-error">âŒ Lá»—i: ${error.message}</div>`;
        resultTitle.textContent = 'Lá»—i';
        resultDiv.style.display = 'block';
      }
    }

    /**
     * TÃ¬m kiáº¿m vÃ  hiá»ƒn thá»‹ chuá»—i pháº£ há»‡
     */
    async function searchLineage() {
      const nameInput = document.getElementById('lineageName');
      
      if (!nameInput) {
        console.error('[Lineage] lineageName input not found');
        alert('Lá»—i: KhÃ´ng tÃ¬m tháº¥y Ã´ nháº­p liá»‡u');
        return;
      }
      
      const name = nameInput.value.trim();
      
      if (!name) {
        alert('Vui lÃ²ng nháº­p tÃªn hoáº·c chá»n tá»« danh sÃ¡ch gá»£i Ã½');
        return;
      }
      
      // Hide suggestions
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      if (suggestionsDiv) {
        suggestionsDiv.style.display = 'none';
      }
      
      try {
        // Use new API /api/search
        const response = await fetch(`/api/search?q=${encodeURIComponent(name)}&limit=20`);
        
        if (!response.ok) {
          throw new Error(`API tráº£ mÃ£ ${response.status}`);
        }
        
        const results = await response.json();
        
        if (results.length === 0) {
          alert(`KhÃ´ng tÃ¬m tháº¥y "${name}"`);
          return;
        }
        
        // Náº¿u cÃ³ nhiá»u káº¿t quáº£ trÃ¹ng tÃªn, hiá»ƒn thá»‹ suggestion Ä‘á»ƒ ngÆ°á»i dÃ¹ng chá»n
        if (results.length > 1) {
          // Hiá»ƒn thá»‹ suggestions Ä‘á»ƒ ngÆ°á»i dÃ¹ng chá»n
          if (suggestionsDiv) {
            suggestionsDiv.innerHTML = results.map((person) => {
              const gen = person.generation_level || person.generation_number || '?';
              const name = person.full_name || 'KhÃ´ng rÃµ tÃªn';
              const fatherName = person.father_name || '';
              const motherName = person.mother_name || '';
              
              // Format parent info (khÃ´ng dÃ¹ng <em>)
              let parentInfo = '';
              if (fatherName && motherName) {
                parentInfo = `Con cá»§a: Ã”ng ${escapeHtml(fatherName)} & BÃ  ${escapeHtml(motherName)}`;
              } else if (fatherName) {
                parentInfo = `Con cá»§a: Ã”ng ${escapeHtml(fatherName)}`;
              } else if (motherName) {
                parentInfo = `Con cá»§a: BÃ  ${escapeHtml(motherName)}`;
              } else {
                parentInfo = 'ChÆ°a cÃ³ thÃ´ng tin cha máº¹';
              }
              
              // Add FM_ID indicator if available to help distinguish duplicates
              const fmIdDisplay = person.father_mother_id || person.fm_id ? ` <span style="color: #999; font-size: 12px;">(FM: ${escapeHtml(person.father_mother_id || person.fm_id)})</span>` : '';
              
              return `
                <div class="suggestion-item" onclick="selectSuggestionFromSearch('${person.person_id}')" style="cursor: pointer; padding: 12px; border-bottom: 1px solid #eee;">
                  <div class="suggestion-name" style="font-weight: 600; color: #7b1a1a; font-size: 16px; margin-bottom: 4px;">
                    ${escapeHtml(name)} â€“ Äá»i ${gen}${fmIdDisplay}
                  </div>
                  <div class="suggestion-details" style="color: #666; font-size: 14px;">
                    ${parentInfo}
                  </div>
                </div>
              `;
            }).join('');
            suggestionsDiv.style.display = 'block';
          }
          return;
        }
        
        // Chá»‰ cÃ³ 1 káº¿t quáº£, tá»± Ä‘á»™ng chá»n
        const person = results[0];
        await displayLineageForPersonFromAPI(person.person_id);
      } catch (err) {
        console.error('Error searching lineage:', err);
        alert(`Lá»—i khi tÃ¬m kiáº¿m: ${err.message}`);
      }
    }
    
    /**
     * Select suggestion from search results
     */
    async function selectSuggestionFromSearch(personId) {
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      if (suggestionsDiv) {
        suggestionsDiv.style.display = 'none';
      }
      
      await displayLineageForPersonFromAPI(personId);
    }
    
    /**
     * Display lineage for person using API
     */
    async function displayLineageForPersonFromAPI(personId) {
      try {
        console.log(`[Lineage] Fetching lineage for person_id: ${personId}`);
        
        // Fetch ancestors API (includes person info)
        const ancestorsRes = await fetch(`/api/ancestors/${personId}`);
        
        if (!ancestorsRes.ok) {
          throw new Error(`API /api/ancestors/${personId} tráº£ mÃ£ ${ancestorsRes.status}`);
        }
        
        const ancestorsData = await ancestorsRes.json();
        console.log('[Lineage] Ancestors API response:', ancestorsData);
        
        // Build lineage chain: ancestors_chain + current person (avoid duplicates)
        let lineage = [];
        
        if (ancestorsData.ancestors_chain && Array.isArray(ancestorsData.ancestors_chain)) {
          lineage = ancestorsData.ancestors_chain;
        }
        
        // Add current person to lineage only if not already in ancestors_chain
        if (ancestorsData.person) {
          const currentPersonId = String(ancestorsData.person.person_id || '').trim();
          // Check with normalized comparison
          const alreadyInChain = lineage.some(p => {
            const pId = String(p.person_id || '').trim();
            return pId === currentPersonId && pId !== '';
          });
          
          if (!alreadyInChain && currentPersonId) {
            lineage.push(ancestorsData.person);
            console.log(`[Lineage] Added current person ${currentPersonId} to lineage`);
          } else {
            console.log(`[Lineage] Person ${currentPersonId} already in ancestors_chain, skipping duplicate`);
          }
        }
        
        console.log(`[Lineage] Built lineage chain with ${lineage.length} generations`);
        console.log('[Lineage] Lineage data:', lineage);
        
        // Display lineage with beautiful timeline (will remove duplicates again)
        displayLineageChain(lineage);
        
        // Show detail panel (fetch full person details)
        try {
          const personRes = await fetch(`/api/person/${personId}`);
          if (personRes.ok) {
            const person = await personRes.json();
            selectedPerson = person;
            showDetailPanel(person);
          }
        } catch (err) {
          console.warn('[Lineage] Could not fetch full person details:', err);
          // Use person from ancestors API (cÃ³ thá»ƒ thiáº¿u má»™t sá»‘ thÃ´ng tin nhÆ°ng váº«n hiá»ƒn thá»‹ Ä‘Æ°á»£c)
          if (ancestorsData.person) {
            selectedPerson = ancestorsData.person;
            showDetailPanel(ancestorsData.person);
          } else {
            // Náº¿u khÃ´ng cÃ³ dá»¯ liá»‡u tá»« ancestors API, hiá»ƒn thá»‹ lá»—i
            const resultDiv = document.getElementById('lineageResult');
            const resultContent = document.getElementById('lineageResultContent');
            const resultTitle = document.getElementById('lineageResultTitle');
            if (resultDiv && resultContent) {
              resultContent.innerHTML = `<div class="lineage-error" style="padding: 20px; color: #d32f2f;">âŒ KhÃ´ng thá»ƒ táº£i thÃ´ng tin chi tiáº¿t cho ngÆ°á»i nÃ y (ID: ${personId})</div>`;
              if (resultTitle) {
                resultTitle.textContent = 'Lá»—i';
              }
              resultDiv.style.display = 'block';
            }
          }
        }
      } catch (err) {
        console.error('Error displaying lineage:', err);
        // Hiá»ƒn thá»‹ lá»—i thÃ¢n thiá»‡n hÆ¡n
        const errorMessage = err.message || 'KhÃ´ng xÃ¡c Ä‘á»‹nh';
        if (errorMessage.includes('404') || errorMessage.includes('not found')) {
          alert(`KhÃ´ng tÃ¬m tháº¥y ngÆ°á»i vá»›i ID: ${personId}\n\nVui lÃ²ng kiá»ƒm tra láº¡i dá»¯ liá»‡u.`);
        } else if (errorMessage.includes('500')) {
          alert(`Lá»—i server khi táº£i dá»¯ liá»‡u.\n\nVui lÃ²ng thá»­ láº¡i sau hoáº·c liÃªn há»‡ quáº£n trá»‹ viÃªn.\n\nChi tiáº¿t: ${errorMessage}`);
        } else {
          alert(`Lá»—i khi hiá»ƒn thá»‹ chuá»—i pháº£ há»‡: ${errorMessage}`);
        }
      }
    }
    
    /**
     * Normalize parent names for display
     */
    function normalizeParentName(name, isFather = true) {
      if (!name) return null;
      // Remove common prefixes
      name = name.replace(/^(Ã”ng|BÃ |Vua)\s+/i, '').trim();
      return name;
    }
    
    /**
     * Get standardized parents for Generation 1 (Vua Minh Máº¡ng)
     */
    function getGen1Parents() {
      return {
        father_name: 'Vua Gia Long',
        mother_name: 'Thuáº­n ThiÃªn HoÃ ng háº­u'
      };
    }
    
    /**
     * Display lineage chain with beautiful timeline format
     */
    function displayLineageChain(lineage) {
      const resultDiv = document.getElementById('lineageResult');
      const resultContent = document.getElementById('lineageResultContent');
      const resultTitle = document.getElementById('lineageResultTitle');
      
      if (!resultDiv) return;
      
      if (!lineage || lineage.length === 0) {
        if (resultContent) {
          resultContent.innerHTML = '<div style="padding: 20px; color: #666; text-align: center;">KhÃ´ng cÃ³ dá»¯ liá»‡u chuá»—i pháº£ há»‡</div>';
        } else {
          resultDiv.innerHTML = '<div style="padding: 20px; color: #666; text-align: center;">KhÃ´ng cÃ³ dá»¯ liá»‡u chuá»—i pháº£ há»‡</div>';
        }
        resultDiv.style.display = 'block';
        return;
      }
      
      // Remove duplicates by person_id (strict check with string conversion and normalization)
      const seenIds = new Set();
      const uniqueLineage = [];
      const duplicateLog = [];
      
      for (const p of lineage) {
        // Normalize person_id: trim, convert to string, handle null/undefined
        let personId = p.person_id;
        if (personId === null || personId === undefined || personId === '') {
          console.warn(`[Lineage] Skipping person without person_id:`, p);
          continue;
        }
        
        // Convert to string and trim whitespace
        const personIdStr = String(personId).trim();
        if (!personIdStr) {
          console.warn(`[Lineage] Skipping person with empty person_id after trim:`, p);
          continue;
        }
        
        // Check for duplicate
        if (seenIds.has(personIdStr)) {
          const duplicateInfo = {
            person_id: personIdStr,
            name: p.full_name || 'N/A',
            generation: p.generation_number || p.generation_level || 'N/A'
          };
          duplicateLog.push(duplicateInfo);
          console.warn(`[Lineage] DUPLICATE DETECTED: person_id=${personIdStr}, name=${duplicateInfo.name}, generation=${duplicateInfo.generation}`);
          continue;
        }
        
        // Add to seen set and unique lineage
        seenIds.add(personIdStr);
        uniqueLineage.push(p);
      }
      
      if (duplicateLog.length > 0) {
        console.warn(`[Lineage] Found ${duplicateLog.length} duplicates:`, duplicateLog);
      }
      console.log(`[Lineage] After deduplication: ${uniqueLineage.length} unique persons (from ${lineage.length} total)`);
      
      // Log all person_ids for debugging
      const allPersonIds = uniqueLineage.map(p => `${p.person_id} (${p.full_name})`).join(', ');
      console.log(`[Lineage] Unique person_ids: ${allPersonIds}`);
      
      // Sort by generation_number (ascending), then by person_id
      const sortedLineage = [...uniqueLineage].sort((a, b) => {
        const genA = a.generation_number || a.generation_level || 0;
        const genB = b.generation_number || b.generation_level || 0;
        if (genA !== genB) {
          return genA - genB;
        }
        // If same generation, sort by person_id (string comparison for VARCHAR IDs)
        const idA = String(a.person_id || '');
        const idB = String(b.person_id || '');
        return idA.localeCompare(idB);
      });
      
      console.log(`[Lineage] After deduplication: ${sortedLineage.length} unique persons`);
      console.log('[Lineage] Generations:', sortedLineage.map(p => `${p.generation_number || p.generation_level}: ${p.full_name}`));
      
      // Kiá»ƒm tra xem cÃ³ thiáº¿u Ä‘á»i nÃ o khÃ´ng (tá»« Ä‘á»i 1 Ä‘áº¿n Ä‘á»i cá»§a ngÆ°á»i tÃ¬m kiáº¿m)
      if (sortedLineage.length > 0) {
        const maxGen = Math.max(...sortedLineage.map(p => p.generation_number || p.generation_level || 0));
        const minGen = Math.min(...sortedLineage.map(p => p.generation_number || p.generation_level || 0));
        const presentGens = new Set(sortedLineage.map(p => p.generation_number || p.generation_level || 0));
        const missingGens = [];
        for (let gen = minGen; gen <= maxGen; gen++) {
          if (!presentGens.has(gen)) {
            missingGens.push(gen);
          }
        }
        if (missingGens.length > 0) {
          console.warn(`[Lineage] WARNING: Missing generations: ${missingGens.join(', ')}`);
          console.warn(`[Lineage] Present generations: ${Array.from(presentGens).sort((a, b) => a - b).join(', ')}`);
        } else {
          console.log(`[Lineage] All generations present from ${minGen} to ${maxGen}`);
        }
      }
      
      // Ensure Generation 1 exists (Vua Minh Máº¡ng)
      const hasGen1 = sortedLineage.some(p => (p.generation_number === 1 || p.generation_level === 1));
      if (!hasGen1) {
        // Find Vua Minh Máº¡ng or create placeholder
        const gen1Person = {
          person_id: 'P-1-1',
          full_name: 'Vua Minh Máº¡ng',
          generation_number: 1,
          generation_level: 1,
          father_name: 'Vua Gia Long',
          mother_name: 'Thuáº­n ThiÃªn HoÃ ng háº­u',
          gender: 'Nam',
          status: 'ÄÃ£ máº¥t'
        };
        sortedLineage.unshift(gen1Person);
        console.log('[Lineage] Added Generation 1 placeholder (Vua Minh Máº¡ng)');
      } else {
        // Normalize Gen 1 parents
        const gen1Index = sortedLineage.findIndex(p => (p.generation_number === 1 || p.generation_level === 1));
        if (gen1Index !== -1) {
          const gen1Parents = getGen1Parents();
          sortedLineage[gen1Index].father_name = gen1Parents.father_name;
          sortedLineage[gen1Index].mother_name = gen1Parents.mother_name;
          console.log('[Lineage] Normalized Generation 1 parents');
        }
      }
      
      // Get target person (last in chain)
      const targetPerson = sortedLineage[sortedLineage.length - 1];
      
      if (resultTitle) {
        resultTitle.textContent = `Chuá»—i pháº£ há»‡ cá»§a ${targetPerson.full_name || 'NgÆ°á»i Ä‘Æ°á»£c chá»n'}`;
      }
      
      // Group by generation for special handling of Äá»i 1 (vá»£ chá»“ng song song)
      const groupedByGen = {};
      sortedLineage.forEach(p => {
        const gen = p.generation_number || p.generation_level || 0;
        if (!groupedByGen[gen]) {
          groupedByGen[gen] = [];
        }
        groupedByGen[gen].push(p);
      });
      
      // Generate timeline HTML grouped by generation
      let timelineHTML = '';
      Object.keys(groupedByGen).sort((a, b) => parseInt(a) - parseInt(b)).forEach(gen => {
        const personsInGen = groupedByGen[gen];
        const genNum = parseInt(gen);
        
        // Special handling for Äá»i 1: display vá»£ chá»“ng song song
        if (genNum === 1 && personsInGen.length > 1) {
          timelineHTML += '<div style="display: flex; flex-direction: row; gap: 16px; width: 100%; margin-bottom: 16px;">';
          personsInGen.forEach(p => {
            timelineHTML += generatePersonCard(p, genNum, false); // 50% width for Äá»i 1 couple
          });
          timelineHTML += '</div>';
        } else {
          // Normal display for other generations (one person per card, full width)
          personsInGen.forEach(p => {
            timelineHTML += generatePersonCard(p, genNum, true);
          });
        }
      });
      
      function generatePersonCard(p, gen, isFullWidth = true) {
        const name = p.full_name || 'KhÃ´ng rÃµ tÃªn';
        const fatherName = normalizeParentName(p.father_name, true) || p.father_name || '';
        const motherName = normalizeParentName(p.mother_name, false) || p.mother_name || '';
        
        // Format theo yÃªu cáº§u: "Äá»i X â€“ TÃªn tá»• tiÃªn" (khÃ´ng cÃ³ tÃªn bá»‘ trong ngoáº·c)
        const titleLine = `Äá»i ${gen} â€“ ${escapeHtml(name)}`;
        
        // Format parent info: "Con cá»§a Ã”ng ... vÃ  BÃ  ..." (khÃ´ng cÃ³ "Con cá»§a:" in nghiÃªng)
        let parentInfo = '';
        if (fatherName && motherName) {
          parentInfo = `Con cá»§a Ã”ng ${escapeHtml(fatherName)} vÃ  BÃ  ${escapeHtml(motherName)}`;
        } else if (fatherName) {
          parentInfo = `Con cá»§a Ã”ng ${escapeHtml(fatherName)} vÃ  BÃ  ChÆ°a cÃ³ thÃ´ng tin`;
        } else if (motherName) {
          parentInfo = `Con cá»§a Ã”ng ChÆ°a cÃ³ thÃ´ng tin vÃ  BÃ  ${escapeHtml(motherName)}`;
        } else {
          parentInfo = 'Con cá»§a Ã”ng ChÆ°a cÃ³ thÃ´ng tin vÃ  BÃ  ChÆ°a cÃ³ thÃ´ng tin';
        }
        
        // Badge color by generation
        let badgeColor = '';
        if (gen === 1) {
          badgeColor = 'background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);'; // Red
        } else if (gen === 2) {
          badgeColor = 'background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);'; // Orange
        } else if (gen === 3) {
          badgeColor = 'background: linear-gradient(135deg, #ca8a04 0%, #a16207 100%);'; // Yellow
        } else if (gen === 4) {
          badgeColor = 'background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);'; // Green
        } else if (gen === 5) {
          badgeColor = 'background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);'; // Blue
        } else if (gen >= 6) {
          badgeColor = 'background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%);'; // Purple
        } else {
          badgeColor = 'background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);'; // Gray
        }
        
        // For Äá»i 1 with multiple people, use 50% width, otherwise 100%
        const cardWidth = (!isFullWidth) ? 'calc(50% - 8px)' : '100%';
        const cardMargin = (!isFullWidth) ? '0' : '0 0 16px 0';
        
        return `
          <div class="lineage-timeline-card" style="
            background: #FFF8DC;
            border-radius: 8px;
            padding: 16px 20px;
            margin: ${cardMargin};
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #DAA520;
            position: relative;
            width: ${cardWidth};
          ">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
              <span class="generation-badge" style="
                ${badgeColor}
                color: white;
                font-weight: 700;
                font-size: 13px;
                padding: 6px 16px;
                border-radius: 20px;
                white-space: nowrap;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
                display: inline-block;
                min-width: 70px;
                text-align: center;
              ">Äá»i ${gen}</span>
              <h3 style="
                color: #8B0000;
                font-weight: 700;
                font-size: 18px;
                margin: 0;
                flex: 1;
                line-height: 1.4;
              ">${titleLine}</h3>
            </div>
            <div style="
              color: #333;
              font-size: 14px;
              line-height: 1.6;
              padding-left: 0;
              margin-top: 6px;
            ">
              ${parentInfo}
            </div>
          </div>
        `;
      }
      
      if (resultContent) {
        resultContent.innerHTML = `
          <div class="lineage-timeline-container" style="
            display: flex;
            flex-direction: column;
            gap: 0;
            width: 100%;
          ">
            ${timelineHTML}
          </div>
        `;
      } else {
        resultDiv.innerHTML = `
          <div style="padding: 20px;">
            <h3 style="color: #8B0000; margin-bottom: 20px;">Chuá»—i pháº£ há»‡ theo dÃ²ng cha</h3>
            <div class="lineage-timeline-container" style="
              display: flex;
              flex-direction: column;
              gap: 0;
              width: 100%;
            ">
              ${timelineHTML}
            </div>
          </div>
        `;
      }
      
      resultDiv.style.display = 'block';
    }

    /**
     * Hiá»ƒn thá»‹ detail panel á»Ÿ cháº¿ Ä‘á»™ xem (read-only)
     */
    /**
     * Format text: thay dáº¥u ";" báº±ng xuá»‘ng dÃ²ng
     */
    function formatTextWithLineBreaks(text) {
      if (!text || text === 'ChÆ°a cÃ³ thÃ´ng tin') return text;
      return text.split(';').map(item => item.trim()).filter(item => item).join('<br>');
    }
    
    /**
     * Chuáº©n hÃ³a dá»¯ liá»‡u HÃ´n phá»‘i tá»« person object
     * Thá»‘ng nháº¥t logic: Æ°u tiÃªn marriages array, sau Ä‘Ã³ spouse_name, sau Ä‘Ã³ spouse
     * @param {Object} person - Person object
     * @returns {string} - Formatted spouse display text
     */
    function getSpouseDisplay(person) {
      if (!person) return 'ChÆ°a cÃ³ thÃ´ng tin';
      
      // Æ¯u tiÃªn 1: marriages array (Ä‘áº§y Ä‘á»§ thÃ´ng tin nháº¥t)
      if (person.marriages && Array.isArray(person.marriages) && person.marriages.length > 0) {
        return person.marriages.map(m => {
          let display = m.spouse_name || '';
          if (m.marriage_date_solar) {
            display += ` (${m.marriage_date_solar})`;
          }
          if (m.marriage_place) {
            display += ` - ${m.marriage_place}`;
          }
          return display;
        }).join('<br>');
      }
      
      // Æ¯u tiÃªn 2: spouse_name (string)
      if (person.spouse_name) {
        return formatTextWithLineBreaks(person.spouse_name);
      }
      
      // Æ¯u tiÃªn 3: spouse (string)
      if (person.spouse) {
        return formatTextWithLineBreaks(person.spouse);
      }
      
      return 'ChÆ°a cÃ³ thÃ´ng tin';
    }

    function showDetailPanel(person) {
      const panel = document.getElementById('lineageDetailPanel');
      const content = document.getElementById('lineageDetailContent');
      
      if (!person) return;
      
      selectedPerson = person;
      isEditMode = false;
      
      // Fetch thÃ´ng tin chi tiáº¿t tá»« API (bao gá»“m hÃ´n phá»‘i)
      fetch(`/api/person/${person.person_id}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`API tráº£ mÃ£ ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          // API cÃ³ thá»ƒ tráº£ vá» {person: {...}} hoáº·c {...} trá»±c tiáº¿p
          const detailedPerson = data.person || data;
          if (detailedPerson.error) {
            console.error('API tráº£ vá» lá»—i:', detailedPerson.error);
            renderDetailPanel(person);
            return;
          }
          
          // Debug: Log data tá»« API
          console.log('[Detail Panel] API Response:', detailedPerson);
          console.log('[Detail Panel] Fields:', {
            full_name: detailedPerson.full_name,
            alias: detailedPerson.alias,
            generation_level: detailedPerson.generation_level,
            father_id: detailedPerson.father_id,
            father_name: detailedPerson.father_name,
            mother_id: detailedPerson.mother_id,
            mother_name: detailedPerson.mother_name,
            birth_date_solar: detailedPerson.birth_date_solar,
            birth_date_lunar: detailedPerson.birth_date_lunar,
            home_town: detailedPerson.home_town,
            occupation: detailedPerson.occupation,
            education: detailedPerson.education,
            religion: detailedPerson.religion,
            events: detailedPerson.events,
            titles: detailedPerson.titles,
            blood_type: detailedPerson.blood_type,
            genetic_disease: detailedPerson.genetic_disease,
            place_of_death: detailedPerson.place_of_death,
            grave_info: detailedPerson.grave_info,
            contact: detailedPerson.contact,
            social: detailedPerson.social,
            note: detailedPerson.note
          });
          
          // Merge thÃ´ng tin chi tiáº¿t vÃ o person
          Object.assign(selectedPerson, detailedPerson);
          // Äáº£m báº£o generation_number Ä‘Æ°á»£c set
          if (!selectedPerson.generation_number && selectedPerson.generation_level) {
            selectedPerson.generation_number = selectedPerson.generation_level;
          }
          
          console.log('[Detail Panel] Merged person:', selectedPerson);
          renderDetailPanel(selectedPerson);
        })
        .catch(error => {
          console.error('Lá»—i khi fetch thÃ´ng tin chi tiáº¿t:', error);
          renderDetailPanel(person);
        });
    }
    
    function renderDetailPanel(person) {
      const content = document.getElementById('lineageDetailContent');
      const panel = document.getElementById('lineageDetailPanel');
      if (!content || !panel) return;
      
      // Äáº£m báº£o luÃ´n á»Ÿ cháº¿ Ä‘á»™ xem khi render
      isEditMode = false;
      
      content.innerHTML = `
        <div class="detail-view-mode">
          <div class="detail-form">
            <div class="form-group">
              <label>Person ID:</label>
              <div class="detail-value">${person.person_id || 'ChÆ°a cÃ³ thÃ´ng tin'}</div>
            </div>
            <div class="form-group">
              <label>TÃªn Ä‘áº§y Ä‘á»§:</label>
              <div class="detail-value">${person.full_name || 'ChÆ°a cÃ³ thÃ´ng tin'}</div>
            </div>
            ${person.alias ? `
            <div class="form-group">
              <label>TÃªn thÆ°á»ng gá»i:</label>
              <div class="detail-value">${person.alias}</div>
            </div>
            ` : ''}
            <div class="form-group">
              <label>Äá»i:</label>
              <div class="detail-value">${person.generation_number || person.generation_level || 'ChÆ°a cÃ³ thÃ´ng tin'}</div>
            </div>
            <div class="form-group">
              <label>Giá»›i tÃ­nh:</label>
              <div class="detail-value">${person.gender || 'ChÆ°a cÃ³ thÃ´ng tin'}</div>
            </div>
            <div class="form-group">
              <label>TÃªn bá»‘:</label>
              <div class="detail-value">${(() => {
                const fatherDisplay = person.father_name || person.father || null;
                return fatherDisplay ? 'Ã”ng ' + fatherDisplay : 'ChÆ°a cÃ³ thÃ´ng tin';
              })()}</div>
            </div>
            <div class="form-group">
              <label>TÃªn máº¹:</label>
              <div class="detail-value">${(() => {
                const motherDisplay = person.mother_name || person.mother || null;
                return motherDisplay ? 'BÃ  ' + motherDisplay : 'ChÆ°a cÃ³ thÃ´ng tin';
              })()}</div>
            </div>
            <div class="form-group">
              <label>NhÃ¡nh:</label>
              <div class="detail-value">${person.branch_name || 'ChÆ°a cÃ³ thÃ´ng tin'}</div>
            </div>
            <div class="form-group">
              <label>Tráº¡ng thÃ¡i:</label>
              <div class="detail-value">${person.status || 'ChÆ°a cÃ³ thÃ´ng tin'}</div>
            </div>
            ${person.birth_date_solar || person.birth_date_lunar ? `
            <div class="form-group">
              <label>NÄƒm sinh:</label>
              <div class="detail-value">
                ${(() => {
                  // Helper function Ä‘á»ƒ parse nÄƒm tá»« date
                  function parseYear(dateValue) {
                    if (!dateValue) return null;
                    
                    // Náº¿u lÃ  sá»‘ (cÃ³ thá»ƒ lÃ  serial date tá»« Excel hoáº·c timestamp)
                    if (typeof dateValue === 'number') {
                      // Náº¿u sá»‘ lá»›n hÆ¡n 10000, cÃ³ thá»ƒ lÃ  serial date (Excel: days since 1900-01-01)
                      if (dateValue > 10000) {
                        // Excel serial date: 1900-01-01 = 1
                        // MySQL DATE cÃ³ thá»ƒ tráº£ vá» sá»‘ ngÃ y tá»« epoch hoáº·c serial
                        try {
                          // Thá»­ convert tá»« Excel serial (1900-01-01 = 1)
                          const excelEpoch = new Date(1899, 11, 30); // 1899-12-30 (Excel epoch)
                          const date = new Date(excelEpoch.getTime() + (dateValue - 1) * 86400000);
                          if (!isNaN(date.getTime()) && date.getFullYear() > 1900 && date.getFullYear() < 2100) {
                            return date.getFullYear();
                          }
                          // Thá»­ convert tá»« Unix timestamp (milliseconds)
                          const date2 = new Date(dateValue);
                          if (!isNaN(date2.getTime()) && date2.getFullYear() > 1900 && date2.getFullYear() < 2100) {
                            return date2.getFullYear();
                          }
                        } catch (e) {
                          // Ignore
                        }
                      }
                      // Náº¿u sá»‘ nhá» (cÃ³ thá»ƒ lÃ  nÄƒm trá»±c tiáº¿p)
                      if (dateValue >= 1800 && dateValue <= 2100) {
                        return dateValue;
                      }
                      return null;
                    }
                    
                    // Náº¿u lÃ  chuá»—i
                    if (typeof dateValue === 'string') {
                      // Format YYYY-MM-DD hoáº·c YYYY/MM/DD
                      const dateMatch = dateValue.match(/^(\d{4})[-/]/);
                      if (dateMatch) {
                        const year = parseInt(dateMatch[1]);
                        if (year >= 1800 && year <= 2100) {
                          return year;
                        }
                      }
                      
                      // Thá»­ parse báº±ng Date
                      try {
                        const date = new Date(dateValue);
                        if (!isNaN(date.getTime())) {
                          const year = date.getFullYear();
                          if (year >= 1800 && year <= 2100) {
                            return year;
                          }
                        }
                      } catch (e) {
                        // Ignore
                      }
                      
                      // Náº¿u chá»‰ lÃ  sá»‘ trong chuá»—i (nÄƒm)
                      const numMatch = dateValue.match(/^\d{4}$/);
                      if (numMatch) {
                        const year = parseInt(numMatch[0]);
                        if (year >= 1800 && year <= 2100) {
                          return year;
                        }
                      }
                    }
                    
                    return null;
                  }
                  
                  let yearDL = parseYear(person.birth_date_solar);
                  let yearAL = parseYear(person.birth_date_lunar);
                  
                  // Logic hiá»ƒn thá»‹
                  if (yearDL && yearAL) {
                    if (yearDL === yearAL) {
                      return yearDL + (person.birth_location ? ' - ' + person.birth_location : '');
                    } else {
                      return `DL: ${yearDL} / AL: ${yearAL}${person.birth_location ? ' - ' + person.birth_location : ''}`;
                    }
                  } else if (yearDL) {
                    return yearDL + (person.birth_location ? ' - ' + person.birth_location : '');
                  } else if (yearAL) {
                    return yearAL + (person.birth_location ? ' - ' + person.birth_location : '');
                  }
                  // Náº¿u khÃ´ng parse Ä‘Æ°á»£c, hiá»ƒn thá»‹ giÃ¡ trá»‹ gá»‘c (trÃ¡nh hiá»ƒn thá»‹ sá»‘ serial)
                  return person.birth_date_solar || person.birth_date_lunar || '';
                })()}
              </div>
            </div>
            ` : ''}
            ${person.death_date_solar || person.death_date_lunar ? `
            <div class="form-group">
              <label>NÄƒm máº¥t:</label>
              <div class="detail-value">
                ${(() => {
                  // Helper function Ä‘á»ƒ parse nÄƒm tá»« date (dÃ¹ng láº¡i logic tá»« birth_date)
                  function parseYear(dateValue) {
                    if (!dateValue) return null;
                    
                    if (typeof dateValue === 'number') {
                      if (dateValue > 10000) {
                        try {
                          const excelEpoch = new Date(1899, 11, 30);
                          const date = new Date(excelEpoch.getTime() + (dateValue - 1) * 86400000);
                          if (!isNaN(date.getTime()) && date.getFullYear() > 1900 && date.getFullYear() < 2100) {
                            return date.getFullYear();
                          }
                          const date2 = new Date(dateValue);
                          if (!isNaN(date2.getTime()) && date2.getFullYear() > 1900 && date2.getFullYear() < 2100) {
                            return date2.getFullYear();
                          }
                        } catch (e) {}
                      }
                      if (dateValue >= 1800 && dateValue <= 2100) {
                        return dateValue;
                      }
                      return null;
                    }
                    
                    if (typeof dateValue === 'string') {
                      const dateMatch = dateValue.match(/^(\d{4})[-/]/);
                      if (dateMatch) {
                        const year = parseInt(dateMatch[1]);
                        if (year >= 1800 && year <= 2100) {
                          return year;
                        }
                      }
                      try {
                        const date = new Date(dateValue);
                        if (!isNaN(date.getTime())) {
                          const year = date.getFullYear();
                          if (year >= 1800 && year <= 2100) {
                            return year;
                          }
                        }
                      } catch (e) {}
                      const numMatch = dateValue.match(/^\d{4}$/);
                      if (numMatch) {
                        const year = parseInt(numMatch[0]);
                        if (year >= 1800 && year <= 2100) {
                          return year;
                        }
                      }
                    }
                    
                    return null;
                  }
                  
                  const yearDL = parseYear(person.death_date_solar);
                  const yearAL = parseYear(person.death_date_lunar);
                  
                  let result = '';
                  if (yearDL && yearAL) {
                    result = `DL: ${yearDL} / AL: ${yearAL}`;
                  } else if (yearDL) {
                    result = yearDL.toString();
                  } else if (yearAL) {
                    result = yearAL.toString();
                  }
                  
                  if (result && (person.sheet3_death_place || person.death_location)) {
                    result += ' - ' + (person.sheet3_death_place || person.death_location);
                  }
                  
                  return result || '';
                })()}
              </div>
            </div>
            ` : ''}
            ${person.sheet3_grave ? `
            <div class="form-group">
              <label>Má»™ pháº§n:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.sheet3_grave)}</div>
            </div>
            ` : ''}
            ${person.sheet3_number ? `
            <div class="form-group">
              <label>Sá»‘ thá»© tá»± thÃ nh viÃªn:</label>
              <div class="detail-value">${person.sheet3_number}</div>
            </div>
            ` : ''}
            ${person.sheet3_parents ? `
            <div class="form-group">
              <label>ThÃ´ng tin Bá»‘ Máº¹:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.sheet3_parents)}</div>
            </div>
            ` : ''}
            ${person.home_town || person.origin_location ? `
            <div class="form-group">
              <label>NguyÃªn quÃ¡n:</label>
              <div class="detail-value">${person.home_town || person.origin_location || 'ChÆ°a cÃ³ thÃ´ng tin'}</div>
            </div>
            ` : ''}
            ${person.occupation ? `
            <div class="form-group">
              <label>Nghá» nghiá»‡p:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.occupation)}</div>
            </div>
            ` : ''}
            ${person.education ? `
            <div class="form-group">
              <label>Há»c váº¥n:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.education)}</div>
            </div>
            ` : ''}
            ${person.events ? `
            <div class="form-group">
              <label>Sá»± kiá»‡n:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.events)}</div>
            </div>
            ` : ''}
            ${person.titles ? `
            <div class="form-group">
              <label>Danh hiá»‡u:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.titles)}</div>
            </div>
            ` : ''}
            ${person.blood_type ? `
            <div class="form-group">
              <label>NhÃ³m mÃ¡u:</label>
              <div class="detail-value">${person.blood_type}</div>
            </div>
            ` : ''}
            ${person.genetic_disease ? `
            <div class="form-group">
              <label>Bá»‡nh di truyá»n:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.genetic_disease)}</div>
            </div>
            ` : ''}
            ${person.place_of_death || person.sheet3_death_place || person.death_location ? `
            <div class="form-group">
              <label>NÆ¡i máº¥t:</label>
              <div class="detail-value">${person.place_of_death || person.sheet3_death_place || person.death_location || 'ChÆ°a cÃ³ thÃ´ng tin'}</div>
            </div>
            ` : ''}
            ${person.grave_info || person.sheet3_grave ? `
            <div class="form-group">
              <label>Má»™ pháº§n:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.grave_info || person.sheet3_grave)}</div>
            </div>
            ` : ''}
            ${person.contact ? `
            <div class="form-group">
              <label>ThÃ´ng tin liÃªn láº¡c:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.contact)}</div>
            </div>
            ` : ''}
            ${person.social ? `
            <div class="form-group">
              <label>Máº¡ng xÃ£ há»™i:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.social)}</div>
            </div>
            ` : ''}
            ${person.note ? `
            <div class="form-group">
              <label>Ghi chÃº:</label>
              <div class="detail-value">${formatTextWithLineBreaks(person.note)}</div>
            </div>
            ` : ''}
            <div class="form-group">
              <label>HÃ´n phá»‘i:</label>
              <div class="detail-value">${getSpouseDisplay(person)}</div>
            </div>
            <div class="form-group">
              <label>Anh/Chá»‹/Em:</label>
              <div class="detail-value">${(() => {
                const siblingsDisplay = person.siblings || person.siblingsText || null;
                if (Array.isArray(siblingsDisplay)) {
                  return siblingsDisplay.join(', ');
                }
                return siblingsDisplay ? formatTextWithLineBreaks(siblingsDisplay) : 'ChÆ°a cÃ³ thÃ´ng tin';
              })()}</div>
            </div>
            <div class="form-group">
              <label>ThÃ´ng tin con:</label>
              <div class="detail-value">${(() => {
                const childrenDisplay = person.children || person.childrenText || null;
                if (Array.isArray(childrenDisplay)) {
                  return childrenDisplay.join(', ');
                }
                return childrenDisplay ? formatTextWithLineBreaks(childrenDisplay) : 'ChÆ°a cÃ³ thÃ´ng tin';
              })()}</div>
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn-cancel" onclick="closeDetailPanel()">ÄÃ³ng</button>
            <button type="button" class="btn-request" onclick="openRequestModal()">ğŸ“ Gá»­i yÃªu cáº§u chá»‰nh sá»­a</button>
          </div>
        </div>
      `;
      
      panel.style.display = 'block';
    }

    /**
     * Hiá»ƒn thá»‹ modal nháº­p máº­t kháº©u vÃ  cho phÃ©p chá»‰nh sá»­a náº¿u Ä‘Ãºng
     */
    function promptPasswordAndEdit() {
      if (!selectedPerson) return;
      
      // Táº¡o modal nháº­p máº­t kháº©u
      let modal = document.getElementById('passwordModal');
      if (!modal) {
        const modalHTML = `
          <div id="passwordModal" class="modal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto;">
            <div class="modal-content" style="background: white; margin: 15% auto; padding: 30px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
              <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #8B0000; margin: 0;">ğŸ” XÃ¡c thá»±c máº­t kháº©u</h3>
                <span class="close" onclick="closePasswordModal()" style="cursor: pointer; font-size: 28px; color: #999; font-weight: bold;">&times;</span>
              </div>
              <form id="passwordForm" onsubmit="verifyPasswordAndEdit(event)">
                <div class="form-group">
                  <label style="display: block; margin-bottom: 8px; color: #8B0000; font-weight: 600;">Nháº­p máº­t kháº©u Ä‘á»ƒ cáº­p nháº­t thÃ´ng tin:</label>
                  <input type="password" id="passwordInput" required 
                         placeholder="Nháº­p máº­t kháº©u" 
                         style="width: 100%; padding: 12px; border: 2px solid #DAA520; border-radius: 6px; font-size: 16px; font-family: 'Noto Serif TC', serif;"
                         autocomplete="off">
                </div>
                <div class="form-actions" style="display: flex; gap: 10px; margin-top: 20px;">
                  <button type="button" class="btn-cancel" onclick="closePasswordModal()" style="flex: 1;">Há»§y</button>
                  <button type="submit" class="btn-save" style="flex: 1;">XÃ¡c nháº­n</button>
                </div>
              </form>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        modal = document.getElementById('passwordModal');
      }
      
      // Reset input
      const passwordInput = document.getElementById('passwordInput');
      if (passwordInput) {
        passwordInput.value = '';
        passwordInput.focus();
      }
      
      // Hiá»ƒn thá»‹ modal
      modal.style.display = 'block';
    }
    
    /**
     * ÄÃ³ng modal máº­t kháº©u
     */
    function closePasswordModal() {
      const modal = document.getElementById('passwordModal');
      if (modal) {
        modal.style.display = 'none';
        const form = document.getElementById('passwordForm');
        if (form) form.reset();
      }
    }
    
    /**
     * Kiá»ƒm tra máº­t kháº©u vÃ  cho phÃ©p chá»‰nh sá»­a náº¿u Ä‘Ãºng
     */
    function verifyPasswordAndEdit(event) {
      event.preventDefault();
      
      const passwordInput = document.getElementById('passwordInput');
      const password = passwordInput ? passwordInput.value.trim() : '';
      
      if (!password) {
        alert('âŒ Vui lÃ²ng nháº­p máº­t kháº©u!');
        if (passwordInput) {
          passwordInput.focus();
        }
        return;
      }
      
      // Verify password via API instead of hardcoding
      try {
        const verifyResponse = await fetch('/api/admin/verify-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: password, action: 'edit_person' })
        });
        const verifyResult = await verifyResponse.json();
        
        if (verifyResult.success) {
          // ÄÃ³ng modal
          closePasswordModal();
          // Cho phÃ©p chá»‰nh sá»­a
          enableEditMode();
        } else {
          alert('âŒ Máº­t kháº©u khÃ´ng Ä‘Ãºng! Vui lÃ²ng thá»­ láº¡i.');
          if (passwordInput) {
            passwordInput.value = '';
            passwordInput.focus();
          }
        }
      } catch (error) {
        console.error('Error verifying password:', error);
        alert('âŒ Lá»—i xÃ¡c thá»±c máº­t kháº©u. Vui lÃ²ng thá»­ láº¡i.');
      }
    }
    
    /**
     * Hiá»ƒn thá»‹ modal xÃ¡c nháº­n xÃ³a vá»›i nháº­p máº­t kháº©u
     */
    function promptPasswordAndDelete() {
      if (!selectedPerson) return;
      
      // Táº¡o modal xÃ¡c nháº­n xÃ³a
      let modal = document.getElementById('deleteConfirmModal');
      if (!modal) {
        const modalHTML = `
          <div id="deleteConfirmModal" class="modal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto;">
            <div class="modal-content" style="background: white; margin: 15% auto; padding: 30px; border-radius: 8px; width: 90%; max-width: 450px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
              <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #DC143C; margin: 0;">âš ï¸ XÃ¡c nháº­n xÃ³a</h3>
                <span class="close" onclick="closeDeleteModal()" style="cursor: pointer; font-size: 28px; color: #999; font-weight: bold;">&times;</span>
              </div>
              <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                <p style="margin: 0; color: #856404; font-weight: 600;">Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a ngÆ°á»i nÃ y?</p>
                <p style="margin: 10px 0 0 0; color: #856404;">
                  <strong id="deletePersonName">${selectedPerson.full_name}</strong> (Äá»i ${selectedPerson.generation_number || '?'})
                </p>
                <p style="margin: 10px 0 0 0; color: #856404; font-size: 14px;">
                  âš ï¸ HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c! Táº¥t cáº£ dá»¯ liá»‡u liÃªn quan sáº½ bá»‹ xÃ³a.
                </p>
              </div>
              <form id="deleteConfirmForm" onsubmit="verifyPasswordAndDelete(event)">
                <div class="form-group">
                  <label style="display: block; margin-bottom: 8px; color: #DC143C; font-weight: 600;">Nháº­p máº­t kháº©u admin Ä‘á»ƒ xÃ¡c nháº­n:</label>
                  <input type="password" id="deletePasswordInput" required 
                         placeholder="Nháº­p máº­t kháº©u" 
                         style="width: 100%; padding: 12px; border: 2px solid #DC143C; border-radius: 6px; font-size: 16px; font-family: 'Noto Serif TC', serif;"
                         autocomplete="off">
                </div>
                <div class="form-actions" style="display: flex; gap: 10px; margin-top: 20px;">
                  <button type="button" class="btn-cancel" onclick="closeDeleteModal()" style="flex: 1;">Há»§y</button>
                  <button type="submit" class="btn-delete" style="flex: 1; background: linear-gradient(135deg, #DC143C 0%, #8B0000 100%); color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">ğŸ—‘ï¸ XÃ³a vÄ©nh viá»…n</button>
                </div>
              </form>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        modal = document.getElementById('deleteConfirmModal');
      }
      
      // Cáº­p nháº­t thÃ´ng tin ngÆ°á»i sáº½ bá»‹ xÃ³a
      const personInfo = document.getElementById('deletePersonName');
      if (personInfo && selectedPerson) {
        personInfo.textContent = `${selectedPerson.full_name} (Äá»i ${selectedPerson.generation_number || '?'})`;
      }
      
      // Reset input
      const passwordInput = document.getElementById('deletePasswordInput');
      if (passwordInput) {
        passwordInput.value = '';
        passwordInput.focus();
      }
      
      // Hiá»ƒn thá»‹ modal
      modal.style.display = 'block';
    }
    
    /**
     * ÄÃ³ng modal xÃ³a
     */
    function closeDeleteModal() {
      const modal = document.getElementById('deleteConfirmModal');
      if (modal) {
        modal.style.display = 'none';
        const form = document.getElementById('deleteConfirmForm');
        if (form) form.reset();
      }
    }
    
    /**
     * Kiá»ƒm tra máº­t kháº©u vÃ  xÃ³a náº¿u Ä‘Ãºng
     */
    async function verifyPasswordAndDelete(event) {
      event.preventDefault();
      
      if (!selectedPerson) {
        alert('âŒ KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin ngÆ°á»i cáº§n xÃ³a');
        return;
      }
      
      const passwordInput = document.getElementById('deletePasswordInput');
      const password = passwordInput ? passwordInput.value.trim() : '';
      
      // Verify password via API instead of hardcoding
      if (!password) {
        alert('âŒ Vui lÃ²ng nháº­p máº­t kháº©u!');
        if (passwordInput) {
          passwordInput.focus();
        }
        return;
      }
      
      // Verify password via API
      try {
        const verifyResponse = await fetch('/api/admin/verify-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: password, action: 'delete_person' })
        });
        const verifyResult = await verifyResponse.json();
        
        if (!verifyResult.success) {
          alert('âŒ Máº­t kháº©u khÃ´ng Ä‘Ãºng! Vui lÃ²ng thá»­ láº¡i.');
          if (passwordInput) {
            passwordInput.value = '';
            passwordInput.focus();
          }
          return;
        }
      } catch (error) {
        console.error('Error verifying password:', error);
        alert('âŒ Lá»—i xÃ¡c thá»±c máº­t kháº©u. Vui lÃ²ng thá»­ láº¡i.');
        return;
      }
      
      // XÃ¡c nháº­n láº§n cuá»‘i
      const personName = selectedPerson.full_name || 'NgÆ°á»i nÃ y';
      const finalConfirm = confirm(`âš ï¸ XÃC NHáº¬N CUá»I CÃ™NG\n\nBáº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a:\n${personName} (Äá»i ${selectedPerson.generation_number || '?'})\n\nHÃ nh Ä‘á»™ng nÃ y KHÃ”NG THá»‚ hoÃ n tÃ¡c!`);
      
      if (!finalConfirm) {
        return;
      }
      
      const personId = selectedPerson.person_id;
      
      try {
        const response = await fetch(`/api/person/${personId}`, {
          method: 'DELETE',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ password: password })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          alert(`âœ… ${result.message}`);
          
          // ÄÃ³ng modal vÃ  panel
          closeDeleteModal();
          closeDetailPanel();
          
          // XÃ³a khá»i input tÃ¬m kiáº¿m
          const nameInput = document.getElementById('lineageName');
          if (nameInput) {
            const nameInput = document.getElementById('lineageName');
            if (nameInput) {
              nameInput.value = '';
            }
          }
          
          // áº¨n káº¿t quáº£
          const resultDiv = document.getElementById('lineageResult');
          if (resultDiv) {
            resultDiv.style.display = 'none';
          }
          
          // Reload dá»¯ liá»‡u (reload trang Ä‘á»ƒ cáº­p nháº­t)
          setTimeout(() => {
            location.reload();
          }, 1000);
        } else {
          alert('âŒ Lá»—i: ' + (result.error || 'KhÃ´ng thá»ƒ xÃ³a ngÆ°á»i nÃ y'));
        }
      } catch (error) {
        console.error('Lá»—i khi xÃ³a:', error);
        alert('âŒ Lá»—i káº¿t ná»‘i: ' + error.message);
      }
    }
    
    /**
     * Chuyá»ƒn sang cháº¿ Ä‘á»™ chá»‰nh sá»­a
     */
    function enableEditMode() {
      if (!selectedPerson) return;
      
      isEditMode = true;
      const content = document.getElementById('lineageDetailContent');
      const person = selectedPerson;
      
      content.innerHTML = `
        <form id="personEditForm" onsubmit="savePersonData(event)">
          <div class="detail-form">
            <div class="form-group">
              <label>Person ID:</label>
              <div class="detail-value">${person.person_id || 'ChÆ°a cÃ³ thÃ´ng tin'}</div>
            </div>
            <div class="form-group">
              <label>TÃªn Ä‘áº§y Ä‘á»§:</label>
              <input type="text" name="full_name" value="${(person.full_name || '').replace(/"/g, '&quot;')}" required>
            </div>
            <div class="form-group">
              <label>Äá»i:</label>
              <input type="number" name="generation_number" value="${person.generation_number || ''}" min="1" required>
            </div>
            <div class="form-group">
              <label>Giá»›i tÃ­nh:</label>
              <select name="gender">
                <option value="Nam" ${person.gender === 'Nam' ? 'selected' : ''}>Nam</option>
                <option value="Ná»¯" ${person.gender === 'Ná»¯' ? 'selected' : ''}>Ná»¯</option>
                <option value="KhÃ¡c" ${person.gender === 'KhÃ¡c' ? 'selected' : ''}>KhÃ¡c</option>
              </select>
            </div>
            <div class="form-group">
              <label>TÃªn bá»‘:</label>
              <input type="text" name="father_name" value="${(person.father_name || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-group">
              <label>TÃªn máº¹:</label>
              <input type="text" name="mother_name" value="${(person.mother_name || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-group">
              <label>NhÃ¡nh:</label>
              <input type="text" name="branch_name" value="${(person.branch_name || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-group">
              <label>Tráº¡ng thÃ¡i:</label>
              <select name="status">
                <option value="CÃ²n sá»‘ng" ${person.status === 'CÃ²n sá»‘ng' ? 'selected' : ''}>CÃ²n sá»‘ng</option>
                <option value="ÄÃ£ máº¥t" ${person.status === 'ÄÃ£ máº¥t' ? 'selected' : ''}>ÄÃ£ máº¥t</option>
                <option value="KhÃ´ng rÃµ" ${person.status === 'KhÃ´ng rÃµ' || !person.status ? 'selected' : ''}>KhÃ´ng rÃµ</option>
              </select>
            </div>
            <div class="form-group">
              <label>NgÃ y sinh (DÆ°Æ¡ng lá»‹ch):</label>
              <input type="date" name="birth_date_solar" value="${person.birth_date_solar || ''}">
            </div>
            <div class="form-group">
              <label>NgÃ y sinh (Ã‚m lá»‹ch):</label>
              <input type="date" name="birth_date_lunar" value="${person.birth_date_lunar || ''}">
            </div>
            <div class="form-group">
              <label>NÆ¡i sinh:</label>
              <input type="text" name="birth_location" value="${(person.birth_location || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-group">
              <label>NgÃ y máº¥t (DÆ°Æ¡ng lá»‹ch):</label>
              <input type="date" name="death_date_solar" value="${person.death_date_solar || ''}">
            </div>
            <div class="form-group">
              <label>NgÃ y máº¥t (Ã‚m lá»‹ch):</label>
              <input type="date" name="death_date_lunar" value="${person.death_date_lunar || ''}">
            </div>
            <div class="form-group">
              <label>NÆ¡i máº¥t:</label>
              <input type="text" name="death_location" value="${(person.death_location || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-group">
              <label>NguyÃªn quÃ¡n:</label>
              <input type="text" name="origin_location" value="${(person.origin_location || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-group">
              <label>Anh/Chá»‹/Em:</label>
              <textarea name="siblings" rows="2">${(person.siblings || '').replace(/"/g, '&quot;')}</textarea>
            </div>
            <div class="form-group">
              <label>HÃ´n phá»‘i:</label>
              <textarea name="spouse" rows="2">${(person.spouse || '').replace(/"/g, '&quot;')}</textarea>
            </div>
            <div class="form-group">
              <label>ThÃ´ng tin con:</label>
              <textarea name="children" rows="3">${(person.children || '').replace(/"/g, '&quot;')}</textarea>
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn-cancel" onclick="cancelEdit()">Há»§y</button>
            <button type="submit" class="btn-save">ğŸ’¾ LÆ°u thay Ä‘á»•i</button>
            <button type="button" class="btn-sync" onclick="syncPersonData()" style="background: #28a745; color: white; margin-left: 10px;">ğŸ”„ Äá»“ng bá»™</button>
          </div>
        </form>
      `;
    }

    /**
     * Há»§y chá»‰nh sá»­a, quay vá» cháº¿ Ä‘á»™ xem
     */
    function cancelEdit() {
      isEditMode = false;
      if (selectedPerson) {
        renderDetailPanel(selectedPerson);
      }
    }
    
    /**
     * Má»Ÿ modal gá»­i yÃªu cáº§u chá»‰nh sá»­a
     */
    function openRequestModal() {
      if (!selectedPerson) return;
      
      let modal = document.getElementById('requestEditModal');
      if (!modal) {
        // Táº¡o modal náº¿u chÆ°a cÃ³
        const modalHTML = `
          <div id="requestEditModal" class="modal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto;">
            <div class="modal-content" style="background: white; margin: 5% auto; padding: 30px; border-radius: 8px; width: 90%; max-width: 600px;">
              <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #8B0000; margin: 0;">ğŸ“ Gá»­i yÃªu cáº§u cáº­p nháº­t thÃ´ng tin</h3>
                <span class="close" onclick="closeRequestModal()" style="cursor: pointer; font-size: 28px; color: #999; font-weight: bold;">&times;</span>
              </div>
              <form id="requestEditForm" onsubmit="submitEditRequest(event)">
                <input type="hidden" id="request_person_id" value="${selectedPerson.person_id}">
                <input type="hidden" id="request_person_name" value="${selectedPerson.full_name}">
                <input type="hidden" id="request_person_generation" value="${selectedPerson.generation_number}">
                
                <div class="form-group" style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; color: #8B0000; font-weight: 600;">NgÆ°á»i cáº§n cáº­p nháº­t thÃ´ng tin:</label>
                  <div style="padding: 12px; background: #f5f5f5; border-radius: 6px; border: 1px solid #e0e0e0;">
                    <strong style="color: #8B0000;">${selectedPerson.full_name}</strong> <span style="color: #666;">(Äá»i ${selectedPerson.generation_number})</span>
                  </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                  <label for="request_full_name" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">Há» vÃ  tÃªn *</label>
                  <input type="text" id="request_full_name" name="full_name" required 
                         placeholder="Nháº­p há» vÃ  tÃªn cá»§a báº¡n"
                         style="width: 100%; padding: 12px; border: 2px solid #DAA520; border-radius: 6px; font-size: 16px; font-family: 'Noto Serif TC', serif;">
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                  <label for="request_contact" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">Email hoáº·c SÄT *</label>
                  <input type="text" id="request_contact" name="contact" required 
                         placeholder="Nháº­p email hoáº·c sá»‘ Ä‘iá»‡n thoáº¡i cá»§a báº¡n"
                         style="width: 100%; padding: 12px; border: 2px solid #DAA520; border-radius: 6px; font-size: 16px; font-family: 'Noto Serif TC', serif;">
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                  <label for="request_content" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">Ná»™i dung cáº§n cáº­p nháº­t *</label>
                  <textarea id="request_content" name="content" rows="6" required 
                            placeholder="Vui lÃ²ng mÃ´ táº£ chi tiáº¿t nhá»¯ng thÃ´ng tin báº¡n muá»‘n cáº­p nháº­t cho ${selectedPerson.full_name}..."
                            style="width: 100%; padding: 12px; border: 2px solid #DAA520; border-radius: 6px; font-size: 16px; font-family: 'Noto Serif TC', serif; resize: vertical;"></textarea>
                </div>
                
                <div class="form-actions" style="display: flex; gap: 10px; margin-top: 30px;">
                  <button type="button" class="btn-cancel" onclick="closeRequestModal()" style="flex: 1; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; background: #757575; color: white;">Há»§y</button>
                  <button type="submit" class="btn-save" style="flex: 1; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%); color: #FFD700;">ğŸ“¤ Gá»­i yÃªu cáº§u</button>
                </div>
              </form>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        modal = document.getElementById('requestEditModal');
      }
      
      // Cáº­p nháº­t giÃ¡ trá»‹
      const personIdInput = document.getElementById('request_person_id');
      const personNameInput = document.getElementById('request_person_name');
      const personGenInput = document.getElementById('request_person_generation');
      const fullNameInput = document.getElementById('request_full_name');
      const contactInput = document.getElementById('request_contact');
      const contentInput = document.getElementById('request_content');
      
      if (personIdInput) personIdInput.value = selectedPerson.person_id;
      if (personNameInput) personNameInput.value = selectedPerson.full_name;
      if (personGenInput) personGenInput.value = selectedPerson.generation_number || '';
      if (fullNameInput) fullNameInput.value = '';
      if (contactInput) contactInput.value = '';
      if (contentInput) contentInput.value = '';
      
      if (modal) {
        modal.style.display = 'block';
      }
    }
    
    /**
     * ÄÃ³ng modal request
     */
    function closeRequestModal() {
      const modal = document.getElementById('requestEditModal');
      if (modal) {
        modal.style.display = 'none';
        const form = document.getElementById('requestEditForm');
        if (form) form.reset();
      }
    }
    
    /**
     * Gá»­i yÃªu cáº§u chá»‰nh sá»­a
     */
    async function submitEditRequest(event) {
      event.preventDefault();
      
      const personIdInput = document.getElementById('request_person_id');
      const personNameInput = document.getElementById('request_person_name');
      const personGenInput = document.getElementById('request_person_generation');
      const fullNameInput = document.getElementById('request_full_name');
      const contactInput = document.getElementById('request_contact');
      const contentInput = document.getElementById('request_content');
      
      if (!personIdInput || !personNameInput || !personGenInput || !fullNameInput || !contactInput || !contentInput) {
        console.error('[EditRequest] Required form elements not found');
        alert('Lá»—i: KhÃ´ng tÃ¬m tháº¥y cÃ¡c trÆ°á»ng form');
        return;
      }
      
      const personId = personIdInput.value;
      const personName = personNameInput.value;
      const personGeneration = personGenInput.value;
      const fullName = fullNameInput.value.trim();
      const contact = contactInput.value.trim();
      const content = contentInput.value.trim();
      
      if (!fullName || !contact || !content) {
        alert('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin');
        return;
      }
      
      try {
        const response = await fetch('/api/send-edit-request-email', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            person_id: personId, // Giá»¯ nguyÃªn string (P-1-1 format)
            person_name: personName,
            person_generation: parseInt(personGeneration),
            requester_name: fullName,
            requester_contact: contact,
            content: content
          })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          alert('âœ… YÃªu cáº§u cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c gá»­i tá»›i email baophongcmu@gmail.com. Cáº£m Æ¡n báº¡n Ä‘Ã£ Ä‘Ã³ng gÃ³p!');
          closeRequestModal();
        } else {
          alert('âŒ Lá»—i: ' + (result.error || 'KhÃ´ng thá»ƒ gá»­i yÃªu cáº§u'));
        }
      } catch (error) {
        console.error('Lá»—i khi gá»­i yÃªu cáº§u:', error);
        alert('âŒ Lá»—i káº¿t ná»‘i: ' + error.message);
      }
    }

    /**
     * ÄÃ³ng detail panel
     */
    function closeDetailPanel() {
      const panel = document.getElementById('lineageDetailPanel');
      panel.style.display = 'none';
    }

    /**
     * LÆ°u dá»¯ liá»‡u Person Ä‘Ã£ chá»‰nh sá»­a
     */
    function savePersonData(event) {
      event.preventDefault();
      
      if (!selectedPerson || !selectedPerson.person_id) {
        alert('Lá»—i: KhÃ´ng tÃ¬m tháº¥y dá»¯ liá»‡u Ä‘á»ƒ cáº­p nháº­t');
        return;
      }
      
      const form = event.target;
      const formData = new FormData(form);
      
      // Thu tháº­p Táº¤T Cáº¢ dá»¯ liá»‡u tá»« form
      const updates = {};
      for (const [key, value] of formData.entries()) {
        if (key === 'generation_number') {
          updates[key] = parseInt(value, 10);
        } else if (value && value.trim()) {
          updates[key] = value.trim();
        }
      }
      
      // Hiá»ƒn thá»‹ loading
      const submitButton = form.querySelector('button[type="submit"]');
      const originalText = submitButton ? submitButton.innerHTML : '';
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.innerHTML = 'â³ Äang lÆ°u...';
      }
      
      // Gá»­i Táº¤T Cáº¢ dá»¯ liá»‡u lÃªn server Ä‘á»ƒ lÆ°u vÃ o database
      fetch(`/api/person/${selectedPerson.person_id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(updates)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log('[API] ÄÃ£ lÆ°u vÃ o database:', data);
          
          // Reload láº¡i dá»¯ liá»‡u tá»« server Ä‘á»ƒ cÃ³ dá»¯ liá»‡u má»›i nháº¥t
          return fetch(`/api/person/${selectedPerson.person_id}`)
            .then(response => response.json())
            .then(personData => {
              if (personData && !personData.error) {
                selectedPerson = personData;
                
                // Cáº­p nháº­t trong memory (náº¿u cÃ³ GenealogyLineage)
                if (window.GenealogyLineage) {
                  window.GenealogyLineage.updatePerson(selectedPerson.person_id, updates);
                }
                
                alert('âœ… ÄÃ£ cáº­p nháº­t vÃ  Ä‘á»“ng bá»™ thÃ´ng tin thÃ nh cÃ´ng!');
                
                // Refresh hiá»ƒn thá»‹ náº¿u cÃ³ thay Ä‘á»•i vá» tÃªn, Ä‘á»i, hoáº·c cha/máº¹
                if (updates.father_name !== undefined || updates.mother_name !== undefined || 
                    updates.full_name !== undefined || updates.generation_number !== undefined) {
                  displayLineageForPerson(selectedPerson);
                }
                
                // Hiá»ƒn thá»‹ láº¡i panel vá»›i dá»¯ liá»‡u má»›i
                isEditMode = false;
                showDetailPanel(selectedPerson);
              } else {
                throw new Error('KhÃ´ng thá»ƒ táº£i láº¡i dá»¯ liá»‡u tá»« server');
              }
            });
        } else {
          throw new Error(data.error || 'Lá»—i khi lÆ°u dá»¯ liá»‡u');
        }
      })
      .catch(error => {
        console.error('[API] Lá»—i khi lÆ°u vÃ o database:', error);
        alert('âŒ Lá»—i khi lÆ°u dá»¯ liá»‡u: ' + error.message);
      })
      .finally(() => {
        // KhÃ´i phá»¥c button
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.innerHTML = originalText;
        }
      });
    }

    /**
     * Äá»“ng bá»™ dá»¯ liá»‡u Person sau khi cáº­p nháº­t
     * Äá»“ng bá»™ relationships, marriages_spouses, vÃ  tÃ­nh láº¡i siblings
     */
    function syncPersonData() {
      if (!selectedPerson || !selectedPerson.person_id) {
        alert('âŒ Lá»—i: KhÃ´ng tÃ¬m tháº¥y dá»¯ liá»‡u Ä‘á»ƒ Ä‘á»“ng bá»™');
        return;
      }

      if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n Ä‘á»“ng bá»™ dá»¯ liá»‡u? Dá»¯ liá»‡u sáº½ Ä‘Æ°á»£c cáº­p nháº­t theo thÃ´ng tin má»›i nháº¥t.')) {
        return;
      }

      // Hiá»ƒn thá»‹ loading
      const syncButton = document.querySelector('.btn-sync');
      const originalText = syncButton ? syncButton.innerHTML : '';
      if (syncButton) {
        syncButton.disabled = true;
        syncButton.innerHTML = 'â³ Äang Ä‘á»“ng bá»™...';
      }

      fetch(`/api/person/${selectedPerson.person_id}/sync`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('âœ… ÄÃ£ Ä‘á»“ng bá»™ dá»¯ liá»‡u thÃ nh cÃ´ng!\n\n' + (data.message || ''));
          
          // Reload láº¡i dá»¯ liá»‡u person tá»« server
          fetch(`/api/person/${selectedPerson.person_id}`)
            .then(response => response.json())
            .then(personData => {
              if (personData && !personData.error) {
                selectedPerson = personData;
                showDetailPanel(personData);
                
                // Reload láº¡i danh sÃ¡ch persons náº¿u cáº§n
                if (window.GenealogyLineage && personData) {
                  window.GenealogyLineage.updatePerson(personData.person_id, personData);
                }
              }
            })
            .catch(error => {
              console.error('[API] Lá»—i khi reload dá»¯ liá»‡u:', error);
            });
        } else {
          alert('âŒ Lá»—i khi Ä‘á»“ng bá»™: ' + (data.error || 'KhÃ´ng xÃ¡c Ä‘á»‹nh'));
        }
      })
      .catch(error => {
        console.error('[API] Lá»—i khi Ä‘á»“ng bá»™:', error);
        alert('âŒ Lá»—i khi Ä‘á»“ng bá»™ dá»¯ liá»‡u: ' + error.message);
      })
      .finally(() => {
        // KhÃ´i phá»¥c button
        if (syncButton) {
          syncButton.disabled = false;
          syncButton.innerHTML = originalText;
        }
      });
    }

    /**
     * Khá»Ÿi táº¡o lineage module khi dá»¯ liá»‡u Ä‘Ã£ load
     */
    window.initLineageModule = function(persons) {
      if (window.GenealogyLineage && persons && persons.length > 0) {
        personsDataForLineage = persons;
        window.GenealogyLineage.init(persons);
        console.log('[Lineage] Module Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o vá»›i', persons.length, 'ngÆ°á»i');
      }
    };

    // ÄÃ³ng suggestions khi click ra ngoÃ i
    document.addEventListener('click', (e) => {
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      const nameInput = document.getElementById('lineageName');
      
      if (suggestionsDiv && nameInput && !suggestionsDiv.contains(e.target) && e.target !== nameInput) {
        suggestionsDiv.style.display = 'none';
      }
      
      // ÄÃ³ng modal máº­t kháº©u khi click ra ngoÃ i
      const passwordModal = document.getElementById('passwordModal');
      if (passwordModal && e.target === passwordModal) {
        closePasswordModal();
      }
      
      // ÄÃ³ng modal xÃ³a khi click ra ngoÃ i
      const deleteModal = document.getElementById('deleteConfirmModal');
      if (deleteModal && e.target === deleteModal) {
        closeDeleteModal();
      }
    });

    // Initialize lineage search functionality when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      console.log('[Lineage] Initializing lineage search...');
      
      const nameInput = document.getElementById('lineageName');
      const btnSearchLineage = document.getElementById('btnSearchLineage');
      
      // Enter key handler
      if (nameInput) {
        nameInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            searchLineage();
          }
        });
        console.log('[Lineage] Enter key handler attached');
      } else {
        console.warn('[Lineage] lineageName input not found');
      }
      
      // Button click handler (if not already handled by onclick)
      if (btnSearchLineage && !btnSearchLineage.onclick) {
        btnSearchLineage.addEventListener('click', (e) => {
          e.preventDefault();
          searchLineage();
        });
        console.log('[Lineage] Search button handler attached');
      }
      
      console.log('[Lineage] Lineage search initialized');
    });

    /**
     * TÃ­nh toÃ¡n vá»‹ trÃ­ cho horizontal layout (generations dá»c, people ngang)
     */
    function calculateHorizontalPositions(node, x = 0, y = 0, levelPositions = {}) {
      if (!node) return { x: 0, nextX: 0 };

      const depth = node.depth || 0;
      if (!levelPositions[depth]) {
        levelPositions[depth] = 0;
      }

      // Y = generation (dá»c) - dÃ¹ng generation thá»±c táº¿
      const generation = node.generation || depth;
      node.y = (generation - 1) * 120 + 50;

      const horizontalSpacing = 180;
      if (node.children.length === 0) {
        node.x = levelPositions[depth] * horizontalSpacing + 20;
        levelPositions[depth]++;
        return { x: node.x, nextX: levelPositions[depth] * horizontalSpacing };
      }

      // TÃ­nh vá»‹ trÃ­ cho children trÆ°á»›c
      let childX = levelPositions[depth] * horizontalSpacing;
      let maxChildX = childX;

      node.children.forEach((child, index) => {
        const childResult = calculateHorizontalPositions(child, 0, 0, levelPositions);
        if (index === 0) {
          childX = childResult.x;
        }
        maxChildX = Math.max(maxChildX, childResult.nextX);
      });

      // Äáº·t parent á»Ÿ giá»¯a children
      if (node.children.length > 0) {
        const firstChildX = node.children[0].x;
        const lastChildX = node.children[node.children.length - 1].x;
        node.x = (firstChildX + lastChildX) / 2;
      } else {
        node.x = levelPositions[depth] * horizontalSpacing + 20;
        levelPositions[depth]++;
      }

      return { x: childX, nextX: maxChildX };
    }


    /**
     * Render family tree vÃ o Activities section (Äá»i 1-5) - Horizontal Layout
     */
  </script>


  <!-- Load genealogy scripts -->
  <!-- Family tree scripts Ä‘Ã£ di chuyá»ƒn sang /genealogy -->
  <script src="/static/js/genealogy-lineage.js"></script>

  <script>
    // Generic fetch helper to ensure JSON responses and better error logging
    async function fetchJson(url, options) {
      const res = await fetch(url, options);
      const contentType = res.headers.get('Content-Type') || '';
      const text = await res.text();

      if (!res.ok) {
        console.error('HTTP error for', url, res.status, text);
        throw new Error(`HTTP ${res.status} when fetching ${url}`);
      }

      if (!contentType.includes('application/json')) {
        console.error('Non-JSON response for', url, 'contentType =', contentType, 'body =', text.slice(0, 300));
        throw new Error(`Expected JSON but got non-JSON response from ${url}`);
      }

      try {
        return JSON.parse(text);
      } catch (e) {
        console.error('JSON parse error for', url, 'body =', text.slice(0, 300));
        throw e;
      }
    }
  </script>
  
  <script>
    // ============================================
    // INTERACTIVE GENEALOGY TREE
    // ============================================
    
    // Load vis-network from CDN
    const visScript = document.createElement('script');
    visScript.src = 'https://unpkg.com/vis-network@latest/standalone/umd/vis-network.min.js';
    visScript.onload = () => {
      console.log('[Tree] vis-network loaded, initializing tree...');
      try {
        // initGenealogyTree(); // ÄÃ£ di chuyá»ƒn sang /genealogy
      } catch (err) {
        console.error('[Tree] Error initializing tree:', err);
        const container = document.getElementById('treeContainer');
        if (container) {
          container.innerHTML = `
            <div style="padding: 20px; color: #d32f2f; text-align: center;">
              <h3>Lá»—i khi khá»Ÿi táº¡o cÃ¢y gia pháº£</h3>
              <p>${err.message}</p>
              <p style="margin-top: 10px; font-size: 14px; color: #666;">
                Vui lÃ²ng kiá»ƒm tra console Ä‘á»ƒ biáº¿t thÃªm chi tiáº¿t.
              </p>
            </div>
          `;
        }
      }
    };
    visScript.onerror = () => {
      console.error('[Tree] Failed to load vis-network');
      const container = document.getElementById('treeContainer');
      if (container) {
        container.innerHTML = `
          <div style="padding: 20px; color: #d32f2f; text-align: center;">
            <h3>KhÃ´ng thá»ƒ táº£i thÆ° viá»‡n vis-network</h3>
            <p>Vui lÃ²ng kiá»ƒm tra káº¿t ná»‘i internet vÃ  thá»­ láº¡i.</p>
          </div>
        `;
      }
    };
    document.head.appendChild(visScript);
    
    const visStyle = document.createElement('link');
    visStyle.rel = 'stylesheet';
    visStyle.href = 'https://unpkg.com/vis-network@latest/styles/vis-network.min.css';
    document.head.appendChild(visStyle);

    let network = null;
    let currentRootId = 'P-1-1'; // Default: Vua Minh Máº¡ng (pháº£i lÃ  string, khÃ´ng pháº£i sá»‘)
    let currentMaxGen = 5;
    let treeData = null;

    async function initGenealogyTree() {
      console.log('[Tree] Initializing genealogy tree...');
      
      // Check if required elements exist
      const genFilter = document.getElementById('genFilter');
      const searchBtn = document.getElementById('searchBtn');
      const searchInput = document.getElementById('searchInput');
      const container = document.getElementById('treeContainer');
      
      if (!container) {
        console.error('[Tree] treeContainer not found');
        return;
      }
      
      // Load initial tree
      try {
        await loadTree(currentRootId, currentMaxGen);
      } catch (err) {
        console.error('[Tree] Error loading initial tree:', err);
        container.innerHTML = `
          <div style="padding: 20px; color: #d32f2f; text-align: center;">
            <h3>Lá»—i khi táº£i cÃ¢y gia pháº£</h3>
            <p>${err.message}</p>
          </div>
        `;
        return;
      }
      
      // Event listeners - with null checks
      if (genFilter) {
        genFilter.addEventListener('change', (e) => {
          currentMaxGen = parseInt(e.target.value);
          loadTree(currentRootId, currentMaxGen);
        });
      } else {
        console.warn('[Tree] genFilter element not found');
      }
      
      if (searchBtn) {
        searchBtn.addEventListener('click', handleSearch);
      } else {
        console.warn('[Tree] searchBtn element not found');
      }
      
      if (searchInput) {
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleSearch();
        });
      } else {
        console.warn('[Tree] searchInput element not found');
      }
      
      console.log('[Tree] Tree initialization complete');
    }

    async function loadTree(rootId, maxGen) {
      const container = document.getElementById('treeContainer');
      if (!container) {
        console.error('Tree container not found');
        return;
      }
      
      // Find or create loading element
      let loading = container.querySelector('.tree-loading');
      if (!loading) {
        loading = document.createElement('div');
        loading.className = 'tree-loading';
        loading.style.cssText = 'padding: 20px; text-align: center; color: #666;';
        container.innerHTML = '';
        container.appendChild(loading);
      }
      
      try {
        loading.style.display = 'block';
        loading.textContent = 'Äang káº¿t ná»‘i vá»›i API...';
        
        // Use AbortController for timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        
        const response = await fetch(`/api/tree?root_id=${rootId}&max_generation=${maxGen}`, {
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`API /api/tree tráº£ mÃ£ ${response.status}`);
        }
        
        loading.textContent = 'ÄÃ£ táº£i dá»¯ liá»‡u, Ä‘ang dá»±ng cÃ¢y...';
        
        treeData = await response.json();
        
        if (!treeData) {
          throw new Error('API tráº£ vá» dá»¯ liá»‡u rá»—ng');
        }
        
        // Convert tree to vis-network format
        const { nodes, edges } = convertTreeToVisFormat(treeData);
        
        // Create network
        const data = { nodes, edges };
        const options = {
          layout: {
            hierarchical: {
              direction: 'UD', // Up-Down
              sortMethod: 'directed',
              levelSeparation: 150, // Increased for better visibility
              nodeSpacing: 200, // Increased spacing between nodes
              treeSpacing: 250, // Increased spacing between trees
              blockShifting: true,
              edgeMinimization: true,
              parentCentralization: true
            }
          },
          nodes: {
            shape: 'box',
            font: { 
              size: 16,
              face: 'Arial, sans-serif',
              color: '#333'
            },
            borderWidth: 4,
            widthConstraint: { maximum: 280 },
            heightConstraint: { minimum: 60 },
            margin: 15,
            shadow: {
              enabled: true,
              color: 'rgba(0,0,0,0.2)',
              size: 5,
              x: 2,
              y: 2
            },
            shapeProperties: {
              borderRadius: 8
            }
          },
          edges: {
            arrows: { 
              to: { 
                enabled: true,
                scaleFactor: 1.2,
                type: 'arrow'
              } 
            },
            color: { 
              color: '#8B0000', 
              highlight: '#DAA520',
              hover: '#FF6347'
            },
            width: 3,
            smooth: {
              type: 'curvedCW',
              roundness: 0.2
            },
            shadow: {
              enabled: true,
              color: 'rgba(0,0,0,0.1)',
              size: 3
            }
          },
          physics: {
            enabled: false
          },
          interaction: {
            zoomView: true,
            dragView: true
          }
        };
        
        if (network) {
          network.destroy();
        }
        
        // Clear container and create network
        container.innerHTML = '';
        try {
          network = new vis.Network(container, data, options);
          
          // Node click handler
          network.on('click', (params) => {
            if (params.nodes.length > 0) {
              const nodeId = params.nodes[0]; // Giá»¯ nguyÃªn string, khÃ´ng parse thÃ nh sá»‘
              if (nodeId && nodeId !== 'NaN' && nodeId !== 'undefined') {
                showPersonInfo(nodeId);
              } else {
                console.warn('[Tree] Invalid nodeId:', nodeId);
              }
            }
          });
          
          console.log('[Tree] Network created successfully');
        } catch (err) {
          console.error('[Tree] Error creating network:', err);
          container.innerHTML = `
            <div style="padding: 20px; color: #d32f2f; text-align: center;">
              <h3>Lá»—i khi táº¡o cÃ¢y gia pháº£</h3>
              <p>${err.message}</p>
            </div>
          `;
          throw err;
        }
        
        // Load breadcrumb - ÄÃƒ XÃ“A (NÃ¢ng cáº¥p 1)
        // await loadBreadcrumb(rootId);
        
        loading.style.display = 'none';
      } catch (err) {
        console.error('Error loading tree:', err);
        loading.style.display = 'block';
        if (err.name === 'AbortError') {
          loading.innerHTML = 'API khÃ´ng pháº£n há»“i sau 30 giÃ¢y. Vui lÃ²ng kiá»ƒm tra káº¿t ná»‘i hoáº·c server.';
        } else {
          loading.innerHTML = `KhÃ´ng thá»ƒ káº¿t ná»‘i API (${err.message}).`;
        }
      }
    }

    function convertTreeToVisFormat(tree) {
      const nodes = [];
      const edges = [];
      const visited = new Set();
      
      function traverse(node, parentId = null) {
        if (!node || visited.has(node.person_id)) return;
        visited.add(node.person_id);
        
        // Add node with generation info in label
        const name = node.full_name || `Person ${node.person_id}`;
        const gen = node.generation_number || '';
        const status = node.status || '';
        
        // Label includes generation for clarity
        const label = gen ? `${name}\n(Äá»i ${gen})` : name;
        
        // Color by generation (different shades for different generations)
        let nodeColor = {
          background: '#fff',
          border: '#DAA520',
          highlight: {
            background: '#FFD700',
            border: '#8B0000'
          }
        };
        
        // Different colors for different generations - improved styling with rich colors
        if (gen === 1) {
          nodeColor.background = '#FFF8DC'; // Cream - Vua/Ancestor
          nodeColor.border = '#8B0000'; // Dark red
        } else if (gen === 2) {
          nodeColor.background = '#FFE4B5'; // Moccasin
          nodeColor.border = '#CD853F'; // Peru
        } else if (gen === 3) {
          nodeColor.background = '#FFFACD'; // Lemon chiffon
          nodeColor.border = '#DAA520'; // Goldenrod
        } else if (gen === 4) {
          nodeColor.background = '#F0E68C'; // Khaki
          nodeColor.border = '#B8860B'; // Dark goldenrod
        } else if (gen === 5) {
          nodeColor.background = '#FFFFE0'; // Light yellow
          nodeColor.border = '#9ACD32'; // Yellow green
        } else if (gen >= 6) {
          nodeColor.background = '#E6E6FA'; // Lavender
          nodeColor.border = '#9370DB'; // Medium purple
        }
        
        nodes.push({
          id: node.person_id,
          label: label,
          title: `${name}\nÄá»i: ${gen || 'N/A'}\nTráº¡ng thÃ¡i: ${status || 'N/A'}`,
          generation: gen,
          gender: node.gender,
          status: status,
          color: nodeColor
        });
        
        // Add edge from parent
        if (parentId !== null) {
          edges.push({
            from: parentId,
            to: node.person_id
          });
        }
        
        // Traverse children
        if (node.children && Array.isArray(node.children)) {
          for (const child of node.children) {
            traverse(child, node.person_id);
          }
        }
      }
      
      traverse(tree);
      return { nodes, edges };
    }

    async function handleSearch() {
      const searchInput = document.getElementById('searchInput');
      if (!searchInput) {
        console.warn('[Tree] searchInput not found');
        return;
      }
      const query = searchInput.value.trim();
      if (!query) return;
      
      const resultsDiv = document.getElementById('searchResults');
      if (!resultsDiv) {
        console.warn('[Tree] searchResults not found');
        return;
      }
      resultsDiv.style.display = 'block';
      resultsDiv.innerHTML = '<div style="padding: 10px; color: #666;">Äang tÃ¬m kiáº¿m...</div>';
      
      try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=30`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const results = await response.json();
        
        if (results.length === 0) {
          resultsDiv.innerHTML = '<div style="padding: 10px; color: #666;">KhÃ´ng tÃ¬m tháº¥y káº¿t quáº£</div>';
          return;
        }
        
        resultsDiv.innerHTML = results.map(person => {
          const gen = person.generation_number ? `Äá»i ${person.generation_number}` : '';
          const loc = person.origin_location ? `, ${person.origin_location}` : '';
          return `
            <div class="search-result" data-person-id="${person.person_id}" 
                 style="padding: 10px; margin: 5px 0; background: #f5f5f5; border-radius: 6px; cursor: pointer; border-left: 3px solid #DAA520;"
                 onmouseover="this.style.background='#FFE4B5'" 
                 onmouseout="this.style.background='#f5f5f5'">
              <strong>${escapeHtml(person.full_name)}</strong>
              ${person.common_name ? ` (${escapeHtml(person.common_name)})` : ''}
              ${gen ? ` - ${gen}` : ''}${loc}
            </div>
          `;
        }).join('');
        
        // Add click handlers
        if (resultsDiv) {
          resultsDiv.querySelectorAll('.search-result').forEach(el => {
            if (el) {
              el.addEventListener('click', () => {
                const personId = el.getAttribute('data-person-id'); // Giá»¯ nguyÃªn string, khÃ´ng parse thÃ nh sá»‘
                currentRootId = personId;
                if (resultsDiv) {
                  resultsDiv.style.display = 'none';
                }
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                  searchInput.value = '';
                }
                loadTree(personId, currentMaxGen);
              });
            }
          });
        }
      } catch (err) {
        console.error('Search error:', err);
        resultsDiv.innerHTML = `<div style="padding: 10px; color: #d32f2f;">Lá»—i: ${err.message}</div>`;
      }
    }

    // HÃ m loadBreadcrumb - ÄÃƒ XÃ“A (NÃ¢ng cáº¥p 1)
    /*
    async function loadBreadcrumb(personId) {
      const breadcrumbDiv = document.getElementById('breadcrumb');
      
      try {
        const response = await fetch(`/api/ancestors/${personId}`);
        if (!response.ok) return;
        
        const data = await response.json();
        const chain = data.ancestors_chain || [];
        
        if (chain.length > 0) {
          breadcrumbDiv.style.display = 'block';
          breadcrumbDiv.innerHTML = chain.map((p, i) => {
            const sep = i < chain.length - 1 ? ' â†’ ' : '';
            return `<span style="color: ${i === chain.length - 1 ? '#8B0000' : '#666'}; font-weight: ${i === chain.length - 1 ? '600' : '400'};">${escapeHtml(p.full_name)}</span>${sep}`;
          }).join('');
        } else {
          breadcrumbDiv.style.display = 'none';
        }
      } catch (err) {
        console.error('Breadcrumb error:', err);
        breadcrumbDiv.style.display = 'none';
      }
    }
    */

    async function showPersonInfo(personId) {
      const infoContent = document.getElementById('infoContent');
      if (!infoContent) {
        console.error('infoContent element not found');
        return;
      }
      
      infoContent.innerHTML = '<div style="padding: 10px; color: #666;">Äang táº£i thÃ´ng tin...</div>';
      
      try {
        // Load person details
        const [personRes, ancestorsRes, descendantsRes] = await Promise.all([
          fetch(`/api/person/${personId}`),
          fetch(`/api/ancestors/${personId}`),
          fetch(`/api/descendants/${personId}?max_depth=5`)
        ]);
        
        if (!personRes.ok) {
          throw new Error(`API /api/person/${personId} tráº£ mÃ£ ${personRes.status}`);
        }
        if (!ancestorsRes.ok) {
          console.warn(`API /api/ancestors/${personId} tráº£ mÃ£ ${ancestorsRes.status}`);
        }
        if (!descendantsRes.ok) {
          console.warn(`API /api/descendants/${personId} tráº£ mÃ£ ${descendantsRes.status}`);
        }
        
        const person = await personRes.json();
        const ancestors = ancestorsRes.ok ? await ancestorsRes.json() : { ancestors_chain: [] };
        const descendants = descendantsRes.ok ? await descendantsRes.json() : { descendants: [] };
        
        // FALLBACK: Náº¿u ancestors.ancestors_chain rá»—ng, thá»­ dÃ¹ng person.ancestors_chain
        let ancestors_chain = ancestors.ancestors_chain || [];
        if (!ancestors_chain || ancestors_chain.length === 0) {
            ancestors_chain = person.ancestors_chain || [];
            console.log(`[PersonInfo] Using fallback ancestors_chain from /api/person, length: ${ancestors_chain.length}`);
        }
        
        let html = `
          <div style="margin-bottom: 20px;">
            <h4 style="color: #8B0000; margin-bottom: 10px; font-size: 20px;">${escapeHtml(person.full_name || '')}</h4>
            ${person.common_name ? `<p style="color: #666; margin-bottom: 5px;"><strong>TÃªn thÆ°á»ng gá»i:</strong> ${escapeHtml(person.common_name)}</p>` : ''}
            ${person.generation_number ? `<p style="color: #666; margin-bottom: 5px;"><strong>Äá»i:</strong> ${person.generation_number}</p>` : ''}
            ${person.gender ? `<p style="color: #666; margin-bottom: 5px;"><strong>Giá»›i tÃ­nh:</strong> ${escapeHtml(person.gender)}</p>` : ''}
            ${person.status ? `<p style="color: #666; margin-bottom: 5px;"><strong>Tráº¡ng thÃ¡i:</strong> ${escapeHtml(person.status)}</p>` : ''}
            ${person.origin_location ? `<p style="color: #666; margin-bottom: 5px;"><strong>NguyÃªn quÃ¡n:</strong> ${escapeHtml(person.origin_location)}</p>` : ''}
          </div>
        `;
        
        // Ancestors - Debug log
        console.log(`[PersonInfo] ancestors_chain length: ${ancestors_chain ? ancestors_chain.length : 0}`);
        if (ancestors_chain && ancestors_chain.length > 0) {
          // Filter: loáº¡i bá» ngÆ°á»i hiá»‡n táº¡i (dá»±a trÃªn person_id) thay vÃ¬ slice(0, -1)
          // Äáº£m báº£o khÃ´ng bá» sÃ³t báº¥t ká»³ tá»• tiÃªn nÃ o
          const currentPersonId = String(person.person_id || '').trim();
          const ancestorsOnly = ancestors_chain.filter(p => {
            const pId = String(p.person_id || '').trim();
            return pId !== currentPersonId;
          });
          
          // Sáº¯p xáº¿p tá»• tiÃªn theo Ä‘á»i tÄƒng dáº§n (Ä‘á»i 1 â†’ Ä‘á»i 2 â†’ ... â†’ Ä‘á»i n)
          const sortedAncestors = ancestorsOnly.sort((a, b) => {
            const genA = a.generation_number || a.generation_level || 999;
            const genB = b.generation_number || b.generation_level || 999;
            return genA - genB;
          });
          
          if (sortedAncestors.length > 0) {
            html += `
              <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                <h5 style="color: #8B0000; margin-bottom: 10px; font-size: 16px;">Tá»• tiÃªn</h5>
                <div style="font-size: 14px; line-height: 1.8;">
                  ${sortedAncestors.map(p => 
                    `<div>${escapeHtml(p.full_name)} ${p.generation_number ? `(Äá»i ${p.generation_number})` : (p.generation_level ? `(Äá»i ${p.generation_level})` : '')}</div>`
                  ).join('')}
                </div>
              </div>
            `;
          }
        }
        
        // Descendants
        if (descendants.descendants && descendants.descendants.length > 0) {
          const byDepth = {};
          descendants.descendants.forEach(d => {
            if (!byDepth[d.depth]) byDepth[d.depth] = [];
            byDepth[d.depth].push(d);
          });
          
          html += `
            <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
              <h5 style="color: #8B0000; margin-bottom: 10px; font-size: 16px;">Con chÃ¡u</h5>
              ${Object.keys(byDepth).sort((a, b) => parseInt(a) - parseInt(b)).map(depth => {
                const depthLabel = depth === '1' ? 'Con' : depth === '2' ? 'ChÃ¡u' : `Äá»i thá»© ${depth}`;
                return `
                  <div style="margin-bottom: 10px;">
                    <strong style="color: #666; font-size: 14px;">${depthLabel}:</strong>
                    <div style="margin-left: 15px; font-size: 14px; line-height: 1.6;">
                      ${byDepth[depth].map(d => 
                        `<div>${escapeHtml(d.full_name)} ${d.generation_number ? `(Äá»i ${d.generation_number})` : ''}</div>`
                      ).join('')}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }
        
        infoContent.innerHTML = html;
        
        // Scroll info panel to top
        const infoPanel = document.getElementById('infoPanel');
        if (infoPanel) {
          infoPanel.scrollTop = 0;
        }
      } catch (err) {
        console.error('Error loading person info:', err);
        if (infoContent) {
          infoContent.innerHTML = `<div style="padding: 10px; color: #d32f2f;">Lá»—i: ${err.message}</div>`;
        }
      }
    }
    */
  </script>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h3>PhÃ²ng Tuy BiÃªn Quáº­n CÃ´ng</h3>
          <p>Gia Pháº£ Nguyá»…n PhÆ°á»›c Tá»™c</p>
        </div>
        
        <div class="footer-section">
          <h3>LiÃªn Há»‡</h3>
          <ul>
            <li>
              <a href="https://www.facebook.com/PhongTuyBienQuanCong" target="_blank" rel="noopener noreferrer">
                ğŸ“˜ Facebook PhÃ²ng Tuy BiÃªn Quáº­n CÃ´ng
              </a>
            </li>
          </ul>
        </div>
        
        <div class="footer-section">
          <h3>ThÃ´ng Tin</h3>
          <ul>
            <li><a href="/">Trang chá»§</a></li>
            <li><a href="/genealogy">Gia pháº£</a></li>
            <li><a href="/activities">Hoáº¡t Ä‘á»™ng</a></li>
            <li><a href="/members">ThÃ nh viÃªn</a></li>
          </ul>
        </div>
      </div>
      
      <!-- Countdown Section -->
      <div class="countdown-section">
        <div class="countdown-item">
          <div class="countdown-label">Giá»— XuÃ¢n 2026 (07/2 Ã‚L)</div>
          <div class="countdown-date">Nháº±m ngÃ y 25/03/2026</div>
          <div class="countdown-timer" id="countdown-xuan">
            <span class="countdown-value">--</span> ngÃ y 
            <span class="countdown-value">--</span> giá» 
            <span class="countdown-value">--</span> phÃºt 
            <span class="countdown-value">--</span> giÃ¢y
          </div>
        </div>
        <div class="countdown-item">
          <div class="countdown-label">Giá»— Thu 2026 (03/7 Ã‚L)</div>
          <div class="countdown-date">Nháº±m ngÃ y 15/08/2026</div>
          <div class="countdown-timer" id="countdown-thu">
            <span class="countdown-value">--</span> ngÃ y 
            <span class="countdown-value">--</span> giá» 
            <span class="countdown-value">--</span> phÃºt 
            <span class="countdown-value">--</span> giÃ¢y
          </div>
        </div>
      </div>
      
      <div class="footer-bottom">
        <p>&copy; 2025 PhÃ²ng Tuy BiÃªn Quáº­n CÃ´ng - Gia Pháº£ Nguyá»…n PhÆ°á»›c Tá»™c. Táº¥t cáº£ quyá»n Ä‘Æ°á»£c báº£o lÆ°u.</p>
      </div>
    </div>
  </footer>

  <style>
    /* Footer Styles */
    .footer {
      background: linear-gradient(135deg, rgba(139, 0, 0, 0.95) 0%, rgba(220, 20, 60, 0.95) 100%);
      color: #FFD700;
      padding: 60px 0 40px;
      margin-top: 80px;
      position: relative;
      overflow: hidden;
    }

    .footer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.05) 0%, rgba(218, 165, 32, 0.05) 100%);
      pointer-events: none;
    }

    .footer .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      position: relative;
      z-index: 1;
    }

    .footer-content {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 48px;
      margin-bottom: 48px;
    }

    .footer-section h3 {
      color: #FFD700;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .footer-section p,
    .footer-section ul {
      font-size: 14px;
      line-height: 1.8;
      color: #FFD700;
    }

    .footer-section ul {
      list-style: none;
      padding: 0;
    }

    .footer-section ul li {
      margin-bottom: 12px;
    }

    .footer-section a {
      color: #FFD700;
      text-decoration: none;
      transition: all 0.3s ease;
      display: inline-block;
    }

    .footer-section a:hover {
      color: #FFFFFF;
      transform: translateX(3px);
    }

    .countdown-section {
      margin: 40px 0;
      padding: 30px 0;
      border-top: 1px solid rgba(255, 215, 0, 0.3);
      border-bottom: 1px solid rgba(255, 215, 0, 0.3);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
    }
    
    .countdown-item {
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(218, 165, 32, 0.15) 100%);
      border-radius: 8px;
      border: 1px solid rgba(255, 215, 0, 0.5);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .countdown-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 215, 0, 0.2);
    }
    
    .countdown-label {
      font-size: 18px;
      font-weight: 600;
      color: #FFD700;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .countdown-date {
      font-size: 14px;
      color: #FFD700;
      margin-bottom: 15px;
    }
    
    .countdown-timer {
      font-size: 16px;
      color: #FFD700;
      font-weight: 500;
    }
    
    .countdown-value {
      color: #FFD700;
      font-weight: 700;
      font-size: 18px;
      margin: 0 4px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    @media (max-width: 768px) {
      .countdown-section {
        grid-template-columns: 1fr;
        gap: 20px;
      }
    }

    .footer-bottom {
      padding-top: 30px;
      border-top: 1px solid rgba(255, 215, 0, 0.3);
      text-align: center;
      font-size: 14px;
      color: #FFD700;
    }

    @media (max-width: 767px) {
      .footer-content {
        grid-template-columns: 1fr;
        gap: 30px;
      }
    }
  </style>

  <script>
    // Countdown timer cho Giá»— XuÃ¢n vÃ  Giá»— Thu
    function updateCountdown() {
      // NgÃ y Giá»— XuÃ¢n 2026: 25/03/2026
      const xuanDate = new Date('2026-03-25T00:00:00');
      // NgÃ y Giá»— Thu 2026: 15/08/2026
      const thuDate = new Date('2026-08-15T00:00:00');
      
      const now = new Date();
      
      // TÃ­nh toÃ¡n cho Giá»— XuÃ¢n
      let xuanDiff = xuanDate - now;
      const xuanTimer = document.getElementById('countdown-xuan');
      if (xuanTimer) {
        if (xuanDiff < 0) {
          xuanTimer.innerHTML = '<span style="color: #94A3B8;">ÄÃ£ qua</span>';
        } else {
          const xuanDays = Math.floor(xuanDiff / (1000 * 60 * 60 * 24));
          const xuanHours = Math.floor((xuanDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const xuanMinutes = Math.floor((xuanDiff % (1000 * 60 * 60)) / (1000 * 60));
          const xuanSeconds = Math.floor((xuanDiff % (1000 * 60)) / 1000);
          
          xuanTimer.innerHTML = `
            <span class="countdown-value">${xuanDays}</span> ngÃ y 
            <span class="countdown-value">${xuanHours}</span> giá» 
            <span class="countdown-value">${xuanMinutes}</span> phÃºt 
            <span class="countdown-value">${xuanSeconds}</span> giÃ¢y
          `;
        }
      }
      
      // TÃ­nh toÃ¡n cho Giá»— Thu
      let thuDiff = thuDate - now;
      const thuTimer = document.getElementById('countdown-thu');
      if (thuTimer) {
        if (thuDiff < 0) {
          thuTimer.innerHTML = '<span style="color: #94A3B8;">ÄÃ£ qua</span>';
        } else {
          const thuDays = Math.floor(thuDiff / (1000 * 60 * 60 * 24));
          const thuHours = Math.floor((thuDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const thuMinutes = Math.floor((thuDiff % (1000 * 60 * 60)) / (1000 * 60));
          const thuSeconds = Math.floor((thuDiff % (1000 * 60)) / 1000);
          
          thuTimer.innerHTML = `
            <span class="countdown-value">${thuDays}</span> ngÃ y 
            <span class="countdown-value">${thuHours}</span> giá» 
            <span class="countdown-value">${thuMinutes}</span> phÃºt 
            <span class="countdown-value">${thuSeconds}</span> giÃ¢y
          `;
        }
      }
    }
    
    // Cáº­p nháº­t countdown má»—i giÃ¢y
    updateCountdown();
    setInterval(updateCountdown, 1000);
  </script>

</body>
</html>

