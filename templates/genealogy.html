<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gia Ph·∫£ - Gia Ph·∫£ Nguy·ªÖn Ph∆∞·ªõc T·ªôc</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/main.css">
  <style>
    /* Page-specific styles */
    .genealogy-page {
      padding-top: var(--space-8);
      padding-bottom: var(--space-10);
      width: 100%;
      max-width: 100%;
    }
    
    /* Override container max-width ƒë·ªÉ full width */
    .genealogy-page .container {
      max-width: 100% !important;
      width: 100% !important;
      padding-left: var(--space-4);
      padding-right: var(--space-4);
    }
    
    .page-header {
      text-align: center;
      margin-bottom: var(--space-8);
    }
    
    .page-header h1 {
      font-size: var(--font-size-4xl);
      color: var(--color-primary);
      margin-bottom: var(--space-3);
    }
    
    .page-subtitle {
      font-size: var(--font-size-lg);
      color: var(--color-text-muted);
    }
    
    /* Layout d·ªçc: C√¢y tr√™n, Tra c·ª©u d∆∞·ªõi */
    .genealogy-layout {
      display: flex;
      flex-direction: column;
      gap: var(--space-8);
      margin-top: var(--space-6);
    }
    
    /* Ph·∫ßn tr√™n: C√¢y t∆∞∆°ng t√°c */
    .tree-section {
      width: 100%;
      max-width: 100%;
    }
    
    .tree-panel {
      width: 100%;
      max-width: 100%;
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: var(--space-4);
      align-items: start;
    }
    
    .tree-container-wrapper {
      grid-column: 1;
    }
    
    .tree-info-panel {
      grid-column: 2;
    }
    
    @media (max-width: 1200px) {
      .tree-panel {
        grid-template-columns: 1fr;
      }
      
      .tree-container-wrapper {
        grid-column: 1;
      }
      
      .tree-info-panel {
        grid-column: 1;
        order: -1;
        max-height: 300px;
      }
    }
    
    /* Ph·∫ßn d∆∞·ªõi: Tra c·ª©u */
    .lineage-panel {
      width: 100%;
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .lineage-card {
      padding: var(--space-6);
    }
    
    .lineage-header h2 {
      font-size: var(--font-size-xl);
      color: var(--color-primary);
      margin-bottom: var(--space-2);
    }
    
    .lineage-header p {
      color: var(--color-text-muted);
      font-size: var(--font-size-sm);
      margin-bottom: var(--space-4);
    }
    
    .lineage-controls {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }
    
    .lineage-input-group {
      position: relative;
    }
    
    .lineage-input-group label {
      display: block;
      margin-bottom: var(--space-2);
      font-weight: var(--font-weight-semibold);
      color: var(--color-primary);
      font-size: var(--font-size-sm);
    }
    
    .lineage-input-group input {
      width: 100%;
      height: 44px;
      padding: 0 var(--space-4);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
    }
    
    .lineage-input-group input:focus {
      outline: 2px solid rgba(139, 0, 0, 0.25);
      border-color: var(--color-primary);
    }
    
    .suggestions-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      margin-top: var(--space-1);
    }
    
    .suggestion-item {
      padding: var(--space-3) var(--space-4);
      cursor: pointer;
      border-bottom: 1px solid var(--color-border);
      transition: background var(--transition-fast);
    }
    
    .suggestion-item:hover {
      background: var(--color-bg);
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .lineage-result {
      margin-top: var(--space-4);
      padding: var(--space-5);
    }
    
    .lineage-result-header h3 {
      color: var(--color-primary);
      margin-bottom: var(--space-4);
    }
    
    .lineage-result-content {
      color: var(--color-text);
      line-height: var(--line-height-relaxed);
    }
    
      text-align: center;
      color: var(--color-text-muted);
    }
    
    .lineage-detail-panel {
      margin-top: var(--space-4);
      padding: var(--space-5);
      max-height: 400px;
      overflow-y: auto;
    }
    
    .detail-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-border);
    }
    
    .detail-panel-header h3 {
      color: var(--color-primary);
      margin: 0;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: var(--font-size-2xl);
      color: var(--color-text-muted);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
    }
    
    .close-btn:hover {
      background: var(--color-bg);
      color: var(--color-text);
    }
    
    /* C√¢y t∆∞∆°ng t√°c */
    .tree-panel {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
      width: 100%;
    }
    
    .tree-controls {
      padding: var(--space-5);
    }
    
    .tree-controls-row {
      display: flex;
      gap: var(--space-4);
      flex-wrap: wrap;
      align-items: center;
    }
    
    .tree-controls-row label {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--font-size-sm);
      color: var(--color-text);
    }
    
    .tree-controls-row .input-group {
      flex: 1;
      min-width: 300px;
    }
    
    .tree-controls-row .input-group input {
      width: 100%;
    }
    
    .tree-container-wrapper {
      position: relative;
      height: 70vh;
      min-height: 600px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      overflow: auto;
      background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%);
      /* Full width - m·ªü r·ªông full ngang */
      width: 100%;
      max-width: 100%;
      /* Smooth scrolling */
      scroll-behavior: smooth;
    }
    
    /* Custom scrollbar */
    .tree-container-wrapper::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }
    
    .tree-container-wrapper::-webkit-scrollbar-track {
      background: var(--color-bg);
      border-radius: var(--radius-sm);
    }
    
    .tree-container-wrapper::-webkit-scrollbar-thumb {
      background: var(--color-primary);
      border-radius: var(--radius-sm);
    }
    
    .tree-container-wrapper::-webkit-scrollbar-thumb:hover {
      background: var(--color-primary-strong);
    }
    
    #treeContainer {
      width: 100%;
      height: 100%;
      min-height: 100%;
      position: relative;
      /* Cho ph√©p tree m·ªü r·ªông v∆∞·ª£t qu√° container ƒë·ªÉ c√≥ scroll ngang */
      overflow: visible;
    }
    
    /* Tree container c·∫ßn c√≥ width l·ªõn h∆°n ƒë·ªÉ scroll ngang */
    #treeContainer .tree {
      min-width: 2000px;
      width: auto;
      height: 100%;
      position: relative;
      overflow: visible;
    }
    
    /* ƒê·∫£m b·∫£o tree c√≥ th·ªÉ m·ªü r·ªông theo chi·ªÅu ngang */
    #treeContainer > div {
      min-width: 2000px;
      width: auto;
    }
    
    /* Tree Node Styles */
    #treeContainer .node {
      position: absolute;
      width: 140px;
      min-height: 100px;
      background: var(--color-surface);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-2);
      box-shadow: var(--shadow-sm);
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    
    #treeContainer .node:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      border-color: var(--color-primary);
      z-index: 20;
    }
    
    #treeContainer .node.founder {
      background: linear-gradient(135deg, #FFF8DC 0%, #FFE4B5 100%);
      border-color: var(--color-primary);
      border-width: 3px;
      font-weight: var(--font-weight-bold);
    }
    
    #treeContainer .node.male {
      background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
      border-color: #1976D2;
    }
    
    #treeContainer .node.female {
      background: linear-gradient(135deg, #FCE4EC 0%, #F8BBD0 100%);
      border-color: #C2185B;
    }
    
    #treeContainer .node.dead {
      opacity: 0.7;
      border-style: dashed;
    }
    
    #treeContainer .node.highlighted {
      border-color: #FF6B35;
      border-width: 3px;
      box-shadow: 0 0 15px rgba(255, 107, 53, 0.5);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 0 15px rgba(255, 107, 53, 0.5);
      }
      50% {
        box-shadow: 0 0 25px rgba(255, 107, 53, 0.8);
      }
    }
    
    #treeContainer .node-name {
      font-size: 11px;
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      margin-bottom: 4px;
      line-height: 1.2;
      word-wrap: break-word;
      overflow-wrap: break-word;
      hyphens: auto;
    }
    
    #treeContainer .node-parents {
      font-size: 9px;
      color: var(--color-text-muted);
      margin-bottom: 4px;
      line-height: 1.2;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    #treeContainer .node-generation {
      display: inline-block;
      background: var(--color-primary);
      color: var(--color-surface);
      font-size: 9px;
      font-weight: var(--font-weight-bold);
      padding: 2px 6px;
      border-radius: var(--radius-full);
      margin-top: 2px;
    }
    
    /* Minimal Family Tree Styles */
    #minimalTreeContainer {
      position: relative;
      width: 100%;
      height: 70vh;
      min-height: 600px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%);
      cursor: grab;
    }
    
    #minimalTreeContainer:active {
      cursor: grabbing;
    }
    
    .minimal-tree-node {
      position: absolute;
      background: var(--color-surface);
      border: 2px solid var(--color-primary);
      border-radius: var(--radius-md);
      padding: var(--space-2);
      box-shadow: var(--shadow-md);
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: center;
    }
    
    .minimal-tree-node:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
      border-color: #8B0000;
    }
    
    .minimal-tree-node .node-id {
      font-size: 10px;
      font-weight: var(--font-weight-bold);
      color: var(--color-primary);
      margin-bottom: 2px;
      font-family: 'Courier New', monospace;
    }
    
    .minimal-tree-node .node-name {
      font-size: 13px;
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      margin-bottom: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .minimal-tree-node .node-lifespan {
      font-size: 10px;
      color: var(--color-text-muted);
      font-family: 'Courier New', monospace;
    }
    
    .minimal-tree-controls {
      display: flex;
      gap: var(--space-3);
      padding: var(--space-4);
      background: var(--color-surface);
      border-bottom: 1px solid var(--color-border);
      flex-wrap: wrap;
      align-items: center;
    }
    
    .minimal-tree-controls button {
      padding: var(--space-2) var(--space-4);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-surface);
      color: var(--color-text);
      cursor: pointer;
      font-size: var(--font-size-sm);
      transition: all var(--transition-fast);
    }
    
    .minimal-tree-controls button:hover {
      background: var(--color-primary);
      color: var(--color-surface);
      border-color: var(--color-primary);
    }
    
    .minimal-tree-controls input[type="number"] {
      width: 60px;
      padding: var(--space-2);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
    }
    
    .minimal-tree-controls input[type="text"] {
      flex: 1;
      min-width: 200px;
      padding: var(--space-2) var(--space-4);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
    }
    
    @media (max-width: 768px) {
      .minimal-tree-node {
        padding: var(--space-1);
      }
      
      .minimal-tree-node .node-id {
        font-size: 9px;
      }
      
      .minimal-tree-node .node-name {
        font-size: 12px;
      }
      
      .minimal-tree-node .node-lifespan {
        font-size: 9px;
      }
    }
    
    /* Connector Styles */
    /* Connector Styles - C·∫£i thi·ªán ƒë·ªÉ ƒë·∫πp h∆°n */
    #treeContainer .connector {
      position: absolute;
      z-index: 1;
      pointer-events: none;
      transition: all 0.3s ease;
    }
    
    #treeContainer .connector.vertical {
      background: linear-gradient(to bottom, #8B0000 0%, #A52A2A 50%, #CD5C5C 100%);
      width: 4px;
      border-radius: 2px;
      box-shadow: 0 2px 8px rgba(139, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    #treeContainer .connector.horizontal {
      background: linear-gradient(to right, #8B0000 0%, #A52A2A 50%, #CD5C5C 100%);
      height: 4px;
      border-radius: 2px;
      box-shadow: 0 2px 8px rgba(139, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    /* Hover effect cho connectors khi hover v√†o node */
    #treeContainer .node:hover ~ .connector,
    #treeContainer .node:hover + .connector {
      box-shadow: 0 4px 12px rgba(139, 0, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    .tree-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: var(--font-size-lg);
      color: var(--color-primary);
      font-weight: var(--font-weight-semibold);
    }
    
    .tree-info-panel {
      padding: var(--space-5);
      max-height: 70vh;
      overflow-y: auto;
      position: sticky;
      top: var(--space-4);
      background: var(--color-surface);
      box-shadow: var(--shadow-md);
    }
    
    .tree-info-panel h3 {
      color: var(--color-primary);
      margin-bottom: var(--space-4);
      font-size: var(--font-size-lg);
    }
    
    .tree-info-content {
      color: var(--color-text);
      line-height: var(--line-height-relaxed);
    }
    
    .tree-info-content p {
      color: var(--color-text-muted);
      font-style: italic;
    }
    
    #searchResults {
      margin-top: var(--space-4);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      background: var(--color-bg);
      display: none;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .search-result-item {
      padding: var(--space-3) var(--space-4);
      margin: var(--space-2) 0;
      background: var(--color-surface);
      border-radius: var(--radius-md);
      cursor: pointer;
      border-left: 3px solid var(--color-primary);
      transition: all var(--transition-fast);
    }
    
    .search-result-item:hover {
      background: var(--color-bg);
      transform: translateX(4px);
    }
    
    /* Mobile responsive */
    @media (max-width: 1023px) {
      .tree-container-wrapper {
        height: 60vh;
        min-height: 500px;
      }
      
      .tree-controls-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .tree-controls-row .input-group {
        min-width: auto;
      }
      
      .lineage-panel {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="/" class="navbar-logo">Ph√≤ng Tuy Bi√™n Qu·∫≠n C√¥ng ‚Äì Gia Ph·∫£ Nguy·ªÖn Ph∆∞·ªõc T·ªôc</a>
    <button class="navbar-toggle" onclick="toggleNavbar()">‚ò∞</button>
    <ul class="navbar-menu" id="navbarMenu">
      <li><a href="/">Trang ch·ªß</a></li>
      <li><a href="/genealogy" class="active">Gia ph·∫£</a></li>
      <li><a href="/activities">Ho·∫°t ƒë·ªông</a></li>
      <li><a href="/members">Th√†nh vi√™n</a></li>
      <li><a href="/contact">Li√™n h·ªá</a></li>
      <li><a href="/login">ƒêƒÉng nh·∫≠p</a></li>
    </ul>
  </nav>

  <div class="container genealogy-page">
    <div class="page-header">
      <h1>C√¢y Gia Ph·∫£</h1>
      <p class="page-subtitle">C√¢y Gia Ph·∫£ T∆∞∆°ng T√°c v√† Tra C·ª©u Chu·ªói Ph·∫£ H·ªá</p>
    </div>

    <div class="genealogy-layout">
      <!-- Ph·∫ßn tr√™n: C√¢y t∆∞∆°ng t√°c -->
      <div class="tree-section">
        <div class="tree-panel">
          <div class="card tree-controls">
            <div class="tree-controls-row">
              <label>
                <span>Hi·ªÉn th·ªã ƒë·∫øn ƒë·ªùi:</span>
                <select id="genFilter" class="select">
                  <!-- Options will be populated dynamically by JavaScript -->
                </select>
              </label>
              
              <div class="input-group" style="flex: 1; min-width: 300px;">
                <input type="text" class="input" id="searchInput" placeholder="Vui l√≤ng nh·∫≠p t√™n c·∫ßn t√¨m ki·∫øm">
              </div>
              <button id="searchBtn" class="btn btn-primary">T√¨m ki·∫øm</button>
            </div>
            
            <!-- Search Results -->
            <div id="searchResults" style="margin-top: var(--space-4); display: none;"></div>
          </div>
          
          <!-- Tree Container -->
          <div class="tree-container-wrapper">
            <div id="treeContainer">
              <div class="tree-loading">ƒêang t·∫£i c√¢y gia ph·∫£...</div>
            </div>
          </div>
          
          <!-- Info Panel -->
          <div class="card tree-info-panel" id="infoPanel">
            <h3>Th√¥ng tin chi ti·∫øt</h3>
            <div class="tree-info-content" id="infoContent">
              <p>Ch·ªçn m·ªôt ng∆∞·ªùi trong c√¢y ƒë·ªÉ xem th√¥ng tin</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Ph·∫ßn d∆∞·ªõi: Tra c·ª©u chu·ªói ph·∫£ h·ªá -->
      <div class="lineage-panel">
        <div class="card lineage-card">
          <div class="lineage-header">
            <h2>üîç Tra c·ª©u chu·ªói ph·∫£ h·ªá</h2>
            <p>Nh·∫≠p t√™n ƒë·ªÉ t√¨m ki·∫øm chu·ªói ph·∫£ h·ªá theo d√≤ng cha. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª£i √Ω.</p>
          </div>
          
          <div class="lineage-controls">
            <div class="lineage-input-group">
              <label for="lineageName">T√™n (t√¨m ki·∫øm th√¥ng minh):</label>
              <input type="text" class="input" id="lineageName" placeholder="V√≠ d·ª•: B·∫£o Phong ho·∫∑c Bao Ph..." 
                     autocomplete="off" oninput="handleLineageSearchInput()">
              <div id="lineageSuggestions" class="suggestions-dropdown" style="display: none;">
                <!-- Suggestions s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
              </div>
            </div>
            <button id="btnSearchLineage" onclick="searchLineage()" class="btn btn-primary">üîç T√¨m chu·ªói ph·∫£ h·ªá</button>
          </div>

          <!-- Panel th√¥ng tin chi ti·∫øt -->
          <div class="lineage-detail-panel card" id="lineageDetailPanel" style="display: none;">
            <div class="detail-panel-header">
              <h3>üìã Th√¥ng tin chi ti·∫øt</h3>
              <button onclick="closeDetailPanel()" class="close-btn">&times;</button>
            </div>
            <div class="detail-panel-content" id="lineageDetailContent">
              <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
            </div>
          </div>

          <!-- K·∫øt qu·∫£ tra c·ª©u -->
          <div class="lineage-result card" id="lineageResult" style="display: none;">
            <div class="lineage-result-header">
              <h3 id="lineageResultTitle"></h3>
            </div>
            <div class="lineage-result-content" id="lineageResultContent">
              <!-- K·∫øt qu·∫£ s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
            </div>
          </div>
        </div>
      </div>

      <!-- Ph·∫ßn t√¨m ki·∫øm m·ªô ph·∫ßn -->
      <div class="grave-search-panel" style="margin-top: var(--space-8);">
        <div class="card lineage-card">
          <div class="lineage-header">
            <h2>ü™¶ T√¨m ki·∫øm m·ªô ph·∫ßn</h2>
            <p>T√¨m ki·∫øm th√¥ng tin m·ªô ph·∫ßn c·ªßa nh·ªØng ng∆∞·ªùi ƒë√£ m·∫•t. H·ªá th·ªëng s·∫Ω hi·ªÉn th·ªã v·ªã tr√≠ tr√™n b·∫£n ƒë·ªì.</p>
          </div>
          
          <div class="lineage-controls">
            <div class="lineage-input-group">
              <label for="graveSearchInput">T√™n ho·∫∑c ID (t√¨m ki·∫øm th√¥ng minh):</label>
              <input type="text" class="input" id="graveSearchInput" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A ho·∫∑c P-1-1..." 
                     autocomplete="off" oninput="handleGraveSearchInput()">
              <div id="graveSearchSuggestions" class="suggestions-dropdown" style="display: none;">
                <!-- Suggestions s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
              </div>
            </div>
            <button id="btnSearchGrave" onclick="searchGrave()" class="btn btn-primary">üîç T√¨m m·ªô ph·∫ßn</button>
          </div>

          <!-- K·∫øt qu·∫£ t√¨m ki·∫øm m·ªô ph·∫ßn -->
          <div class="grave-result card" id="graveResult" style="display: none; margin-top: var(--space-4);">
            <div class="grave-result-header" style="margin-bottom: var(--space-4);">
              <h3 id="graveResultTitle" style="color: var(--color-primary); margin-bottom: var(--space-2);"></h3>
            </div>
            
            <div class="grave-info-section" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-4);">
              <!-- Th√¥ng tin ng∆∞·ªùi -->
              <div class="card" style="padding: var(--space-4);">
                <h4 style="color: var(--color-primary); margin-bottom: var(--space-3); font-size: var(--font-size-lg);">Th√¥ng tin ng∆∞·ªùi</h4>
                <div id="gravePersonInfo" style="line-height: 1.8; color: var(--color-text);">
                  <!-- Th√¥ng tin s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
                </div>
              </div>
              
              <!-- Th√¥ng tin m·ªô ph·∫ßn -->
              <div class="card" style="padding: var(--space-4);">
                <h4 style="color: var(--color-primary); margin-bottom: var(--space-3); font-size: var(--font-size-lg);">Th√¥ng tin m·ªô ph·∫ßn</h4>
                <div id="graveInfoText" style="line-height: 1.8; color: var(--color-text); margin-bottom: var(--space-3);">
                  <!-- Th√¥ng tin m·ªô ph·∫ßn s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
                </div>
                <div id="graveCoordinates" style="font-size: var(--font-size-sm); color: var(--color-text-muted); font-family: monospace;">
                  <!-- T·ªça ƒë·ªô s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>
              </div>
            </div>

            <!-- B·∫£n ƒë·ªì -->
            <div class="grave-map-section" style="margin-bottom: var(--space-4);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-3);">
                <h4 style="color: var(--color-primary); font-size: var(--font-size-lg); margin: 0;">B·∫£n ƒë·ªì ƒë·ªãnh v·ªã</h4>
                <button id="btnUpdateGraveLocation" onclick="enableGraveLocationEdit()" class="btn" style="background: var(--color-surface); border: 1px solid var(--color-border);">
                  ‚úèÔ∏è C·∫≠p nh·∫≠t v·ªã tr√≠
                </button>
              </div>
              <div id="graveMap" style="width: 100%; height: 400px; border: 1px solid var(--color-border); border-radius: var(--radius-md); position: relative;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--color-text-muted);">
                  ƒêang t·∫£i b·∫£n ƒë·ªì...
                </div>
              </div>
              <div id="graveMapControls" style="display: none; margin-top: var(--space-3); padding: var(--space-4); background: var(--color-bg); border-radius: var(--radius-md);">
                <p style="color: var(--color-text-muted); margin-bottom: var(--space-3);">
                  üí° T√¨m ki·∫øm ƒë·ªãa ch·ªâ ho·∫∑c nh·∫•p v√†o b·∫£n ƒë·ªì ƒë·ªÉ ƒë·∫∑t marker t·∫°i v·ªã tr√≠ m·ªô ph·∫ßn. Sau ƒë√≥ nh·∫•n "L∆∞u" ƒë·ªÉ c·∫≠p nh·∫≠t.
                </p>
                
                <!-- Thanh t√¨m ki·∫øm ƒë·ªãa ch·ªâ -->
                <div style="margin-bottom: var(--space-3);">
                  <label for="graveAddressSearch" style="display: block; margin-bottom: var(--space-2); font-weight: var(--font-weight-semibold); color: var(--color-primary); font-size: var(--font-size-sm);">
                    üîç T√¨m ki·∫øm ƒë·ªãa ch·ªâ:
                  </label>
                  <div style="display: flex; gap: var(--space-2);">
                    <input type="text" id="graveAddressSearch" placeholder="V√≠ d·ª•: Ph√∫ Th∆∞·ª£ng, Ph√∫ Vang, Th·ª´a Thi√™n Hu·∫ø" 
                           class="input" style="flex: 1;" 
                           onkeypress="if(event.key==='Enter') searchGraveAddress()">
                    <button onclick="searchGraveAddress()" class="btn btn-primary" style="white-space: nowrap;">
                      T√¨m ki·∫øm
                    </button>
                  </div>
                  <div id="graveAddressSuggestions" style="display: none; margin-top: var(--space-2); max-height: 200px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface);">
                    <!-- Suggestions s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
                  </div>
                </div>
                
                <!-- N√∫t ƒë·ªãnh v·ªã b·∫±ng ƒëi·ªán tho·∫°i -->
                <div style="margin-bottom: var(--space-3); padding: var(--space-3); background: var(--color-surface); border-radius: var(--radius-md); border: 1px solid var(--color-border);">
                  <p style="color: var(--color-text-muted); margin-bottom: var(--space-2); font-size: var(--font-size-sm);">
                    üì± ƒê·ªãnh v·ªã b·∫±ng ƒëi·ªán tho·∫°i:
                  </p>
                  <button id="btnGetCurrentLocation" onclick="getCurrentLocation()" class="btn btn-primary" style="width: 100%;">
                    üìç ƒê·ªãnh v·ªã b·∫±ng ƒëi·ªán tho·∫°i
                  </button>
                  <div id="locationStatus" style="margin-top: var(--space-2); font-size: var(--font-size-sm); color: var(--color-text-muted); display: none;"></div>
                </div>
                
                <div style="display: flex; gap: var(--space-3); align-items: center;">
                  <button id="btnSaveGraveLocation" onclick="saveGraveLocation()" class="btn btn-primary">
                    üíæ L∆∞u v·ªã tr√≠
                  </button>
                  <button id="btnCancelGraveLocation" onclick="cancelGraveLocationEdit()" class="btn" style="background: var(--color-surface); border: 1px solid var(--color-border);">
                    H·ªßy
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>


      <!-- Section: Member Stats -->
      <section id="stats" style="margin-top: var(--space-10);">
        <div class="section-container" style="max-width: 1200px; margin: 0 auto; padding: 0 var(--space-4);">
          <h2 class="section-title" style="text-align: center; font-size: var(--font-size-3xl); color: var(--color-primary); margin-bottom: var(--space-4);">Th·ªëng K√™ Th√†nh Vi√™n</h2>
          <p class="stats-subtitle" style="text-align: center; color: var(--color-text-muted); margin-bottom: var(--space-6); font-size: var(--font-size-base);">
            Th·ªëng k√™ nhanh s·ªë l∆∞·ª£ng th√†nh vi√™n trong gia ph·∫£ Tuy Bi√™n Ph√≤ng ‚Äì Nam, N·ªØ v√† c√°c tr∆∞·ªùng h·ª£p ch∆∞a r√µ.
          </p>

          <div class="stats-layout" style="display: grid; grid-template-columns: 1.2fr 2fr; gap: var(--space-8); align-items: stretch;">
            <div class="stats-summary" style="display: grid; grid-template-columns: 1fr; gap: var(--space-4);">
              <div class="stats-card card" style="border-left: 5px solid var(--color-primary);">
                <div class="stats-label" style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">T·ªïng th√†nh vi√™n</div>
                <div class="stats-value" id="statsTotalMembers" style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
              <div class="stats-card card" style="border-left: 5px solid var(--color-primary);">
                <div class="stats-label" style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">S·ªë Nam</div>
                <div class="stats-value" id="statsMaleCount" style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
              <div class="stats-card card" style="border-left: 5px solid var(--color-primary);">
                <div class="stats-label" style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">S·ªë N·ªØ</div>
                <div class="stats-value" id="statsFemaleCount" style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
              <div class="stats-card card" style="border-left: 5px solid var(--color-primary);">
                <div class="stats-label" style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">Kh√¥ng r√µ / kh√°c</div>
                <div class="stats-value" id="statsUnknownCount" style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
            </div>

            <div class="stats-charts" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-5);">
              <div class="stats-chart-card card">
                <h3 style="margin-bottom: var(--space-3); font-size: var(--font-size-base); color: var(--color-primary); text-align: center;">C∆° c·∫•u gi·ªõi t√≠nh</h3>
                <canvas id="genderPieChart"></canvas>
              </div>
              <div class="stats-chart-card card">
                <h3 style="margin-bottom: var(--space-3); font-size: var(--font-size-base); color: var(--color-primary); text-align: center;">Th√†nh vi√™n theo gi·ªõi t√≠nh</h3>
                <canvas id="genderBarChart"></canvas>
              </div>
            </div>
          </div>

          <!-- Th·ªëng k√™ theo ƒë·ªùi -->
          <div class="generation-stats-section" style="margin-top: var(--space-8);">
            <h3 style="text-align: center; font-size: var(--font-size-xl); color: var(--color-primary); margin-bottom: var(--space-5);">Th·ªëng K√™ Theo ƒê·ªùi</h3>
            <div class="generation-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6);">
              <div class="generation-stat-card card" id="gen1Card" style="text-align: center; padding: var(--space-4); border-left: 4px solid var(--color-primary);">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">ƒê·ªùi 1</div>
                <div class="generation-stat-value" id="gen1Count" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
              <div class="generation-stat-card card" id="gen2Card" style="text-align: center; padding: var(--space-4); border-left: 4px solid var(--color-primary);">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">ƒê·ªùi 2</div>
                <div class="generation-stat-value" id="gen2Count" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
              <div class="generation-stat-card card" id="gen3Card" style="text-align: center; padding: var(--space-4); border-left: 4px solid var(--color-primary);">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">ƒê·ªùi 3</div>
                <div class="generation-stat-value" id="gen3Count" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
              <div class="generation-stat-card card" id="gen4Card" style="text-align: center; padding: var(--space-4); border-left: 4px solid var(--color-primary);">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">ƒê·ªùi 4</div>
                <div class="generation-stat-value" id="gen4Count" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
              <div class="generation-stat-card card" id="gen5Card" style="text-align: center; padding: var(--space-4); border-left: 4px solid var(--color-primary);">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">ƒê·ªùi 5</div>
                <div class="generation-stat-value" id="gen5Count" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
              <div class="generation-stat-card card" id="gen6Card" style="text-align: center; padding: var(--space-4); border-left: 4px solid var(--color-primary);">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">ƒê·ªùi 6</div>
                <div class="generation-stat-value" id="gen6Count" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
              <div class="generation-stat-card card" id="gen7Card" style="text-align: center; padding: var(--space-4); border-left: 4px solid var(--color-primary);">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">ƒê·ªùi 7</div>
                <div class="generation-stat-value" id="gen7Count" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
              <div class="generation-stat-card card" id="gen8Card" style="text-align: center; padding: var(--space-4); border-left: 4px solid var(--color-primary);">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">ƒê·ªùi 8</div>
                <div class="generation-stat-value" id="gen8Count" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
            </div>
            <div class="generation-chart-container card" style="padding: var(--space-5);">
              <h3 style="margin-bottom: var(--space-4); font-size: var(--font-size-base); color: var(--color-primary); text-align: center;">Bi·ªÉu ƒë·ªì s·ªë ng∆∞·ªùi theo ƒë·ªùi</h3>
              <canvas id="generationBarChart"></canvas>
            </div>
          </div>

          <div id="statsErrorMessage" style="display:none; margin-top: var(--space-5); text-align: center; color: var(--color-error); font-weight: var(--font-weight-semibold);">
            L·ªói: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu th·ªëng k√™. Vui l√≤ng th·ª≠ l·∫°i sau.
          </div>
        </div>
      </section>
    </div>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Leaflet for maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Load genealogy scripts -->
  <script src="/static/js/common.js"></script>
  <script src="/static/js/family-tree-core.js"></script>
  <script src="/static/js/family-tree-graph-builder.js"></script>
  <script src="/static/js/family-tree-family-renderer.js"></script>
  <script src="/static/js/family-tree-ui.js"></script>
  <script src="/static/js/family-tree-family-ui.js"></script>
  <script src="/static/js/genealogy-lineage.js"></script>
  
  <!-- Tree controls event listeners -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // GenFilter change handler
      const genFilter = document.getElementById('genFilter');
      if (genFilter) {
        genFilter.addEventListener('change', async (e) => {
          const maxGen = parseInt(e.target.value);
          console.log('[Genealogy] GenFilter changed to:', maxGen);
          
          // Reload tree v·ªõi maxGeneration m·ªõi
          try {
            const container = document.getElementById('treeContainer');
            if (container) {
              container.innerHTML = '<div class="tree-loading">ƒêang t·∫£i c√¢y gia ph·∫£...</div>';
            }
            
            // Load l·∫°i tree data v·ªõi maxGeneration m·ªõi
            if (typeof loadTreeData === 'function') {
              const { graph: newGraph } = await loadTreeData(maxGen, 'P-1-1');
              if (newGraph && typeof renderDefaultTree === 'function') {
                renderDefaultTree(newGraph, maxGen);
              }
            } else {
              console.error('[Genealogy] loadTreeData function not found');
            }
          } catch (err) {
            console.error('[Genealogy] Error reloading tree:', err);
            const container = document.getElementById('treeContainer');
            if (container) {
              container.innerHTML = `<div style="padding: 20px; color: #d32f2f; text-align: center;">
                <h3>L·ªói khi t·∫£i c√¢y gia ph·∫£</h3>
                <p>${err.message}</p>
              </div>`;
            }
          }
        });
      }
      
      // Search button handler
      const searchBtn = document.getElementById('searchBtn');
      const searchInput = document.getElementById('searchInput');
      const searchResults = document.getElementById('searchResults');
      
      if (searchBtn && searchInput) {
        const handleSearch = async () => {
          const query = searchInput.value.trim();
          if (!query) {
            alert('Vui l√≤ng nh·∫≠p t√™n c·∫ßn t√¨m ki·∫øm');
            return;
          }
          
          const maxGen = genFilter ? parseInt(genFilter.value) : 5;
          console.log('[Genealogy] Searching for:', query, 'maxGen:', maxGen);
          
          // Hi·ªÉn th·ªã loading
          if (searchResults) {
            searchResults.style.display = 'block';
            searchResults.innerHTML = '<div style="padding: 10px; color: #666;">ƒêang t√¨m ki·∫øm...</div>';
          }
          
          try {
            const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=30`);
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            
            const results = await response.json();
            if (results.length === 0) {
              if (searchResults) {
                searchResults.innerHTML = `<div style="padding: 10px; color: #666;">Kh√¥ng t√¨m th·∫•y "${query}"</div>`;
              } else {
                alert(`Kh√¥ng t√¨m th·∫•y "${query}"`);
              }
              return;
            }
            
            // Hi·ªÉn th·ªã k·∫øt qu·∫£ t√¨m ki·∫øm
            if (searchResults) {
              searchResults.innerHTML = results.map(person => {
                const gen = person.generation_number || person.generation_level || '';
                return `
                  <div class="search-result-item" data-person-id="${person.person_id}" 
                       style="padding: 10px; margin: 5px 0; background: #f5f5f5; border-radius: 6px; cursor: pointer; border-left: 3px solid var(--color-primary);"
                       onmouseover="this.style.background='#FFE4B5'" 
                       onmouseout="this.style.background='#f5f5f5'">
                    <strong>${escapeHtml(person.full_name || person.name || '')}</strong>
                    ${gen ? ` - ƒê·ªùi ${gen}` : ''}
            </div>
                `;
              }).join('');
              
              // Add click handlers
              searchResults.querySelectorAll('.search-result-item').forEach(el => {
                el.addEventListener('click', async () => {
                  const personId = el.getAttribute('data-person-id');
                  console.log('[Genealogy] Selected person:', personId);
                  
                  // Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt ngay l·∫≠p t·ª©c
                  if (typeof showPersonInfo === 'function') {
                    showPersonInfo(personId);
                  }
                  
                  // Reload tree v√† focus v√†o person n√†y (ch·ªâ hi·ªÉn th·ªã c√°c node li√™n quan)
                  try {
                    const container = document.getElementById('treeContainer');
                    if (container) {
                      container.innerHTML = '<div class="tree-loading">ƒêang t·∫£i c√¢y gia ph·∫£ (ch·ªâ hi·ªÉn th·ªã c√°c node li√™n quan)...</div>';
                    }
                    
                    // Load l·∫°i tree data v·ªõi maxGeneration
                    if (typeof loadTreeData === 'function') {
                      const { graph: newGraph } = await loadTreeData(maxGen, 'P-1-1');
                      // Lu√¥n d√πng renderFocusTree ƒë·ªÉ ch·ªâ hi·ªÉn th·ªã c√°c node li√™n quan
                      if (newGraph && typeof renderFocusTree === 'function') {
                        renderFocusTree(personId);
                      } else if (newGraph && typeof renderDefaultTree === 'function') {
                        // Fallback: render default tree v√† highlight
                        renderDefaultTree(newGraph, maxGen);
                        setTimeout(() => {
                          const node = document.querySelector(`[data-person-id="${personId}"]`);
                          if (node) {
                            node.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                            node.classList.add('highlighted');
                          }
                        }, 500);
                      }
                    }
                    
                    // ·∫®n search results
                    if (searchResults) {
                      searchResults.style.display = 'none';
                    }
                    if (searchInput) {
                      searchInput.value = '';
                    }
                  } catch (err) {
                    console.error('[Genealogy] Error loading tree:', err);
                    alert(`L·ªói khi t·∫£i c√¢y gia ph·∫£: ${err.message}`);
                  }
                });
              });
            } else {
              // Fallback: n·∫øu kh√¥ng c√≥ searchResults div, d√πng alert
              if (results.length === 1) {
                const person = results[0];
                if (typeof renderFocusTree === 'function') {
                  renderFocusTree(person.person_id);
                }
              } else {
                alert(`T√¨m th·∫•y ${results.length} k·∫øt qu·∫£. Vui l√≤ng ch·ªçn t·ª´ danh s√°ch.`);
              }
            }
          } catch (err) {
            console.error('[Genealogy] Search error:', err);
            if (searchResults) {
              searchResults.innerHTML = `<div style="padding: 10px; color: #d32f2f;">L·ªói: ${err.message}</div>`;
            } else {
              alert(`L·ªói khi t√¨m ki·∫øm: ${err.message}`);
            }
          }
        };
        
        searchBtn.addEventListener('click', handleSearch);
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            handleSearch();
          }
        });
      }
    });
  </script>
  
  <!-- Lineage UI Functions -->
  <script>
    // Lineage search state
    let selectedPerson = null;
    let searchTimeout = null;
    
    /**
     * X·ª≠ l√Ω khi ng∆∞·ªùi d√πng g√µ v√†o √¥ t√¨m ki·∫øm (autocomplete)
     */
    function handleLineageSearchInput() {
      const nameInput = document.getElementById('lineageName');
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      
      if (!nameInput || !suggestionsDiv) {
        console.warn('[Lineage] Required elements not found for search input');
        return;
      }
      
      const query = nameInput.value.trim();
      
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
      
      if (!query || query.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
      }
      
      searchTimeout = setTimeout(async () => {
        try {
          const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=10`);
          
          if (!response.ok) {
            suggestionsDiv.style.display = 'none';
            return;
          }
          
          const results = await response.json();
          
          if (results.length === 0) {
            suggestionsDiv.innerHTML = '<div class="suggestion-item" style="color: #999; font-style: italic;">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>';
            suggestionsDiv.style.display = 'block';
            return;
          }
          
          suggestionsDiv.innerHTML = results.map((person) => {
            const gen = person.generation_level || person.generation_number || '?';
            const name = person.full_name || 'Kh√¥ng r√µ t√™n';
            const fatherName = person.father_name || '';
            const motherName = person.mother_name || '';
            
            let parentInfo = '';
            if (fatherName && motherName) {
              parentInfo = `Con c·ªßa: √îng ${escapeHtml(fatherName)} & B√† ${escapeHtml(motherName)}`;
            } else if (fatherName) {
              parentInfo = `Con c·ªßa: √îng ${escapeHtml(fatherName)}`;
            } else if (motherName) {
              parentInfo = `Con c·ªßa: B√† ${escapeHtml(motherName)}`;
            } else {
              parentInfo = 'Ch∆∞a c√≥ th√¥ng tin cha m·∫π';
            }
            
            return `
              <div class="suggestion-item" onclick="selectSuggestionFromSearch('${person.person_id}')" style="cursor: pointer;">
                <div style="font-weight: 600; color: var(--color-primary); margin-bottom: 4px;">
                  ${escapeHtml(name)} ‚Äì ƒê·ªùi ${gen}
          </div>
                <div style="color: var(--color-text-muted); font-size: 14px;">
                  ${parentInfo}
                </div>
              </div>
            `;
          }).join('');
          
          suggestionsDiv.style.display = 'block';
        } catch (err) {
          console.error('Error in autocomplete:', err);
          suggestionsDiv.style.display = 'none';
        }
      }, 300);
    }
    
    /**
     * Select suggestion from search results
     */
    async function selectSuggestionFromSearch(personId) {
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      if (suggestionsDiv) {
        suggestionsDiv.style.display = 'none';
      }
      
      await displayLineageForPersonFromAPI(personId);
    }
    
    /**
     * Search lineage
     */
    async function searchLineage() {
      const nameInput = document.getElementById('lineageName');
      
      if (!nameInput) {
        console.error('[Lineage] lineageName input not found');
        alert('L·ªói: Kh√¥ng t√¨m th·∫•y √¥ nh·∫≠p li·ªáu');
        return;
      }
      
      const name = nameInput.value.trim();
      
      if (!name) {
        alert('Vui l√≤ng nh·∫≠p t√™n ho·∫∑c ch·ªçn t·ª´ danh s√°ch g·ª£i √Ω');
        return;
      }
      
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      if (suggestionsDiv) {
        suggestionsDiv.style.display = 'none';
      }
      
      try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(name)}&limit=20`);
        
        if (!response.ok) {
          throw new Error(`API tr·∫£ m√£ ${response.status}`);
        }
        
        const results = await response.json();
        
        if (results.length === 0) {
          alert(`Kh√¥ng t√¨m th·∫•y "${name}"`);
          return;
        }
        
        if (results.length > 1) {
          if (suggestionsDiv) {
            suggestionsDiv.innerHTML = results.map((person) => {
              const gen = person.generation_level || person.generation_number || '?';
              const name = person.full_name || 'Kh√¥ng r√µ t√™n';
              const fatherName = person.father_name || '';
              const motherName = person.mother_name || '';
              
              let parentInfo = '';
              if (fatherName && motherName) {
                parentInfo = `Con c·ªßa: √îng ${escapeHtml(fatherName)} & B√† ${escapeHtml(motherName)}`;
              } else if (fatherName) {
                parentInfo = `Con c·ªßa: √îng ${escapeHtml(fatherName)}`;
              } else if (motherName) {
                parentInfo = `Con c·ªßa: B√† ${escapeHtml(motherName)}`;
              } else {
                parentInfo = 'Ch∆∞a c√≥ th√¥ng tin cha m·∫π';
              }
              
              return `
                <div class="suggestion-item" onclick="selectSuggestionFromSearch('${person.person_id}')" style="cursor: pointer;">
                  <div style="font-weight: 600; color: var(--color-primary); margin-bottom: 4px;">
                    ${escapeHtml(name)} ‚Äì ƒê·ªùi ${gen}
        </div>
                  <div style="color: var(--color-text-muted); font-size: 14px;">
                    ${parentInfo}
                  </div>
                </div>
              `;
            }).join('');
            suggestionsDiv.style.display = 'block';
          }
          return;
        }
        
        const person = results[0];
        await displayLineageForPersonFromAPI(person.person_id);
      } catch (err) {
        console.error('Error searching lineage:', err);
        alert(`L·ªói khi t√¨m ki·∫øm: ${err.message}`);
      }
    }
    
    /**
     * Display lineage for person using API
     */
    async function displayLineageForPersonFromAPI(personId) {
      try {
        console.log(`[Lineage] Fetching lineage for person_id: ${personId}`);
        
        const ancestorsRes = await fetch(`/api/ancestors/${personId}`);
        
        if (!ancestorsRes.ok) {
          throw new Error(`API /api/ancestors/${personId} tr·∫£ m√£ ${ancestorsRes.status}`);
        }
        
        const ancestorsData = await ancestorsRes.json();
        
        let lineage = [];
        if (ancestorsData.ancestors_chain && Array.isArray(ancestorsData.ancestors_chain)) {
          lineage = ancestorsData.ancestors_chain;
        }
        
        if (ancestorsData.person) {
          const currentPersonId = String(ancestorsData.person.person_id || '').trim();
          const alreadyInChain = lineage.some(p => {
            const pId = String(p.person_id || '').trim();
            return pId === currentPersonId && pId !== '';
          });
          
          if (!alreadyInChain && currentPersonId) {
            lineage.push(ancestorsData.person);
          }
        }
        
        displayLineageChain(lineage);
        
        try {
          const personRes = await fetch(`/api/person/${personId}`);
          if (personRes.ok) {
            const data = await personRes.json();
            const person = data.person || data;
            
            // ƒê·∫£m b·∫£o g√°n ƒë·∫ßy ƒë·ªß d·ªØ li·ªáu v√†o selectedPerson
            selectedPerson = {
              ...person,
              // ƒê·∫£m b·∫£o c√°c field quan tr·ªçng ƒë∆∞·ª£c gi·ªØ l·∫°i
              marriages: person.marriages || [],
              children: person.children || [],
              spouse: person.spouse || person.spouse_name || null,
              spouse_name: person.spouse_name || person.spouse || null,  // ƒê·∫£m b·∫£o c·∫£ 2 field
              children_string: person.children_string || (person.children && Array.isArray(person.children) ? person.children.map(c => c.full_name || c.name).join('; ') : null) || null,
              siblings: person.siblings || null
            };
            
            console.log('[Lineage] Full person data loaded:', {
              person_id: selectedPerson.person_id,
              has_marriages: Array.isArray(selectedPerson.marriages) && selectedPerson.marriages.length > 0,
              marriages_count: selectedPerson.marriages ? selectedPerson.marriages.length : 0,
              has_children: Array.isArray(selectedPerson.children) && selectedPerson.children.length > 0,
              children_count: selectedPerson.children ? selectedPerson.children.length : 0,
              children_string: selectedPerson.children_string,
              has_spouse: !!selectedPerson.spouse,
              spouse_value: selectedPerson.spouse,
              has_spouse_name: !!selectedPerson.spouse_name,
              spouse_name_value: selectedPerson.spouse_name,
              has_siblings: !!selectedPerson.siblings
            });
            
            showDetailPanel(selectedPerson);
          }
        } catch (err) {
          console.warn('[Lineage] Could not fetch full person details:', err);
          if (ancestorsData.person) {
            selectedPerson = ancestorsData.person;
            showDetailPanel(ancestorsData.person);
          }
        }
      } catch (err) {
        console.error('Error displaying lineage:', err);
        alert(`L·ªói khi hi·ªÉn th·ªã chu·ªói ph·∫£ h·ªá: ${err.message}`);
      }
    }
    
    /**
     * Normalize parent names
     */
    function normalizeParentName(name, isFather = true) {
      if (!name) return null;
      name = name.replace(/^(√îng|B√†|Vua)\s+/i, '').trim();
      return name;
    }
    
    /**
     * Get Gen 1 parents
     */
    function getGen1Parents() {
      return {
        father_name: 'Vua Gia Long',
        mother_name: 'Thu·∫≠n Thi√™n Ho√†ng h·∫≠u'
      };
    }
    
    /**
     * Display lineage chain
     */
    function displayLineageChain(lineage) {
      const resultDiv = document.getElementById('lineageResult');
      const resultContent = document.getElementById('lineageResultContent');
      const resultTitle = document.getElementById('lineageResultTitle');
      
      if (!resultDiv) return;
      
      if (!lineage || lineage.length === 0) {
        if (resultContent) {
          resultContent.innerHTML = '<div style="padding: 20px; color: #666; text-align: center;">Kh√¥ng c√≥ d·ªØ li·ªáu chu·ªói ph·∫£ h·ªá</div>';
        }
        resultDiv.style.display = 'block';
        return;
      }
      
      const seenIds = new Set();
      const uniqueLineage = [];
      
      for (const p of lineage) {
        let personId = p.person_id;
        if (personId === null || personId === undefined || personId === '') {
          continue;
        }
        
        const personIdStr = String(personId).trim();
        if (!personIdStr || seenIds.has(personIdStr)) {
          continue;
        }
        
        seenIds.add(personIdStr);
        uniqueLineage.push(p);
      }
      
      const sortedLineage = [...uniqueLineage].sort((a, b) => {
        const genA = a.generation_number || a.generation_level || 0;
        const genB = b.generation_number || b.generation_level || 0;
        if (genA !== genB) {
          return genA - genB;
        }
        const idA = String(a.person_id || '');
        const idB = String(b.person_id || '');
        return idA.localeCompare(idB);
      });
      
      const hasGen1 = sortedLineage.some(p => (p.generation_number === 1 || p.generation_level === 1));
      if (!hasGen1) {
        const gen1Person = {
          person_id: 'P-1-1',
          full_name: 'Vua Minh M·∫°ng',
          generation_number: 1,
          generation_level: 1,
          father_name: 'Vua Gia Long',
          mother_name: 'Thu·∫≠n Thi√™n Ho√†ng h·∫≠u',
          gender: 'Nam',
          status: 'ƒê√£ m·∫•t'
        };
        sortedLineage.unshift(gen1Person);
      } else {
        const gen1Index = sortedLineage.findIndex(p => (p.generation_number === 1 || p.generation_level === 1));
        if (gen1Index !== -1) {
          const gen1Parents = getGen1Parents();
          sortedLineage[gen1Index].father_name = gen1Parents.father_name;
          sortedLineage[gen1Index].mother_name = gen1Parents.mother_name;
        }
      }
      
      const targetPerson = sortedLineage[sortedLineage.length - 1];
      
      if (resultTitle) {
        resultTitle.textContent = `Chu·ªói ph·∫£ h·ªá c·ªßa ${targetPerson.full_name || 'Ng∆∞·ªùi ƒë∆∞·ª£c ch·ªçn'}`;
      }
      
      const groupedByGen = {};
      sortedLineage.forEach(p => {
        const gen = p.generation_number || p.generation_level || 0;
        if (!groupedByGen[gen]) {
          groupedByGen[gen] = [];
        }
        groupedByGen[gen].push(p);
      });
      
      let timelineHTML = '';
      Object.keys(groupedByGen).sort((a, b) => parseInt(a) - parseInt(b)).forEach(gen => {
        const personsInGen = groupedByGen[gen];
        const genNum = parseInt(gen);
        
        if (genNum === 1 && personsInGen.length > 1) {
          timelineHTML += '<div style="display: flex; flex-direction: row; gap: 16px; width: 100%; margin-bottom: 16px;">';
          personsInGen.forEach(p => {
            timelineHTML += generatePersonCard(p, genNum, false);
          });
          timelineHTML += '</div>';
        } else {
          personsInGen.forEach(p => {
            timelineHTML += generatePersonCard(p, genNum, true);
          });
        }
      });
      
      function generatePersonCard(p, gen, isFullWidth = true) {
        const name = p.full_name || 'Kh√¥ng r√µ t√™n';
        const fatherName = normalizeParentName(p.father_name, true) || p.father_name || '';
        const motherName = normalizeParentName(p.mother_name, false) || p.mother_name || '';
        
        const titleLine = `ƒê·ªùi ${gen} ‚Äì ${escapeHtml(name)}`;
        
        let parentInfo = '';
        if (fatherName && motherName) {
          parentInfo = `Con c·ªßa √îng ${escapeHtml(fatherName)} v√† B√† ${escapeHtml(motherName)}`;
        } else if (fatherName) {
          parentInfo = `Con c·ªßa √îng ${escapeHtml(fatherName)} v√† B√† Ch∆∞a c√≥ th√¥ng tin`;
        } else if (motherName) {
          parentInfo = `Con c·ªßa √îng Ch∆∞a c√≥ th√¥ng tin v√† B√† ${escapeHtml(motherName)}`;
        } else {
          parentInfo = 'Con c·ªßa √îng Ch∆∞a c√≥ th√¥ng tin v√† B√† Ch∆∞a c√≥ th√¥ng tin';
        }
        
        let badgeColor = '';
        if (gen === 1) badgeColor = 'background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);';
        else if (gen === 2) badgeColor = 'background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);';
        else if (gen === 3) badgeColor = 'background: linear-gradient(135deg, #ca8a04 0%, #a16207 100%);';
        else if (gen === 4) badgeColor = 'background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);';
        else if (gen === 5) badgeColor = 'background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);';
        else if (gen >= 6) badgeColor = 'background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%);';
        else badgeColor = 'background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);';
        
        const cardWidth = (!isFullWidth) ? 'calc(50% - 8px)' : '100%';
        const cardMargin = (!isFullWidth) ? '0' : '0 0 16px 0';
        
        return `
          <div style="
            background: #FFF8DC;
            border-radius: 8px;
            padding: 16px 20px;
            margin: ${cardMargin};
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #DAA520;
            width: ${cardWidth};
          ">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
              <span style="
                ${badgeColor}
                color: white;
                font-weight: 700;
                font-size: 13px;
                padding: 6px 16px;
                border-radius: 20px;
                white-space: nowrap;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
                display: inline-block;
                min-width: 70px;
                text-align: center;
              ">ƒê·ªùi ${gen}</span>
              <h3 style="
                color: var(--color-primary);
                font-weight: 700;
                font-size: 18px;
                margin: 0;
                flex: 1;
                line-height: 1.4;
              ">${titleLine}</h3>
          </div>
            <div style="
              color: var(--color-text);
              font-size: 14px;
              line-height: 1.6;
              padding-left: 0;
              margin-top: 6px;
            ">
              ${parentInfo}
        </div>
          </div>
        `;
      }
      
      if (resultContent) {
        resultContent.innerHTML = `
          <div style="display: flex; flex-direction: column; gap: 0; width: 100%;">
            ${timelineHTML}
          </div>
        `;
      }
      
      resultDiv.style.display = 'block';
    }
    
    /**
     * Show detail panel
     */
    function showDetailPanel(person) {
      const panel = document.getElementById('lineageDetailPanel');
      const content = document.getElementById('lineageDetailContent');
      
      if (!person || !panel || !content) return;
      
      selectedPerson = person;
      
      fetch(`/api/person/${person.person_id}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`API tr·∫£ m√£ ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          const detailedPerson = data.person || data;
          if (detailedPerson.error) {
            renderDetailPanel(person);
            return;
          }
          
          Object.assign(selectedPerson, detailedPerson);
          if (!selectedPerson.generation_number && selectedPerson.generation_level) {
            selectedPerson.generation_number = selectedPerson.generation_level;
          }
          
          // ƒê·∫£m b·∫£o c√°c field quan tr·ªçng ƒë∆∞·ª£c gi·ªØ l·∫°i sau khi Object.assign
          if (!selectedPerson.spouse && selectedPerson.spouse_name) {
            selectedPerson.spouse = selectedPerson.spouse_name;
          }
          if (!selectedPerson.spouse_name && selectedPerson.spouse) {
            selectedPerson.spouse_name = selectedPerson.spouse;
          }
          if (!selectedPerson.children_string && selectedPerson.children && Array.isArray(selectedPerson.children)) {
            selectedPerson.children_string = selectedPerson.children.map(c => c.full_name || c.name).filter(n => n).join('; ');
          }
          
          console.log('[Lineage] After Object.assign:', {
            person_id: selectedPerson.person_id,
            spouse: selectedPerson.spouse,
            spouse_name: selectedPerson.spouse_name,
            children: selectedPerson.children,
            children_string: selectedPerson.children_string,
            marriages: selectedPerson.marriages
          });
          
          renderDetailPanel(selectedPerson);
        })
        .catch(error => {
          console.error('L·ªói khi fetch th√¥ng tin chi ti·∫øt:', error);
          renderDetailPanel(person);
        });
    }
    
    /**
     * Format marriages for display
     */
    function formatMarriages(person) {
      if (!person) return 'Ch∆∞a c√≥ th√¥ng tin';
      
      // ∆Øu ti√™n marriages array (ƒë·∫ßy ƒë·ªß th√¥ng tin nh·∫•t)
      if (person.marriages && Array.isArray(person.marriages) && person.marriages.length > 0) {
        return person.marriages.map(m => {
          let display = m.spouse_name || '';
          if (m.marriage_date_solar) {
            display += ` (${m.marriage_date_solar})`;
          }
          if (m.marriage_place) {
            display += ` - ${m.marriage_place}`;
          }
          return display;
        }).join('<br>');
      }
      
      // ∆Øu ti√™n spouse_name (string)
      if (person.spouse_name) {
        const spouses = person.spouse_name.split(';').map(s => s.trim()).filter(s => s);
        return spouses.join('<br>');
      }
      
      // Fallback: spouse (string)
      if (person.spouse) {
        const spouses = person.spouse.split(';').map(s => s.trim()).filter(s => s);
        return spouses.join('<br>');
      }
      
      return 'Ch∆∞a c√≥ th√¥ng tin';
    }
    
    /**
     * Format siblings for display
     */
    function formatSiblings(person) {
      if (!person) return 'Ch∆∞a c√≥ th√¥ng tin';
      
      if (person.siblings) {
        const siblings = person.siblings.split(';').map(s => s.trim()).filter(s => s);
        return siblings.length > 0 ? siblings.join('<br>') : 'Ch∆∞a c√≥ th√¥ng tin';
      }
      
      return 'Ch∆∞a c√≥ th√¥ng tin';
    }
    
    /**
     * Format children for display
     */
    function formatChildren(person) {
      if (!person) return 'Ch∆∞a c√≥ th√¥ng tin';
      
      // ∆Øu ti√™n children array
      if (person.children && Array.isArray(person.children) && person.children.length > 0) {
        return person.children.map(c => {
          let display = c.full_name || c.name || '';
          if (c.generation_level || c.generation_number) {
            display += ` (ƒê·ªùi ${c.generation_level || c.generation_number})`;
          }
          return display;
        }).join('<br>');
      }
      
      // Fallback: children_string
      if (person.children_string) {
        const children = person.children_string.split(';').map(c => c.trim()).filter(c => c);
        return children.length > 0 ? children.join('<br>') : 'Ch∆∞a c√≥ th√¥ng tin';
      }
      
      // Fallback: children (string)
      if (person.children && typeof person.children === 'string') {
        const children = person.children.split(';').map(c => c.trim()).filter(c => c);
        return children.length > 0 ? children.join('<br>') : 'Ch∆∞a c√≥ th√¥ng tin';
      }
      
      return 'Ch∆∞a c√≥ th√¥ng tin';
    }
    
    /**
     * Render detail panel
     */
    function renderDetailPanel(person) {
      const content = document.getElementById('lineageDetailContent');
      const panel = document.getElementById('lineageDetailPanel');
      if (!content || !panel) return;
      
      // Debug: Log d·ªØ li·ªáu tr∆∞·ªõc khi render
      console.log('[Lineage] Rendering detail panel:', {
        person_id: person.person_id,
        has_marriages: Array.isArray(person.marriages) && person.marriages.length > 0,
        marriages_count: person.marriages ? person.marriages.length : 0,
        has_children: Array.isArray(person.children) && person.children.length > 0,
        children_count: person.children ? person.children.length : 0,
        has_spouse: !!person.spouse,
        spouse_value: person.spouse,
        has_spouse_name: !!person.spouse_name,
        spouse_name_value: person.spouse_name
      });
      
      content.innerHTML = `
        <div style="line-height: 1.6;">
          <div style="margin-bottom: var(--space-3);">
            <strong>Person ID:</strong> ${person.person_id || 'Ch∆∞a c√≥ th√¥ng tin'}
        </div>
          <div style="margin-bottom: var(--space-3);">
            <strong>T√™n ƒë·∫ßy ƒë·ªß:</strong> ${person.full_name || 'Ch∆∞a c√≥ th√¥ng tin'}
      </div>
          ${person.alias ? `<div style="margin-bottom: var(--space-3);"><strong>T√™n th∆∞·ªùng g·ªçi:</strong> ${person.alias}</div>` : ''}
          <div style="margin-bottom: var(--space-3);">
            <strong>ƒê·ªùi:</strong> ${person.generation_number || person.generation_level || 'Ch∆∞a c√≥ th√¥ng tin'}
    </div>
          <div style="margin-bottom: var(--space-3);">
            <strong>Gi·ªõi t√≠nh:</strong> ${person.gender || 'Ch∆∞a c√≥ th√¥ng tin'}
  </div>
          <div style="margin-bottom: var(--space-3);">
            <strong>T√™n b·ªë:</strong> ${person.father_name ? '√îng ' + escapeHtml(person.father_name) : 'Ch∆∞a c√≥ th√¥ng tin'}
          </div>
          <div style="margin-bottom: var(--space-3);">
            <strong>T√™n m·∫π:</strong> ${person.mother_name ? 'B√† ' + escapeHtml(person.mother_name) : 'Ch∆∞a c√≥ th√¥ng tin'}
          </div>
          <div style="margin-bottom: var(--space-3);">
            <strong>H√¥n ph·ªëi:</strong><br>
            <div style="margin-top: 4px; color: var(--color-text);">${formatMarriages(person)}</div>
          </div>
          <div style="margin-bottom: var(--space-3);">
            <strong>Anh ch·ªã em:</strong><br>
            <div style="margin-top: 4px; color: var(--color-text);">${formatSiblings(person)}</div>
          </div>
          <div style="margin-bottom: var(--space-3);">
            <strong>Th√¥ng tin con:</strong><br>
            <div style="margin-top: 4px; color: var(--color-text);">${formatChildren(person)}</div>
          </div>
          <div style="margin-bottom: var(--space-3);">
            <strong>Nh√°nh:</strong> ${person.branch_name || 'Ch∆∞a c√≥ th√¥ng tin'}
          </div>
          <div style="margin-bottom: var(--space-3);">
            <strong>Tr·∫°ng th√°i:</strong> ${person.status || 'Ch∆∞a c√≥ th√¥ng tin'}
          </div>
        </div>
      `;
      
      panel.style.display = 'block';
    }
    
    /**
     * Close detail panel
     */
    function closeDetailPanel() {
      const panel = document.getElementById('lineageDetailPanel');
      if (panel) {
        panel.style.display = 'none';
      }
    }
  </script>

  <!-- Member statistics -->
  <script>
    // Generic fetch helper
    async function fetchJson(url, options) {
      const res = await fetch(url, options);
      const contentType = res.headers.get('Content-Type') || '';
      const text = await res.text();

      if (!res.ok) {
        console.error('HTTP error for', url, res.status, text);
        throw new Error(`HTTP ${res.status} when fetching ${url}`);
      }

      if (!contentType.includes('application/json')) {
        console.error('Non-JSON response for', url, 'contentType =', contentType, 'body =', text.slice(0, 300));
        throw new Error(`Expected JSON but got non-JSON response from ${url}`);
      }

      try {
        return JSON.parse(text);
      } catch (e) {
        console.error('JSON parse error for', url, 'body =', text.slice(0, 300));
        throw e;
      }
    }

    /**
     * Sort generation options numerically
     * Extracts number from "ƒê·ªùi X" format and sorts ascending
     */
    function sortGenerationOptions(options) {
      return options.sort((a, b) => {
        // Extract numeric value from option text (e.g., "ƒê·ªùi 5" -> 5)
        const extractNumber = (text) => {
          const match = text.match(/\d+/);
          return match ? parseInt(match[0], 10) : Infinity; // Put non-numeric at end
        };
        
        const numA = extractNumber(a.text);
        const numB = extractNumber(b.text);
        
        return numA - numB;
      });
    }

    /**
     * Populate generation filter dropdown with available generations
     * Sorts numerically and removes duplicates
     */
    function populateGenerationFilter(generationCounts) {
      const genFilter = document.getElementById('genFilter');
      if (!genFilter) return;
      
      // Extract unique generation levels from data
      const availableGenerations = new Set();
      if (generationCounts && Array.isArray(generationCounts)) {
        generationCounts.forEach(gen => {
          if (gen.generation_level && gen.generation_level >= 1) {
            availableGenerations.add(gen.generation_level);
          }
        });
      }
      
      // If no data, use default range 1-8
      if (availableGenerations.size === 0) {
        for (let i = 1; i <= 8; i++) {
          availableGenerations.add(i);
        }
      }
      
      // Create options array
      const options = Array.from(availableGenerations).map(genLevel => ({
        value: genLevel,
        text: `ƒê·∫øn ƒë·ªùi ${genLevel}`
      }));
      
      // Sort numerically
      const sortedOptions = sortGenerationOptions(options);
      
      // Clear existing options
      genFilter.innerHTML = '';
      
      // Add sorted options
      sortedOptions.forEach((opt, index) => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.text;
        // Select the last option (highest generation) by default, or option 5 if exists
        if (index === sortedOptions.length - 1 || opt.value === 5) {
          option.selected = true;
        }
        genFilter.appendChild(option);
      });
      
      console.log('[Genealogy] Populated generation filter:', sortedOptions.map(o => o.text));
    }

    async function loadMemberStats() {
      const errorEl = document.getElementById('statsErrorMessage');
      try {
        const data = await fetchJson('/api/stats/members');
        const total = data.total_members || 0;
        const male = data.male_count || 0;
        const female = data.female_count || 0;
        const unknown = data.unknown_gender_count || 0;

        document.getElementById('statsTotalMembers').textContent = total.toLocaleString('vi-VN');
        document.getElementById('statsMaleCount').textContent = male.toLocaleString('vi-VN');
        document.getElementById('statsFemaleCount').textContent = female.toLocaleString('vi-VN');
        document.getElementById('statsUnknownCount').textContent = unknown.toLocaleString('vi-VN');

        renderGenderCharts({ male, female, unknown });

        // Hi·ªÉn th·ªã th·ªëng k√™ theo ƒë·ªùi
        if (data.generation_counts && Array.isArray(data.generation_counts)) {
          const generationCounts = data.generation_counts;
          
          // Populate generation filter dropdown
          populateGenerationFilter(generationCounts);
          
          // C·∫≠p nh·∫≠t s·ªë li·ªáu cho t·ª´ng ƒë·ªùi
          for (let i = 1; i <= 8; i++) {
            const genElement = document.getElementById(`gen${i}Count`);
            if (genElement) {
              const genData = generationCounts.find(g => g.generation_level === i);
              const count = genData ? genData.count : 0;
              genElement.textContent = count.toLocaleString('vi-VN');
            }
          }
          
          // V·∫Ω bi·ªÉu ƒë·ªì
          renderGenerationChart(generationCounts);
        } else {
          // If no generation_counts, still populate dropdown with default range
          populateGenerationFilter([]);
        }
      } catch (err) {
        console.error('Error loading stats:', err);
        if (errorEl) errorEl.style.display = 'block';
        // On error, populate dropdown with default range
        populateGenerationFilter([]);
      }
    }

    function renderGenderCharts({ male, female, unknown }) {
      const pieCtx = document.getElementById('genderPieChart')?.getContext('2d');
      const barCtx = document.getElementById('genderBarChart')?.getContext('2d');
      if (!pieCtx || !barCtx || typeof Chart === 'undefined') return;

      const labels = ['Nam', 'N·ªØ', 'Kh√¥ng r√µ / kh√°c'];
      const values = [male, female, unknown];

      new Chart(pieCtx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: ['#1976d2', '#e91e63', '#9e9e9e'],
            borderWidth: 1
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      new Chart(barCtx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'S·ªë l∆∞·ª£ng',
            data: values,
            backgroundColor: ['#1976d2', '#e91e63', '#9e9e9e']
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          }
        }
      });
    }

    function renderGenerationChart(generationCounts) {
      const ctx = document.getElementById('generationBarChart')?.getContext('2d');
      if (!ctx || typeof Chart === 'undefined') return;

      // S·∫Øp x·∫øp theo generation_level
      const sorted = generationCounts.sort((a, b) => a.generation_level - b.generation_level);
      const labels = sorted.map(g => `ƒê·ªùi ${g.generation_level}`);
      const values = sorted.map(g => g.count);

      // M√†u s·∫Øc kh√°c nhau cho t·ª´ng ƒë·ªùi
      const colors = [
        '#8B0000', // ƒê·ªùi 1 - Dark red
        '#CD853F', // ƒê·ªùi 2 - Peru
        '#DAA520', // ƒê·ªùi 3 - Goldenrod
        '#B8860B', // ƒê·ªùi 4 - Dark goldenrod
        '#9ACD32', // ƒê·ªùi 5 - Yellow green
        '#9370DB', // ƒê·ªùi 6 - Medium purple
        '#20B2AA', // ƒê·ªùi 7 - Light sea green
        '#FF6347'  // ƒê·ªùi 8 - Tomato
      ];

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'S·ªë ng∆∞·ªùi',
            data: values,
            backgroundColor: colors.slice(0, labels.length),
            borderColor: colors.slice(0, labels.length).map(c => c + 'DD'),
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `S·ªë ng∆∞·ªùi: ${context.parsed.y.toLocaleString('vi-VN')}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0,
                callback: function(value) {
                  return value.toLocaleString('vi-VN');
                }
              }
            },
            x: {
              ticks: {
                font: {
                  size: 12
                }
              }
            }
          }
        }
      });
    }

    // Load stats on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadMemberStats();
    });
  </script>

  <style>

  <style>
    @media (max-width: 900px) {
      .stats-layout {
        grid-template-columns: 1fr !important;
      }
      .stats-charts {
        grid-template-columns: 1fr !important;
      }
      .grave-info-section {
        grid-template-columns: 1fr !important;
      }
    }
  </style>

  <!-- Grave Search Scripts -->
  <script>
    // Grave search state
    let graveMap = null;
    let graveMarker = null;
    let currentGravePerson = null;
    let graveEditMode = false;
    let graveSearchTimeout = null;

    /**
     * X·ª≠ l√Ω khi ng∆∞·ªùi d√πng g√µ v√†o √¥ t√¨m ki·∫øm m·ªô ph·∫ßn (autocomplete)
     */
    function handleGraveSearchInput() {
      const searchInput = document.getElementById('graveSearchInput');
      const suggestionsDiv = document.getElementById('graveSearchSuggestions');
      
      if (!searchInput || !suggestionsDiv) {
        console.warn('[Grave Search] Required elements not found');
        return;
      }
      
      const query = searchInput.value.trim();
      
      if (graveSearchTimeout) {
        clearTimeout(graveSearchTimeout);
      }
      
      if (!query || query.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
      }
      
      graveSearchTimeout = setTimeout(async () => {
        try {
          const response = await fetch(`/api/grave-search?query=${encodeURIComponent(query)}`);
          
          if (!response.ok) {
            suggestionsDiv.style.display = 'none';
            return;
          }
          
          const data = await response.json();
          
          if (!data.success || !data.results || data.results.length === 0) {
            suggestionsDiv.innerHTML = '<div class="suggestion-item" style="color: #999; font-style: italic;">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>';
            suggestionsDiv.style.display = 'block';
            return;
          }
          
          suggestionsDiv.innerHTML = data.results.slice(0, 10).map((person) => {
            const gen = person.generation_level || '?';
            const name = person.full_name || 'Kh√¥ng r√µ t√™n';
            const graveInfo = person.grave_info || '';
            const hasLocation = extractCoordinates(graveInfo).lat !== null;
            
            return `
              <div class="suggestion-item" onclick="selectGraveSuggestion('${person.person_id}')" style="cursor: pointer;">
                <div style="font-weight: 600; color: var(--color-primary); margin-bottom: 4px;">
                  ${escapeHtml(name)} ‚Äì ƒê·ªùi ${gen}
                </div>
                <div style="color: var(--color-text-muted); font-size: 14px;">
                  ${graveInfo ? escapeHtml(graveInfo.substring(0, 50)) + (graveInfo.length > 50 ? '...' : '') : 'Ch∆∞a c√≥ th√¥ng tin m·ªô ph·∫ßn'}
                  ${hasLocation ? ' <span style="color: green;">üìç</span>' : ''}
                </div>
              </div>
            `;
          }).join('');
          
          suggestionsDiv.style.display = 'block';
        } catch (err) {
          console.error('Error in grave autocomplete:', err);
          suggestionsDiv.style.display = 'none';
        }
      }, 300);
    }

    /**
     * Select suggestion from search results
     */
    async function selectGraveSuggestion(personId) {
      const suggestionsDiv = document.getElementById('graveSearchSuggestions');
      if (suggestionsDiv) {
        suggestionsDiv.style.display = 'none';
      }
      
      await displayGraveInfo(personId);
    }

    /**
     * Search grave
     */
    async function searchGrave() {
      const searchInput = document.getElementById('graveSearchInput');
      
      if (!searchInput) {
        console.error('[Grave Search] graveSearchInput not found');
        alert('L·ªói: Kh√¥ng t√¨m th·∫•y √¥ nh·∫≠p li·ªáu');
        return;
      }
      
      const query = searchInput.value.trim();
      
      if (!query) {
        alert('Vui l√≤ng nh·∫≠p t√™n ho·∫∑c ID ƒë·ªÉ t√¨m ki·∫øm');
        return;
      }
      
      const suggestionsDiv = document.getElementById('graveSearchSuggestions');
      if (suggestionsDiv) {
        suggestionsDiv.style.display = 'none';
      }
      
      try {
        const response = await fetch(`/api/grave-search?query=${encodeURIComponent(query)}`);
        
        if (!response.ok) {
          throw new Error(`API tr·∫£ m√£ ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.success || !data.results || data.results.length === 0) {
          alert(`Kh√¥ng t√¨m th·∫•y m·ªô ph·∫ßn cho "${query}"`);
          return;
        }
        
        if (data.results.length > 1) {
          // Hi·ªÉn th·ªã suggestions ƒë·ªÉ ch·ªçn
          if (suggestionsDiv) {
            suggestionsDiv.innerHTML = data.results.map((person) => {
              const gen = person.generation_level || '?';
              const name = person.full_name || 'Kh√¥ng r√µ t√™n';
              const graveInfo = person.grave_info || '';
              const hasLocation = extractCoordinates(graveInfo).lat !== null;
              
              return `
                <div class="suggestion-item" onclick="selectGraveSuggestion('${person.person_id}')" style="cursor: pointer;">
                  <div style="font-weight: 600; color: var(--color-primary); margin-bottom: 4px;">
                    ${escapeHtml(name)} ‚Äì ƒê·ªùi ${gen}
                  </div>
                  <div style="color: var(--color-text-muted); font-size: 14px;">
                    ${graveInfo ? escapeHtml(graveInfo.substring(0, 50)) + (graveInfo.length > 50 ? '...' : '') : 'Ch∆∞a c√≥ th√¥ng tin m·ªô ph·∫ßn'}
                    ${hasLocation ? ' <span style="color: green;">üìç</span>' : ''}
                  </div>
                </div>
              `;
            }).join('');
            suggestionsDiv.style.display = 'block';
          }
          return;
        }
        
        // Ch·ªâ c√≥ 1 k·∫øt qu·∫£, hi·ªÉn th·ªã lu√¥n
        await displayGraveInfo(data.results[0].person_id);
      } catch (err) {
        console.error('Error searching grave:', err);
        alert(`L·ªói khi t√¨m ki·∫øm: ${err.message}`);
      }
    }

    /**
     * Extract coordinates from grave_info string
     */
    function extractCoordinates(graveInfo) {
      if (!graveInfo) return { lat: null, lng: null };
      
      // Format: "ƒê·ªãa ch·ªâ | lat:16.4637,lng:107.5909" ho·∫∑c "lat:16.4637,lng:107.5909"
      const latMatch = graveInfo.match(/lat:([\d.]+)/);
      const lngMatch = graveInfo.match(/lng:([\d.]+)/);
      
      if (latMatch && lngMatch) {
        return {
          lat: parseFloat(latMatch[1]),
          lng: parseFloat(lngMatch[1])
        };
      }
      
      return { lat: null, lng: null };
    }

    /**
     * Display grave information and map
     */
    async function displayGraveInfo(personId) {
      try {
        const response = await fetch(`/api/grave-search?query=${personId}`);
        
        if (!response.ok) {
          throw new Error(`API tr·∫£ m√£ ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.success || !data.results || data.results.length === 0) {
          alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin m·ªô ph·∫ßn');
          return;
        }
        
        const person = data.results.find(p => p.person_id === personId) || data.results[0];
        currentGravePerson = person;
        
        // Hi·ªÉn th·ªã k·∫øt qu·∫£
        const resultDiv = document.getElementById('graveResult');
        const resultTitle = document.getElementById('graveResultTitle');
        const personInfoDiv = document.getElementById('gravePersonInfo');
        const graveInfoDiv = document.getElementById('graveInfoText');
        const coordinatesDiv = document.getElementById('graveCoordinates');
        
        if (resultDiv) {
          resultDiv.style.display = 'block';
        }
        
        if (resultTitle) {
          resultTitle.textContent = `M·ªô ph·∫ßn c·ªßa ${person.full_name || 'Kh√¥ng r√µ t√™n'}`;
        }
        
        // Th√¥ng tin ng∆∞·ªùi
        if (personInfoDiv) {
          personInfoDiv.innerHTML = `
            <div><strong>Person ID:</strong> ${person.person_id || 'Ch∆∞a c√≥'}</div>
            <div><strong>T√™n ƒë·∫ßy ƒë·ªß:</strong> ${person.full_name || 'Ch∆∞a c√≥'}</div>
            ${person.alias ? `<div><strong>T√™n th∆∞·ªùng g·ªçi:</strong> ${person.alias}</div>` : ''}
            <div><strong>ƒê·ªùi:</strong> ${person.generation_level || 'Ch∆∞a c√≥'}</div>
            <div><strong>Gi·ªõi t√≠nh:</strong> ${person.gender || 'Ch∆∞a c√≥'}</div>
            ${person.birth_date ? `<div><strong>Ng√†y sinh:</strong> ${person.birth_date}</div>` : ''}
            ${person.death_date ? `<div><strong>Ng√†y m·∫•t:</strong> ${person.death_date}</div>` : ''}
            ${person.place_of_death ? `<div><strong>N∆°i m·∫•t:</strong> ${person.place_of_death}</div>` : ''}
            ${person.home_town ? `<div><strong>Qu√™ qu√°n:</strong> ${person.home_town}</div>` : ''}
          `;
        }
        
        // Th√¥ng tin m·ªô ph·∫ßn
        const graveInfo = person.grave_info || '';
        const coords = extractCoordinates(graveInfo);
        const graveInfoText = graveInfo ? graveInfo.replace(/\s*\|\s*lat:[\d.]+,\s*lng:[\d.]+/g, '').trim() : '';
        
        if (graveInfoDiv) {
          if (graveInfoText) {
            graveInfoDiv.innerHTML = graveInfoText;
          } else {
            graveInfoDiv.innerHTML = '<span style="color: var(--color-text-muted); font-style: italic;">Ch∆∞a c√≥ th√¥ng tin m·ªô ph·∫ßn. B·∫°n c√≥ th·ªÉ th√™m v·ªã tr√≠ b·∫±ng c√°ch nh·∫•n "C·∫≠p nh·∫≠t v·ªã tr√≠".</span>';
          }
        }
        
        if (coordinatesDiv) {
          if (coords.lat !== null && coords.lng !== null) {
            coordinatesDiv.innerHTML = `üìç T·ªça ƒë·ªô: ${coords.lat.toFixed(6)}, ${coords.lng.toFixed(6)}`;
            coordinatesDiv.style.color = 'var(--color-text)';
            coordinatesDiv.style.fontWeight = 'normal';
          } else {
            coordinatesDiv.innerHTML = '‚ö†Ô∏è Ch∆∞a c√≥ t·ªça ƒë·ªô ƒë·ªãnh v·ªã. Nh·∫•n "C·∫≠p nh·∫≠t v·ªã tr√≠" ƒë·ªÉ th√™m.';
            coordinatesDiv.style.color = 'var(--color-text-muted)';
            coordinatesDiv.style.fontWeight = 'normal';
          }
        }
        
        // Hi·ªÉn th·ªã b·∫£n ƒë·ªì
        await renderGraveMap(coords, person);
        
        // Scroll to result
        resultDiv?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
      } catch (err) {
        console.error('Error displaying grave info:', err);
        alert(`L·ªói khi hi·ªÉn th·ªã th√¥ng tin m·ªô ph·∫ßn: ${err.message}`);
      }
    }

    /**
     * Render map with grave location
     */
    async function renderGraveMap(coords, person) {
      const mapDiv = document.getElementById('graveMap');
      if (!mapDiv) return;
      
      // Clear previous map
      if (graveMap) {
        graveMap.remove();
        graveMap = null;
        graveMarker = null;
      }
      
      // Default center (Hu·∫ø, Vi·ªát Nam)
      let centerLat = 16.4637;
      let centerLng = 107.5909;
      let zoom = 10;
      
      if (coords.lat !== null && coords.lng !== null) {
        centerLat = coords.lat;
        centerLng = coords.lng;
        zoom = 15;
      }
      
      // Initialize map
      graveMap = L.map('graveMap').setView([centerLat, centerLng], zoom);
      
      // Add tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(graveMap);
      
      // Add marker if coordinates exist
      if (coords.lat !== null && coords.lng !== null) {
        graveMarker = L.marker([coords.lat, coords.lng], {
          draggable: false
        }).addTo(graveMap);
        
        graveMarker.bindPopup(`
          <strong>${person.full_name || 'Kh√¥ng r√µ t√™n'}</strong><br>
          ${person.grave_info ? escapeHtml(person.grave_info.replace(/\s*\|\s*lat:[\d.]+,\s*lng:[\d.]+/g, '').trim()) : 'M·ªô ph·∫ßn'}
        `).openPopup();
      } else {
        // Show message if no coordinates
        L.popup()
          .setLatLng([centerLat, centerLng])
          .setContent(`
            <div style="text-align: center;">
              <strong>Ch∆∞a c√≥ t·ªça ƒë·ªô ƒë·ªãnh v·ªã</strong><br>
              Nh·∫•n "C·∫≠p nh·∫≠t v·ªã tr√≠" ƒë·ªÉ th√™m t·ªça ƒë·ªô m·ªô ph·∫ßn<br>
              <small style="color: #666;">B·∫°n c√≥ th·ªÉ nh·∫•p v√†o b·∫£n ƒë·ªì ƒë·ªÉ ƒë·∫∑t marker</small>
            </div>
          `)
          .openOn(graveMap);
      }
    }

    /**
     * Enable grave location edit mode
     */
    function enableGraveLocationEdit() {
      if (!currentGravePerson || !graveMap) {
        alert('Vui l√≤ng t√¨m ki·∫øm m·ªô ph·∫ßn tr∆∞·ªõc');
        return;
      }
      
      graveEditMode = true;
      const controlsDiv = document.getElementById('graveMapControls');
      const updateBtn = document.getElementById('btnUpdateGraveLocation');
      
      if (controlsDiv) {
        controlsDiv.style.display = 'block';
      }
      
      if (updateBtn) {
        updateBtn.style.display = 'none';
      }
      
      // Make map clickable
      graveMap.on('click', onGraveMapClick);
      
      // Make marker draggable if exists
      if (graveMarker) {
        graveMarker.setDraggable(true);
        graveMarker.on('dragend', onGraveMarkerDrag);
      }
    }

    /**
     * Handle map click in edit mode
     */
    function onGraveMapClick(e) {
      const { lat, lng } = e.latlng;
      
      // Remove old marker
      if (graveMarker) {
        graveMap.removeLayer(graveMarker);
      }
      
      // Add new marker
      graveMarker = L.marker([lat, lng], {
        draggable: true
      }).addTo(graveMap);
      
      graveMarker.bindPopup(`
        <strong>V·ªã tr√≠ m·ªõi</strong><br>
        ${lat.toFixed(6)}, ${lng.toFixed(6)}
      `).openPopup();
      
      graveMarker.on('dragend', onGraveMarkerDrag);
      
      // Update coordinates display
      const coordinatesDiv = document.getElementById('graveCoordinates');
      if (coordinatesDiv) {
        coordinatesDiv.innerHTML = `üìç T·ªça ƒë·ªô m·ªõi: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        coordinatesDiv.style.color = 'var(--color-primary)';
        coordinatesDiv.style.fontWeight = 'bold';
      }
    }

    /**
     * Handle marker drag end
     */
    function onGraveMarkerDrag(e) {
      const marker = e.target;
      const position = marker.getLatLng();
      const { lat, lng } = position;
      
      // Update popup
      marker.setPopupContent(`
        <strong>V·ªã tr√≠ m·ªõi</strong><br>
        ${lat.toFixed(6)}, ${lng.toFixed(6)}
      `).openPopup();
      
      // Update coordinates display
      const coordinatesDiv = document.getElementById('graveCoordinates');
      if (coordinatesDiv) {
        coordinatesDiv.innerHTML = `üìç T·ªça ƒë·ªô m·ªõi: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        coordinatesDiv.style.color = 'var(--color-primary)';
        coordinatesDiv.style.fontWeight = 'bold';
      }
    }

    /**
     * Search address using Nominatim (OpenStreetMap)
     */
    let addressSearchTimeout = null;
    async function searchGraveAddress() {
      const searchInput = document.getElementById('graveAddressSearch');
      const suggestionsDiv = document.getElementById('graveAddressSuggestions');
      
      if (!searchInput || !graveMap) {
        return;
      }
      
      const query = searchInput.value.trim();
      if (!query || query.length < 3) {
        if (suggestionsDiv) {
          suggestionsDiv.style.display = 'none';
        }
        return;
      }
      
      // Clear previous timeout
      if (addressSearchTimeout) {
        clearTimeout(addressSearchTimeout);
      }
      
      // Show loading
      if (suggestionsDiv) {
        suggestionsDiv.innerHTML = '<div style="padding: var(--space-3); color: var(--color-text-muted); text-align: center;">ƒêang t√¨m ki·∫øm...</div>';
        suggestionsDiv.style.display = 'block';
      }
      
      addressSearchTimeout = setTimeout(async () => {
        try {
          // S·ª≠ d·ª•ng Nominatim API (OpenStreetMap) - mi·ªÖn ph√≠
          const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=vn&addressdetails=1`;
          
          const response = await fetch(url, {
            headers: {
              'User-Agent': 'TBQC-Genealogy-System/1.0'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const results = await response.json();
          
          if (!results || results.length === 0) {
            if (suggestionsDiv) {
              suggestionsDiv.innerHTML = '<div style="padding: var(--space-3); color: var(--color-text-muted); text-align: center;">Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ</div>';
            }
            return;
          }
          
          // Hi·ªÉn th·ªã suggestions
          if (suggestionsDiv) {
            suggestionsDiv.innerHTML = results.map((result, index) => {
              const displayName = result.display_name || result.name || 'Kh√¥ng r√µ ƒë·ªãa ch·ªâ';
              const lat = parseFloat(result.lat);
              const lng = parseFloat(result.lon);
              
              // Escape HTML v√† quotes ƒë·ªÉ tr√°nh XSS v√† l·ªói JavaScript
              const escapedName = displayName.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ');
              const escapedShortName = displayName.substring(0, 80).replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
              
              return `
                <div class="suggestion-item" onclick="selectGraveAddress(${lat}, ${lng}, '${escapedName}')" 
                     style="padding: var(--space-3); cursor: pointer; border-bottom: 1px solid var(--color-border); transition: background var(--transition-fast);">
                  <div style="font-weight: 600; color: var(--color-primary); margin-bottom: 4px;">
                    ${escapedShortName}${displayName.length > 80 ? '...' : ''}
                  </div>
                  <div style="font-size: var(--font-size-sm); color: var(--color-text-muted);">
                    üìç ${lat.toFixed(6)}, ${lng.toFixed(6)}
                  </div>
                </div>
              `;
            }).join('');
          }
        } catch (err) {
          console.error('Error searching address:', err);
          if (suggestionsDiv) {
            suggestionsDiv.innerHTML = `<div style="padding: var(--space-3); color: var(--color-error); text-align: center;">L·ªói khi t√¨m ki·∫øm: ${err.message}</div>`;
          }
        }
      }, 500);
    }
    
    /**
     * Select address from suggestions
     */
    function selectGraveAddress(lat, lng, addressName) {
      const suggestionsDiv = document.getElementById('graveAddressSuggestions');
      const searchInput = document.getElementById('graveAddressSearch');
      
      if (suggestionsDiv) {
        suggestionsDiv.style.display = 'none';
      }
      
      if (searchInput) {
        searchInput.value = addressName;
      }
      
      // Di chuy·ªÉn map ƒë·∫øn v·ªã tr√≠ v√† ƒë·∫∑t marker
      if (graveMap) {
        graveMap.setView([lat, lng], 16);
        
        // Remove old marker
        if (graveMarker) {
          graveMap.removeLayer(graveMarker);
        }
        
        // Add new marker
        graveMarker = L.marker([lat, lng], {
          draggable: true
        }).addTo(graveMap);
        
        // Escape HTML ƒë·ªÉ tr√°nh XSS (s·ª≠ d·ª•ng escapeHtml t·ª´ common.js n·∫øu c√≥)
        const escapedAddressName = typeof escapeHtml !== 'undefined' ? escapeHtml(addressName) : addressName.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        graveMarker.bindPopup(`
          <strong>${escapedAddressName}</strong><br>
          ${lat.toFixed(6)}, ${lng.toFixed(6)}
        `).openPopup();
        
        graveMarker.on('dragend', onGraveMarkerDrag);
        
        // Update coordinates display
        const coordinatesDiv = document.getElementById('graveCoordinates');
        if (coordinatesDiv) {
          coordinatesDiv.innerHTML = `üìç T·ªça ƒë·ªô m·ªõi: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
          coordinatesDiv.style.color = 'var(--color-primary)';
          coordinatesDiv.style.fontWeight = 'bold';
        }
      }
    }

    /**
     * Get current location using device GPS (Geolocation API)
     */
    function getCurrentLocation() {
      const statusDiv = document.getElementById('locationStatus');
      const btnGetLocation = document.getElementById('btnGetCurrentLocation');
      
      if (!navigator.geolocation) {
        alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã GPS. Vui l√≤ng s·ª≠ d·ª•ng tr√¨nh duy·ªát kh√°c ho·∫∑c c·∫≠p nh·∫≠t tr√¨nh duy·ªát.');
        return;
      }
      
      if (!graveMap) {
        alert('Vui l√≤ng t√¨m ki·∫øm m·ªô ph·∫ßn v√† b·∫≠t ch·∫ø ƒë·ªô ch·ªânh s·ª≠a tr∆∞·ªõc');
        return;
      }
      
      // Disable button v√† hi·ªÉn th·ªã tr·∫°ng th√°i
      if (btnGetLocation) {
        btnGetLocation.disabled = true;
        btnGetLocation.textContent = '‚è≥ ƒêang l·∫•y v·ªã tr√≠...';
      }
      
      if (statusDiv) {
        statusDiv.style.display = 'block';
        statusDiv.textContent = 'ƒêang l·∫•y v·ªã tr√≠ GPS t·ª´ ƒëi·ªán tho·∫°i...';
        statusDiv.style.color = 'var(--color-primary)';
      }
      
      // L·∫•y v·ªã tr√≠ v·ªõi ƒë·ªô ch√≠nh x√°c cao
      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const accuracy = position.coords.accuracy; // ƒê·ªô ch√≠nh x√°c t√≠nh b·∫±ng m√©t
          
          console.log(`[Grave Location] GPS Position: ${lat}, ${lng} (accuracy: ${accuracy}m)`);
          
          // Di chuy·ªÉn map ƒë·∫øn v·ªã tr√≠ GPS
          graveMap.setView([lat, lng], 18); // Zoom level 18 ƒë·ªÉ xem chi ti·∫øt
          
          // Remove old marker
          if (graveMarker) {
            graveMap.removeLayer(graveMarker);
          }
          
          // Add new marker t·∫°i v·ªã tr√≠ GPS
          graveMarker = L.marker([lat, lng], {
            draggable: true
          }).addTo(graveMap);
          
          graveMarker.bindPopup(`
            <strong>üìç V·ªã tr√≠ GPS</strong><br>
            ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>
            <small>ƒê·ªô ch√≠nh x√°c: ¬±${Math.round(accuracy)}m</small>
          `).openPopup();
          
          graveMarker.on('dragend', onGraveMarkerDrag);
          
          // Update coordinates display
          const coordinatesDiv = document.getElementById('graveCoordinates');
          if (coordinatesDiv) {
            coordinatesDiv.innerHTML = `üìç T·ªça ƒë·ªô GPS: ${lat.toFixed(6)}, ${lng.toFixed(6)} (ƒê·ªô ch√≠nh x√°c: ¬±${Math.round(accuracy)}m)`;
            coordinatesDiv.style.color = 'var(--color-primary)';
            coordinatesDiv.style.fontWeight = 'bold';
          }
          
          // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
          if (statusDiv) {
            statusDiv.textContent = `‚úÖ ƒê√£ l·∫•y v·ªã tr√≠ GPS th√†nh c√¥ng! ƒê·ªô ch√≠nh x√°c: ¬±${Math.round(accuracy)}m. Nh·∫•n "L∆∞u v·ªã tr√≠" ƒë·ªÉ l∆∞u l·∫°i.`;
            statusDiv.style.color = 'var(--color-success, #28a745)';
          }
          
          // Restore button
          if (btnGetLocation) {
            btnGetLocation.disabled = false;
            btnGetLocation.textContent = 'üìç ƒê·ªãnh v·ªã b·∫±ng ƒëi·ªán tho·∫°i';
          }
        },
        (error) => {
          console.error('[Grave Location] Geolocation error:', error);
          
          let errorMessage = 'Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ GPS. ';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMessage += 'B·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p v·ªã tr√≠. Vui l√≤ng c·∫•p quy·ªÅn trong c√†i ƒë·∫∑t tr√¨nh duy·ªát.';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage += 'V·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng. Vui l√≤ng ki·ªÉm tra GPS c·ªßa ƒëi·ªán tho·∫°i.';
              break;
            case error.TIMEOUT:
              errorMessage += 'H·∫øt th·ªùi gian ch·ªù l·∫•y v·ªã tr√≠. Vui l√≤ng th·ª≠ l·∫°i.';
              break;
            default:
              errorMessage += 'L·ªói kh√¥ng x√°c ƒë·ªãnh.';
              break;
          }
          
          alert(errorMessage);
          
          // Restore button
          if (btnGetLocation) {
            btnGetLocation.disabled = false;
            btnGetLocation.textContent = 'üìç ƒê·ªãnh v·ªã b·∫±ng ƒëi·ªán tho·∫°i';
          }
          
          if (statusDiv) {
            statusDiv.textContent = '‚ùå ' + errorMessage;
            statusDiv.style.color = 'var(--color-error, #dc3545)';
          }
        },
        {
          enableHighAccuracy: true, // S·ª≠ d·ª•ng GPS ƒë·ªô ch√≠nh x√°c cao
          timeout: 10000, // Timeout 10 gi√¢y
          maximumAge: 0 // Kh√¥ng s·ª≠ d·ª•ng cache, lu√¥n l·∫•y v·ªã tr√≠ m·ªõi
        }
      );
    }
    
    /**
     * Save grave location
     */
    async function saveGraveLocation() {
      if (!currentGravePerson || !graveMarker) {
        alert('Vui l√≤ng ƒë·∫∑t marker tr√™n b·∫£n ƒë·ªì tr∆∞·ªõc');
        return;
      }
      
      const position = graveMarker.getLatLng();
      const lat = position.lat;
      const lng = position.lng;
      
      try {
        const response = await fetch('/api/grave/update-location', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            person_id: currentGravePerson.person_id,
            latitude: lat,
            longitude: lng
          })
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
          throw new Error(data.error || 'L·ªói khi c·∫≠p nh·∫≠t v·ªã tr√≠');
        }
        
        alert('ƒê√£ c·∫≠p nh·∫≠t v·ªã tr√≠ m·ªô ph·∫ßn th√†nh c√¥ng!');
        
        // Reload grave info
        await displayGraveInfo(currentGravePerson.person_id);
        
        // Exit edit mode
        cancelGraveLocationEdit();
        
      } catch (err) {
        console.error('Error saving grave location:', err);
        alert(`L·ªói khi l∆∞u v·ªã tr√≠: ${err.message}`);
      }
    }

    /**
     * Cancel grave location edit
     */
    function cancelGraveLocationEdit() {
      graveEditMode = false;
      const controlsDiv = document.getElementById('graveMapControls');
      const updateBtn = document.getElementById('btnUpdateGraveLocation');
      const searchInput = document.getElementById('graveAddressSearch');
      const suggestionsDiv = document.getElementById('graveAddressSuggestions');
      
      if (controlsDiv) {
        controlsDiv.style.display = 'none';
      }
      
      if (updateBtn) {
        updateBtn.style.display = 'block';
      }
      
      // Clear search
      if (searchInput) {
        searchInput.value = '';
      }
      if (suggestionsDiv) {
        suggestionsDiv.style.display = 'none';
      }
      
      // Remove click handler
      if (graveMap) {
        graveMap.off('click', onGraveMapClick);
      }
      
      // Reload map to show original location
      if (currentGravePerson) {
        const graveInfo = currentGravePerson.grave_info || '';
        const coords = extractCoordinates(graveInfo);
        renderGraveMap(coords, currentGravePerson);
      }
    }

    // Handle Enter key in search inputs
    document.addEventListener('DOMContentLoaded', () => {
      const graveSearchInput = document.getElementById('graveSearchInput');
      if (graveSearchInput) {
        graveSearchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            searchGrave();
          }
        });
      }
      
    });
    
    // Add event listener for address search when edit mode is enabled
    // Wrap original function to add event listener
    const originalEnableGraveLocationEdit = enableGraveLocationEdit;
    enableGraveLocationEdit = function() {
      originalEnableGraveLocationEdit();
      
      // Add Enter key handler for address search after element is created
      setTimeout(() => {
        const graveAddressSearch = document.getElementById('graveAddressSearch');
        if (graveAddressSearch) {
          // Remove old listener if exists
          graveAddressSearch.removeEventListener('keypress', handleAddressSearchEnter);
          // Add new listener
          graveAddressSearch.addEventListener('keypress', handleAddressSearchEnter);
        }
      }, 100);
    };
    
    function handleAddressSearchEnter(e) {
      if (e.key === 'Enter') {
        searchGraveAddress();
      }
    }
  </script>
</body>
</html>

