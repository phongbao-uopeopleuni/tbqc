<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gia Ph·∫£ - Gia Ph·∫£ Nguy·ªÖn Ph∆∞·ªõc T·ªôc</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/main.css">
  <style>
    /* Page-specific styles */
    .genealogy-page {
      padding-top: var(--space-8);
      padding-bottom: var(--space-10);
      width: 100%;
      max-width: 100%;
    }
    
    /* Override container max-width ƒë·ªÉ full width */
    .genealogy-page .container {
      max-width: 100% !important;
      width: 100% !important;
      padding-left: var(--space-4);
      padding-right: var(--space-4);
    }
    
    .page-header {
      text-align: center;
      margin-bottom: var(--space-8);
    }
    
    .page-header h1 {
      font-size: var(--font-size-4xl);
      color: var(--color-primary);
      margin-bottom: var(--space-3);
    }
    
    .page-subtitle {
      font-size: var(--font-size-lg);
      color: var(--color-text-muted);
    }
    
    /* Layout d·ªçc: C√¢y tr√™n, Tra c·ª©u d∆∞·ªõi */
    .genealogy-layout {
      display: flex;
      flex-direction: column;
      gap: var(--space-8);
      margin-top: var(--space-6);
    }
    
    /* Ph·∫ßn tr√™n: C√¢y t∆∞∆°ng t√°c */
    .tree-section {
      width: 100%;
      max-width: 100%;
    }
    
    .tree-panel {
      width: 100%;
      max-width: 100%;
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: var(--space-4);
      align-items: start;
    }
    
    .tree-container-wrapper {
      grid-column: 1;
    }
    
    .tree-info-panel {
      grid-column: 2;
    }
    
    @media (max-width: 1200px) {
      .tree-panel {
        grid-template-columns: 1fr;
      }
      
      .tree-container-wrapper {
        grid-column: 1;
      }
      
      .tree-info-panel {
        grid-column: 1;
        order: -1;
        max-height: 300px;
      }
    }
    
    /* Ph·∫ßn d∆∞·ªõi: Tra c·ª©u */
    .lineage-panel {
      width: 100%;
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .lineage-card {
      padding: var(--space-6);
    }
    
    .lineage-header h2 {
      font-size: var(--font-size-xl);
      color: var(--color-primary);
      margin-bottom: var(--space-2);
    }
    
    .lineage-header p {
      color: var(--color-text-muted);
      font-size: var(--font-size-sm);
      margin-bottom: var(--space-4);
    }
    
    .lineage-controls {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }
    
    .lineage-input-group {
      position: relative;
    }
    
    .lineage-input-group label {
      display: block;
      margin-bottom: var(--space-2);
      font-weight: var(--font-weight-semibold);
      color: var(--color-primary);
      font-size: var(--font-size-sm);
    }
    
    .lineage-input-group input {
      width: 100%;
      height: 44px;
      padding: 0 var(--space-4);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
    }
    
    .lineage-input-group input:focus {
      outline: 2px solid rgba(139, 0, 0, 0.25);
      border-color: var(--color-primary);
    }
    
    .suggestions-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      margin-top: var(--space-1);
    }
    
    .suggestion-item {
      padding: var(--space-3) var(--space-4);
      cursor: pointer;
      border-bottom: 1px solid var(--color-border);
      transition: background var(--transition-fast);
    }
    
    .suggestion-item:hover {
      background: var(--color-bg);
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .lineage-result {
      margin-top: var(--space-4);
      padding: var(--space-5);
    }
    
    .lineage-result-header h3 {
      color: var(--color-primary);
      margin-bottom: var(--space-4);
    }
    
    .lineage-result-content {
      color: var(--color-text);
      line-height: var(--line-height-relaxed);
    }
    
    .lineage-detail-panel {
      margin-top: var(--space-4);
      padding: var(--space-5);
      max-height: 400px;
      overflow-y: auto;
    }
    
    .detail-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-border);
    }
    
    .detail-panel-header h3 {
      color: var(--color-primary);
      margin: 0;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: var(--font-size-2xl);
      color: var(--color-text-muted);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
    }
    
    .close-btn:hover {
      background: var(--color-bg);
      color: var(--color-text);
    }
    
    /* C√¢y t∆∞∆°ng t√°c */
    .tree-panel {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
      width: 100%;
    }
    
    .tree-controls {
      padding: var(--space-5);
    }
    
    .tree-controls-row {
      display: flex;
      gap: var(--space-4);
      flex-wrap: wrap;
      align-items: center;
    }
    
    .tree-controls-row label {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--font-size-sm);
      color: var(--color-text);
    }
    
    .tree-controls-row .input-group {
      flex: 1;
      min-width: 300px;
    }
    
    .tree-controls-row .input-group input {
      width: 100%;
    }
    
    .tree-container-wrapper {
      position: relative;
      height: 70vh;
      min-height: 600px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      overflow: auto;
      background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%);
      /* Full width - m·ªü r·ªông full ngang */
      width: 100%;
      max-width: 100%;
      /* Smooth scrolling */
      scroll-behavior: smooth;
    }
    
    /* Custom scrollbar */
    .tree-container-wrapper::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }
    
    .tree-container-wrapper::-webkit-scrollbar-track {
      background: var(--color-bg);
      border-radius: var(--radius-sm);
    }
    
    .tree-container-wrapper::-webkit-scrollbar-thumb {
      background: var(--color-primary);
      border-radius: var(--radius-sm);
    }
    
    .tree-container-wrapper::-webkit-scrollbar-thumb:hover {
      background: var(--color-primary-strong);
    }
    
    #treeContainer {
      width: 100%;
      height: 100%;
      min-height: 100%;
      position: relative;
      /* Cho ph√©p tree m·ªü r·ªông v∆∞·ª£t qu√° container ƒë·ªÉ c√≥ scroll ngang */
      overflow: visible;
    }
    
    /* Tree container c·∫ßn c√≥ width l·ªõn h∆°n ƒë·ªÉ scroll ngang */
    #treeContainer .tree {
      min-width: 2000px;
      width: auto;
      height: 100%;
      position: relative;
      overflow: visible;
    }
    
    /* ƒê·∫£m b·∫£o tree c√≥ th·ªÉ m·ªü r·ªông theo chi·ªÅu ngang */
    #treeContainer > div {
      min-width: 2000px;
      width: auto;
    }
    
    /* Tree Node Styles */
    #treeContainer .node {
      position: absolute;
      width: 140px;
      min-height: 100px;
      background: var(--color-surface);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-2);
      box-shadow: var(--shadow-sm);
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    
    #treeContainer .node:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      border-color: var(--color-primary);
      z-index: 20;
    }
    
    #treeContainer .node.founder {
      background: linear-gradient(135deg, #FFF8DC 0%, #FFE4B5 100%);
      border-color: var(--color-primary);
      border-width: 3px;
      font-weight: var(--font-weight-bold);
    }
    
    #treeContainer .node.male {
      background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
      border-color: #1976D2;
    }
    
    #treeContainer .node.female {
      background: linear-gradient(135deg, #FCE4EC 0%, #F8BBD0 100%);
      border-color: #C2185B;
    }
    
    #treeContainer .node.dead {
      opacity: 0.7;
      border-style: dashed;
    }
    
    #treeContainer .node.highlighted {
      border-color: #FF6B35;
      border-width: 3px;
      box-shadow: 0 0 15px rgba(255, 107, 53, 0.5);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 0 15px rgba(255, 107, 53, 0.5);
      }
      50% {
        box-shadow: 0 0 25px rgba(255, 107, 53, 0.8);
      }
    }
    
    #treeContainer .node-name {
      font-size: 11px;
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      margin-bottom: 4px;
      line-height: 1.2;
      word-wrap: break-word;
      overflow-wrap: break-word;
      hyphens: auto;
    }
    
    #treeContainer .node-parents {
      font-size: 9px;
      color: var(--color-text-muted);
      margin-bottom: 4px;
      line-height: 1.2;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    #treeContainer .node-generation {
      display: inline-block;
      background: var(--color-primary);
      color: var(--color-surface);
      font-size: 9px;
      font-weight: var(--font-weight-bold);
      padding: 2px 6px;
      border-radius: var(--radius-full);
      margin-top: 2px;
    }
    
    /* Connector Styles */
    #treeContainer .connector {
      position: absolute;
      z-index: 1;
      pointer-events: none;
    }
    
    #treeContainer .connector.vertical {
      background: linear-gradient(to bottom, var(--color-primary) 0%, var(--color-primary) 100%);
      width: 3px;
      box-shadow: 0 0 3px rgba(139, 0, 0, 0.4);
    }
    
    #treeContainer .connector.horizontal {
      background: linear-gradient(to right, var(--color-primary) 0%, var(--color-primary) 100%);
      height: 3px;
      box-shadow: 0 0 3px rgba(139, 0, 0, 0.4);
    }
    
    .tree-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: var(--font-size-lg);
      color: var(--color-primary);
      font-weight: var(--font-weight-semibold);
    }
    
    .tree-info-panel {
      padding: var(--space-5);
      max-height: 70vh;
      overflow-y: auto;
      position: sticky;
      top: var(--space-4);
      background: var(--color-surface);
      box-shadow: var(--shadow-md);
    }
    
    .tree-info-panel h3 {
      color: var(--color-primary);
      margin-bottom: var(--space-4);
      font-size: var(--font-size-lg);
    }
    
    .tree-info-content {
      color: var(--color-text);
      line-height: var(--line-height-relaxed);
    }
    
    .tree-info-content p {
      color: var(--color-text-muted);
      font-style: italic;
    }
    
    #searchResults {
      margin-top: var(--space-4);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      background: var(--color-bg);
      display: none;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .search-result-item {
      padding: var(--space-3) var(--space-4);
      margin: var(--space-2) 0;
      background: var(--color-surface);
      border-radius: var(--radius-md);
      cursor: pointer;
      border-left: 3px solid var(--color-primary);
      transition: all var(--transition-fast);
    }
    
    .search-result-item:hover {
      background: var(--color-bg);
      transform: translateX(4px);
    }
    
    /* Mobile responsive */
    @media (max-width: 1023px) {
      .tree-container-wrapper {
        height: 60vh;
        min-height: 500px;
      }
      
      .tree-controls-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .tree-controls-row .input-group {
        min-width: auto;
      }
      
      .lineage-panel {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="/" class="navbar-logo">Ph√≤ng Tuy Bi√™n Qu·∫≠n C√¥ng ‚Äì Gia Ph·∫£ Nguy·ªÖn Ph∆∞·ªõc T·ªôc</a>
    <button class="navbar-toggle" onclick="toggleNavbar()">‚ò∞</button>
    <ul class="navbar-menu" id="navbarMenu">
      <li><a href="/">Trang ch·ªß</a></li>
      <li><a href="/genealogy" class="active">Gia ph·∫£</a></li>
      <li><a href="/activities">Ho·∫°t ƒë·ªông</a></li>
      <li><a href="/members">Th√†nh vi√™n</a></li>
      <li><a href="/contact">Li√™n h·ªá</a></li>
      <li><a href="/login">ƒêƒÉng nh·∫≠p</a></li>
    </ul>
  </nav>

  <div class="container genealogy-page">
    <div class="page-header">
      <h1>üå≥ Gia Ph·∫£</h1>
      <p class="page-subtitle">C√¢y Gia Ph·∫£ T∆∞∆°ng T√°c v√† Tra C·ª©u Chu·ªói Ph·∫£ H·ªá</p>
    </div>

    <div class="genealogy-layout">
      <!-- Ph·∫ßn tr√™n: C√¢y t∆∞∆°ng t√°c -->
      <div class="tree-section">
        <div class="tree-panel">
          <div class="card tree-controls">
            <div class="tree-controls-row">
              <label>
                <span>Hi·ªÉn th·ªã ƒë·∫øn ƒë·ªùi:</span>
                <select id="genFilter" class="select">
                  <option value="5" selected>ƒê·∫øn ƒë·ªùi 5</option>
                  <option value="6">ƒê·∫øn ƒë·ªùi 6</option>
                  <option value="7">ƒê·∫øn ƒë·ªùi 7</option>
                  <option value="8">ƒê·∫øn ƒë·ªùi 8</option>
                </select>
              </label>
              
              <div class="input-group" style="flex: 1; min-width: 300px;">
                <input type="text" class="input" id="searchInput" placeholder="Vui l√≤ng nh·∫≠p t√™n c·∫ßn t√¨m ki·∫øm">
              </div>
              <button id="searchBtn" class="btn btn-primary">T√¨m ki·∫øm</button>
            </div>
            
            <!-- Search Results -->
            <div id="searchResults" style="margin-top: var(--space-4); display: none;"></div>
          </div>
          
          <!-- Tree Container -->
          <div class="tree-container-wrapper">
            <div id="treeContainer">
              <div class="tree-loading">ƒêang t·∫£i c√¢y gia ph·∫£...</div>
            </div>
          </div>
          
          <!-- Info Panel -->
          <div class="card tree-info-panel" id="infoPanel">
            <h3>Th√¥ng tin chi ti·∫øt</h3>
            <div class="tree-info-content" id="infoContent">
              <p>Ch·ªçn m·ªôt ng∆∞·ªùi trong c√¢y ƒë·ªÉ xem th√¥ng tin</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Ph·∫ßn d∆∞·ªõi: Tra c·ª©u chu·ªói ph·∫£ h·ªá -->
      <div class="lineage-panel">
        <div class="card lineage-card">
          <div class="lineage-header">
            <h2>üîç Tra c·ª©u chu·ªói ph·∫£ h·ªá</h2>
            <p>Nh·∫≠p t√™n ƒë·ªÉ t√¨m ki·∫øm chu·ªói ph·∫£ h·ªá theo d√≤ng cha. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª£i √Ω.</p>
          </div>
          
          <div class="lineage-controls">
            <div class="lineage-input-group">
              <label for="lineageName">T√™n (t√¨m ki·∫øm th√¥ng minh):</label>
              <input type="text" class="input" id="lineageName" placeholder="V√≠ d·ª•: B·∫£o Phong ho·∫∑c Bao Ph..." 
                     autocomplete="off" oninput="handleLineageSearchInput()">
              <div id="lineageSuggestions" class="suggestions-dropdown" style="display: none;">
                <!-- Suggestions s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
              </div>
            </div>
            <button id="btnSearchLineage" onclick="searchLineage()" class="btn btn-primary">üîç T√¨m chu·ªói ph·∫£ h·ªá</button>
          </div>

          <!-- Panel th√¥ng tin chi ti·∫øt -->
          <div class="lineage-detail-panel card" id="lineageDetailPanel" style="display: none;">
            <div class="detail-panel-header">
              <h3>üìã Th√¥ng tin chi ti·∫øt</h3>
              <button onclick="closeDetailPanel()" class="close-btn">&times;</button>
            </div>
            <div class="detail-panel-content" id="lineageDetailContent">
              <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
            </div>
          </div>

          <!-- K·∫øt qu·∫£ tra c·ª©u -->
          <div class="lineage-result card" id="lineageResult" style="display: none;">
            <div class="lineage-result-header">
              <h3 id="lineageResultTitle"></h3>
            </div>
            <div class="lineage-result-content" id="lineageResultContent">
              <!-- K·∫øt qu·∫£ s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
            </div>
          </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section: Member Stats -->
      <section id="stats" style="margin-top: var(--space-10);">
        <div class="section-container" style="max-width: 1200px; margin: 0 auto; padding: 0 var(--space-4);">
          <h2 class="section-title" style="text-align: center; font-size: var(--font-size-3xl); color: var(--color-primary); margin-bottom: var(--space-4);">Th·ªëng K√™ Th√†nh Vi√™n</h2>
          <p class="stats-subtitle" style="text-align: center; color: var(--color-text-muted); margin-bottom: var(--space-6); font-size: var(--font-size-base);">
            Th·ªëng k√™ nhanh s·ªë l∆∞·ª£ng th√†nh vi√™n trong gia ph·∫£ Tuy Bi√™n Ph√≤ng ‚Äì Nam, N·ªØ v√† c√°c tr∆∞·ªùng h·ª£p ch∆∞a r√µ.
          </p>

          <div class="stats-layout" style="display: grid; grid-template-columns: 1.2fr 2fr; gap: var(--space-8); align-items: stretch;">
            <div class="stats-summary" style="display: grid; grid-template-columns: 1fr; gap: var(--space-4);">
              <div class="stats-card card" style="border-left: 5px solid var(--color-primary);">
                <div class="stats-label" style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">T·ªïng th√†nh vi√™n</div>
                <div class="stats-value" id="statsTotalMembers" style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
              <div class="stats-card card" style="border-left: 5px solid var(--color-primary);">
                <div class="stats-label" style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">S·ªë Nam</div>
                <div class="stats-value" id="statsMaleCount" style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
              <div class="stats-card card" style="border-left: 5px solid var(--color-primary);">
                <div class="stats-label" style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">S·ªë N·ªØ</div>
                <div class="stats-value" id="statsFemaleCount" style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
              <div class="stats-card card" style="border-left: 5px solid var(--color-primary);">
                <div class="stats-label" style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">Kh√¥ng r√µ / kh√°c</div>
                <div class="stats-value" id="statsUnknownCount" style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
            </div>

            <div class="stats-charts" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-5);">
              <div class="stats-chart-card card">
                <h3 style="margin-bottom: var(--space-3); font-size: var(--font-size-base); color: var(--color-primary); text-align: center;">C∆° c·∫•u gi·ªõi t√≠nh</h3>
                <canvas id="genderPieChart"></canvas>
              </div>
              <div class="stats-chart-card card">
                <h3 style="margin-bottom: var(--space-3); font-size: var(--font-size-base); color: var(--color-primary); text-align: center;">Th√†nh vi√™n theo gi·ªõi t√≠nh</h3>
                <canvas id="genderBarChart"></canvas>
              </div>
            </div>
          </div>

          <!-- Th·ªëng k√™ theo ƒë·ªùi -->
          <div class="generation-stats-section" style="margin-top: var(--space-8);">
            <h3 style="text-align: center; font-size: var(--font-size-xl); color: var(--color-primary); margin-bottom: var(--space-5);">Th·ªëng K√™ Theo ƒê·ªùi</h3>
            <div class="generation-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6);">
              <div class="generation-stat-card card" id="gen1Card" style="text-align: center; padding: var(--space-4); border-left: 4px solid var(--color-primary);">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">ƒê·ªùi 1</div>
                <div class="generation-stat-value" id="gen1Count" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
              <div class="generation-stat-card card" id="gen2Card" style="text-align: center; padding: var(--space-4); border-left: 4px solid var(--color-primary);">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">ƒê·ªùi 2</div>
                <div class="generation-stat-value" id="gen2Count" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
              <div class="generation-stat-card card" id="gen3Card" style="text-align: center; padding: var(--space-4); border-left: 4px solid var(--color-primary);">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">ƒê·ªùi 3</div>
                <div class="generation-stat-value" id="gen3Count" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
              <div class="generation-stat-card card" id="gen4Card" style="text-align: center; padding: var(--space-4); border-left: 4px solid var(--color-primary);">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">ƒê·ªùi 4</div>
                <div class="generation-stat-value" id="gen4Count" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
              <div class="generation-stat-card card" id="gen5Card" style="text-align: center; padding: var(--space-4); border-left: 4px solid var(--color-primary);">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">ƒê·ªùi 5</div>
                <div class="generation-stat-value" id="gen5Count" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
              <div class="generation-stat-card card" id="gen6Card" style="text-align: center; padding: var(--space-4); border-left: 4px solid var(--color-primary);">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">ƒê·ªùi 6</div>
                <div class="generation-stat-value" id="gen6Count" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
              <div class="generation-stat-card card" id="gen7Card" style="text-align: center; padding: var(--space-4); border-left: 4px solid var(--color-primary);">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">ƒê·ªùi 7</div>
                <div class="generation-stat-value" id="gen7Count" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
              <div class="generation-stat-card card" id="gen8Card" style="text-align: center; padding: var(--space-4); border-left: 4px solid var(--color-primary);">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">ƒê·ªùi 8</div>
                <div class="generation-stat-value" id="gen8Count" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">‚Äì</div>
              </div>
            </div>
            <div class="generation-chart-container card" style="padding: var(--space-5);">
              <h3 style="margin-bottom: var(--space-4); font-size: var(--font-size-base); color: var(--color-primary); text-align: center;">Bi·ªÉu ƒë·ªì s·ªë ng∆∞·ªùi theo ƒë·ªùi</h3>
              <canvas id="generationBarChart"></canvas>
            </div>
          </div>

          <div id="statsErrorMessage" style="display:none; margin-top: var(--space-5); text-align: center; color: var(--color-error); font-weight: var(--font-weight-semibold);">
            L·ªói: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu th·ªëng k√™. Vui l√≤ng th·ª≠ l·∫°i sau.
          </div>
        </div>
      </section>
    </div>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Load genealogy scripts -->
  <script src="/static/js/common.js"></script>
  <script src="/static/js/family-tree-core.js"></script>
  <script src="/static/js/family-tree-ui.js"></script>
  <script src="/static/js/genealogy-lineage.js"></script>
  
  <!-- Tree controls event listeners -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // GenFilter change handler
      const genFilter = document.getElementById('genFilter');
      if (genFilter) {
        genFilter.addEventListener('change', async (e) => {
          const maxGen = parseInt(e.target.value);
          console.log('[Genealogy] GenFilter changed to:', maxGen);
          
          // Reload tree v·ªõi maxGeneration m·ªõi
          try {
            const container = document.getElementById('treeContainer');
            if (container) {
              container.innerHTML = '<div class="tree-loading">ƒêang t·∫£i c√¢y gia ph·∫£...</div>';
            }
            
            // Load l·∫°i tree data v·ªõi maxGeneration m·ªõi
            if (typeof loadTreeData === 'function') {
              const { graph: newGraph } = await loadTreeData(maxGen, 'P-1-1');
              if (newGraph && typeof renderDefaultTree === 'function') {
                renderDefaultTree(newGraph, maxGen);
              }
            } else {
              console.error('[Genealogy] loadTreeData function not found');
            }
          } catch (err) {
            console.error('[Genealogy] Error reloading tree:', err);
            const container = document.getElementById('treeContainer');
            if (container) {
              container.innerHTML = `<div style="padding: 20px; color: #d32f2f; text-align: center;">
                <h3>L·ªói khi t·∫£i c√¢y gia ph·∫£</h3>
                <p>${err.message}</p>
              </div>`;
            }
          }
        });
      }
      
      // Search button handler
      const searchBtn = document.getElementById('searchBtn');
      const searchInput = document.getElementById('searchInput');
      const searchResults = document.getElementById('searchResults');
      
      if (searchBtn && searchInput) {
        const handleSearch = async () => {
          const query = searchInput.value.trim();
          if (!query) {
            alert('Vui l√≤ng nh·∫≠p t√™n c·∫ßn t√¨m ki·∫øm');
            return;
          }
          
          const maxGen = genFilter ? parseInt(genFilter.value) : 5;
          console.log('[Genealogy] Searching for:', query, 'maxGen:', maxGen);
          
          // Hi·ªÉn th·ªã loading
          if (searchResults) {
            searchResults.style.display = 'block';
            searchResults.innerHTML = '<div style="padding: 10px; color: #666;">ƒêang t√¨m ki·∫øm...</div>';
          }
          
          try {
            const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=30`);
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            
            const results = await response.json();
            if (results.length === 0) {
              if (searchResults) {
                searchResults.innerHTML = `<div style="padding: 10px; color: #666;">Kh√¥ng t√¨m th·∫•y "${query}"</div>`;
              } else {
                alert(`Kh√¥ng t√¨m th·∫•y "${query}"`);
              }
              return;
            }
            
            // Hi·ªÉn th·ªã k·∫øt qu·∫£ t√¨m ki·∫øm
            if (searchResults) {
              searchResults.innerHTML = results.map(person => {
                const gen = person.generation_number || person.generation_level || '';
                return `
                  <div class="search-result-item" data-person-id="${person.person_id}" 
                       style="padding: 10px; margin: 5px 0; background: #f5f5f5; border-radius: 6px; cursor: pointer; border-left: 3px solid var(--color-primary);"
                       onmouseover="this.style.background='#FFE4B5'" 
                       onmouseout="this.style.background='#f5f5f5'">
                    <strong>${escapeHtml(person.full_name || person.name || '')}</strong>
                    ${gen ? ` - ƒê·ªùi ${gen}` : ''}
            </div>
                `;
              }).join('');
              
              // Add click handlers
              searchResults.querySelectorAll('.search-result-item').forEach(el => {
                el.addEventListener('click', async () => {
                  const personId = el.getAttribute('data-person-id');
                  console.log('[Genealogy] Selected person:', personId);
                  
                  // Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt ngay l·∫≠p t·ª©c
                  if (typeof showPersonInfo === 'function') {
                    showPersonInfo(personId);
                  }
                  
                  // Reload tree v·ªõi maxGen v√† focus v√†o person n√†y
                  try {
                    const container = document.getElementById('treeContainer');
                    if (container) {
                      container.innerHTML = '<div class="tree-loading">ƒêang t·∫£i c√¢y gia ph·∫£...</div>';
                    }
                    
                    // Load l·∫°i tree data v·ªõi maxGeneration
                    if (typeof loadTreeData === 'function') {
                      const { graph: newGraph } = await loadTreeData(maxGen, 'P-1-1');
                      if (newGraph && typeof renderFocusTree === 'function') {
                        renderFocusTree(personId);
                      } else if (newGraph && typeof renderDefaultTree === 'function') {
                        renderDefaultTree(newGraph, maxGen);
                        // Highlight person sau khi render
                        setTimeout(() => {
                          const node = document.querySelector(`[data-person-id="${personId}"]`);
                          if (node) {
                            node.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                            node.classList.add('highlighted');
                          }
                        }, 500);
                      }
                    }
                    
                    // ·∫®n search results
                    if (searchResults) {
                      searchResults.style.display = 'none';
                    }
                    if (searchInput) {
                      searchInput.value = '';
                    }
                  } catch (err) {
                    console.error('[Genealogy] Error loading tree:', err);
                    alert(`L·ªói khi t·∫£i c√¢y gia ph·∫£: ${err.message}`);
                  }
                });
              });
            } else {
              // Fallback: n·∫øu kh√¥ng c√≥ searchResults div, d√πng alert
              if (results.length === 1) {
                const person = results[0];
                if (typeof renderFocusTree === 'function') {
                  renderFocusTree(person.person_id);
                }
              } else {
                alert(`T√¨m th·∫•y ${results.length} k·∫øt qu·∫£. Vui l√≤ng ch·ªçn t·ª´ danh s√°ch.`);
              }
            }
          } catch (err) {
            console.error('[Genealogy] Search error:', err);
            if (searchResults) {
              searchResults.innerHTML = `<div style="padding: 10px; color: #d32f2f;">L·ªói: ${err.message}</div>`;
            } else {
              alert(`L·ªói khi t√¨m ki·∫øm: ${err.message}`);
            }
          }
        };
        
        searchBtn.addEventListener('click', handleSearch);
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            handleSearch();
          }
        });
      }
    });
  </script>
  
  <!-- Lineage UI Functions -->
  <script>
    // Lineage search state
    let selectedPerson = null;
    let searchTimeout = null;
    
    /**
     * X·ª≠ l√Ω khi ng∆∞·ªùi d√πng g√µ v√†o √¥ t√¨m ki·∫øm (autocomplete)
     */
    function handleLineageSearchInput() {
      const nameInput = document.getElementById('lineageName');
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      
      if (!nameInput || !suggestionsDiv) {
        console.warn('[Lineage] Required elements not found for search input');
        return;
      }
      
      const query = nameInput.value.trim();
      
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
      
      if (!query || query.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
      }
      
      searchTimeout = setTimeout(async () => {
        try {
          const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=10`);
          
          if (!response.ok) {
            suggestionsDiv.style.display = 'none';
            return;
          }
          
          const results = await response.json();
          
          if (results.length === 0) {
            suggestionsDiv.innerHTML = '<div class="suggestion-item" style="color: #999; font-style: italic;">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>';
            suggestionsDiv.style.display = 'block';
            return;
          }
          
          suggestionsDiv.innerHTML = results.map((person) => {
            const gen = person.generation_level || person.generation_number || '?';
            const name = person.full_name || 'Kh√¥ng r√µ t√™n';
            const fatherName = person.father_name || '';
            const motherName = person.mother_name || '';
            
            let parentInfo = '';
            if (fatherName && motherName) {
              parentInfo = `Con c·ªßa: √îng ${escapeHtml(fatherName)} & B√† ${escapeHtml(motherName)}`;
            } else if (fatherName) {
              parentInfo = `Con c·ªßa: √îng ${escapeHtml(fatherName)}`;
            } else if (motherName) {
              parentInfo = `Con c·ªßa: B√† ${escapeHtml(motherName)}`;
            } else {
              parentInfo = 'Ch∆∞a c√≥ th√¥ng tin cha m·∫π';
            }
            
            return `
              <div class="suggestion-item" onclick="selectSuggestionFromSearch('${person.person_id}')" style="cursor: pointer;">
                <div style="font-weight: 600; color: var(--color-primary); margin-bottom: 4px;">
                  ${escapeHtml(name)} ‚Äì ƒê·ªùi ${gen}
          </div>
                <div style="color: var(--color-text-muted); font-size: 14px;">
                  ${parentInfo}
                </div>
              </div>
            `;
          }).join('');
          
          suggestionsDiv.style.display = 'block';
        } catch (err) {
          console.error('Error in autocomplete:', err);
          suggestionsDiv.style.display = 'none';
        }
      }, 300);
    }
    
    /**
     * Select suggestion from search results
     */
    async function selectSuggestionFromSearch(personId) {
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      if (suggestionsDiv) {
        suggestionsDiv.style.display = 'none';
      }
      
      await displayLineageForPersonFromAPI(personId);
    }
    
    /**
     * Search lineage
     */
    async function searchLineage() {
      const nameInput = document.getElementById('lineageName');
      
      if (!nameInput) {
        console.error('[Lineage] lineageName input not found');
        alert('L·ªói: Kh√¥ng t√¨m th·∫•y √¥ nh·∫≠p li·ªáu');
        return;
      }
      
      const name = nameInput.value.trim();
      
      if (!name) {
        alert('Vui l√≤ng nh·∫≠p t√™n ho·∫∑c ch·ªçn t·ª´ danh s√°ch g·ª£i √Ω');
        return;
      }
      
      const suggestionsDiv = document.getElementById('lineageSuggestions');
      if (suggestionsDiv) {
        suggestionsDiv.style.display = 'none';
      }
      
      try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(name)}&limit=20`);
        
        if (!response.ok) {
          throw new Error(`API tr·∫£ m√£ ${response.status}`);
        }
        
        const results = await response.json();
        
        if (results.length === 0) {
          alert(`Kh√¥ng t√¨m th·∫•y "${name}"`);
          return;
        }
        
        if (results.length > 1) {
          if (suggestionsDiv) {
            suggestionsDiv.innerHTML = results.map((person) => {
              const gen = person.generation_level || person.generation_number || '?';
              const name = person.full_name || 'Kh√¥ng r√µ t√™n';
              const fatherName = person.father_name || '';
              const motherName = person.mother_name || '';
              
              let parentInfo = '';
              if (fatherName && motherName) {
                parentInfo = `Con c·ªßa: √îng ${escapeHtml(fatherName)} & B√† ${escapeHtml(motherName)}`;
              } else if (fatherName) {
                parentInfo = `Con c·ªßa: √îng ${escapeHtml(fatherName)}`;
              } else if (motherName) {
                parentInfo = `Con c·ªßa: B√† ${escapeHtml(motherName)}`;
              } else {
                parentInfo = 'Ch∆∞a c√≥ th√¥ng tin cha m·∫π';
              }
              
              return `
                <div class="suggestion-item" onclick="selectSuggestionFromSearch('${person.person_id}')" style="cursor: pointer;">
                  <div style="font-weight: 600; color: var(--color-primary); margin-bottom: 4px;">
                    ${escapeHtml(name)} ‚Äì ƒê·ªùi ${gen}
        </div>
                  <div style="color: var(--color-text-muted); font-size: 14px;">
                    ${parentInfo}
                  </div>
                </div>
              `;
            }).join('');
            suggestionsDiv.style.display = 'block';
          }
          return;
        }
        
        const person = results[0];
        await displayLineageForPersonFromAPI(person.person_id);
      } catch (err) {
        console.error('Error searching lineage:', err);
        alert(`L·ªói khi t√¨m ki·∫øm: ${err.message}`);
      }
    }
    
    /**
     * Display lineage for person using API
     */
    async function displayLineageForPersonFromAPI(personId) {
      try {
        console.log(`[Lineage] Fetching lineage for person_id: ${personId}`);
        
        const ancestorsRes = await fetch(`/api/ancestors/${personId}`);
        
        if (!ancestorsRes.ok) {
          throw new Error(`API /api/ancestors/${personId} tr·∫£ m√£ ${ancestorsRes.status}`);
        }
        
        const ancestorsData = await ancestorsRes.json();
        
        let lineage = [];
        if (ancestorsData.ancestors_chain && Array.isArray(ancestorsData.ancestors_chain)) {
          lineage = ancestorsData.ancestors_chain;
        }
        
        if (ancestorsData.person) {
          const currentPersonId = String(ancestorsData.person.person_id || '').trim();
          const alreadyInChain = lineage.some(p => {
            const pId = String(p.person_id || '').trim();
            return pId === currentPersonId && pId !== '';
          });
          
          if (!alreadyInChain && currentPersonId) {
            lineage.push(ancestorsData.person);
          }
        }
        
        displayLineageChain(lineage);
        
        try {
          const personRes = await fetch(`/api/person/${personId}`);
          if (personRes.ok) {
            const person = await personRes.json();
            selectedPerson = person.person || person;
            showDetailPanel(selectedPerson);
          }
        } catch (err) {
          console.warn('[Lineage] Could not fetch full person details:', err);
          if (ancestorsData.person) {
            selectedPerson = ancestorsData.person;
            showDetailPanel(ancestorsData.person);
          }
        }
      } catch (err) {
        console.error('Error displaying lineage:', err);
        alert(`L·ªói khi hi·ªÉn th·ªã chu·ªói ph·∫£ h·ªá: ${err.message}`);
      }
    }
    
    /**
     * Normalize parent names
     */
    function normalizeParentName(name, isFather = true) {
      if (!name) return null;
      name = name.replace(/^(√îng|B√†|Vua)\s+/i, '').trim();
      return name;
    }
    
    /**
     * Get Gen 1 parents
     */
    function getGen1Parents() {
      return {
        father_name: 'Vua Gia Long',
        mother_name: 'Thu·∫≠n Thi√™n Ho√†ng h·∫≠u'
      };
    }
    
    /**
     * Display lineage chain
     */
    function displayLineageChain(lineage) {
      const resultDiv = document.getElementById('lineageResult');
      const resultContent = document.getElementById('lineageResultContent');
      const resultTitle = document.getElementById('lineageResultTitle');
      
      if (!resultDiv) return;
      
      if (!lineage || lineage.length === 0) {
        if (resultContent) {
          resultContent.innerHTML = '<div style="padding: 20px; color: #666; text-align: center;">Kh√¥ng c√≥ d·ªØ li·ªáu chu·ªói ph·∫£ h·ªá</div>';
        }
        resultDiv.style.display = 'block';
        return;
      }
      
      const seenIds = new Set();
      const uniqueLineage = [];
      
      for (const p of lineage) {
        let personId = p.person_id;
        if (personId === null || personId === undefined || personId === '') {
          continue;
        }
        
        const personIdStr = String(personId).trim();
        if (!personIdStr || seenIds.has(personIdStr)) {
          continue;
        }
        
        seenIds.add(personIdStr);
        uniqueLineage.push(p);
      }
      
      const sortedLineage = [...uniqueLineage].sort((a, b) => {
        const genA = a.generation_number || a.generation_level || 0;
        const genB = b.generation_number || b.generation_level || 0;
        if (genA !== genB) {
          return genA - genB;
        }
        const idA = String(a.person_id || '');
        const idB = String(b.person_id || '');
        return idA.localeCompare(idB);
      });
      
      const hasGen1 = sortedLineage.some(p => (p.generation_number === 1 || p.generation_level === 1));
      if (!hasGen1) {
        const gen1Person = {
          person_id: 'P-1-1',
          full_name: 'Vua Minh M·∫°ng',
          generation_number: 1,
          generation_level: 1,
          father_name: 'Vua Gia Long',
          mother_name: 'Thu·∫≠n Thi√™n Ho√†ng h·∫≠u',
          gender: 'Nam',
          status: 'ƒê√£ m·∫•t'
        };
        sortedLineage.unshift(gen1Person);
      } else {
        const gen1Index = sortedLineage.findIndex(p => (p.generation_number === 1 || p.generation_level === 1));
        if (gen1Index !== -1) {
          const gen1Parents = getGen1Parents();
          sortedLineage[gen1Index].father_name = gen1Parents.father_name;
          sortedLineage[gen1Index].mother_name = gen1Parents.mother_name;
        }
      }
      
      const targetPerson = sortedLineage[sortedLineage.length - 1];
      
      if (resultTitle) {
        resultTitle.textContent = `Chu·ªói ph·∫£ h·ªá c·ªßa ${targetPerson.full_name || 'Ng∆∞·ªùi ƒë∆∞·ª£c ch·ªçn'}`;
      }
      
      const groupedByGen = {};
      sortedLineage.forEach(p => {
        const gen = p.generation_number || p.generation_level || 0;
        if (!groupedByGen[gen]) {
          groupedByGen[gen] = [];
        }
        groupedByGen[gen].push(p);
      });
      
      let timelineHTML = '';
      Object.keys(groupedByGen).sort((a, b) => parseInt(a) - parseInt(b)).forEach(gen => {
        const personsInGen = groupedByGen[gen];
        const genNum = parseInt(gen);
        
        if (genNum === 1 && personsInGen.length > 1) {
          timelineHTML += '<div style="display: flex; flex-direction: row; gap: 16px; width: 100%; margin-bottom: 16px;">';
          personsInGen.forEach(p => {
            timelineHTML += generatePersonCard(p, genNum, false);
          });
          timelineHTML += '</div>';
        } else {
          personsInGen.forEach(p => {
            timelineHTML += generatePersonCard(p, genNum, true);
          });
        }
      });
      
      function generatePersonCard(p, gen, isFullWidth = true) {
        const name = p.full_name || 'Kh√¥ng r√µ t√™n';
        const fatherName = normalizeParentName(p.father_name, true) || p.father_name || '';
        const motherName = normalizeParentName(p.mother_name, false) || p.mother_name || '';
        
        const titleLine = `ƒê·ªùi ${gen} ‚Äì ${escapeHtml(name)}`;
        
        let parentInfo = '';
        if (fatherName && motherName) {
          parentInfo = `Con c·ªßa √îng ${escapeHtml(fatherName)} v√† B√† ${escapeHtml(motherName)}`;
        } else if (fatherName) {
          parentInfo = `Con c·ªßa √îng ${escapeHtml(fatherName)} v√† B√† Ch∆∞a c√≥ th√¥ng tin`;
        } else if (motherName) {
          parentInfo = `Con c·ªßa √îng Ch∆∞a c√≥ th√¥ng tin v√† B√† ${escapeHtml(motherName)}`;
        } else {
          parentInfo = 'Con c·ªßa √îng Ch∆∞a c√≥ th√¥ng tin v√† B√† Ch∆∞a c√≥ th√¥ng tin';
        }
        
        let badgeColor = '';
        if (gen === 1) badgeColor = 'background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);';
        else if (gen === 2) badgeColor = 'background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);';
        else if (gen === 3) badgeColor = 'background: linear-gradient(135deg, #ca8a04 0%, #a16207 100%);';
        else if (gen === 4) badgeColor = 'background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);';
        else if (gen === 5) badgeColor = 'background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);';
        else if (gen >= 6) badgeColor = 'background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%);';
        else badgeColor = 'background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);';
        
        const cardWidth = (!isFullWidth) ? 'calc(50% - 8px)' : '100%';
        const cardMargin = (!isFullWidth) ? '0' : '0 0 16px 0';
        
        return `
          <div style="
            background: #FFF8DC;
            border-radius: 8px;
            padding: 16px 20px;
            margin: ${cardMargin};
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #DAA520;
            width: ${cardWidth};
          ">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
              <span style="
                ${badgeColor}
                color: white;
                font-weight: 700;
                font-size: 13px;
                padding: 6px 16px;
                border-radius: 20px;
                white-space: nowrap;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
                display: inline-block;
                min-width: 70px;
                text-align: center;
              ">ƒê·ªùi ${gen}</span>
              <h3 style="
                color: var(--color-primary);
                font-weight: 700;
                font-size: 18px;
                margin: 0;
                flex: 1;
                line-height: 1.4;
              ">${titleLine}</h3>
          </div>
            <div style="
              color: var(--color-text);
              font-size: 14px;
              line-height: 1.6;
              padding-left: 0;
              margin-top: 6px;
            ">
              ${parentInfo}
        </div>
          </div>
        `;
      }
      
      if (resultContent) {
        resultContent.innerHTML = `
          <div style="display: flex; flex-direction: column; gap: 0; width: 100%;">
            ${timelineHTML}
          </div>
        `;
      }
      
      resultDiv.style.display = 'block';
    }
    
    /**
     * Show detail panel
     */
    function showDetailPanel(person) {
      const panel = document.getElementById('lineageDetailPanel');
      const content = document.getElementById('lineageDetailContent');
      
      if (!person || !panel || !content) return;
      
      selectedPerson = person;
      
      fetch(`/api/person/${person.person_id}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`API tr·∫£ m√£ ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          const detailedPerson = data.person || data;
          if (detailedPerson.error) {
            renderDetailPanel(person);
            return;
          }
          
          Object.assign(selectedPerson, detailedPerson);
          if (!selectedPerson.generation_number && selectedPerson.generation_level) {
            selectedPerson.generation_number = selectedPerson.generation_level;
          }
          
          renderDetailPanel(selectedPerson);
        })
        .catch(error => {
          console.error('L·ªói khi fetch th√¥ng tin chi ti·∫øt:', error);
          renderDetailPanel(person);
        });
    }
    
    /**
     * Format marriages for display
     */
    function formatMarriages(person) {
      if (!person) return 'Ch∆∞a c√≥ th√¥ng tin';
      
      // ∆Øu ti√™n marriages array (ƒë·∫ßy ƒë·ªß th√¥ng tin nh·∫•t)
      if (person.marriages && Array.isArray(person.marriages) && person.marriages.length > 0) {
        return person.marriages.map(m => {
          let display = m.spouse_name || '';
          if (m.marriage_date_solar) {
            display += ` (${m.marriage_date_solar})`;
          }
          if (m.marriage_place) {
            display += ` - ${m.marriage_place}`;
          }
          return display;
        }).join('<br>');
      }
      
      // ∆Øu ti√™n spouse_name (string)
      if (person.spouse_name) {
        const spouses = person.spouse_name.split(';').map(s => s.trim()).filter(s => s);
        return spouses.join('<br>');
      }
      
      // Fallback: spouse (string)
      if (person.spouse) {
        const spouses = person.spouse.split(';').map(s => s.trim()).filter(s => s);
        return spouses.join('<br>');
      }
      
      return 'Ch∆∞a c√≥ th√¥ng tin';
    }
    
    /**
     * Format siblings for display
     */
    function formatSiblings(person) {
      if (!person) return 'Ch∆∞a c√≥ th√¥ng tin';
      
      if (person.siblings) {
        const siblings = person.siblings.split(';').map(s => s.trim()).filter(s => s);
        return siblings.length > 0 ? siblings.join('<br>') : 'Ch∆∞a c√≥ th√¥ng tin';
      }
      
      return 'Ch∆∞a c√≥ th√¥ng tin';
    }
    
    /**
     * Format children for display
     */
    function formatChildren(person) {
      if (!person) return 'Ch∆∞a c√≥ th√¥ng tin';
      
      // ∆Øu ti√™n children array
      if (person.children && Array.isArray(person.children) && person.children.length > 0) {
        return person.children.map(c => {
          let display = c.full_name || c.name || '';
          if (c.generation_level || c.generation_number) {
            display += ` (ƒê·ªùi ${c.generation_level || c.generation_number})`;
          }
          return display;
        }).join('<br>');
      }
      
      // Fallback: children (string)
      if (person.children && typeof person.children === 'string') {
        const children = person.children.split(';').map(c => c.trim()).filter(c => c);
        return children.length > 0 ? children.join('<br>') : 'Ch∆∞a c√≥ th√¥ng tin';
      }
      
      return 'Ch∆∞a c√≥ th√¥ng tin';
    }
    
    /**
     * Render detail panel
     */
    function renderDetailPanel(person) {
      const content = document.getElementById('lineageDetailContent');
      const panel = document.getElementById('lineageDetailPanel');
      if (!content || !panel) return;
      
      content.innerHTML = `
        <div style="line-height: 1.6;">
          <div style="margin-bottom: var(--space-3);">
            <strong>Person ID:</strong> ${person.person_id || 'Ch∆∞a c√≥ th√¥ng tin'}
        </div>
          <div style="margin-bottom: var(--space-3);">
            <strong>T√™n ƒë·∫ßy ƒë·ªß:</strong> ${person.full_name || 'Ch∆∞a c√≥ th√¥ng tin'}
      </div>
          ${person.alias ? `<div style="margin-bottom: var(--space-3);"><strong>T√™n th∆∞·ªùng g·ªçi:</strong> ${person.alias}</div>` : ''}
          <div style="margin-bottom: var(--space-3);">
            <strong>ƒê·ªùi:</strong> ${person.generation_number || person.generation_level || 'Ch∆∞a c√≥ th√¥ng tin'}
    </div>
          <div style="margin-bottom: var(--space-3);">
            <strong>Gi·ªõi t√≠nh:</strong> ${person.gender || 'Ch∆∞a c√≥ th√¥ng tin'}
  </div>
          <div style="margin-bottom: var(--space-3);">
            <strong>T√™n b·ªë:</strong> ${person.father_name ? '√îng ' + escapeHtml(person.father_name) : 'Ch∆∞a c√≥ th√¥ng tin'}
          </div>
          <div style="margin-bottom: var(--space-3);">
            <strong>T√™n m·∫π:</strong> ${person.mother_name ? 'B√† ' + escapeHtml(person.mother_name) : 'Ch∆∞a c√≥ th√¥ng tin'}
          </div>
          <div style="margin-bottom: var(--space-3);">
            <strong>H√¥n ph·ªëi:</strong><br>
            <div style="margin-top: 4px; color: var(--color-text);">${formatMarriages(person)}</div>
          </div>
          <div style="margin-bottom: var(--space-3);">
            <strong>Anh ch·ªã em:</strong><br>
            <div style="margin-top: 4px; color: var(--color-text);">${formatSiblings(person)}</div>
          </div>
          <div style="margin-bottom: var(--space-3);">
            <strong>Th√¥ng tin con:</strong><br>
            <div style="margin-top: 4px; color: var(--color-text);">${formatChildren(person)}</div>
          </div>
          <div style="margin-bottom: var(--space-3);">
            <strong>Nh√°nh:</strong> ${person.branch_name || 'Ch∆∞a c√≥ th√¥ng tin'}
          </div>
          <div style="margin-bottom: var(--space-3);">
            <strong>Tr·∫°ng th√°i:</strong> ${person.status || 'Ch∆∞a c√≥ th√¥ng tin'}
          </div>
        </div>
      `;
      
      panel.style.display = 'block';
    }
    
    /**
     * Close detail panel
     */
    function closeDetailPanel() {
      const panel = document.getElementById('lineageDetailPanel');
      if (panel) {
        panel.style.display = 'none';
      }
    }
  </script>

  <!-- Member statistics -->
  <script>
    // Generic fetch helper
    async function fetchJson(url, options) {
      const res = await fetch(url, options);
      const contentType = res.headers.get('Content-Type') || '';
      const text = await res.text();

      if (!res.ok) {
        console.error('HTTP error for', url, res.status, text);
        throw new Error(`HTTP ${res.status} when fetching ${url}`);
      }

      if (!contentType.includes('application/json')) {
        console.error('Non-JSON response for', url, 'contentType =', contentType, 'body =', text.slice(0, 300));
        throw new Error(`Expected JSON but got non-JSON response from ${url}`);
      }

      try {
        return JSON.parse(text);
      } catch (e) {
        console.error('JSON parse error for', url, 'body =', text.slice(0, 300));
        throw e;
      }
    }

    async function loadMemberStats() {
      const errorEl = document.getElementById('statsErrorMessage');
      try {
        const data = await fetchJson('/api/stats/members');
        const total = data.total_members || 0;
        const male = data.male_count || 0;
        const female = data.female_count || 0;
        const unknown = data.unknown_gender_count || 0;

        document.getElementById('statsTotalMembers').textContent = total.toLocaleString('vi-VN');
        document.getElementById('statsMaleCount').textContent = male.toLocaleString('vi-VN');
        document.getElementById('statsFemaleCount').textContent = female.toLocaleString('vi-VN');
        document.getElementById('statsUnknownCount').textContent = unknown.toLocaleString('vi-VN');

        renderGenderCharts({ male, female, unknown });

        // Hi·ªÉn th·ªã th·ªëng k√™ theo ƒë·ªùi
        if (data.generation_counts && Array.isArray(data.generation_counts)) {
          const generationCounts = data.generation_counts;
          
          // C·∫≠p nh·∫≠t s·ªë li·ªáu cho t·ª´ng ƒë·ªùi
          for (let i = 1; i <= 8; i++) {
            const genElement = document.getElementById(`gen${i}Count`);
            if (genElement) {
              const genData = generationCounts.find(g => g.generation_level === i);
              const count = genData ? genData.count : 0;
              genElement.textContent = count.toLocaleString('vi-VN');
            }
          }
          
          // V·∫Ω bi·ªÉu ƒë·ªì
          renderGenerationChart(generationCounts);
        }
      } catch (err) {
        console.error('Error loading stats:', err);
        if (errorEl) errorEl.style.display = 'block';
      }
    }

    function renderGenderCharts({ male, female, unknown }) {
      const pieCtx = document.getElementById('genderPieChart')?.getContext('2d');
      const barCtx = document.getElementById('genderBarChart')?.getContext('2d');
      if (!pieCtx || !barCtx || typeof Chart === 'undefined') return;

      const labels = ['Nam', 'N·ªØ', 'Kh√¥ng r√µ / kh√°c'];
      const values = [male, female, unknown];

      new Chart(pieCtx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: ['#1976d2', '#e91e63', '#9e9e9e'],
            borderWidth: 1
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      new Chart(barCtx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'S·ªë l∆∞·ª£ng',
            data: values,
            backgroundColor: ['#1976d2', '#e91e63', '#9e9e9e']
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          }
        }
      });
    }

    function renderGenerationChart(generationCounts) {
      const ctx = document.getElementById('generationBarChart')?.getContext('2d');
      if (!ctx || typeof Chart === 'undefined') return;

      // S·∫Øp x·∫øp theo generation_level
      const sorted = generationCounts.sort((a, b) => a.generation_level - b.generation_level);
      const labels = sorted.map(g => `ƒê·ªùi ${g.generation_level}`);
      const values = sorted.map(g => g.count);

      // M√†u s·∫Øc kh√°c nhau cho t·ª´ng ƒë·ªùi
      const colors = [
        '#8B0000', // ƒê·ªùi 1 - Dark red
        '#CD853F', // ƒê·ªùi 2 - Peru
        '#DAA520', // ƒê·ªùi 3 - Goldenrod
        '#B8860B', // ƒê·ªùi 4 - Dark goldenrod
        '#9ACD32', // ƒê·ªùi 5 - Yellow green
        '#9370DB', // ƒê·ªùi 6 - Medium purple
        '#20B2AA', // ƒê·ªùi 7 - Light sea green
        '#FF6347'  // ƒê·ªùi 8 - Tomato
      ];

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'S·ªë ng∆∞·ªùi',
            data: values,
            backgroundColor: colors.slice(0, labels.length),
            borderColor: colors.slice(0, labels.length).map(c => c + 'DD'),
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `S·ªë ng∆∞·ªùi: ${context.parsed.y.toLocaleString('vi-VN')}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0,
                callback: function(value) {
                  return value.toLocaleString('vi-VN');
                }
              }
            },
            x: {
              ticks: {
                font: {
                  size: 12
                }
              }
            }
          }
        }
      });
    }

    // Load stats on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadMemberStats();
    });
  </script>

  <style>
    @media (max-width: 900px) {
      .stats-layout {
        grid-template-columns: 1fr !important;
      }
      .stats-charts {
        grid-template-columns: 1fr !important;
      }
    }
  </style>
</body>
</html>

