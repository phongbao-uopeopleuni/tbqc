# ğŸ—ï¸ KIáº¾N TRÃšC VÃ€ THIáº¾T Láº¬P PROJECT TBQC

**Há»‡ thá»‘ng tra cá»©u gia pháº£ Nguyá»…n PhÆ°á»›c Tá»™c - PhÃ²ng Tuy BiÃªn Quáº­n CÃ´ng**

---

## ğŸ“ Tá»”NG QUAN KIáº¾N TRÃšC

Project nÃ y lÃ  má»™t **Full-Stack Web Application** sá»­ dá»¥ng:
- **Backend**: Flask (Python) - RESTful API
- **Frontend**: HTML/CSS/JavaScript (Vanilla JS, khÃ´ng dÃ¹ng framework)
- **Database**: MySQL 8.0+
- **Deployment**: Railway.app (Production)

### Kiáº¿n trÃºc tá»•ng thá»ƒ:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLIENT (Browser)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  HTML Pages  â”‚  â”‚  JavaScript  â”‚  â”‚     CSS     â”‚  â”‚
â”‚  â”‚  (Templates) â”‚  â”‚   (Static)   â”‚  â”‚   (Static)  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ HTTP/HTTPS
                         â”‚ REST API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FLASK APPLICATION (Backend)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Routes     â”‚  â”‚   Business   â”‚  â”‚   Database   â”‚  â”‚
â”‚  â”‚  (app.py)    â”‚  â”‚    Logic     â”‚  â”‚  Connection  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ SQL Queries
                         â”‚ mysql.connector
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  MYSQL DATABASE                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   persons    â”‚  â”‚relationships â”‚  â”‚  marriages   â”‚  â”‚
â”‚  â”‚   users      â”‚  â”‚  activities  â”‚  â”‚    views     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ BACKEND (Flask Application)

### 1. **Entry Point & Configuration**

#### `app.py` (Main Application)
- **Vai trÃ²**: File chÃ­nh cá»§a Flask application
- **Chá»©c nÄƒng**:
  - Khá»Ÿi táº¡o Flask app vá»›i cáº¥u hÃ¬nh templates/static folders
  - ÄÄƒng kÃ½ táº¥t cáº£ routes (API endpoints, pages)
  - Xá»­ lÃ½ authentication (Flask-Login)
  - Káº¿t ná»‘i database thÃ´ng qua `folder_py/db_config.py`
  - Xá»­ lÃ½ CORS cho frontend

**Cáº¥u trÃºc chÃ­nh:**
```python
app = Flask(__name__, 
            static_folder='static', 
            static_url_path='/static',
            template_folder='templates')
CORS(app)  # Cho phÃ©p frontend gá»i API
```

#### `start_server.py`
- **Vai trÃ²**: Script khá»Ÿi Ä‘á»™ng server
- **Chá»©c nÄƒng**:
  - Tá»± Ä‘á»™ng thÃªm `folder_py` vÃ o Python path
  - Fix encoding cho Windows console
  - Cháº¡y Flask development server (port 5000)
  - Production: Sá»­ dá»¥ng Gunicorn (theo Procfile)

### 2. **Database Layer**

#### `folder_py/db_config.py` (Unified Database Configuration)
- **Vai trÃ²**: Single source of truth cho database connection
- **Priority order**:
  1. `DB_*` environment variables (Railway production)
  2. `MYSQL*` environment variables (Railway MySQL service)
  3. `tbqc_db.env` file (local development)
  4. Default localhost (fallback)

**Functions:**
- `get_db_config()` - Tráº£ vá» dict config cho mysql.connector
- `get_db_connection()` - Táº¡o vÃ  tráº£ vá» database connection

**Example:**
```python
from folder_py.db_config import get_db_connection

connection = get_db_connection()
cursor = connection.cursor(dictionary=True)
cursor.execute("SELECT * FROM persons")
```

### 3. **Authentication System**

#### `auth.py` / `folder_py/auth.py`
- **Vai trÃ²**: Xá»­ lÃ½ authentication vÃ  authorization
- **Chá»©c nÄƒng**:
  - Flask-Login integration
  - User model vá»›i roles (admin, user)
  - Password hashing (bcrypt)
  - Session management

**Routes:**
- `/login` - Login page
- `/api/login` - Login API endpoint
- `@login_required` decorator cho protected routes

### 4. **API Endpoints Structure**

#### Main API Routes trong `app.py`:

**Health & Status:**
- `GET /api/health` - Server vÃ  database status

**Persons Management:**
- `GET /api/persons` - List all persons
- `GET /api/person/<person_id>` - Get person details
- `POST /api/persons` - Create person (admin)
- `PUT /api/person/<person_id>` - Update person (admin)
- `DELETE /api/person/<person_id>` - Delete person (admin)
- `DELETE /api/persons/batch` - Delete multiple persons (admin)

**Tree & Genealogy:**
- `GET /api/tree?root_id=P-1-1&max_gen=5` - Get genealogy tree
- `GET /api/search?q=<query>&generation=<num>&limit=50` - Search persons
- `GET /api/ancestors/<person_id>?max_level=10` - Get ancestors chain
- `GET /api/descendants/<person_id>?max_level=5` - Get descendants
- `GET /api/children/<parent_id>` - Get children of a person

**Relationships:**
- `GET /api/relationships` - List all relationships
- `GET /api/person/<person_id>/spouses` - Get spouses (login required)

**Activities:**
- `GET /api/activities` - List activities
- `POST /api/activities` - Create activity (admin)
- `GET /api/activities/<id>` - Get activity details
- `PUT /api/activities/<id>` - Update activity (admin)
- `DELETE /api/activities/<id>` - Delete activity (admin)

**Admin & Backup:**
- `POST /api/admin/backup` - Create database backup (admin)
- `GET /api/admin/backups` - List backups (admin)
- `GET /api/admin/backup/<filename>` - Download backup (admin)
- `POST /api/admin/restore` - Restore from backup (admin)
- `POST /api/admin/verify-password` - Verify password for admin actions

**Statistics:**
- `GET /api/stats/members` - Member statistics

### 5. **Module Structure**

#### `folder_py/` - Python Modules:
- `db_config.py` - Database configuration
- `auth.py` - Authentication logic
- `admin_routes.py` - Admin routes (registered via `register_admin_routes(app)`)
- `marriage_api.py` - Marriage API routes (registered via `register_marriage_routes(app)`)
- `genealogy_tree.py` - Tree building functions (used by `/api/tree`)
- `audit_log.py` - Audit logging
- `facebook_sync.py` - Facebook synchronization
- `reset_and_import.py` - Database reset and CSV import

### 6. **Data Import System**

#### CSV Import Process:
1. **person.csv** - Main person data vá»›i táº¥t cáº£ fields
2. **father_mother.csv** - Parent relationships (resolve names to IDs)
3. **spouse_sibling_children.csv** - Marriages and siblings (resolve names to IDs)

**Script:** `reset_and_import.py`
- Reset schema (tá»« `folder_sql/reset_schema_tbqc.sql`)
- Truncate data (tá»« `folder_sql/reset_tbqc_tables.sql`)
- Import tá»« 3 CSV files
- Update views/procedures (tá»« `folder_sql/update_views_procedures_tbqc.sql`)

---

## ğŸ¨ FRONTEND (HTML/CSS/JavaScript)

### 1. **Page Structure**

#### Templates (`templates/`):

**`index.html`** - Trang chá»§
- Hiá»ƒn thá»‹ thÃ´ng tin tá»•ng quan
- Search functionality
- Links Ä‘áº¿n cÃ¡c trang khÃ¡c

**`genealogy.html`** - Trang Gia Pháº£
- **Family Tree Viewer**: 
  - Legacy viewer: `family-tree-core.js` + `family-tree-ui.js`
  - Minimal viewer (má»›i): `minimal-family-tree.js` (theo spec)
- **Lineage Search**: Tra cá»©u chuá»—i pháº£ há»‡
- **Statistics**: Thá»‘ng kÃª thÃ nh viÃªn

**`members.html`** - Trang Quáº£n lÃ½ ThÃ nh viÃªn
- Danh sÃ¡ch táº¥t cáº£ thÃ nh viÃªn
- CRUD operations (Create, Read, Update, Delete)
- Batch delete vá»›i password protection
- Backup database button
- Password modal cho admin actions

**`login.html`** - Trang Ä‘Äƒng nháº­p
- Form Ä‘Äƒng nháº­p
- Redirect sau khi login

**`activities.html`** - Trang Hoáº¡t Ä‘á»™ng
- Danh sÃ¡ch cÃ¡c hoáº¡t Ä‘á»™ng
- Chi tiáº¿t hoáº¡t Ä‘á»™ng

**`contact.html`** - Trang LiÃªn há»‡
- ThÃ´ng tin liÃªn há»‡

**`editor.html`** - Trang Editor (náº¿u cÃ³)

### 2. **Static Files Structure**

#### CSS (`static/css/`):
- **`tokens.css`** - Design tokens (colors, spacing, typography)
- **`main.css`** - Main styles
- **`components.css`** - Component styles
- **`navbar.css`** - Navigation bar styles
- **`footer.css`** - Footer styles

**Design System:**
- CSS Variables cho colors, spacing, typography
- Responsive design vá»›i media queries
- Consistent styling across pages

#### JavaScript (`static/js/`):

**`common.js`** - Common utilities
- Shared functions
- Helper functions

**Family Tree Viewers:**
- **`family-tree-core.js`** - Core data structures vÃ  logic cho legacy tree
  - Graph building
  - Tree traversal
  - Ancestors/descendants logic
  
- **`family-tree-ui.js`** - UI rendering cho legacy tree
  - Node rendering
  - Connector drawing
  - Zoom/pan functionality
  
- **`minimal-family-tree.js`** - Minimal family tree viewer (má»›i)
  - Theo technical spec: ID + Name + Birth-Death only
  - Generation-based layout
  - Zoom/Pan/Fit-to-screen
  - Search functionality
  - Collapse/Expand descendants

**`genealogy-lineage.js`** - Lineage search functionality
- Search ancestors chain
- Display lineage information

### 3. **Frontend-Backend Communication**

**Pattern:**
- Frontend gá»i API qua `fetch()` hoáº·c `XMLHttpRequest`
- API tráº£ vá» JSON
- Frontend render dá»¯ liá»‡u vÃ o DOM

**Example:**
```javascript
// Load tree data
const response = await fetch('/api/tree?root_id=P-1-1&max_gen=5');
const treeData = await response.json();

// Search persons
const response = await fetch('/api/search?q=MiÃªn&limit=50');
const results = await response.json();
```

**Error Handling:**
- Try-catch blocks
- Error messages hiá»ƒn thá»‹ cho user
- Console logging cho debugging

---

## ğŸ—„ï¸ DATABASE SCHEMA

### Main Tables:

**`persons`** - Person records
- `person_id` VARCHAR(50) PRIMARY KEY (e.g., "P-1-1")
- `full_name`, `alias`, `gender`, `status`
- `generation_level` INT (direct field, khÃ´ng dÃ¹ng foreign key)
- `birth_date_solar`, `birth_date_lunar`
- `death_date_solar`, `death_date_lunar`
- `father_name`, `mother_name` (denormalized for display)
- VÃ  nhiá»u fields khÃ¡c...

**`relationships`** - Parent-child relationships
- `parent_id` VARCHAR(50)
- `child_id` VARCHAR(50)
- `relation_type` ENUM('father', 'mother')
- Foreign keys to `persons`

**`marriages`** - Marriage records
- `person_id` VARCHAR(50)
- `spouse_person_id` VARCHAR(50)
- Foreign keys to `persons`

**`users`** - User accounts
- `username`, `password_hash`, `role`, `is_active`

**`activities`** - Activity records
- Various activity information

### Views & Stored Procedures:
- Views Ä‘á»ƒ simplify queries
- Stored procedures: `sp_get_ancestors`, `sp_get_descendants`, `sp_get_children`

---

## ğŸš€ DEPLOYMENT

### Production (Railway.app):

**Configuration:**
- **Procfile**: `web: gunicorn app:app --bind 0.0.0.0:$PORT --workers 2 --timeout 120`
- **Start Command**: `python start_server.py` (hoáº·c gunicorn tá»« Procfile)
- **Port**: Railway auto-assigns (sá»­ dá»¥ng `PORT` env var)

**Environment Variables (Railway Dashboard):**
```
DB_HOST=<mysql-host>
DB_PORT=<mysql-port>
DB_USER=<mysql-user>
DB_PASSWORD=<mysql-password>
DB_NAME=<database-name>
SECRET_KEY=<random-string>
ADMIN_PASSWORD=<admin-password>
BACKUP_PASSWORD=<backup-password>
MEMBERS_PASSWORD=<members-password>
SMTP_USER=<smtp-user>
SMTP_PASSWORD=<smtp-password>
```

**Custom Domain:**
- Railway há»— trá»£ custom domain
- Cáº¥u hÃ¬nh DNS records (A record hoáº·c CNAME)
- SSL certificate tá»± Ä‘á»™ng (Let's Encrypt)

### Local Development:

**Setup:**
1. Clone repository
2. Táº¡o virtual environment: `python -m venv .venv`
3. Activate: `.\.venv\Scripts\Activate.ps1` (Windows)
4. Install dependencies: `pip install -r requirements.txt`
5. Copy `tbqc_db.env.example` â†’ `tbqc_db.env` vÃ  Ä‘iá»n thÃ´ng tin
6. Run: `python start_server.py`

**Access:**
- `http://localhost:5000/` - Trang chá»§
- `http://localhost:5000/genealogy` - Gia pháº£
- `http://localhost:5000/members` - Quáº£n lÃ½ thÃ nh viÃªn
- `http://localhost:5000/api/health` - Health check

---

## ğŸ“¦ DEPENDENCIES

### Backend (requirements.txt):
```
flask==3.0.0              # Web framework
flask-cors==4.0.0         # CORS support
mysql-connector-python==8.2.0  # MySQL driver
bcrypt==4.1.2             # Password hashing
flask-login==0.6.3        # Authentication
gunicorn==23.0.0          # Production WSGI server
pytest==7.4.3             # Testing
requests==2.31.0          # HTTP requests
Pillow==10.1.0            # Image processing
```

### Frontend:
- **No build step** - Pure HTML/CSS/JavaScript
- **No npm/node_modules** - Vanilla JS only
- **External libraries** (loaded via CDN náº¿u cáº§n):
  - Chart.js (cho statistics charts)
  - Google Fonts (Inter font family)

---

## ğŸ” SECURITY

### Authentication:
- Flask-Login cho session management
- Password hashing vá»›i bcrypt
- Role-based access control (admin/user)

### Password Protection:
- Admin actions yÃªu cáº§u password verification
- Passwords lÆ°u trong environment variables (khÃ´ng hardcode)
- API endpoint `/api/admin/verify-password` Ä‘á»ƒ verify

### Database Security:
- Prepared statements (parameterized queries) Ä‘á»ƒ trÃ¡nh SQL injection
- Connection pooling
- Error handling khÃ´ng expose sensitive information

### File Security:
- `.gitignore` báº£o vá»‡:
  - `tbqc_db.env` - Database credentials
  - `.smtp_config` - SMTP credentials
  - `backups/*.sql` - Database backups
  - `.idea/*` - IDE config files

---

## ğŸ“ PROJECT STRUCTURE CHI TIáº¾T

```
tbqc/
â”œâ”€â”€ app.py                    # Main Flask application (3998 lines)
â”œâ”€â”€ auth.py                   # Authentication module
â”œâ”€â”€ admin_routes.py           # Admin routes
â”œâ”€â”€ marriage_api.py           # Marriage API routes
â”œâ”€â”€ backup_database.py        # Database backup script
â”œâ”€â”€ start_server.py           # Server startup script
â”œâ”€â”€ reset_and_import.py      # Database reset & CSV import
â”œâ”€â”€ Procfile                  # Railway deployment config
â”œâ”€â”€ requirements.txt          # Python dependencies
â”œâ”€â”€ tbqc_db.env.example      # Database config example
â”‚
â”œâ”€â”€ folder_py/                # Python modules
â”‚   â”œâ”€â”€ db_config.py          # Unified DB configuration â­
â”‚   â”œâ”€â”€ genealogy_tree.py    # Tree building functions
â”‚   â”œâ”€â”€ auth.py              # Auth module
â”‚   â”œâ”€â”€ admin_routes.py      # Admin routes module
â”‚   â”œâ”€â”€ marriage_api.py      # Marriage API module
â”‚   â”œâ”€â”€ audit_log.py         # Audit logging
â”‚   â”œâ”€â”€ facebook_sync.py    # Facebook sync
â”‚   â””â”€â”€ archive/             # Archived scripts
â”‚
â”œâ”€â”€ folder_sql/               # SQL scripts
â”‚   â”œâ”€â”€ reset_schema_tbqc.sql        # Main schema â­
â”‚   â”œâ”€â”€ reset_tbqc_tables.sql        # Reset data
â”‚   â”œâ”€â”€ update_views_procedures_tbqc.sql  # Views & procedures
â”‚   â””â”€â”€ archive/              # Archived SQL files
â”‚
â”œâ”€â”€ templates/                # HTML templates
â”‚   â”œâ”€â”€ index.html           # Trang chá»§
â”‚   â”œâ”€â”€ genealogy.html       # Trang Gia pháº£ â­
â”‚   â”œâ”€â”€ members.html         # Trang Quáº£n lÃ½ thÃ nh viÃªn
â”‚   â”œâ”€â”€ login.html           # Trang Ä‘Äƒng nháº­p
â”‚   â”œâ”€â”€ activities.html      # Trang hoáº¡t Ä‘á»™ng
â”‚   â””â”€â”€ contact.html         # Trang liÃªn há»‡
â”‚
â”œâ”€â”€ static/                   # Static files
â”‚   â”œâ”€â”€ css/                 # Stylesheets
â”‚   â”‚   â”œâ”€â”€ tokens.css       # Design tokens
â”‚   â”‚   â”œâ”€â”€ main.css         # Main styles
â”‚   â”‚   â”œâ”€â”€ components.css    # Components
â”‚   â”‚   â”œâ”€â”€ navbar.css       # Navigation
â”‚   â”‚   â””â”€â”€ footer.css       # Footer
â”‚   â”œâ”€â”€ js/                  # JavaScript files
â”‚   â”‚   â”œâ”€â”€ common.js        # Common utilities
â”‚   â”‚   â”œâ”€â”€ family-tree-core.js      # Legacy tree core
â”‚   â”‚   â”œâ”€â”€ family-tree-ui.js        # Legacy tree UI
â”‚   â”‚   â”œâ”€â”€ genealogy-lineage.js    # Lineage search
â”‚   â”‚   â””â”€â”€ minimal-family-tree.js   # Minimal tree viewer (má»›i)
â”‚   â””â”€â”€ images/              # Images
â”‚
â”œâ”€â”€ person.csv               # Main person data â­
â”œâ”€â”€ father_mother.csv        # Parent relationships â­
â”œâ”€â”€ spouse_sibling_children.csv  # Marriages & siblings â­
â”‚
â”œâ”€â”€ folder_md/               # Documentation
â”‚   â”œâ”€â”€ SCHEMA_IMPORT_GUIDE.md
â”‚   â”œâ”€â”€ HUONG_DAN_GAN_TEN_MIEN_RAILWAY.md
â”‚   â”œâ”€â”€ HUONG_DAN_CAU_HINH_SMTP.md
â”‚   â””â”€â”€ PROJECT_ARCHITECTURE.md (file nÃ y)
â”‚
â””â”€â”€ tests/                   # Test suite
    â”œâ”€â”€ test_health_endpoint.py
    â”œâ”€â”€ test_person_api_smoke.py
    â”œâ”€â”€ test_tree_api.py
    â””â”€â”€ test_db_connection.py
```

---

## ğŸ”„ DATA FLOW

### 1. **Page Load Flow:**
```
User â†’ Browser â†’ Flask Route â†’ render_template() â†’ HTML + JS
                                                    â†“
                                            JavaScript loads
                                                    â†“
                                            Fetch API data
                                                    â†“
                                            Render to DOM
```

### 2. **API Request Flow:**
```
Frontend JS â†’ fetch('/api/...') â†’ Flask Route â†’ Database Query
                                                    â†“
                                            Process data
                                                    â†“
                                            Return JSON
                                                    â†“
                                            Frontend updates UI
```

### 3. **Database Import Flow:**
```
CSV Files â†’ reset_and_import.py â†’ SQL Scripts â†’ MySQL
                                              â†“
                                    Parse & validate
                                              â†“
                                    Insert into tables
                                              â†“
                                    Update views/procedures
```

---

## ğŸ¯ KEY FEATURES

### Backend Features:
- âœ… RESTful API vá»›i comprehensive endpoints
- âœ… Unified database configuration (works vá»›i Railway vÃ  local)
- âœ… Authentication & Authorization (Flask-Login)
- âœ… Database backup/restore system
- âœ… Audit logging
- âœ… Error handling vÃ  logging
- âœ… Health checks

### Frontend Features:
- âœ… Responsive design (mobile, tablet, desktop)
- âœ… Interactive family tree visualization
  - Legacy viewer (full features)
  - Minimal viewer (ID + Name + Birth-Death)
- âœ… Search functionality
- âœ… CRUD operations cho members
- âœ… Statistics vÃ  charts
- âœ… Lineage search

### Database Features:
- âœ… Normalized schema (persons, relationships, marriages)
- âœ… Stored procedures cho complex queries
- âœ… Views Ä‘á»ƒ simplify access
- âœ… VARCHAR person_id (tá»« CSV format "P-1-1")

---

## ğŸ› ï¸ DEVELOPMENT WORKFLOW

### Local Development:
1. **Setup environment**: `python -m venv .venv && .\.venv\Scripts\Activate.ps1`
2. **Install dependencies**: `pip install -r requirements.txt`
3. **Configure database**: Táº¡o `tbqc_db.env` tá»« example
4. **Import data**: `python reset_and_import.py`
5. **Run server**: `python start_server.py`
6. **Access**: `http://localhost:5000`

### Making Changes:
1. **Backend**: Edit `app.py` hoáº·c modules trong `folder_py/`
2. **Frontend**: Edit templates trong `templates/` hoáº·c JS trong `static/js/`
3. **Database**: Edit SQL scripts trong `folder_sql/`
4. **Test**: Check browser console vÃ  server logs
5. **Commit**: `git add . && git commit -m "..." && git push`

### Deployment:
1. **Push to GitHub**: `git push origin master`
2. **Railway auto-deploys**: Tá»± Ä‘á»™ng deploy khi cÃ³ push
3. **Check logs**: Railway dashboard â†’ Logs
4. **Verify**: Test trÃªn production URL

---

## ğŸ“Š TECHNOLOGY STACK SUMMARY

| Layer | Technology | Version/Purpose |
|-------|-----------|-----------------|
| **Backend Framework** | Flask | 3.0.0 |
| **WSGI Server** | Gunicorn | 23.0.0 (Production) |
| **Database** | MySQL | 8.0+ |
| **Database Driver** | mysql-connector-python | 8.2.0 |
| **Authentication** | Flask-Login | 0.6.3 |
| **Password Hashing** | bcrypt | 4.1.2 |
| **CORS** | Flask-CORS | 4.0.0 |
| **Frontend** | Vanilla JS | No framework |
| **CSS** | Custom CSS | Design system vá»›i variables |
| **Deployment** | Railway.app | Cloud platform |
| **Version Control** | Git | GitHub |

---

## ğŸ” DEBUGGING & TROUBLESHOOTING

### Common Issues:

**1. Database Connection:**
- Check `tbqc_db.env` hoáº·c environment variables
- Verify MySQL Ä‘ang cháº¡y
- Test connection: `python folder_py/test_db_health.py`

**2. Import Errors:**
- Check Python path
- Verify `folder_py` Ä‘Æ°á»£c import Ä‘Ãºng
- Check `start_server.py` Ä‘Ã£ thÃªm path chÆ°a

**3. API Errors:**
- Check browser console (F12)
- Check server logs
- Verify route Ä‘Ã£ Ä‘Æ°á»£c register trong `app.py`

**4. Frontend Issues:**
- Check browser console cho JavaScript errors
- Verify static files Ä‘Æ°á»£c serve Ä‘Ãºng (`/static/...`)
- Check network tab trong DevTools

---

## ğŸ“ NOTES

- **No build step**: Frontend lÃ  pure HTML/CSS/JS, khÃ´ng cáº§n compile
- **No ORM**: Sá»­ dá»¥ng raw SQL queries vá»›i mysql.connector
- **Modular structure**: Code Ä‘Æ°á»£c tá»• chá»©c trong `folder_py/` modules
- **Unified config**: Táº¥t cáº£ database connections dÃ¹ng `db_config.py`
- **Production-ready**: CÃ³ error handling, logging, health checks

---

**Last Updated**: 2025-12-28  
**Status**: âœ… Production Ready

